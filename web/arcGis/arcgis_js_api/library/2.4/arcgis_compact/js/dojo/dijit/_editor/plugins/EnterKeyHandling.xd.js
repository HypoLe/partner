/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


window[esri._dojoScopeName||"dojo"]._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dijit._editor.plugins.EnterKeyHandling"],["require","dojo.window"],["require","dijit._editor._Plugin"],["require","dijit._editor.range"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dijit._editor.plugins.EnterKeyHandling"]){_4._hasResource["dijit._editor.plugins.EnterKeyHandling"]=true;_4.provide("dijit._editor.plugins.EnterKeyHandling");_4.require("dojo.window");_4.require("dijit._editor._Plugin");_4.require("dijit._editor.range");_4.declare("dijit._editor.plugins.EnterKeyHandling",_5._editor._Plugin,{blockNodeForEnter:"BR",constructor:function(_7){if(_7){if("blockNodeForEnter" in _7){_7.blockNodeForEnter=_7.blockNodeForEnter.toUpperCase();}_4.mixin(this,_7);}},setEditor:function(_8){if(this.editor===_8){return;}this.editor=_8;if(this.blockNodeForEnter=="BR"){this.editor.customUndo=true;_8.onLoadDeferred.addCallback(_4.hitch(this,function(d){this.connect(_8.document,"onkeypress",function(e){if(e.charOrCode==_4.keys.ENTER){var ne=_4.mixin({},e);ne.shiftKey=true;if(!this.handleEnterKey(ne)){_4.stopEvent(e);}}});return d;}));}else{if(this.blockNodeForEnter){var h=_4.hitch(this,this.handleEnterKey);_8.addKeyHandler(13,0,0,h);_8.addKeyHandler(13,0,1,h);this.connect(this.editor,"onKeyPressed","onKeyPressed");}}},onKeyPressed:function(e){if(this._checkListLater){if(_4.withGlobal(this.editor.window,"isCollapsed",_5)){var _9=_4.withGlobal(this.editor.window,"getAncestorElement",_5._editor.selection,["LI"]);if(!_9){_5._editor.RichText.prototype.execCommand.call(this.editor,"formatblock",this.blockNodeForEnter);var _a=_4.withGlobal(this.editor.window,"getAncestorElement",_5._editor.selection,[this.blockNodeForEnter]);if(_a){_a.innerHTML=this.bogusHtmlContent;if(_4.isIE){var r=this.editor.document.selection.createRange();r.move("character",-1);r.select();}}else{console.error("onKeyPressed: Cannot find the new block node");}}else{if(_4.isMoz){if(_9.parentNode.parentNode.nodeName=="LI"){_9=_9.parentNode.parentNode;}}var fc=_9.firstChild;if(fc&&fc.nodeType==1&&(fc.nodeName=="UL"||fc.nodeName=="OL")){_9.insertBefore(fc.ownerDocument.createTextNode(" "),fc);var _b=_5.range.create(this.editor.window);_b.setStart(_9.firstChild,0);var _c=_5.range.getSelection(this.editor.window,true);_c.removeAllRanges();_c.addRange(_b);}}}this._checkListLater=false;}if(this._pressedEnterInBlock){if(this._pressedEnterInBlock.previousSibling){this.removeTrailingBr(this._pressedEnterInBlock.previousSibling);}delete this._pressedEnterInBlock;}},bogusHtmlContent:"&nbsp;",blockNodes:/^(?:P|H1|H2|H3|H4|H5|H6|LI)$/,handleEnterKey:function(e){var _d,_e,_f,_10,_11,_12,doc=this.editor.document,br,rs,txt;if(e.shiftKey){var _13=_4.withGlobal(this.editor.window,"getParentElement",_5._editor.selection);var _14=_5.range.getAncestor(_13,this.blockNodes);if(_14){if(_14.tagName=="LI"){return true;}_d=_5.range.getSelection(this.editor.window);_e=_d.getRangeAt(0);if(!_e.collapsed){_e.deleteContents();_d=_5.range.getSelection(this.editor.window);_e=_d.getRangeAt(0);}if(_5.range.atBeginningOfContainer(_14,_e.startContainer,_e.startOffset)){br=doc.createElement("br");_f=_5.range.create(this.editor.window);_14.insertBefore(br,_14.firstChild);_f.setStartBefore(br.nextSibling);_d.removeAllRanges();_d.addRange(_f);}else{if(_5.range.atEndOfContainer(_14,_e.startContainer,_e.startOffset)){_f=_5.range.create(this.editor.window);br=doc.createElement("br");_14.appendChild(br);_14.appendChild(doc.createTextNode(" "));_f.setStart(_14.lastChild,0);_d.removeAllRanges();_d.addRange(_f);}else{rs=_e.startContainer;if(rs&&rs.nodeType==3){txt=rs.nodeValue;_4.withGlobal(this.editor.window,function(){_10=doc.createTextNode(txt.substring(0,_e.startOffset));_11=doc.createTextNode(txt.substring(_e.startOffset));_12=doc.createElement("br");if(_11.nodeValue==""&&_4.isWebKit){_11=doc.createTextNode(" ");}_4.place(_10,rs,"after");_4.place(_12,_10,"after");_4.place(_11,_12,"after");_4.destroy(rs);_f=_5.range.create(_4.gobal);_f.setStart(_11,0);_d.removeAllRanges();_d.addRange(_f);});return false;}return true;}}}else{_d=_5.range.getSelection(this.editor.window);if(_d.rangeCount){_e=_d.getRangeAt(0);if(_e&&_e.startContainer){if(!_e.collapsed){_e.deleteContents();_d=_5.range.getSelection(this.editor.window);_e=_d.getRangeAt(0);}rs=_e.startContainer;if(rs&&rs.nodeType==3){_4.withGlobal(this.editor.window,_4.hitch(this,function(){var _15=false;var _16=_e.startOffset;if(rs.length<_16){ret=this._adjustNodeAndOffset(rs,_16);rs=ret.node;_16=ret.offset;}txt=rs.nodeValue;_10=doc.createTextNode(txt.substring(0,_16));_11=doc.createTextNode(txt.substring(_16));_12=doc.createElement("br");if(!_11.length){_11=doc.createTextNode(" ");_15=true;}if(_10.length){_4.place(_10,rs,"after");}else{_10=rs;}_4.place(_12,_10,"after");_4.place(_11,_12,"after");_4.destroy(rs);_f=_5.range.create(_4.gobal);_f.setStart(_11,0);_f.setEnd(_11,_11.length);_d.removeAllRanges();_d.addRange(_f);if(_15&&!_4.isWebKit){_5._editor.selection.remove();}else{_5._editor.selection.collapse(true);}}));}else{_4.withGlobal(this.editor.window,_4.hitch(this,function(){var _17=doc.createElement("br");rs.appendChild(_17);var _18=doc.createTextNode(" ");rs.appendChild(_18);_f=_5.range.create(_4.global);_f.setStart(_18,0);_f.setEnd(_18,_18.length);_d.removeAllRanges();_d.addRange(_f);_5._editor.selection.collapse(true);}));}}}else{_5._editor.RichText.prototype.execCommand.call(this.editor,"inserthtml","<br>");}}return false;}var _19=true;_d=_5.range.getSelection(this.editor.window);_e=_d.getRangeAt(0);if(!_e.collapsed){_e.deleteContents();_d=_5.range.getSelection(this.editor.window);_e=_d.getRangeAt(0);}var _1a=_5.range.getBlockAncestor(_e.endContainer,null,this.editor.editNode);var _1b=_1a.blockNode;if((this._checkListLater=(_1b&&(_1b.nodeName=="LI"||_1b.parentNode.nodeName=="LI")))){if(_4.isMoz){this._pressedEnterInBlock=_1b;}if(/^(\s|&nbsp;|\xA0|<span\b[^>]*\bclass=['"]Apple-style-span['"][^>]*>(\s|&nbsp;|\xA0)<\/span>)?(<br>)?$/.test(_1b.innerHTML)){_1b.innerHTML="";if(_4.isWebKit){_f=_5.range.create(this.editor.window);_f.setStart(_1b,0);_d.removeAllRanges();_d.addRange(_f);}this._checkListLater=false;}return true;}if(!_1a.blockNode||_1a.blockNode===this.editor.editNode){try{_5._editor.RichText.prototype.execCommand.call(this.editor,"formatblock",this.blockNodeForEnter);}catch(e2){}_1a={blockNode:_4.withGlobal(this.editor.window,"getAncestorElement",_5._editor.selection,[this.blockNodeForEnter]),blockContainer:this.editor.editNode};if(_1a.blockNode){if(_1a.blockNode!=this.editor.editNode&&(!(_1a.blockNode.textContent||_1a.blockNode.innerHTML).replace(/^\s+|\s+$/g,"").length)){this.removeTrailingBr(_1a.blockNode);return false;}}else{_1a.blockNode=this.editor.editNode;}_d=_5.range.getSelection(this.editor.window);_e=_d.getRangeAt(0);}var _1c=doc.createElement(this.blockNodeForEnter);_1c.innerHTML=this.bogusHtmlContent;this.removeTrailingBr(_1a.blockNode);var _1d=_e.endOffset;var _1e=_e.endContainer;if(_1e.length<_1d){var ret=this._adjustNodeAndOffset(_1e,_1d);_1e=ret.node;_1d=ret.offset;}if(_5.range.atEndOfContainer(_1a.blockNode,_1e,_1d)){if(_1a.blockNode===_1a.blockContainer){_1a.blockNode.appendChild(_1c);}else{_4.place(_1c,_1a.blockNode,"after");}_19=false;_f=_5.range.create(this.editor.window);_f.setStart(_1c,0);_d.removeAllRanges();_d.addRange(_f);if(this.editor.height){_4.window.scrollIntoView(_1c);}}else{if(_5.range.atBeginningOfContainer(_1a.blockNode,_e.startContainer,_e.startOffset)){_4.place(_1c,_1a.blockNode,_1a.blockNode===_1a.blockContainer?"first":"before");if(_1c.nextSibling&&this.editor.height){_f=_5.range.create(this.editor.window);_f.setStart(_1c.nextSibling,0);_d.removeAllRanges();_d.addRange(_f);_4.window.scrollIntoView(_1c.nextSibling);}_19=false;}else{if(_1a.blockNode===_1a.blockContainer){_1a.blockNode.appendChild(_1c);}else{_4.place(_1c,_1a.blockNode,"after");}_19=false;if(_1a.blockNode.style){if(_1c.style){if(_1a.blockNode.style.cssText){_1c.style.cssText=_1a.blockNode.style.cssText;}}}rs=_e.startContainer;var _1f;if(rs&&rs.nodeType==3){var _20,_21;_1d=_e.endOffset;if(rs.length<_1d){ret=this._adjustNodeAndOffset(rs,_1d);rs=ret.node;_1d=ret.offset;}txt=rs.nodeValue;_10=doc.createTextNode(txt.substring(0,_1d));_11=doc.createTextNode(txt.substring(_1d,txt.length));_4.place(_10,rs,"before");_4.place(_11,rs,"after");_4.destroy(rs);var _22=_10.parentNode;while(_22!==_1a.blockNode){var tg=_22.tagName;var _23=doc.createElement(tg);if(_22.style){if(_23.style){if(_22.style.cssText){_23.style.cssText=_22.style.cssText;}}}if(_22.tagName==="FONT"){if(_22.color){_23.color=_22.color;}if(_22.face){_23.face=_22.face;}if(_22.size){_23.size=_22.size;}}_20=_11;while(_20){_21=_20.nextSibling;_23.appendChild(_20);_20=_21;}_4.place(_23,_22,"after");_10=_22;_11=_23;_22=_22.parentNode;}_20=_11;if(_20.nodeType==1||(_20.nodeType==3&&_20.nodeValue)){_1c.innerHTML="";}_1f=_20;while(_20){_21=_20.nextSibling;_1c.appendChild(_20);_20=_21;}}_f=_5.range.create(this.editor.window);var _24;var _25=_1f;if(this.blockNodeForEnter!=="BR"){while(_25){_24=_25;_21=_25.firstChild;_25=_21;}if(_24&&_24.parentNode){_1c=_24.parentNode;_f.setStart(_1c,0);_d.removeAllRanges();_d.addRange(_f);if(this.editor.height){_5.scrollIntoView(_1c);}if(_4.isMoz){this._pressedEnterInBlock=_1a.blockNode;}}else{_19=true;}}else{_f.setStart(_1c,0);_d.removeAllRanges();_d.addRange(_f);if(this.editor.height){_5.scrollIntoView(_1c);}if(_4.isMoz){this._pressedEnterInBlock=_1a.blockNode;}}}}return _19;},_adjustNodeAndOffset:function(_26,_27){while(_26.length<_27&&_26.nextSibling&&_26.nextSibling.nodeType==3){_27=_27-_26.length;_26=_26.nextSibling;}var ret={"node":_26,"offset":_27};return ret;},removeTrailingBr:function(_28){var _29=/P|DIV|LI/i.test(_28.tagName)?_28:_5._editor.selection.getParentOfType(_28,["P","DIV","LI"]);if(!_29){return;}if(_29.lastChild){if((_29.childNodes.length>1&&_29.lastChild.nodeType==3&&/^[\s\xAD]*$/.test(_29.lastChild.nodeValue))||_29.lastChild.tagName=="BR"){_4.destroy(_29.lastChild);}}if(!_29.childNodes.length){_29.innerHTML=this.bogusHtmlContent;}}});}}};});