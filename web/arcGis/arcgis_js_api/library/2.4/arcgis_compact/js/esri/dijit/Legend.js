/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */

if(!dojo._hasResource["esri.dijit.Legend"]){dojo._hasResource["esri.dijit.Legend"]=true;dojo.provide("esri.dijit.Legend");dojo.require("dijit._Widget");dojo.require("dojo.DeferredList");(function(){var _1=[dojo.moduleUrl("esri.dijit","css/Legend.css")];var _2=document.getElementsByTagName("head").item(0),_3;for(var i=0,il=_1.length;i<il;i++){_3=document.createElement("link");_3.type="text/css";_3.rel="stylesheet";_3.href=_1[i].toString();_2.appendChild(_3);}}());dojo.declare("esri.dijit.Legend",[dijit._Widget],{widgetsInTemplate:false,layers:null,alignRight:false,_ieTimer:100,constructor:function(_4,_5){dojo.mixin(this,esri.bundle.widgets.legend);_4=_4||{};if(!_4.map){console.error("esri.dijit.Legend: unable to find the 'map' property in parameters");return;}if(!_5){console.error("esri.dijit.Legend: must specify a container for the legend");return;}this.map=_4.map;this.layerInfos=_4.layerInfos;this._respectCurrentMapScale=(_4.respectCurrentMapScale===false)?false:true;this.arrangement=(_4.arrangement===esri.dijit.Legend.ALIGN_RIGHT)?esri.dijit.Legend.ALIGN_RIGHT:esri.dijit.Legend.ALIGN_LEFT;if(this.arrangement===esri.dijit.Legend.ALIGN_RIGHT){this.alignRight=true;}this._surfaceItems=[];},startup:function(){this.inherited(arguments);this._initialize();if(dojo.isIE){this._repaintItems=dojo.hitch(this,this._repaintItems);setTimeout(this._repaintItems,this._ieTimer);}},destroy:function(){this._deactivate();this.inherited(arguments);},refresh:function(_6){if(!this.domNode){return;}if(_6){this.layerInfos=_6;this.layers=[];dojo.forEach(this.layerInfos,function(_7){if(this._isSupportedLayerType(_7.layer)){if(_7.title){_7.layer._titleForLegend=_7.title;}this.layers.push(_7.layer);}},this);}else{if(this.useAllMapLayers){this.layerInfos=null;this.layers=null;}}for(var i=this.domNode.children.length-1;i>=0;i--){dojo.destroy(this.domNode.children[i]);}this.startup();},_legendUrl:"http://www.arcgis.com/sharing/tools/legend",_initialize:function(){if(this.layerInfos){this.layers=[];dojo.forEach(this.layerInfos,function(_8){if(this._isSupportedLayerType(_8.layer)){if(_8.title){_8.layer._titleForLegend=_8.title;}this.layers.push(_8.layer);}},this);}this.useAllMapLayers=false;if(!this.layers){this.useAllMapLayers=true;this.layers=[];dojo.forEach(this.map.layerIds,function(_9){var _a=this.map.getLayer(_9);if(this._isSupportedLayerType(_a)){this.layers.push(_a);}},this);dojo.forEach(this.map.graphicsLayerIds,function(_b){var _c=this.map.getLayer(_b);if(this._isSupportedLayerType(_c)){this.layers.push(_c);}},this);}this._createLegend();},_activate:function(){this._deactivate();if(this._respectCurrentMapScale){this._ozeConnect=dojo.connect(this.map,"onZoomEnd",this,"_refreshLayers");}if(this.useAllMapLayers){this._olaConnect=dojo.connect(this.map,"onLayerAdd",this,"_updateAllMapLayers");this._olrConnect=dojo.connect(this.map,"onLayerRemove",this,"_updateAllMapLayers");this._olroConnect=dojo.connect(this.map,"onLayersReordered",this,"_updateAllMapLayers");}dojo.forEach(this.layers,function(_d){_d.ovcConnect=dojo.connect(_d,"onVisibilityChange",this,"_refreshLayers");},this);},_deactivate:function(){if(this._ozeConnect){dojo.disconnect(this._ozeConnect);}if(this._olaConnect){dojo.disconnect(this._olaConnect);}if(this._olroConnect){dojo.disconnect(this._olroConnect);}if(this._olrConnect){dojo.disconnect(this._olrConnect);}dojo.forEach(this.layers,function(_e){if(_e.ovcConnect){dojo.disconnect(_e.ovcConnect);}},this);},_refreshLayers:function(){this.refresh();},_updateAllMapLayers:function(){this.layers=[];dojo.forEach(this.map.layerIds,function(_f){var _10=this.map.getLayer(_f);if(this._isSupportedLayerType(_10)){this.layers.push(_10);}},this);dojo.forEach(this.map.graphicsLayerIds,function(_11){var _12=this.map.getLayer(_11);if(this._isSupportedLayerType(_12)){this.layers.push(_12);}},this);this.refresh();},_createLegend:function(){dojo.style(this.domNode,"position","relative");dojo.create("div",{id:this.id+"_msg",innerHTML:this.NLS_creatingLegend+"..."},this.domNode);var _13=[];dojo.forEach(this.layers,function(_14){if(_14.declaredClass=="esri.layers.KMLLayer"){dojo.forEach(_14.getLayers(),function(_15){if(_15.declaredClass=="esri.layers.FeatureLayer"){_15._titleForLegend=_14._titleForLegend+" - ";if(_15.geometryType=="esriGeometryPoint"){_15._titleForLegend+="Points";}else{if(_15.geometryType=="esriGeometryPolyline"){_15._titleForLegend+="Lines";}else{if(_15.geometryType=="esriGeometryPolygon"){_15._titleForLegend+="Polygons";}}}_13.push(_15);}});}else{_13.push(_14);}},this);var _16=[];dojo.forEach(_13,function(_17){if(_17.visible===true&&(_17.layerInfos||_17.renderer)){var d=dojo.create("div",{id:this.id+"_"+_17.id,style:"display: none;","class":"esriLegendService"});dojo.create("span",{innerHTML:this._getServiceTitle(_17),"class":"esriLegendServiceLabel"},dojo.create("td",{align:(this.alignRight?"right":"")},dojo.create("tr",{},dojo.create("tbody",{},dojo.create("table",{width:"95%"},d)))));dojo.place(d,this.id,"first");if(dojo.isIE){dojo.style(dojo.byId(this.id+"_"+_17.id),"display","none");}if(_17.legendResponse||_17.renderer){this._createLegendForLayer(_17);}else{_16.push(this._legendRequest(_17));}}},this);if(_16.length===0){dojo.byId(this.id+"_msg").innerHTML=this.NLS_noLegend;this._activate();}else{var _18=new dojo.DeferredList(_16);_18.addCallback(dojo.hitch(this,function(_19){dojo.byId(this.id+"_msg").innerHTML=this.NLS_noLegend;this._activate();}));}},_createLegendForLayer:function(_1a){if(_1a.legendResponse||_1a.renderer){var _1b=false;if(_1a.legendResponse){dojo.forEach(_1a.layerInfos,function(_1c,i){var f=this._buildLegendItems(_1a,_1c,i);_1b=_1b||f;},this);}else{if(_1a.renderer){var id;if(!_1a.url){id="fc_"+_1a.id;}else{id=_1a.url.substring(_1a.url.lastIndexOf("/")+1,_1a.url.length);}var _1d={id:id,name:null,subLayerIds:null,parentLayerId:-1};_1b=this._buildLegendItems(_1a,_1d,0);}}if(_1b){dojo.style(dojo.byId(this.id+"_"+_1a.id),"display","block");dojo.style(dojo.byId(this.id+"_msg"),"display","none");}}},_legendRequest:function(_1e){if(_1e.version>=10.01){return this._legendRequestServer(_1e);}else{return this._legendRequestTools(_1e);}},_legendRequestServer:function(_1f){var url=_1f.url+"/legend";var _20=dojo.hitch(this,"_processLegendResponse");var _21={};_21.f="json";var _22=esri.request({url:url,content:_21,callbackParamName:"callback",load:function(_23,_24){_20(_1f,_23,_24);},error:esriConfig.defaults.io.errorHandler});return _22;},_legendRequestTools:function(_25){var p=_25.url.toLowerCase().indexOf("/rest/");var _26=_25.url.substring(0,p)+_25.url.substring(p+5,_25.url.length);var url=this._legendUrl+"?soapUrl="+escape(_26);if(!dojo.isIE){url+="&returnbytes=true";}var uri=url+(dojo.isIE?("&"+(new Date()).getTime()+"="+(new Date()).getTime()):"");var _27=dojo.hitch(this,"_processLegendResponse");var _28={};_28.f="json";var _29=esri.request({url:uri,content:_28,callbackParamName:"callback",load:function(_2a,_2b){_27(_25,_2a,_2b);},error:esriConfig.defaults.io.errorHandler});return _29;},_processLegendResponse:function(_2c,_2d){if(_2d&&_2d.layers){_2c.legendResponse=_2d;this._createLegendForLayer(_2c);}else{console.log("Legend could not get generated for "+_2c.url+": "+dojo.toJson(_2d));}},_buildLegendItems:function(_2e,_2f,pos){var _30=false;var _31=dojo.byId(this.id+"_"+_2e.id);var _32=_2f.subLayerIds;var _33=_2f.parentLayerId;if(_32){var _34=dojo.create("div",{id:this.id+"_"+_2e.id+"_"+_2f.id+"_group",style:"display: none;","class":(_33==-1)?((pos>0)?"esriLegendGroupLayer":""):(this.alignRight?"esriLegendRight":"esriLegendLeft")},(_33==-1)?_31:dojo.byId(this.id+"_"+_2e.id+"_"+_33+"_group"));if(dojo.isIE){dojo.style(dojo.byId(this.id+"_"+_2e.id+"_"+_2f.id+"_group"),"display","none");}dojo.create("td",{innerHTML:_2f.name.replace(/[\<]/g,"&lt;").replace(/[\>]/g,"&gt;"),align:(this.alignRight?"right":"")},dojo.create("tr",{},dojo.create("tbody",{},dojo.create("table",{width:"95%","class":"esriLegendLayerLabel"},_34))));}else{if(_2e.visibleLayers&&(","+_2e.visibleLayers+",").indexOf(","+_2f.id+",")==-1){return _30;}var d=dojo.create("div",{id:this.id+"_"+_2e.id+"_"+_2f.id,style:"display:none;","class":(_33>-1)?(this.alignRight?"esriLegendRight":"esriLegendLeft"):""},(_33==-1)?_31:dojo.byId(this.id+"_"+_2e.id+"_"+_33+"_group"));if(dojo.isIE){dojo.style(dojo.byId(this.id+"_"+_2e.id+"_"+_2f.id),"display","none");}if(_2f.name&&_2f.name.length>0){dojo.create("td",{innerHTML:(_2f.name)?_2f.name.replace(/[\<]/g,"&lt;").replace(/[\>]/g,"&gt;"):"",align:(this.alignRight?"right":"")},dojo.create("tr",{},dojo.create("tbody",{},dojo.create("table",{width:"95%","class":"esriLegendLayerLabel"},d))));}if(_2e.legendResponse){_30=_30||this._buildLegendItems_Tools(_2e,_2f,d);}else{if(_2e.renderer){_30=_30||this._buildLegendItems_Renderer(_2e,_2f,d);}}}return _30;},_buildLegendItems_Tools:function(_35,_36,_37){var _38=_36.parentLayerId;var _39=esri.geometry.getScale(this.map);var _3a=false;if(!this._respectCurrentMapScale||(this._respectCurrentMapScale&&this._isLayerInScale(_35,_36,_39))){for(var i=0;i<_35.legendResponse.layers.length;i++){if(_36.id==_35.legendResponse.layers[i].layerId){var _3b=_35.legendResponse.layers[i].legend;if(_3b.length==3&&_3b[0].label.replace(/\s+/g,"").indexOf(":Band_")>-1){}else{var _3c=dojo.create("tbody",{},dojo.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},_37));dojo.forEach(_3b,function(_3d){if((_3d.url&&_3d.url.indexOf("http://")>-1)||(_3d.imageData&&_3d.imageData.length>0)){_3a=true;this._buildRow_Tools(_3d,_3c,_35,_36.id);}},this);}break;}}}if(_3a){dojo.style(dojo.byId(this.id+"_"+_35.id+"_"+_36.id),"display","block");if(_38>-1){dojo.style(dojo.byId(this.id+"_"+_35.id+"_"+_38+"_group"),"display","block");this._findParentGroup(_35.id,_35,_38);}}return _3a;},_buildRow_Tools:function(_3e,_3f,_40,_41){var tr=dojo.create("tr",{},_3f);var _42;var _43;if(this.alignRight){_42=dojo.create("td",{align:"right"},tr);_43=dojo.create("td",{align:"right",width:35},tr);}else{_43=dojo.create("td",{width:35},tr);_42=dojo.create("td",{},tr);}var src=_3e.url;if(!dojo.isIE&&_3e.imageData&&_3e.imageData.length>0){src="data:image/png;base64,"+_3e.imageData;}else{if(_3e.url.indexOf("http://")==-1){src=_40.url+"/"+_41+"/images/"+_3e.url;}}dojo.create("img",{src:src,border:0},_43);dojo.create("td",{innerHTML:_3e.label.replace(/[\<]/g,"&lt;").replace(/[\>]/g,"&gt;"),align:(this.alignRight?"right":"")},dojo.create("tr",{},dojo.create("tbody",{},dojo.create("table",{width:"95%"},_42))));},_buildLegendItems_Renderer:function(_44,_45,_46){var _47=_45.parentLayerId;var _48=esri.geometry.getScale(this.map);var _49=false;if(!this._respectCurrentMapScale||this._isLayerInScale(_44,_45,_48)){var _4a;if(_44.renderer instanceof esri.renderer.UniqueValueRenderer){if(_44.renderer.infos&&_44.renderer.infos.length>0){_49=true;_4a=dojo.create("tbody",{},dojo.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},_46));dojo.forEach(_44.renderer.infos,function(_4b,_4c){var _4d=null;if(_44._editable&&_44.types){_4d=this._getTemplateFromTypes(_44.types,_4b.value);}var _4e=_4b.label;if(!_4e||_4e.length===0){_4e=_4b.value;}this._buildRow_Renderer(_4b.symbol,_4e,_4d,_4a);},this);}}if(_44.renderer instanceof esri.renderer.ClassBreaksRenderer){if(_44.renderer.infos&&_44.renderer.infos.length>0){_49=true;_4a=dojo.create("tbody",{},dojo.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},_46));dojo.forEach(_44.renderer.infos,function(_4f,_50){var _51=_4f.label;if(!_51||_51.length===0){_51=_4f.minValue+" - "+_4f.maxValue;}this._buildRow_Renderer(_4f.symbol,_51,null,_4a);},this);}}if(_44.renderer instanceof esri.renderer.SimpleRenderer){_49=true;_4a=dojo.create("tbody",{},dojo.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},_46));var _52=null;if(_44._editable&&_44.templates&&_44.templates.length>0){_52=_44.templates[0];}this._buildRow_Renderer(_44.renderer.symbol,_44.renderer.label,_52,_4a);}if(_44.renderer.defaultSymbol){_49=true;_4a=dojo.create("tbody",{},dojo.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},_46));this._buildRow_Renderer(_44.renderer.defaultSymbol,"others",null,_4a);}}if(_49){dojo.style(dojo.byId(this.id+"_"+_44.id+"_"+_45.id),"display","block");if(_47>-1){dojo.style(dojo.byId(this.id+"_"+_44.id+"_"+_47+"_group"),"display","block");this._findParentGroup(_44.id,_47);}}return _49;},_buildRow_Renderer:function(_53,_54,_55,_56){var tr=dojo.create("tr",{},_56);var _57;var _58;if(this.alignRight){_57=dojo.create("td",{align:"right"},tr);_58=dojo.create("td",{align:"right",width:35},tr);}else{_58=dojo.create("td",{width:35},tr);_57=dojo.create("td",{},tr);}var _59=30;if(_53.type=="simplemarkersymbol"){_59=Math.min(Math.max(_59,_53.size+12),125);}else{if(_53.type=="picturemarkersymbol"){_59=Math.min(Math.max(_59,_53.width),125);}}var div=dojo.create("div",{style:"width:"+_59+"px;height:"+_59+"px;"},_58);dojo.create("td",{innerHTML:_54?_54.replace(/[\<]/g,"&lt;").replace(/[\>]/g,"&gt;").replace(/^#/,""):"",align:(this.alignRight?"right":"")},dojo.create("tr",{},dojo.create("tbody",{},dojo.create("table",{width:"95%"},_57))));var _5a=this._drawSymbol(div,_53,_59,_59,_55);this._surfaceItems.push(_5a);},_drawSymbol:function(_5b,_5c,_5d,_5e,_5f){var _60=dojox.gfx.createSurface(_5b,_5d,_5e);if(dojo.isIE){var _61=_60.getEventSource();dojo.style(_61,"position","relative");dojo.style(_61.parentNode,"position","relative");}var _62=this._getDrawingToolShape(_5c,_5f)||esri.symbol.getShapeDescriptors(_5c);var _63;try{_63=_60.createShape(_62.defaultShape).setFill(_62.fill).setStroke(_62.stroke);}catch(e){_60.clear();_60.destroy();return;}var dim=_60.getDimensions();var _64={dx:dim.width/2,dy:dim.height/2};var _65=_63.getBoundingBox(),_66=_65.width,_67=_65.height;if(_66>_5d||_67>_5e){var _68=_66>_67?_66:_67;var _69=_5d<_5e?_5d:_5e;var _6a=(_69-5)/_68;dojo.mixin(_64,{xx:_6a,yy:_6a});}_63.applyTransform(_64);return _60;},_getDrawingToolShape:function(_6b,_6c){var _6d,_6e=_6c?_6c.drawingTool||null:null;switch(_6e){case "esriFeatureEditToolArrow":_6d={type:"path",path:"M 10,1 L 3,8 L 3,5 L -15,5 L -15,-2 L 3,-2 L 3,-5 L 10,1 E"};break;case "esriFeatureEditToolTriangle":_6d={type:"path",path:"M -10,14 L 2,-10 L 14,14 L -10,14 E"};break;case "esriFeatureEditToolRectangle":_6d={type:"path",path:"M -10,-10 L 10,-10 L 10,10 L -10,10 L -10,-10 E"};break;case "esriFeatureEditToolCircle":_6d={type:"circle",cx:0,cy:0,r:10};break;case "esriFeatureEditToolEllipse":_6d={type:"ellipse",cx:0,cy:0,rx:10,ry:5};break;default:return null;}return {defaultShape:_6d,fill:_6b.getFill(),stroke:_6b.getStroke()};},_repaintItems:function(){dojo.forEach(this._surfaceItems,function(_6f){this._repaint(_6f);},this);},_repaint:function(_70){if(!_70){return;}if(_70.getStroke&&_70.setStroke){_70.setStroke(_70.getStroke());}if(_70.getFill&&_70.setFill){_70.setFill(_70.getFill());}if(_70.children&&dojo.isArray(_70.children)){dojo.forEach(_70.children,this._repaint,this);}},_getTemplateFromTypes:function(_71,_72){for(var i=0;i<_71.length;i++){if(_71[i].id==_72&&_71[i].templates&&_71[i].templates.length>0){return _71[i].templates[0];}}return null;},_findParentGroup:function(_73,_74,_75){var _76=_74.layerInfos;for(var k=0;k<_76.length;k++){if(_75==_76[k].id){if(_76[k].parentLayerId>-1){dojo.style(dojo.byId(this.id+"_"+_73+"_"+_76[k].parentLayerId+"_group"),"display","block");this._findParentGroup(_73,_74,_76[k].parentLayerId);}break;}}},_isLayerInScale:function(_77,_78,_79){var _7a=true;if(_77.legendResponse&&_77.legendResponse.layers){for(var i=0;i<_77.legendResponse.layers.length;i++){var _7b=_77.legendResponse.layers[i];if(_78.id==_7b.layerId){if(_7b.minScale==0&&_77.tileInfo){_7b.minScale=_77.tileInfo.lods[0].scale+1;}if(_7b.maxScale==0&&_77.tileInfo){_7b.maxScale=_77.tileInfo.lods[_77.tileInfo.lods.length-1].scale-1;}if((_7b.minScale>0&&_7b.minScale<_79)||_7b.maxScale>_79){_7a=false;}break;}}}else{if(_77.minScale||_77.maxScale){if((_77.minScale&&_77.minScale<_79)||_77.maxScale&&_77.maxScale>_79){_7a=false;}}}return _7a;},_getServiceTitle:function(_7c){var _7d=_7c._titleForLegend;if(!_7d){_7d=_7c.url;if(!_7c.url){_7d="";}else{if(_7c.url.indexOf("/MapServer")>-1){_7d=_7c.url.substring(0,_7c.url.indexOf("/MapServer"));_7d=_7d.substring(_7d.lastIndexOf("/")+1,_7d.length);}else{if(_7c.url.indexOf("/ImageServer")>-1){_7d=_7c.url.substring(0,_7c.url.indexOf("/ImageServer"));_7d=_7d.substring(_7d.lastIndexOf("/")+1,_7d.length);}else{if(_7c.url.indexOf("/FeatureServer")>-1){_7d=_7c.url.substring(0,_7c.url.indexOf("/FeatureServer"));_7d=_7d.substring(_7d.lastIndexOf("/")+1,_7d.length);}}}}if(_7c.name){if(_7d.length>0){_7d+=" - "+_7c.name;}else{_7d=_7c.name;}}}return _7d;},_isSupportedLayerType:function(_7e){if(_7e&&(_7e.declaredClass==="esri.layers.ArcGISDynamicMapServiceLayer"||_7e.declaredClass==="esri.layers.ArcGISTiledMapServiceLayer"||_7e.declaredClass==="esri.layers.FeatureLayer"||_7e.declaredClass=="esri.layers.KMLLayer")){return true;}return false;}});dojo.mixin(esri.dijit.Legend,{ALIGN_LEFT:0,ALIGN_RIGHT:1});}