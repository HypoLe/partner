/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */

if(!dojo._hasResource["esri.tasks.query"]){dojo._hasResource["esri.tasks.query"]=true;dojo.provide("esri.tasks.query");dojo.require("esri.tasks._task");dojo.require("esri._time");dojo.declare("esri.tasks.QueryTask",esri.tasks._Task,{constructor:function(_1){this._handler=dojo.hitch(this,this._handler);this._relationshipQueryHandler=dojo.hitch(this,this._relationshipQueryHandler);this._executeForIdsHandler=dojo.hitch(this,this._executeForIdsHandler);this._countHandler=dojo.hitch(this,this._countHandler);},__msigns:[{n:"execute",c:4,a:[{i:0,p:["geometry"]}],e:2},{n:"executeForIds",c:3,a:[{i:0,p:["geometry"]}],e:2},{n:"executeForCount",c:3,a:[{i:0,p:["geometry"]}],e:2}],onComplete:function(){},onExecuteRelationshipQueryComplete:function(){},onExecuteForIdsComplete:function(){},onExecuteForCountComplete:function(){},execute:function(_2,_3,_4,_5,_6){var _7=_6.assembly,_8=this._encode(dojo.mixin({},this._url.query,{f:"json"},_2.toJson(_7&&_7[0]))),_9=this._handler,_a=this._errorHandler;return esri.request({url:this._url.path+"/query",content:_8,callbackParamName:"callback",load:function(r,i){_9(r,i,_3,_4,_6.dfd);},error:function(r){_a(r,_4,_6.dfd);},callbackSuffix:_5});},executeRelationshipQuery:function(_b,_c,_d){var _e=this._encode(dojo.mixin({},this._url.query,{f:"json"},_b.toJson())),_f=this._relationshipQueryHandler,_10=this._errorHandler;var dfd=new dojo.Deferred(esri._dfdCanceller);dfd._pendingDfd=esri.request({url:this._url.path+"/queryRelatedRecords",content:_e,callbackParamName:"callback",load:function(r,i){_f(r,i,_c,_d,dfd);},error:function(r){_10(r,_d,dfd);}});return dfd;},executeForIds:function(_11,_12,_13,_14){var _15=_14.assembly,_16=this._encode(dojo.mixin({},this._url.query,{f:"json",returnIdsOnly:true},_11.toJson(_15&&_15[0]))),_17=this._executeForIdsHandler,_18=this._errorHandler;return esri.request({url:this._url.path+"/query",content:_16,callbackParamName:"callback",load:function(r,i){_17(r,i,_12,_13,_14.dfd);},error:function(r){_18(r,_13,_14.dfd);}});},executeForCount:function(_19,_1a,_1b,_1c){var _1d=_1c.assembly,_1e=this._encode(dojo.mixin({},this._url.query,{f:"json",returnIdsOnly:true,returnCountOnly:true},_19.toJson(_1d&&_1d[0]))),_1f=this._countHandler,_20=this._errorHandler;return esri.request({url:this._url.path+"/query",content:_1e,callbackParamName:"callback",load:function(r,i){_1f(r,i,_1a,_1b,_1c.dfd);},error:function(r){_20(r,_1b,_1c.dfd);}});},_handler:function(_21,io,_22,_23,dfd){try{var _24=new esri.tasks.FeatureSet(_21);this._successHandler([_24],"onComplete",_22,dfd);}catch(err){this._errorHandler(err,_23,dfd);}},_relationshipQueryHandler:function(_25,io,_26,_27,dfd){try{var gt=_25.geometryType,sr=_25.spatialReference,_28={};dojo.forEach(_25.relatedRecordGroups,function(gr){var _29={};_29.geometryType=gt;_29.spatialReference=sr;_29.features=gr.relatedRecords;var _2a=new esri.tasks.FeatureSet(_29);_28[gr.objectId]=_2a;});this._successHandler([_28],"onExecuteRelationshipQueryComplete",_26,dfd);}catch(err){this._errorHandler(err,_27,dfd);}},_executeForIdsHandler:function(_2b,io,_2c,_2d,dfd){try{this._successHandler([_2b.objectIds],"onExecuteForIdsComplete",_2c,dfd);}catch(err){this._errorHandler(err,_2d,dfd);}},_countHandler:function(_2e,io,_2f,_30,dfd){try{var _31,_32=_2e.features,ids=_2e.objectIds;if(ids){_31=ids.length;}else{if(_32){throw new Error(esri.bundle.tasks.query.invalid);}else{_31=_2e.count;}}this._successHandler([_31],"onExecuteForCountComplete",_2f,dfd);}catch(err){this._errorHandler(err,_30,dfd);}}});esri._createWrappers("esri.tasks.QueryTask");dojo.declare("esri.tasks.Query",null,{constructor:function(){this.spatialRelationship=esri.tasks.Query.SPATIAL_REL_INTERSECTS;},text:null,where:"",geometry:null,objectIds:null,returnGeometry:false,outSpatialReference:null,outFields:null,timeExtent:null,relationParam:null,toJson:function(_33){var _34={text:this.text,where:this.where,returnGeometry:this.returnGeometry,spatialRel:this.spatialRelationship,maxAllowableOffset:this.maxAllowableOffset},g=_33&&_33["geometry"]||this.geometry,ids=this.objectIds,_35=this.outFields,_36=this.outSpatialReference;if(g){_34.geometry=g;_34.geometryType=esri.geometry.getJsonType(g);_34.inSR=g.spatialReference.wkid||dojo.toJson(g.spatialReference.toJson());}if(ids){_34.objectIds=ids.join(",");}if(_35){_34.outFields=_35.join(",");}if(_36!==null){_34.outSR=_36.wkid||dojo.toJson(_36.toJson());}else{if(g){_34.outSR=g.spatialReference.wkid||dojo.toJson(g.spatialReference.toJson());}}var _37=this.timeExtent;_34.time=_37?_37.toJson().join(","):null;var _38=this.relationParam;if(_38&&this.spatialRelationship===esri.tasks.Query.SPATIAL_REL_RELATION){_34.relationParam=_38;}_34._ts=this._ts;return _34;}});dojo.mixin(esri.tasks.Query,esri.tasks._SpatialRelationship);dojo.declare("esri.tasks.RelationshipQuery",null,{definitionExpression:"",relationshipId:null,returnGeometry:false,objectIds:null,outSpatialReference:null,outFields:null,toJson:function(){var _39={definitionExpression:this.definitionExpression,relationshipId:this.relationshipId,returnGeometry:this.returnGeometry,maxAllowableOffset:this.maxAllowableOffset},_3a=this.objectIds,_3b=this.outFields,_3c=this.outSpatialReference;if(_3a){_39.objectIds=_3a.join(",");}if(_3b){_39.outFields=_3b.join(",");}if(_3c){_39.outSR=_3c.toJson();}_39._ts=this._ts;return _39;}});}