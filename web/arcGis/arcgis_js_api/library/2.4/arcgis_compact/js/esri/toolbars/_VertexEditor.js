/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */

if(!dojo._hasResource["esri.toolbars._VertexEditor"]){dojo._hasResource["esri.toolbars._VertexEditor"]=true;dojo.provide("esri.toolbars._VertexEditor");dojo.require("dijit.Menu");dojo.require("esri.toolbars._VertexMover");dojo.declare("esri.toolbars._GraphicVertexEditor",null,{constructor:function(_1,_2,_3){this.graphic=_1;this.map=_2;this.toolbar=_3;var _4=_3._options;this._symbol1=_4.vertexSymbol;this._symbol2=_4.ghostVertexSymbol;var _5=_4.ghostLineSymbol;this._lineStroke={style:_5.style,width:_5.width,color:_5.color};this._canDel=_4.allowDeleteVertices;this._canAdd=_4.allowAddVertices;this._addControllers();},destroy:function(){this._removeControllers();},refresh:function(_6){if(_6){this._removeControllers();this._addControllers();}else{this._refresh(this._vertexMovers);this._refresh(this._mpVertexMovers);}},suspend:function(){if(!this._suspended){this._removeControllers();}this._suspended=true;},resume:function(){if(this._suspended){this._addControllers();}this._suspended=false;},_addControllers:function(){this._firstMoveHandle=dojo.connect(esri.toolbars.VertexMover,"onFirstMove",this,this._firstMoveHandler);this._moveStopHandle=dojo.connect(esri.toolbars.VertexMover,"onMoveStop",this,this._moveStopHandler);this._vertexMovers=this._add(this._getSegments(this.graphic.geometry),this._symbol1);if(this._canAdd){this._mpVertexMovers=this._add(this._getMidpointSegments(this.graphic.geometry),this._symbol2,true);}var _7=this._getGraphicsLayer();this._mouseOverHandle=dojo.connect(_7,"onMouseOver",this,this._mouseOverHandler);this._mouseOutHandle=dojo.connect(_7,"onMouseOut",this,this._mouseOutHandler);if(this._canDel){this._ctxMenu=new dijit.Menu({style:"font-size: 12px; margin-left: 5px; margin-top: 5px;"});var _8=(this._ctxDelete=new dijit.MenuItem({label:esri.bundle.toolbars.edit.deleteLabel,iconClass:"vertexDeleteIcon",style:"outline: none;"}));this._deleteHandle=dojo.connect(_8,"onClick",this,this._deleteHandler);this._ctxMenu.addChild(_8);this._ctxMenu.startup();}},_removeControllers:function(){dojo.disconnect(this._firstMoveHandle);dojo.disconnect(this._moveStopHandle);dojo.disconnect(this._mouseOverHandle);dojo.disconnect(this._mouseOutHandle);dojo.disconnect(this._deleteHandle);if(this._ctxMenu){this._ctxDelete=null;this._unbindCtxNode();this._ctxMenu.destroyRecursive();}this._remove(this._vertexMovers);this._remove(this._mpVertexMovers);this._vertexMovers=this._mpVertexMovers=null;},_add:function(_9,_a,_b){var _c=this.graphic,_d=[];for(var i=0;i<_9.length;i++){var _e=_9[i],_f=[];for(var j=0;j<_e.length;j++){_f.push(new esri.toolbars.VertexMover(_e[j],_a,_c,i,j,_e.length,this,_b));}_d.push(_f);}return _d;},_remove:function(_10){if(_10){dojo.forEach(_10,function(_11){dojo.forEach(_11,function(_12){_12.destroy();});});}},_refresh:function(_13){if(_13){dojo.forEach(_13,function(_14){dojo.forEach(_14,function(_15){_15.refresh();});});}},_isNew:function(_16){return (dojo.indexOf(this._vertexMovers[_16.segIndex],_16)===-1)?true:false;},_getGraphicsLayer:function(){return this.toolbar._scratchGL;},_deleteHandler:function(evt){var _17=this._selectedMover,_18=_17.ptIndex;this._updateRelatedGraphic(_17,_17.relatedGraphic,_17.graphic.geometry,_17.segIndex,_17.ptIndex,_17.segLength,false,true);if(this._canAdd){this._deleteMidpoints(_17);}this._deleteVertex(_17);this.toolbar._endOperation("VERTICES");},_mouseOverHandler:function(evt){var _19=evt.graphic,_1a=this._findMover(_19);if(_1a){this.toolbar.onVertexMouseOver(this.graphic,_1a._getInfo());if(!_1a._placeholder){this._selectedMover=_1a;if(this._canDel){this._bindCtxNode(_19.getDojoShape().getNode());}}}},_mouseOutHandler:function(evt){var _1b=evt.graphic,_1c=this._findMover(_1b);if(_1c){this.toolbar.onVertexMouseOut(this.graphic,_1c._getInfo());}},_bindCtxNode:function(_1d){this._unbindCtxNode();this._ctxDelete.set("disabled",(this._selectedMover.segLength<=this.minLength)?true:false);this._ctxMenu.bindDomNode(_1d);this._bindNode=_1d;},_unbindCtxNode:function(){var _1e=this._bindNode;if(_1e){this._ctxMenu.unBindDomNode(_1e);}},_findMover:function(_1f){var _20=[],_21=this._mpVertexMovers;dojo.forEach(this._vertexMovers,function(_22){_20=_20.concat(_22);});if(_21){dojo.forEach(_21,function(_23){_20=_20.concat(_23);});}for(var i=0;i<_20.length;i++){var _24=_20[i];if(_24.graphic===_1f){return _24;}}},_firstMoveHandler:function(_25){if(!this._isNew(_25)&&this._canAdd){this._hideRelatedMidpoints(_25);}this.toolbar._beginOperation("VERTICES");},_moveStopHandler:function(_26,tx){var add=this._isNew(_26);if(!tx||!tx.dx&&!tx.dy){if(!add&&this._canAdd){this._showRelatedMidpoints(_26);}return;}this._updateRelatedGraphic(_26,_26.relatedGraphic,_26.graphic.geometry,_26.segIndex,_26.ptIndex,_26.segLength,add);if(this._canAdd){if(add){this._addMidpoints(_26);}else{this._repositionRelatedMidpoints(_26);this._showRelatedMidpoints(_26);}}this.toolbar._endOperation("VERTICES");},_showRelatedMidpoints:function(_27){var _28=this._getAdjacentMidpoints(_27.ptIndex,_27.segLength),_29=this._mpVertexMovers[_27.segIndex];for(var i=0;i<_28.length;i++){var mvr=_29[_28[i]];mvr.graphic.show();mvr.refresh();}},_hideRelatedMidpoints:function(_2a){var _2b=this._getAdjacentMidpoints(_2a.ptIndex,_2a.segLength),_2c=this._mpVertexMovers[_2a.segIndex];for(var i=0;i<_2b.length;i++){_2c[_2b[i]].graphic.hide();}},_repositionRelatedMidpoints:function(_2d){var _2e=this._getAdjacentMidpoints(_2d.ptIndex,_2d.segLength),_2f=this._mpVertexMovers[_2d.segIndex];for(var i=0;i<_2e.length;i++){var _30=this._getAdjacentVertices(_2e[i],_2d.segLength);var _31=_2d.relatedGraphic.geometry.getPoint(_2d.segIndex,_30[0]),_32=_2d.relatedGraphic.geometry.getPoint(_2d.segIndex,_30[1]);var _33=new esri.geometry.Point({x:(_31.x+_32.x)/2,y:(_31.y+_32.y)/2,spatialReference:_31.spatialReference.toJson()});_2f[_2e[i]].graphic.setGeometry(_33);}},_addMidpoints:function(_34){var _35=_34.segIndex,_36=_34.ptIndex,_37=_34.segLength;var _38=_36+1;var _39=_37+1;this._mpVertexMovers[_35].splice(_36,1);var _3a=this._vertexMovers[_35];for(var i=0;i<_38;i++){_3a[i].segLength+=1;}for(var i=_38;i<_3a.length;i++){_3a[i].ptIndex+=1;_3a[i].segLength+=1;}_34.ptIndex=_38;_34.segLength=_3a.length+1;_3a.splice(_38,0,_34);_34.graphic.setSymbol(this._symbol1);_3a=this._mpVertexMovers[_35];for(var i=0;i<_36;i++){_3a[i].segLength+=1;}for(var i=_36;i<_37-1;i++){_3a[i].ptIndex+=1;_3a[i].segLength+=1;}var _3b=this._getAdjacentVertices(_36,_39);var _3c=this._getAdjacentVertices(_36+1,_39);var _3d,_3e;_3d=_34.relatedGraphic.geometry.getPoint(_34.segIndex,_3b[0]);_3e=_34.relatedGraphic.geometry.getPoint(_34.segIndex,_3b[1]);var _3f=new esri.geometry.Point({x:(_3d.x+_3e.x)/2,y:(_3d.y+_3e.y)/2,spatialReference:_3d.spatialReference.toJson()});_3d=_34.relatedGraphic.geometry.getPoint(_34.segIndex,_3c[0]);_3e=_34.relatedGraphic.geometry.getPoint(_34.segIndex,_3c[1]);var _40=new esri.geometry.Point({x:(_3d.x+_3e.x)/2,y:(_3d.y+_3e.y)/2,spatialReference:_3d.spatialReference.toJson()});var _41=new esri.toolbars.VertexMover(_3f,this._symbol2,this.graphic,_34.segIndex,_36,_39,this,true);var _42=new esri.toolbars.VertexMover(_40,this._symbol2,this.graphic,_34.segIndex,_36+1,_39,this,true);_3a.splice(_36,0,_41,_42);},_deleteVertex:function(_43){var _44=_43.segIndex,_45=_43.ptIndex;var _46=this._vertexMovers[_44];for(var i=0;i<_45;i++){_46[i].segLength-=1;}for(i=_45+1;i<_46.length;i++){var mvr=_46[i];mvr.ptIndex-=1;mvr.segLength-=1;}_46.splice(_45,1);var _47=_43._getInfo();_43.destroy();this.toolbar.onVertexDelete(this.graphic,_47);}});dojo.mixin(esri.toolbars._GraphicVertexEditor,{create:function(_48,map,_49){var _4a=_48.geometry.type;switch(_4a){case "multipoint":return new esri.toolbars._MultipointVertexEditor(_48,map,_49);break;case "polyline":return new esri.toolbars._PolylineVertexEditor(_48,map,_49);break;case "polygon":return new esri.toolbars._PolygonVertexEditor(_48,map,_49);break;}}});dojo.declare("esri.toolbars._MultipointVertexEditor",esri.toolbars._GraphicVertexEditor,{minLength:1,constructor:function(){this._moveStartHandle=dojo.connect(esri.toolbars.VertexMover,"onMoveStart",this,this._moveStartHandler);dojo.disconnect(this._firstMoveHandle);},destroy:function(){this.inherited(arguments);dojo.disconnect(this._moveStartHandle);},_getSegments:function(_4b){var _4c=_4b.points,_4d=[],sr=_4b.spatialReference;for(var i=0;i<_4c.length;i++){var _4e=_4c[i];_4d.push(new esri.geometry.Point({x:_4e[0],y:_4e[1],spatialReference:sr.toJson()}));}return [_4d];},_getMidpointSegments:function(_4f){return [];},_getControlPoints:function(_50,_51,_52,_53,_54){return [];},_getGraphicsLayer:function(){return this.graphic._graphicsLayer;},_mouseOverHandler:function(evt){var _55=evt.graphic,_56=this._findMover(evt);if(_56){this.toolbar.onVertexMouseOver(_55,_56._getInfo());this._selectedMover=_56;if(this._canDel){this._bindCtxNode(_56.graphic.getDojoShape().getNode());}}},_mouseOutHandler:function(evt){var _57=evt.graphic,_58=this._findMover(evt);if(_58){this.toolbar.onVertexMouseOut(_57,_58._getInfo());}},_findMover:function(evt){var _59=[].concat(this._vertexMovers[0]),_5a=evt.target;for(var i=0;i<_59.length;i++){var _5b=_59[i];if(_5b.graphic.getDojoShape().getNode()===_5a){return _5b;}}},_moveStartHandler:function(_5c){var _5d=_5c.relatedGraphic.geometry,_5e=_5c.ptIndex;var _5f=_5c.segLength-1;var _60=_5d.points;var _61=_60.splice(_5e,1);_60.push(_61[0]);var _62=this._vertexMovers[0];for(var j=_5f;j>_5e;j--){_62[j].ptIndex-=1;}_61=_62.splice(_5e,1);_62.push(_61[0]);_61[0].ptIndex=_5f;},_moveStopHandler:function(_63){this._updateRelatedGraphic(_63,_63.relatedGraphic,_63.graphic.geometry,_63.segIndex,_63.ptIndex,_63.segLength);this.toolbar._endOperation("VERTICES");},_updateRelatedGraphic:function(_64,_65,_66,_67,_68,_69,add,del){var _6a=_65.geometry;if(del){_6a.removePoint(_68);}else{_6a.setPoint(_68,_66);}_65.setGeometry(_6a);},_deleteMidpoints:function(_6b){}});dojo.declare("esri.toolbars._PolylineVertexEditor",esri.toolbars._GraphicVertexEditor,{minLength:2,_getSegments:function(_6c){var _6d=_6c.paths,_6e=[];for(var i=0;i<_6d.length;i++){var _6f=_6d[i],_70=[];for(var j=0;j<_6f.length;j++){_70.push(_6c.getPoint(i,j));}_6e.push(_70);}return _6e;},_getMidpointSegments:function(_71){var _72=_71.paths,_73=[],sr=_71.spatialReference;for(var i=0;i<_72.length;i++){var _74=_72[i],_75=[];for(var j=0;j<_74.length-1;j++){var _76=_71.getPoint(i,j),_77=_71.getPoint(i,j+1);var _78=(_76.x+_77.x)/2,_79=(_76.y+_77.y)/2;var _7a=new esri.geometry.Point({x:_78,y:_79,spatialReference:sr.toJson()});_75.push(_7a);}_73.push(_75);}return _73;},_getControlPoints:function(_7b,_7c,_7d,_7e,_7f){var map=this.map,_80,_81,pt1,pt2;if(this._isNew(_7b)){_80=_7e;_81=_7e+1;if(_80>=0){pt1=map.toScreen(_7c.getPoint(_7d,_80));}if(_81<=_7f){pt2=map.toScreen(_7c.getPoint(_7d,_81));}}else{_80=_7e-1;_81=_7e+1;if(_80>=0){pt1=map.toScreen(_7c.getPoint(_7d,_80));}if(_81<_7f){pt2=map.toScreen(_7c.getPoint(_7d,_81));}}return [pt1,pt2];},_getAdjacentMidpoints:function(_82,_83){var _84=[];var _85=_82-1;if(_85>=0){_84.push(_85);}var _86=_82;if(_86<_83-1){_84.push(_86);}return _84;},_getAdjacentVertices:function(_87,_88){return [_87,_87+1];},_deleteMidpoints:function(_89){var _8a=_89.segIndex,_8b=_89.ptIndex,_8c=_89.segLength;var _8d=this._mpVertexMovers[_8a],_8e=_8d.length-1;var _8f=this._getAdjacentMidpoints(_8b,_8c).sort();var min=_8f[0];for(var i=0;i<min;i++){_8d[i].segLength-=1;}for(var i=min+1;i<_8d.length;i++){var mvr=_8d[i];mvr.ptIndex-=1;mvr.segLength-=1;}if(_8f.length===1){_8d.splice(min,1)[0].destroy();}else{var _90=this._getAdjacentVertices(min,_8e);var _91=_89.relatedGraphic.geometry.getPoint(_89.segIndex,_90[0]);var _92=_89.relatedGraphic.geometry.getPoint(_89.segIndex,_90[1]);var _93=new esri.geometry.Point({x:(_91.x+_92.x)/2,y:(_91.y+_92.y)/2,spatialReference:_91.spatialReference.toJson()});var _94=new esri.toolbars.VertexMover(_93,this._symbol2,this.graphic,_89.segIndex,min,_8e,this,true);var _95=_8d.splice(min,_8f.length,_94);for(var i=0;i<_95.length;i++){_95[i].destroy();}}},_updateRelatedGraphic:function(_96,_97,_98,_99,_9a,_9b,add,del){var _9c=_97.geometry;if(add){_9c.insertPoint(_99,_9a+1,esri.geometry.fromJson(_98.toJson()));}else{if(del){_9c.removePoint(_99,_9a);}else{_9c.setPoint(_99,_9a,esri.geometry.fromJson(_98.toJson()));}}_97.setGeometry(_9c);}});dojo.declare("esri.toolbars._PolygonVertexEditor",esri.toolbars._GraphicVertexEditor,{minLength:3,_getSegments:function(_9d){var _9e=_9d.rings,_9f=[];for(var i=0;i<_9e.length;i++){var _a0=_9e[i],_a1=[];for(var j=0;j<_a0.length-1;j++){_a1.push(_9d.getPoint(i,j));}_9f.push(_a1);}return _9f;},_getMidpointSegments:function(_a2){var _a3=_a2.rings,_a4=[],sr=_a2.spatialReference;for(var i=0;i<_a3.length;i++){var _a5=_a3[i],_a6=[];for(var j=0;j<_a5.length-1;j++){var _a7=_a2.getPoint(i,j),_a8=_a2.getPoint(i,j+1);var _a9=(_a7.x+_a8.x)/2,_aa=(_a7.y+_a8.y)/2;var _ab=new esri.geometry.Point({x:_a9,y:_aa,spatialReference:sr.toJson()});_a6.push(_ab);}_a4.push(_a6);}return _a4;},_getControlPoints:function(_ac,_ad,_ae,_af,_b0){var map=this.map,_b1,_b2,pt1,pt2;if(this._isNew(_ac)){_b1=_af;_b2=(_af+1)%_b0;}else{_b1=_af-1;_b1=_b1<0?(_b0+_b1)%_b0:_b1;_b2=(_af+1)%_b0;}pt1=map.toScreen(_ad.getPoint(_ae,_b1));pt2=map.toScreen(_ad.getPoint(_ae,_b2));return [pt1,pt2];},_getAdjacentMidpoints:function(_b3,_b4){var _b5=_b3-1;_b5=_b5<0?(_b4+_b5)%_b4:_b5;var _b6=_b3;return [_b5,_b6];},_getAdjacentVertices:function(_b7,_b8){return [_b7,(_b7+1)%_b8];},_deleteMidpoints:function(_b9){var _ba=_b9.segIndex,_bb=_b9.ptIndex,_bc=_b9.segLength;var _bd=this._mpVertexMovers[_ba],_be=_bd.length-1;var _bf=this._getAdjacentMidpoints(_bb,_bc).sort();var min=_bf[0],max=_bf[_bf.length-1];if(_bb===0){var _c0=this._getAdjacentVertices(_be-1,_be);var _c1=_b9.relatedGraphic.geometry.getPoint(_b9.segIndex,_c0[0]);var _c2=_b9.relatedGraphic.geometry.getPoint(_b9.segIndex,_c0[1]);var _c3=new esri.geometry.Point({x:(_c1.x+_c2.x)/2,y:(_c1.y+_c2.y)/2,spatialReference:_c1.spatialReference.toJson()});var _c4=new esri.toolbars.VertexMover(_c3,this._symbol2,this.graphic,_b9.segIndex,_be-1,_be,this,true);_bd.splice(max,1,_c4)[0].destroy();_bd.splice(min,1)[0].destroy();for(var i=0;i<_bd.length-1;i++){var mvr=_bd[i];mvr.ptIndex-=1;mvr.segLength-=1;}}else{var _c0=this._getAdjacentVertices(min,_be);var _c1=_b9.relatedGraphic.geometry.getPoint(_b9.segIndex,_c0[0]);var _c2=_b9.relatedGraphic.geometry.getPoint(_b9.segIndex,_c0[1]);var _c3=new esri.geometry.Point({x:(_c1.x+_c2.x)/2,y:(_c1.y+_c2.y)/2,spatialReference:_c1.spatialReference.toJson()});var _c4=new esri.toolbars.VertexMover(_c3,this._symbol2,this.graphic,_b9.segIndex,min,_be,this,true);var _c5=_bd.splice(min,_bf.length,_c4);for(var i=0;i<_c5.length;i++){_c5[i].destroy();}for(var i=0;i<min;i++){_bd[i].segLength-=1;}for(var i=min+1;i<_bd.length;i++){var mvr=_bd[i];mvr.ptIndex-=1;mvr.segLength-=1;}}},_updateRelatedGraphic:function(_c6,_c7,_c8,_c9,_ca,_cb,add,del){var _cc=_c7.geometry;if(add){_cc.insertPoint(_c9,_ca+1,esri.geometry.fromJson(_c8.toJson()));}else{if(del){_cc.removePoint(_c9,_ca);if(_ca===0){_cc.setPoint(_c9,_cb-1,esri.geometry.fromJson(_cc.getPoint(_c9,0).toJson()));}}else{_cc.setPoint(_c9,_ca,esri.geometry.fromJson(_c8.toJson()));if(_ca===0){_cc.setPoint(_c9,_cb,esri.geometry.fromJson(_c8.toJson()));}}}_c7.setGeometry(_cc);}});}