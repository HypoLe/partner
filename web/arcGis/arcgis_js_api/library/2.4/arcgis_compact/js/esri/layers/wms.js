/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */

if(!dojo._hasResource["esri.layers.wms"]){dojo._hasResource["esri.layers.wms"]=true;dojo.provide("esri.layers.wms");dojo.require("esri.layers.dynamic");dojo.require("esri.layers.agscommon");dojo.declare("esri.layers.WMSLayer",[esri.layers.DynamicMapServiceLayer],{_CRS_TO_EPSG:{84:4326,83:4269,27:4267},_REVERSED_LAT_LONG_RANGES:[[4001,4999],[2044,2045],[2081,2083],[2085,2086],[2093,2093],[2096,2098],[2105,2132],[2169,2170],[2176,2180],[2193,2193],[2200,2200],[2206,2212],[2319,2319],[2320,2462],[2523,2549],[2551,2735],[2738,2758],[2935,2941],[2953,2953],[3006,3030],[3034,3035],[3058,3059],[3068,3068],[3114,3118],[3126,3138],[3300,3301],[3328,3335],[3346,3346],[3350,3352],[3366,3366],[3416,3416],[20004,20032],[20064,20092],[21413,21423],[21473,21483],[21896,21899],[22171,22177],[22181,22187],[22191,22197],[25884,25884],[27205,27232],[27391,27398],[27492,27492],[28402,28432],[28462,28492],[30161,30179],[30800,30800],[31251,31259],[31275,31279],[31281,31290],[31466,31700]],_WEB_MERCATOR:[102100,3857,102113,900913],_WORLD_MERCATOR:[3395,54004],allExtents:[],constructor:function(_1,_2){this._getCapabilitiesURL=_1;this._initLayer=dojo.hitch(this,this._initLayer);this._parseCapabilities=dojo.hitch(this,this._parseCapabilities);this._getCapabilitiesError=dojo.hitch(this,this._getCapabilitiesError);if(_2){this.imageFormat=this._getImageFormat(_2.format);this.imageTransparency=(_2.transparent===false)?false:true;this.visibleLayers=_2.visibleLayers?_2.visibleLayers:[];if(_2.resourceInfo){this._readResourceInfo(_2.resourceInfo);}else{this._getCapabilities();}}else{this.imageFormat="image/png";this.imageTransparency=true;this.visibleLayers=[];this._getCapabilities();}this._blankImageURL=dojo.moduleUrl("esri","../../images/pixel.png").uri;},setVisibleLayers:function(_3){_3=this._checkVisibleLayersList(_3);this.visibleLayers=(_3)?_3:[];this.refresh(true);},setImageFormat:function(_4){this.imageFormat=this._getImageFormat(_4);this.refresh(true);},setImageTransparency:function(_5){this.imageTransparency=_5;this.refresh(true);},getImageUrl:function(_6,_7,_8,_9){if(!this.visibleLayers||this.visibleLayers.length===0){_9(this._blankImageURL);return;}var _a=_6.spatialReference.wkid;if(dojo.some(this._WEB_MERCATOR,function(el){return el==_a;})){var _b=dojo.filter(this.spatialReferences,function(el){return (dojo.some(this._WEB_MERCATOR,function(_c){return _c==el;}));},this);if(_b.length==0){_b=dojo.filter(this.spatialReferences,function(el){return (dojo.some(this._WORLD_MERCATOR,function(_d){return _d==el;}));},this);}if(_b.length>0){_a=_b[0];}else{_a=this._WEB_MERCATOR[0];}}var _e=dojo.filter(this.spatialReferences,function(el){return el!==_a;});this.spatialReferences=_e;this.spatialReferences.unshift(_a);var _f=_6.xmin;var _10=_6.xmax;var _11=_6.ymin;var _12=_6.ymax;var _13={};_13.SERVICE="WMS";_13.REQUEST="GetMap";_13.FORMAT=this.imageFormat;_13.TRANSPARENT=this.imageTransparency?"TRUE":"FALSE";_13.STYLES="";_13.VERSION=this.version;_13.LAYERS=this.visibleLayers?this.visibleLayers.toString():null;_13.WIDTH=_7;_13.HEIGHT=_8;if(this.maxWidth<_7){_13.WIDTH=this.maxWidth;}if(this.maxHeight<_8){_13.HEIGHT=this.maxHeight;}var _14=_a?_a:NaN;if(!isNaN(_14)){if(this.version=="1.3.0"){_13.CRS="EPSG:"+_14;}else{_13.SRS="EPSG:"+_14;}}if(this.version=="1.3.0"&&this._useLatLong(_14)){_13.BBOX=_11+","+_f+","+_12+","+_10;}else{_13.BBOX=_f+","+_11+","+_10+","+_12;}var _15=this.getMapURL;_15+=(_15.indexOf("?")==-1)?"?":"";for(var key in _13){_15+=(_15.substring(_15.length-1,_15.length)=="?")?"":"&";_15+=key+"="+_13[key];}_9(_15);},_initLayer:function(_16,io){this.spatialReference=new esri.SpatialReference(this.extent.spatialReference);this.initialExtent=new esri.geometry.Extent(this.extent);this.fullExtent=new esri.geometry.Extent(this.extent);this.visibleLayers=this._checkVisibleLayersList(this.visibleLayers);this.loaded=true;this.onLoad(this);var _17=this._loadCallback;if(_17){delete this._loadCallback;_17(this);}},_readResourceInfo:function(_18){if(!_18.extent){console.error("esri.layers.WMSLayer: unable to find the 'extent' property in resourceInfo");return;}if(!_18.layerInfos){console.error("esri.layers.WMSLayer: unable to find the 'layerInfos' property in resourceInfo");return;}this.extent=_18.extent;this.layerInfos=_18.layerInfos;this.description=_18.description?_18.description:"";this.copyright=_18.copyright?_18.copyright:"";this.title=_18.title?_18.title:"";this.getMapURL=_18.getMapURL?_18.getMapURL:this._getCapabilitiesURL;this.version=_18.version?_18.version:"1.3.0";this.maxWidth=_18.maxWidth?_18.maxWidth:5000;this.maxHeight=_18.maxHeight?_18.maxHeight:5000;this.spatialReferences=_18.spatialReferences?_18.spatialReferences:[];this._initLayer();},_getCapabilities:function(){var _19=this._url.query?this._url.query:{};_19.SERVICE="WMS";_19.REQUEST="GetCapabilities";var uri=this._url.path+"?";for(var key in _19){uri+=(uri.substring(uri.length-1,uri.length)=="?")?"":"&";uri+=key+"="+_19[key];}var _1a=esri.request({url:uri,handleAs:"xml",load:this._parseCapabilities,error:this._getCapabilitiesError},{usePost:false});},_parseCapabilities:function(xml){if(!xml){this.onError("GetCapabilities request for "+this._getCapabilitiesURL+" failed. (Response is null.)");return;}this.version=this._getAttributeValue("WMS_Capabilities","version",xml,null);if(!this.version){this.version=this._getAttributeValue("WMT_MS_Capabilities","version",xml,"1.3.0");}var _1b=this._getTag("Service",xml);this.title=this._getTagValue("Title",_1b,"");if(this.title.length==0){this.title=this._getTagValue("Name",_1b,"");}this.copyright=this._getTagValue("AccessConstraints",_1b,"");this.description=this._getTagValue("Abstract",_1b,"");this.maxWidth=parseInt(this._getTagValue("MaxWidth",_1b,5000));this.maxHeight=parseInt(this._getTagValue("MaxHeight",_1b,5000));var _1c=this._getTag("Layer",xml);if(!_1c){this._getCapabilitiesError({"error":{"message":"Response does not contain any layers."}});return;}var _1d=this._getLayerInfo(_1c);if(_1d){this.layerInfos=_1d.subLayers;this.extent=_1d.extent;this.spatialReferences=_1d.spatialReferences;this.allExtents=_1d.allExtents;}this.getMapURL=this._getCapabilitiesURL;var _1e=dojo.query("DCPType",this._getTag("GetMap",xml));if(_1e&&_1e.length>0){var _1f=dojo.query("HTTP",_1e[0]);if(_1f&&_1f.length>0){var _20=dojo.query("Get",_1f[0]);if(_20&&_20.length>0){var _21=this._getAttributeValue("OnlineResource","xlink:href",_20[0],null);if(_21){if(_21.indexOf("&")==(_21.length-1)){_21=_21.substring(0,_21.length-1);}this.getMapURL=_21;}}}}this.getMapFormats=[];dojo.forEach(dojo.query("Format",this._getTag("GetMap",xml)),function(_22){if(dojo.isIE){this.getMapFormats.push(_22.text);}else{this.getMapFormats.push(_22.textContent);}},this);this._initLayer();},_getCapabilitiesError:function(_23,io){this.onError("GetCapabilities request for "+this._getCapabilitiesURL+" failed. ("+dojo.toJson(_23)+")");},_getLayerInfo:function(_24){var _25;if(_24){_25=new esri.layers.WMSLayerInfo();_25.name="";_25.title="";_25.description="";dojo.forEach(_24.childNodes,function(_26){if(_26.nodeName=="Name"){_25.name=(dojo.isIE?_26.text:_26.textContent)||"";}else{if(_26.nodeName=="Title"){_25.title=(dojo.isIE?_26.text:_26.textContent)||"";}else{if(_26.nodeName=="Abstract"){_25.description=(dojo.isIE?_26.text:_26.textContent)||"";}}}},this);_25.allExtents=[];var _27=this._getTag("LatLonBoundingBox",_24);if(_27){_25.allExtents[0]=this._getExtent(_27,4326);}var _28=this._getTag("EX_GeographicBoundingBox",_24);if(_28){var _29=new esri.geometry.Extent(0,0,0,0,new esri.SpatialReference({wkid:4326}));_29.xmin=parseFloat(this._getTagValue("westBoundLongitude",_28,0));_29.ymin=parseFloat(this._getTagValue("southBoundLatitude",_28,0));_29.xmax=parseFloat(this._getTagValue("eastBoundLongitude",_28,0));_29.ymax=parseFloat(this._getTagValue("northBoundLatitude",_28,0));_25.allExtents[0]=_29;}var _2a=dojo.query("BoundingBox",_24);if(_2a.length===0){_25.extent=_25.allExtents[0];}else{var _2b=(this.version=="1.3.0")?"CRS":"SRS";var bb,_2c,_2d;for(var i=0;i<_2a.length;i++){bb=_2a[i];var tag=bb.parentNode.nodeName;if(tag!=="Layer"){continue;}var _2e="";var _2f="";dojo.forEach(bb.parentNode.childNodes,function(_30){if(_30.nodeName=="Name"){_2e=(dojo.isIE?_30.text:_30.textContent)||"";}if(_30.nodeName=="Title"){_2f=(dojo.isIE?_30.text:_30.textContent)||"";}},this);if(_2e!==_25.name||_2f!==_25.title){continue;}_2c=bb.getAttribute(_2b);if(_2c&&_2c.indexOf("EPSG:")===0){_2d=parseInt(_2c.substring(5));if(_2d==0){continue;}var _29;if(this.version=="1.3.0"){_29=this._getExtent(bb,_2d,this._useLatLong(_2d));}else{_29=this._getExtent(bb,_2d);}_25.allExtents[_2d]=_29;if(!_25.extent){_25.extent=_29;}}else{if(_2c&&_2c.indexOf("CRS:")===0){_2d=parseInt(_2c.substring(4));if(_2d==0){continue;}if(this._CRS_TO_EPSG[_2d]){_2d=this._CRS_TO_EPSG[_2d];}_25.allExtents[_2d]=this._getExtent(bb,_2d);}else{_2d=parseInt(_2c);_25.allExtents[_2d]=this._getExtent(bb,_2d);}}}if(!_25.extent){bb=_2a[0];_2c=bb.getAttribute(_2b)[0];if(_2c){if(_2c.indexOf("CRS:")===0){_2d=parseInt(_2c.substring(4));if(this._CRS_TO_EPSG[_2d]){_2d=this._CRS_TO_EPSG[_2d];}_25.extent=_25.allExtents[_2d];}else{_2d=parseInt(_2c);_25.extent=_25.allExtents[_2d];}}}}if(!_25.extent){_25.extent=_25.allExtents[0];}_25.spatialReferences=[];var _31=(this.version=="1.3.0")?"CRS":"SRS";dojo.forEach(dojo.query(_31,_24),function(crs){var _32;if(dojo.isIE){_32=crs.text;}else{_32=crs.textContent;}var arr=_32.split(" ");dojo.forEach(arr,function(val){if(val.indexOf(":")>-1){val=parseInt(val.split(":")[1]);}else{val=parseInt(val);}if(val!=84&&val!=0){if(!dojo.some(_25.spatialReferences,function(el){return el==val;})){_25.spatialReferences.push(val);}}});},this);var _33=this._getTag("Style",_24);if(_33){var _34=this._getTag("LegendURL",_33);if(_34){var _35=this._getTag("OnlineResource",_34);if(_35){_25.legendURL=_35.getAttribute("xlink:href");}}}var _36=dojo.query("Layer",_24);var _37="||";if(_36.length>0){_25.subLayers=[];dojo.forEach(_36,function(_38){var l=this._getLayerInfo(_38);if(l.subLayers&&l.subLayers.length>0&&l.name===l.subLayers[0].name){l.name=null;}if(_37.indexOf("||"+l.name+"||")==-1){_25.subLayers.push(l);if(l.subLayers&&l.subLayers.length>0){dojo.forEach(l.subLayers,function(_39){_37+=_39.name+"||";},this);}}},this);}}return _25;},_getImageFormat:function(_3a){var _3b=_3a?_3a.toLowerCase():"";switch(_3b){case "jpg":return "image/jpeg";case "bmp":return "image/bmp";case "gif":return "image/gif";case "svg":return "image/svg+xml";default:return "image/png";}},_getExtent:function(_3c,_3d,_3e){var _3f;if(_3c){_3f=new esri.geometry.Extent();var _40=parseFloat(_3c.getAttribute("minx"));var _41=parseFloat(_3c.getAttribute("miny"));var _42=parseFloat(_3c.getAttribute("maxx"));var _43=parseFloat(_3c.getAttribute("maxy"));if(_3e){_3f.xmin=isNaN(_41)?Number.MIN_VALUE:_41;_3f.ymin=isNaN(_40)?Number.MIN_VALUE:_40;_3f.xmax=isNaN(_43)?Number.MAX_VALUE:_43;_3f.ymax=isNaN(_42)?Number.MAX_VALUE:_42;}else{_3f.xmin=isNaN(_40)?Number.MIN_VALUE:_40;_3f.ymin=isNaN(_41)?Number.MIN_VALUE:_41;_3f.xmax=isNaN(_42)?Number.MAX_VALUE:_42;_3f.ymax=isNaN(_43)?Number.MAX_VALUE:_43;}_3f.spatialReference=new esri.SpatialReference({wkid:_3d});}return _3f;},_useLatLong:function(_44){var _45;for(var i=0;i<this._REVERSED_LAT_LONG_RANGES.length;i++){var _46=this._REVERSED_LAT_LONG_RANGES[i];if(_44>=_46[0]&&_44<=_46[1]){_45=true;break;}}return _45;},_getTag:function(_47,xml){var _48=dojo.query(_47,xml);if(_48&&_48.length>0){return _48[0];}else{return null;}},_getTagValue:function(_49,xml,_4a){var _4b=dojo.query(_49,xml);if(_4b&&_4b.length>0){if(dojo.isIE){return _4b[0].text;}else{return _4b[0].textContent;}}else{return _4a;}},_getAttributeValue:function(_4c,_4d,xml,_4e){var _4f=dojo.query(_4c,xml);if(_4f&&_4f.length>0){return _4f[0].getAttribute(_4d);}else{return _4e;}},_checkVisibleLayersList:function(_50){if(_50&&_50.length>0&&this.layerInfos&&this.layerInfos.length>0){if((typeof _50[0])=="number"){var _51=[];dojo.forEach(_50,function(pos){if(pos<this.layerInfos.length){_51.push(this.layerInfos[pos].name);}},this);_50=_51;}}return _50;}});dojo.declare("esri.layers.WMSLayerInfo",null,{name:null,title:null,description:null,extent:null,legendURL:null,subLayers:[],constructor:function(_52){if(_52){this.name=_52.name;this.title=_52.title;this.description=_52.description;this.extent=_52.extent;this.legendURL=_52.legendURL;}}});}