/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */

if(!dojo._hasResource["esri.layers.agsdynamic"]){dojo._hasResource["esri.layers.agsdynamic"]=true;dojo.provide("esri.layers.agsdynamic");dojo.require("esri.layers.dynamic");dojo.require("esri.layers.agscommon");dojo.require("esri._time");dojo.declare("esri.layers.ArcGISDynamicMapServiceLayer",[esri.layers.DynamicMapServiceLayer,esri.layers.ArcGISMapServiceLayer],{constructor:function(_1,_2){var _3=_2&&_2.imageParameters,dh=dojo.hitch;if(_3){var _4=_3.layerDefinitions;if(_4){this.setLayerDefinitions(_4);}if(_3.layerOption===esri.layers.ImageParameters.LAYER_OPTION_SHOW){this.visibleLayers=[].concat(_3.layerIds);}}this._setIsPNG32=dh(this,this._setIsPNG32);this.dpi=(_3&&_3.dpi)||96;this.imageFormat=(_3&&_3.format)||"png8";this.imageTransparency=(_3&&_3.transparent===false)?false:true;this._setIsPNG32();dojo.mixin(this._params,this._url.query,{dpi:this.dpi,transparent:this.imageTransparency,format:this.imageFormat},_3?_3.toJson():{});this.getImageUrl=dh(this,this.getImageUrl);this._initLayer=dh(this,this._initLayer);this._load=dh(this,this._load);this.useMapImage=_2?_2.useMapImage:false;if(this.useMapImage){this._imageExportHandler=dh(this,this._imageExportHandler);}this._loadCallback=_2&&_2.loadCallback;var _5=_2&&_2.resourceInfo;if(_5){this._initLayer(_5);}else{if(arguments[2]===undefined||arguments[2]===false){this._load();}}},disableClientCaching:false,layerDefinitions:null,_initLayer:function(_6,io){this.inherited(arguments);if(_6.timeInfo){this.timeInfo=new esri.layers.TimeInfo(_6.timeInfo);}this.loaded=true;this.onLoad(this);var _7=this._loadCallback;if(_7){delete this._loadCallback;_7(this);}},getImageUrl:function(_8,_9,_a,_b){var _c=this._url.path+"/export?",_d=this._params,sr=_8.spatialReference.wkid||dojo.toJson(_8.spatialReference.toJson()),_e=this._errorHandler;delete _d._ts;dojo.mixin(_d,{bbox:_8.xmin+","+_8.ymin+","+_8.xmax+","+_8.ymax,bboxSR:sr,imageSR:sr,size:_9+","+_a},this.disableClientCaching?{_ts:new Date().getTime()}:{});if(_d.layerDefs){var _f=_d.layerDefs;delete _d.layerDefs;dojo.mixin(_d,{layerDefs:_f});}var _10=esri._getProxiedUrl(_c+dojo.objectToQuery(dojo.mixin({},_d,{f:"image"})));if((_10.length>esri.config.defaults.io.postLength)||this.useMapImage){var _11=this._imageExportHandler;this._jsonRequest=esri.request({url:_c,content:dojo.mixin(_d,{f:"json"}),callbackParamName:"callback",load:function(_12,io){_11(_12,io,_b);},error:_e});}else{_b(_10);}},_imageExportHandler:function(_13,io,_14){_14(esri._getProxiedUrl(_13.href));},_setIsPNG32:function(){var _15=this.imageFormat.toLowerCase();var _16=dojo.isIE;this.isPNG32=_16&&_16===6&&(_15==="png32"||_15==="png24")&&this.imageTransparency;},_setTime:function(_17){var _18=(this._params.time=_17?_17.toJson().join(","):null);if(this.version<10.02&&this.timeInfo){if(!_18){var _19=this.layerInfos;if(_19){var _1a=this.layerTimeOptions,_1b=_1a?_1a.slice(0):[],ids=[];dojo.forEach(_19,function(_1c){if(!_1c.subLayerIds){ids.push(_1c.id);}});if(ids.length){dojo.forEach(ids,function(id){if(!_1b[id]){var opt=new esri.layers.LayerTimeOptions();opt.useTime=false;_1b[id]=opt;}});this._params.layerTimeOptions=esri._serializeTimeOptions(_1b,ids);}}}else{this._params.layerTimeOptions=esri._serializeTimeOptions(this.layerTimeOptions);}}if(this.version>=10.02&&this.timeInfo){if(!_18){this._params.time="null,null";}}},setDPI:function(dpi,_1d){this.dpi=(this._params.dpi=dpi);if(!_1d){this.refresh(true);}},setImageFormat:function(_1e,_1f){this.imageFormat=(this._params.format=_1e);this._setIsPNG32();if(!_1f){this.refresh(true);}},setImageTransparency:function(_20,_21){this.imageTransparency=(this._params.transparent=_20);this._setIsPNG32();if(!_21){this.refresh(true);}},setVisibleLayers:function(_22,_23){this.visibleLayers=_22;this._params.layers=esri.layers.ImageParameters.LAYER_OPTION_SHOW+":"+_22.join(",");if(!_23){this.refresh(true);}},setDefaultVisibleLayers:function(_24){this.visibleLayers=this._defaultVisibleLayers;this._params.layers=null;if(!_24){this.refresh(true);}},setLayerDefinitions:function(_25,_26){this.layerDefinitions=_25;this._params.layerDefs=esri._serializeLayerDefinitions(_25);if(!_26){this.refresh(true);}},setDefaultLayerDefinitions:function(_27){this.layerDefinitions=this._params.layerDefs=null;if(!_27){this.refresh(true);}},setDisableClientCaching:function(_28){this.disableClientCaching=_28;},setLayerTimeOptions:function(_29,_2a){this.layerTimeOptions=_29;this._params.layerTimeOptions=esri._serializeTimeOptions(_29);if(!_2a){this.refresh(true);}},refresh:function(_2b){if(_2b){this.inherited(arguments);}else{var dc=this.disableClientCaching;this.disableClientCaching=true;this.inherited(arguments);this.disableClientCaching=dc;}},exportMapImage:function(_2c,_2d){var m=esri.config.defaults.map,p=dojo.mixin({size:m.width+","+m.height},this._params,_2c?_2c.toJson(this.normalization):{},{f:"json"});delete p._ts;if(p.layerDefs){var _2e=p.layerDefs;delete p.layerDefs;dojo.mixin(p,{layerDefs:_2e});}this._exportMapImage(this._url.path+"/export",p,_2d);}});dojo.declare("esri.layers.ImageParameters",null,{constructor:function(){this.layerDefinitions=[];this._bundle=dojo.i18n.getLocalization("esri","jsapi");},bbox:null,extent:null,width:null,height:null,dpi:null,format:null,imageSpatialReference:null,layerOption:null,layerIds:null,transparent:null,timeExtent:null,layerTimeOptions:null,toJson:function(_2f){if(this.bbox){dojo.deprecated(this.declaredClass+" : "+this._bundle.layers.imageParameters.deprecateBBox);}var bb=this.bbox||this.extent;bb=bb&&_2f&&bb._normalize(true);var _30=this.layerOption,_31=bb?(bb.spatialReference.wkid||dojo.toJson(bb.spatialReference.toJson())):null,_32=this.imageSpatialReference,_33={dpi:this.dpi,format:this.format,transparent:this.transparent,size:(this.width!==null&&this.height!==null?this.width+","+this.height:null),bbox:(bb?(bb.xmin+","+bb.ymin+","+bb.xmax+","+bb.ymax):null),bboxSR:_31,layers:(_30?_30+":"+this.layerIds.join(","):null),imageSR:(_32?(_32.wkid||dojo.toJson(_32.toJson())):_31)};_33.layerDefs=esri._serializeLayerDefinitions(this.layerDefinitions);var _34=this.timeExtent;_33.time=_34?_34.toJson().join(","):null;_33.layerTimeOptions=esri._serializeTimeOptions(this.layerTimeOptions);return esri.filter(_33,function(_35){if(_35!==null){return true;}});}});dojo.mixin(esri.layers.ImageParameters,{LAYER_OPTION_SHOW:"show",LAYER_OPTION_HIDE:"hide",LAYER_OPTION_INCLUDE:"include",LAYER_OPTION_EXCLUDE:"exclude"});dojo.declare("esri.layers.MapImage",null,{constructor:function(_36){dojo.mixin(this,_36);this.extent=new esri.geometry.Extent(this.extent);}});}