/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */

window[esri._dojoScopeName||"dojo"]._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","esri.SnappingManager"],["require","esri.tasks.query"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["esri.SnappingManager"]){_4._hasResource["esri.SnappingManager"]=true;_4.provide("esri.SnappingManager");_4.require("esri.tasks.query");_4.declare("esri.SnappingManager",null,{constructor:function(_7){_7=_7||{};if(!_7.map){console.error("map is not specified for SnappingManager");}this.map=_7.map;this.tolerance=_7.tolerance||15;this.layerInfos=[];if(_7.layerInfos){this.layerInfos=_7.layerInfos;}else{var i;for(i=0;i<this.map.graphicsLayerIds.length;i++){var _8=this.map.getLayer(this.map.graphicsLayerIds[i]);this.layerInfos.push({"layer":_8});}this.layerInfos.push({"layer":this.map.graphics});}if(_7.snapPointSymbol){this.snapPointSymbol=_7.snapPointSymbol;}else{this.snapPointSymbol=new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CROSS,15,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new _4.Color([0,255,255]),1),new _4.Color([0,255,0,0]));}if(_7.alwaysSnap){this.alwaysSnap=_7.alwaysSnap;}else{this.alwaysSnap=false;}if(_7.snapKey){this.snapKey=_7.snapKey;}else{this.snapKey=_4.keys.copyKey;}this._SelectionLyrQuery=new esri.tasks.Query();this._SelectionLyrQuery.spatialRelationship=esri.tasks.Query.SPATIAL_REL_INTERSECTS;this._snappingGraphic=new esri.Graphic();this.setLayerInfos(this.layerInfos);this._currentGraphicOption={snapToPoint:true,snapToVertex:true,snapToEdge:true};this._snappingCallback=_4.hitch(this,this._snappingCallback);},getSnappingPoint:function(_9){var _a=this.layers,_b=this.tolerance,_c=this.map,_d=this.layerOptions,_e=_c.toMap(_9.offset(-_b,_b)),_f=_c.toMap(_9.offset(_b,-_b)),_10=new esri.geometry.Extent(_e.x,_e.y,_f.x,_f.y,_c.spatialReference),_11=new esri.tasks.Query();_11.geometry=_10;_11.spatialRelationship=esri.tasks.Query.SPATIAL_REL_INTERSECTS;var _12=[],_13=[],_14,_15=this._extractPointsAndLines,_16=new _4.Deferred(),_17=this._nonSelectionLayerCount,_18,_19=_10.xmin,_1a=_10.xmax;if(_c.spatialReference._isWrappable()){_19=esri.geometry.Extent.prototype._normalizeX(_10.xmin,_c.spatialReference._getInfo()).x;_1a=esri.geometry.Extent.prototype._normalizeX(_10.xmax,_c.spatialReference._getInfo()).x;}var _1b=new esri.geometry.Extent(_19,_10.ymin,_1a,_10.ymax,_c.spatialReference);_4.forEach(_a,function(_1c,idx){if(_1c.declaredClass==="esri.layers.GraphicsLayer"&&_1c.visible){var _1d=[];_4.forEach(_1c.graphics,function(_1e){if(_1e){if(_1e.visible&&_1b.intersects(_1e.geometry)){_1d.push(_1e);}}});var _1f=_15(_1d,_d[idx]);_12=_12.concat(_1f[0]);_13=_13.concat(_1f[1]);}});var _20=_4.hitch(this,function(_21){_17--;if(_21 instanceof Error){var msg="getSnappingPoint: query features failed";console.log(msg);}else{var _22=_15(_21.features,_d[_18]);_12=_12.concat(_22[0]);_13=_13.concat(_22[1]);}if(!_17){_14=this._getSnappingPoint(_12,_13,_9);_16.callback(_14);}});var _23=false;_4.forEach(_a,function(_24,idx){if(_24.visible&&_24.loaded){_18=idx;if((_24.declaredClass==="esri.layers.FeatureLayer")&&_24.mode!==esri.layers.FeatureLayer.MODE_SELECTION){_23=true;_24.queryFeatures(_11,_20,_20);}}});if(!_23){_14=this._getSnappingPoint(_12,_13,_9);_16.callback(_14);}return _16;},setLayerInfos:function(_25){this.layers=[];this.layerOptions=[];var i;for(i=0;i<_25.length;i++){this.layers.push(_25[i].layer);this.layerOptions.push({snapToPoint:true,snapToVertex:true,snapToEdge:true});if(_25[i].snapToPoint===false){this.layerOptions[i].snapToPoint=_25[i].snapToPoint;}if(_25[i].snapToVertex===false){this.layerOptions[i].snapToVertex=_25[i].snapToVertex;}if(_25[i].snapToEdge===false){this.layerOptions[i].snapToEdge=_25[i].snapToEdge;}}this._nonSelectionLayerCount=0;this._featurePtsFromSelectionLayer=[];this._featureLinesFromSelectionLayer=[];this._selectionLayers=[];this._selectionLayerOptions=[];_4.forEach(this.layers,function(_26,idx){if(_26.declaredClass==="esri.layers.FeatureLayer"){if(_26.mode===esri.layers.FeatureLayer.MODE_SELECTION){this._selectionLayers.push(_26);this._selectionLayerOptions.push(this.layerOptions[idx]);}else{this._nonSelectionLayerCount++;}}},this);this.layerInfos=_25;},destroy:function(){_4.disconnect(this._onExtentChangeConnect);this._killOffSnapping();this._featurePtsFromSelectionLayer=this._featureLinesFromSelectionLayer=this._currentFeaturePts=this._currentFeatureLines=this.layers=this.map=null;},_startSelectionLayerQuery:function(){_4.disconnect(this._onExtentChangeConnect);this._mapExtentChangeHandler(this._selectionLayers,this._selectionLayerOptions,this.map.extent);this._onExtentChangeConnect=_4.connect(this.map,"onExtentChange",_4.hitch(this,"_mapExtentChangeHandler",this._selectionLayers,this._selectionLayerOptions));},_stopSelectionLayerQuery:function(){_4.disconnect(this._onExtentChangeConnect);},_mapExtentChangeHandler:function(_27,_28,_29){this._featurePtsFromSelectionLayer=[];this._featureLinesFromSelectionLayer=[];var _2a;this._SelectionLyrQuery.geometry=_29;var _2b=_4.hitch(this,function(_2c){if(_2c instanceof Error){var msg="getSnappingPoint: query features failed";console.log(msg);}else{var _2d=this._extractPointsAndLines(_2c.features,_28[_2a]);this._featurePtsFromSelectionLayer=this._featurePtsFromSelectionLayer.concat(_2d[0]);this._featureLinesFromSelectionLayer=this._featureLinesFromSelectionLayer.concat(_2d[1]);}});_4.forEach(_27,function(_2e,idx){if(_2e.visible&&_2e.loaded){_2a=idx;_2e.queryFeatures(this._SelectionLyrQuery,_2b,_2b);}},this);},_extractPointsAndLines:function(_2f,_30){var _31=[],_32=[];var i,j;_4.forEach(_2f,function(_33,idx){if(_33.visible&&_33.geometry){if(_33.geometry.type==="point"&&_30.snapToPoint){_31.push(_33.geometry);}else{if(_33.geometry.type==="polyline"){for(i=0;i<_33.geometry.paths.length;i++){_32.push("lineStart");for(j=0;j<_33.geometry.paths[i].length;j++){var _34=_33.geometry.getPoint(i,j);if(_30.snapToVertex){_31.push(_34);}if(_30.snapToEdge){_32.push(_34);}}_32.push("lineEnd");}}else{if(_33.geometry.type==="polygon"){for(i=0;i<_33.geometry.rings.length;i++){_32.push("lineStart");for(j=0;j<_33.geometry.rings[i].length;j++){var _35=_33.geometry.getPoint(i,j);if(_30.snapToVertex){_31.push(_35);}if(_30.snapToEdge){_32.push(_35);}}_32.push("lineEnd");}}}}}});return [_31,_32];},_getSnappingPoint:function(_36,_37,_38){var _39,_3a,_3b=this.tolerance;var map=this.map;var _3c=this.map._getFrameWidth();_36=_36.concat(this._featurePtsFromSelectionLayer);_37=_37.concat(this._featureLinesFromSelectionLayer);if(this._currentGraphic){var _3d=this._extractPointsAndLines([this._currentGraphic],this._currentGraphicOption);_36=_36.concat(_3d[0]);_37=_37.concat(_3d[1]);}var _3e,_3f;_4.forEach(_36,function(pt,idx){var _40=map.toScreen(pt,true);if(_3c!==-1){_40.x=_40.x%_3c;if(_40.x<0){_40.x+=_3c;}if(map.width>_3c){var _41=(map.width-_3c)/2;while(_40.x<_41){_40.x+=_3c;}}}_39=Math.sqrt((_40.x-_38.x)*(_40.x-_38.x)+(_40.y-_38.y)*(_40.y-_38.y));if(_39<=_3b){_3b=_39;_3e=_40.x;_3f=_40.y;}});if(_3e){var _42=new esri.geometry.Point(_3e,_3f);_42=map.toMap(_42);_3a=_42;}else{var _43,_44,i,j;_3b=this.tolerance;for(i=0;i<_37.length;i++){if(_37[i]==="lineStart"){for(j=i+1;j<_37.length;j++){if(_37[j+1]!=="lineEnd"&&_37[j+1]!=="lineStart"&&_37[j]!=="lineEnd"&&_37[j]!=="lineStart"){var _45=map.toScreen(_37[j],true),_46=map.toScreen(_37[j+1],true),_47=(_45.x>=_46.x)?_45:_46,_48=(_45.x>=_46.x)?_46:_45;if(_3c!==-1){_47.x=_47.x%_3c;if(_47.x<0){_47.x+=_3c;}_48.x=_48.x%_3c;if(_48.x<0){_48.x+=_3c;}if(_48.x>_47.x){_48.x-=_3c;}}var x1=_47.x,y1=_47.y,x2=_48.x,y2=_48.y,a=(y2-y1)/(x2-x1),b=(y1*x2-x1*y2)/(x2-x1),_49=(x1-x2)/(y2-y1),_4a=(_38.y*y2-_38.y*y1-_38.x*x1+_38.x*x2)/(y2-y1),_4b=(b-_4a)/(_49-a),_4c=a*_4b+b,_4d=(x1<=x2)?x1:x2,_4e=(x1<=x2)?x2:x1,_4f=(y1<=y2)?y1:y2,_50=(y1<=y2)?y2:y1;if(_4b>=_4d&&_4b<=_4e&&_4c>=_4f&&_4c<=_50){var _51=Math.sqrt((_38.x-_4b)*(_38.x-_4b)+(_38.y-_4c)*(_38.y-_4c));if(_51<=_3b){_3b=_51;_43=_4b;_44=_4c;}}}if(_37[j]==="lineEnd"){i=j;break;}}}}if(_43){var _52=new esri.geometry.Point(_43,_44);_52=map.toMap(_52);_3a=_52;}}return _3a;},_setGraphic:function(_53){this._currentGraphic=_53;},_addSnappingPointGraphic:function(){var map=this.map;var _54=this.snapPointSymbol;this._snappingGraphic.setSymbol(_54);map.graphics.add(this._snappingGraphic);},_setUpSnapping:function(){var map=this.map;this._onSnapKeyDown_connect=_4.connect(map,"onKeyDown",this,"_onSnapKeyDownHandler");this._onSnapKeyUp_connect=_4.connect(map,"onKeyUp",this,"_onSnapKeyUpHandler");this._onSnappingMouseMove_connect=_4.connect(map,"onMouseMove",this,"_onSnappingMouseMoveHandler");this._onSnappingMouseDrag_connect=_4.connect(map,"onMouseDrag",this,"_onSnappingMouseMoveHandler");if(this.alwaysSnap){this._activateSnapping();}},_killOffSnapping:function(){_4.disconnect(this._onSnapKeyDown_connect);_4.disconnect(this._onSnapKeyUp_connect);_4.disconnect(this._onSnappingMouseMove_connect);_4.disconnect(this._onSnappingMouseDrag_connect);this._deactivateSnapping();},_onSnapKeyDownHandler:function(evt){if(evt.keyCode===this.snapKey){_4.disconnect(this._onSnapKeyDown_connect);if(this.alwaysSnap){this._deactivateSnapping();}else{this._activateSnapping();}}},_activateSnapping:function(){this._snappingActive=true;this._addSnappingPointGraphic();if(this._currentLocation){this._onSnappingMouseMoveHandler(this._currentLocation);}},_onSnapKeyUpHandler:function(evt){if(evt.keyCode===this.snapKey){this._onSnapKeyDown_connect=_4.connect(this.map,"onKeyDown",this,"_onSnapKeyDownHandler");if(this.alwaysSnap){this._activateSnapping();}else{this._deactivateSnapping();}}},_deactivateSnapping:function(){this._snappingActive=false;this._snappingPoint=null;this.map.graphics.remove(this._snappingGraphic);this._snappingGraphic.setGeometry(null);},_onSnappingMouseMoveHandler:function(evt){this._currentLocation=evt;this._snappingPoint=null;if(this._snappingActive){this._snappingGraphic.hide();var _55=this.getSnappingPoint(evt.screenPoint);_55.addCallback(this._snappingCallback);}},_snappingCallback:function(_56){this._snappingPoint=_56;if(_56){this._snappingGraphic.show();this._snappingGraphic.setGeometry(_56);}}});}}};});