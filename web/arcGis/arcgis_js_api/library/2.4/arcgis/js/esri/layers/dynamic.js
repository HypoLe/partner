/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */

if(!dojo._hasResource["esri.layers.dynamic"]){dojo._hasResource["esri.layers.dynamic"]=true;dojo.provide("esri.layers.dynamic");dojo.require("esri.layers.layer");dojo.require("esri.geometry");dojo.require("dojox.xml.parser");dojo.declare("esri.layers.DynamicMapServiceLayer",esri.layers.Layer,{constructor:function(_1,_2){this.useMapTime=(_2&&_2.hasOwnProperty("useMapTime"))?(!!_2.useMapTime):true;var dh=dojo.hitch;this._exportMapImageHandler=dh(this,this._exportMapImageHandler);this._imgSrcFunc=dh(this,this._imgSrcFunc);this._divAlphaImageFunc=dh(this,this._divAlphaImageFunc);this._tileLoadHandler=dh(this,this._tileLoadHandler);this._tileErrorHandler=dh(this,this._tileErrorHandler);},opacity:1,isPNG32:false,_setMap:function(_3,_4,_5){this._map=_3;var d=(this._div=dojo.create("div",null,_4));var _6={position:"absolute",left:"0px",top:"0px",width:_3.width+"px",height:_3.height+"px",overflow:"visible",opacity:this.opacity};var _7=dojo.isIE;if(_7&&_7>7){delete _6["opacity"];}dojo.style(d,_6);this._layerIndex=_5;var dc=dojo.connect;this._onPanHandler_connect=dc(_3,"onPan",this,"_onPanHandler");this._onExtentChangeHandler_connect=dc(_3,"onExtentChange",this,"_onExtentChangeHandler");this._toggleTime();this._onZoomHandler_connect=dc(_3,"onZoom",this,"_onZoomHandler");this._onResizeHandler_connect=dc(_3,"onResize",this,"_onResizeHandler");this._opacityChangeHandler_connect=dc(this,"onOpacityChange",this,"_opacityChangeHandler");this._visibilityChangeHandler_connect=dc(this,"onVisibilityChange",this,"_visibilityChangeHandler");this._img_loading=null;this._img_dragOrigin={x:0,y:0};if(!this.visible){this._visibilityChangeHandler(this.visible);}else{if(_3.extent&&_3.loaded){this._onExtentChangeHandler(_3.extent);}}return d;},_unsetMap:function(_8,_9){if(_9){this._div=_9.removeChild(this._div);}dojo.destroy(this._div);this._map=this._layerIndex=this._div=null;var dd=dojo.disconnect;dd(this._onPanHandler_connect);dd(this._onExtentChangeHandler_connect);dd(this._onZoomHandler_connect);dd(this._onResizeHandler_connect);dd(this._opacityChangeHandler_connect);dd(this._visibilityChangeHandler_connect);this._toggleTime();},_onResizeHandler:function(_a,_b,_c){dojo.style(this._div,{width:_b+"px",height:_c+"px"});this._onExtentChangeHandler(_a);},_visibilityChangeHandler:function(v){var dc=dojo.connect,dd=dojo.disconnect;this._toggleTime();if(v){this._onExtentChangeHandler(this._map.extent);this._onPanHandler_connect=dc(this._map,"onPan",this,"_onPanHandler");this._onExtentChangeHandler_connect=dc(this._map,"onExtentChange",this,"_onExtentChangeHandler");this._onZoomHandler_connect=dc(this._map,"onZoom",this,"_onZoomHandler");}else{esri.hide(this._div);dd(this._onPanHandler_connect);dd(this._onExtentChangeHandler_connect);dd(this._onZoomHandler_connect);}},_toggleTime:function(){var _d=this._map;if(this.timeInfo&&this.useMapTime&&_d&&this.visible){if(!this._timeConnect){this._timeConnect=dojo.connect(_d,"onTimeExtentChange",this,this._onTimeExtentChangeHandler);}this._setTime(_d.timeExtent);}else{dojo.disconnect(this._timeConnect);this._timeConnect=null;this._setTime(null);}},_setTime:function(_e){if(this._params){this._params.time=_e?_e.toJson().join(","):null;}},_onPanHandler:function(_f,_10){this._panDx=_10.x;this._panDy=_10.y;var _11=this._img_dragOrigin,img=this._img;if(img){dojo.style(img,{left:(_11.x+_10.x)+"px",top:(_11.y+_10.y)+"px"});}},_onExtentChangeHandler:function(_12,_13,_14){if(!this.visible){return;}this._fireUpdateStart();var _15=this._map,_16=this._img,_17=_16&&_16.style,_18=this._img_dragOrigin;if(_13&&!_14&&_16&&(_13.x!==this._panDx||_13.y!==this._panDy)){dojo.style(_16,{left:(_18.x+_13.x)+"px",top:(_18.y+_13.y)+"px"});}if(_16){_18.x=parseInt(_17.left);_18.y=parseInt(_17.top);}else{_18.x=(_18.y=0);}var _19=this._img_loading;if(_19){dojo.disconnect(_19._onload_connect);dojo.disconnect(_19._onerror_connect);dojo.disconnect(_19._onabort_connect);dojo.destroy(_19);this._img_loading=null;var _1a=this._jsonRequest;if(_1a){try{_1a.cancel();}catch(e){}this._jsonRequest=null;}}if(this.version>=10&&_15.wrapAround180){_12=_12._normalize(true);}if(this.isPNG32){var div=(this._img_loading=dojo.create("div"));div.id=_15.id+"_"+this.id+"_"+new Date().getTime();dojo.style(div,{position:"absolute",left:"0px",top:"0px",width:_15.width+"px",height:_15.height+"px"});var _1b=div.appendChild(dojo.create("div"));dojo.style(_1b,{opacity:0,width:_15.width+"px",height:_15.height+"px"});this.getImageUrl(_12,_15.width,_15.height,this._divAlphaImageFunc);div=null;}else{var img=(this._img_loading=dojo.create("img"));img.id=_15.id+"_"+this.id+"_"+new Date().getTime();var _1c={position:"absolute",left:"0px",top:"0px",width:_15.width+"px",height:_15.height+"px"};var _1d=dojo.isIE;if(_1d&&_1d>7){_1c.opacity=this.opacity;}dojo.style(img,_1c);img._onload_connect=dojo.connect(img,"onload",this,"_onLoadHandler");img._onerror_connect=dojo.connect(img,"onerror",this,"_onErrorHandler");img._onabort_connect=dojo.connect(img,"onabort",this,"_onErrorHandler");this._startRect={left:_18.x,top:_18.y,width:_16?parseInt(_17.width):_15.width,height:_16?parseInt(_17.height):_15.height,zoom:(_17&&_17.zoom)?parseFloat(_17.zoom):1};this.getImageUrl(_12,_15.width,_15.height,this._imgSrcFunc);img=null;}},_onTimeExtentChangeHandler:function(_1e){if(!this.visible){return;}this._setTime(_1e);this.refresh(true);},getImageUrl:function(_1f,wd,ht,_20){},_imgSrcFunc:function(src){this._img_loading.src=src;},_divAlphaImageFunc:function(src){dojo.style(this._img_loading,"filter","progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+src+"', sizingMethod='scale')");this._onLoadHandler({currentTarget:this._img_loading});},_onLoadHandler:function(evt){var img=evt.currentTarget,dd=dojo.disconnect,_21=this._map;dd(img._onload_connect);dd(img._onerror_connect);dd(img._onabort_connect);if(!_21||_21.__panning){dojo.destroy(img);this._fireUpdateEnd();return;}dojox.xml.parser.removeChildren(this._div);this._img=img;this._startRect={left:0,top:0,width:_21.width,height:_21.height,zoom:1};this._div.appendChild(img);if(this.visible){esri.show(this._div);}img._onload_connect=img._onerror_connect=img._onabort_connect=this._img_loading=null;var _22=this._img_dragOrigin;_22.x=(_22.y=0);this.onUpdate();this._fireUpdateEnd();},_onErrorHandler:function(evt){var img=evt.currentTarget,dd=dojo.disconnect;dojo.style(img,"visibility","hidden");dd(img._onload_connect);dd(img._onerror_connect);dd(img._onabort_connect);img._onload_connect=img._onerror_connect=img._onabort_connect=null;var _23=new Error(esri.bundle.layers.dynamic.imageError+": "+img.src);this.onError(_23);this._fireUpdateEnd(_23);},setUseMapTime:function(use,_24){this.useMapTime=use;this._toggleTime();if(!_24){this.refresh(true);}},refresh:function(){if(this._map){this._onExtentChangeHandler(this._map.extent);}},_onZoomHandler:function(_25,_26,_27){var _28=this._startRect,_29={width:_28.width*_26,height:_28.height*_26},img=this._img;if(img){var _2a=dojo.isIE;if(_2a&&_2a<8){dojo.style(img,{left:(_28.left-((_29.width-_28.width)*(_27.x-_28.left)/_28.width))+"px",top:(_28.top-((_29.height-_28.height)*(_27.y-_28.top)/_28.height))+"px",zoom:_26*_28.zoom});}else{dojo.style(img,{left:(_28.left-((_29.width-_28.width)*(_27.x-_28.left)/_28.width))+"px",top:(_28.top-((_29.height-_28.height)*(_27.y-_28.top)/_28.height))+"px",width:_29.width+"px",height:_29.height+"px"});}}},_exportMapImage:function(url,_2b,_2c){var _2d=this._exportMapImageHandler;esri.request({url:url,content:_2b,callbackParamName:"callback",load:function(){_2d(arguments[0],arguments[1],_2c);},error:esri.config.defaults.io.errorHandler});},_exportMapImageHandler:function(_2e,io,_2f){var _30=new esri.layers.MapImage(_2e);this.onMapImageExport(_30);if(_2f){_2f(_30);}},onMapImageExport:function(){},setOpacity:function(o){if(this.opacity!=o){this.onOpacityChange(this.opacity=o);}},onOpacityChange:function(){},_opacityChangeHandler:function(_31){dojo.style(this._div,"opacity",_31);}});}