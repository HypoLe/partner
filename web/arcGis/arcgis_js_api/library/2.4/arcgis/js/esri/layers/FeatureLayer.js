/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */

if(!dojo._hasResource["esri.layers.FeatureLayer"]){dojo._hasResource["esri.layers.FeatureLayer"]=true;dojo.provide("esri.layers.FeatureLayer");dojo.require("esri.layers.graphics");dojo.require("esri.tasks.query");dojo.require("dojo.io.iframe");dojo.require("esri.layers.agscommon");dojo.declare("esri.layers.FeatureLayer",esri.layers.GraphicsLayer,{constructor:function(_1,_2){this._outFields=_2&&_2.outFields;this._loadCallback=_2&&_2.loadCallback;var _3=_2&&_2._usePatch;this._usePatch=(_3===null||_3===undefined)?true:_3;this._trackIdField=_2&&_2.trackIdField;this.objectIdField=_2&&_2.objectIdField;this._maxOffset=_2&&_2.maxAllowableOffset;this._optEditable=_2&&_2.editable;this.useMapTime=(_2&&_2.hasOwnProperty("useMapTime"))?(!!_2.useMapTime):true;this._selectedFeatures={};this._selectedFeaturesArr=[];this._newFeatures=[];this._deletedFeatures={};this._ulid=this._getUniqueId();var _4=this.constructor,_5=this.mode=(esri._isDefined(_2&&_2.mode)?_2.mode:_4.MODE_ONDEMAND);switch(_5){case _4.MODE_SNAPSHOT:this._mode=new esri.layers._SnapshotMode(this);this._isSnapshot=true;break;case _4.MODE_ONDEMAND:this._tileWidth=(_2&&_2.tileWidth)||512;this._tileHeight=(_2&&_2.tileHeight)||512;this._mode=new esri.layers._OnDemandMode(this);break;case _4.MODE_SELECTION:this._mode=new esri.layers._SelectionMode(this);this._isSelOnly=true;break;}this._initLayer=dojo.hitch(this,this._initLayer);this._selectHandler=dojo.hitch(this,this._selectHandler);if(dojo.isObject(_1)&&_1.layerDefinition){var _6=_1;this._collection=true;this._editable=true;this.mode=_4.MODE_SNAPSHOT;this._initLayer(_6);return this;}this._task=new esri.tasks.QueryTask(this.url);var _7=this._url.path;this._editable=this._fserver=false;if(_7.search(/\/FeatureServer\//i)!==-1){this._fserver=true;}var _8=_2&&_2.resourceInfo;if(_8){this._initLayer(_8);}else{esri.request({url:_7,content:dojo.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:this._initLayer,error:this._errorHandler});}},_initLayer:function(_9,io){if(_9||io){this._json=_9;if(this._collection){this._mode=new esri.layers._SnapshotMode(this);this._isSnapshot=true;this._featureSet=_9.featureSet;this._nextId=_9.nextObjectId;_9=_9.layerDefinition;}else{if(_9.hasOwnProperty("capabilities")){var _a=(this.capabilities=_9.capabilities);if(_a&&_a.toLowerCase().indexOf("editing")!==-1){this._editable=true;}}else{this._editable=this._fserver;}}if(esri._isDefined(this._optEditable)){this._editable=this._optEditable;delete this._optEditable;}this._json=dojo.toJson(this._json);if(this._editable){delete this._maxOffset;}this.minScale=_9.minScale||0;this.maxScale=_9.maxScale||0;this.layerId=_9.id;this.name=_9.name;this.description=_9.description;this.copyright=_9.copyrightText;this.type=_9.type;this.geometryType=_9.geometryType;this.displayField=_9.displayField;this.defaultDefinitionExpression=_9.definitionExpression;this.fullExtent=new esri.geometry.Extent(_9.extent);this._isTable=(this.type==="Table");var _b=this.fields=[];var _c=_9.fields;for(var i=0;i<_c.length;i++){_b.push(new esri.layers.Field(_c[i]));}if(!this.objectIdField){this.objectIdField=_9.objectIdField;if(!this.objectIdField){var _c=_9.fields;for(var i=0;i<_c.length;i++){var _d=_c[i];if(_d.type==="esriFieldTypeOID"){this.objectIdField=_d.name;break;}}}if(!this.objectIdField){console.debug("esri.layers.FeatureLayer: "+esri.substitute({url:this.url},esri.bundle.layers.FeatureLayer.noOIDField));}}if(!esri._isDefined(this._nextId)){var _e=this.objectIdField,_f=-1;if(this._collection&&_e){var _10=this._featureSet,_11=_10&&_10.features,i,il,oid,_12;for(i=0,il=_11?_11.length:0;i<il;i++){_12=_11[i].attributes;oid=_12&&_12[_e];if(oid>_f){_f=oid;}}}this._nextId=(_f+1);}this.globalIdField=_9.globalIdField;this.typeIdField=_9.typeIdField;this.visibilityField=_9.visibilityField;var _13=_9.defaultSymbol;if(_13){this.defaultSymbol=esri.symbol.fromJson(_13);}var _14=this.types=[];var _15=_9.types;if(_15){for(var i=0;i<_15.length;i++){_14.push(new esri.layers.FeatureType(_15[i]));}}var _16=_9.templates;var _17=this.templates=[];if(_16){for(var i=0;i<_16.length;i++){_17.push(new esri.layers.FeatureTemplate(_16[i]));}}var _18=_9.timeInfo;if(_18){this.timeInfo=new esri.layers.TimeInfo(_18);this._startTimeField=_18.startTimeField;this._endTimeField=_18.endTimeField;if(this._startTimeField&&this._endTimeField){this._twoTimeFields=true;}if(this._trackIdField){_18.trackIdField=this._trackIdField;}else{this._trackIdField=_18.trackIdField;}}this.relationships=_9.relationships;this.hasAttachments=(!this._collection&&_9.hasAttachments)?true:false;this.htmlPopupType=_9.htmlPopupType;var _19=_9.drawingInfo;if(!this.renderer){if(_19&&_19.renderer){var _1a=_19.renderer;this.setRenderer(esri.renderer.fromJson(_1a));if(_1a.type==="classBreaks"){this.renderer._setMaxInclusiveness(true);}if(!this._collection){var _1b=_1a.type,_1a=this.renderer,_1c=[];switch(_1b){case "simple":_1c.push(_1a.symbol);break;case "uniqueValue":case "classBreaks":_1c.push(_1a.defaultSymbol);_1c=_1c.concat(dojo.map(_1a.infos,function(_1d){return _1d.symbol;}));break;}_1c=dojo.filter(_1c,esri._isDefined);var _1e=this._url.path+"/images/",_1f=this._getToken();dojo.forEach(_1c,function(sym){var url=sym.url;if(url){if((url.search(/https?\:/)===-1)&&(url.indexOf("data:")===-1)){sym.url=_1e+url;}if(_1f&&sym.url.search(/https?\:/)!==-1){sym.url+=("?token="+_1f);}}});}}else{if(_13){var _15=this.types,_1a;if(_15.length>0){_1a=new esri.renderer.UniqueValueRenderer(this.defaultSymbol,this.typeIdField);dojo.forEach(_15,function(_20){_1a.addValue(_20.id,_20.symbol);});}else{_1a=new esri.renderer.SimpleRenderer(this.defaultSymbol);}this.setRenderer(_1a);}else{if(!this._isTable){var _21;switch(this.geometryType){case "esriGeometryPoint":case "esriGeometryMultipoint":_21=new esri.symbol.SimpleMarkerSymbol();break;case "esriGeometryPolyline":_21=new esri.symbol.SimpleLineSymbol();break;case "esriGeometryPolygon":_21=new esri.symbol.SimpleFillSymbol();break;}this.setRenderer(_21?new esri.renderer.SimpleRenderer(_21):null);}}}}var _22=(_19&&_19.transparency)||0;if(!esri._isDefined(this.opacity)&&_22>0){this.opacity=1-(_22/100);}this.version=_9.currentVersion;if(!this.version){var ver;if("capabilities" in _9||"drawingInfo" in _9||"hasAttachments" in _9||"htmlPopupType" in _9||"relationships" in _9||"timeInfo" in _9||"typeIdField" in _9||"types" in _9){ver=10;}else{ver=9.3;}this.version=ver;}if((dojo.isIE||dojo.isSafari)&&this._editable&&this.version<10.02){this._ts=true;}this.loaded=true;this._fixRendererFields();this._checkFields();if(this._collection){this._fireUpdateStart();var _10=this._featureSet;delete this._featureSet;this._mode._drawFeatures(new esri.tasks.FeatureSet(_10));this._fcAdded=true;}this.onLoad(this);var _23=this._loadCallback;if(_23){delete this._loadCallback;_23(this);}}},setRenderer:function(ren){this.inherited("setRenderer",arguments);var _24=this.renderer;if(_24){this._ager=(_24.declaredClass.indexOf("TemporalRenderer")!==-1&&_24.observationAger&&_24.observationRenderer);var _25=dojo.filter([_24,_24.observationRenderer,_24.latestObservationRenderer,_24.trackRenderer],esri._isDefined);var _26=[];dojo.forEach(_25,function(rnd){_26.push(rnd.attributeField);_26.push(rnd.attributeField2);_26.push(rnd.attributeField3);},this);this._rendererFields=dojo.filter(_26,esri._isDefined);}else{this._ager=false;this._rendererFields=[];}if(this.loaded&&this._rendererFields.length>0){this._fixRendererFields();this._checkFields(this._rendererFields);}if(this.loaded&&this._collection){this._typesDirty=true;}},_setMap:function(map,_27){this._map=map;this._toggleTime(true);var div=this.inherited("_setMap",arguments);this.clearSelection();var _28=this.renderer;if(this.timeInfo){if(this._trackIdField||(_28&&(_28.latestObservationRenderer||_28.trackRenderer))){this._trackManager=new esri.layers._TrackManager(this);this._trackManager.initialize(map);}}if(this.minScale!==0||this.maxScale!==0){this._zoomConnect=dojo.connect(map,"onZoomEnd",this,this._updateStatus);}var _29=this._mode;if(_29){_29.initialize(map);}return div;},_unsetMap:function(map,_2a){var _2b=this._mode;if(_2b){_2b.destroy();this._mode=null;}if(this._trackManager){this._trackManager.destroy();this._trackManager=null;}dojo.disconnect(this._zoomConnect);this._toggleTime(false);this.inherited("_unsetMap",arguments);},refresh:function(){var _2c=this._mode;if(_2c){_2c.refresh();}},isEditable:function(){return this._editable;},setMaxAllowableOffset:function(_2d){if(!this._editable){this._maxOffset=_2d;}return this;},setDefinitionExpression:function(_2e){this._defnExpr=_2e;var _2f=this._mode;if(_2f){_2f.propertyChangeHandler(1);}return this;},getDefinitionExpression:function(){return this._defnExpr;},setTimeDefinition:function(_30){if(this._isSnapshot){this._timeDefn=_30;var _31=this._mode;if(_31){_31.propertyChangeHandler(2);}}return this;},getTimeDefinition:function(){return this._timeDefn;},setTimeOffset:function(_32,_33){this._timeOffset=_32;this._timeOffsetUnits=_33;var _34=this._mode;if(_34){_34.propertyChangeHandler(0);}return this;},setUseMapTime:function(use){this.useMapTime=use;this._toggleTime(!this._suspended);var _35=this._mode;if(_35){_35.propertyChangeHandler(0);}},selectFeatures:function(_36,_37,_38,_39){_37=_37||this.constructor.SELECTION_NEW;var _3a=this._getShallowClone(_36),map=this._map,dfd=esri._fixDfd(new dojo.Deferred(esri._dfdCanceller));_3a.outFields=this._getOutFields();_3a.returnGeometry=true;if(map){_3a.outSpatialReference=new esri.SpatialReference(map.spatialReference.toJson());}if(!this._applyQueryFilters(_3a)){var _3b={features:[]};this._selectHandler(_3b,_37,_38,_39,dfd);return dfd;}var _3c=this._canDoClientSideQuery(_3a);if(_3c){var _3b={features:this._doQuery(_3a,_3c)};this._selectHandler(_3b,_37,_38,_39,dfd);return dfd;}else{if(this._collection){var err=new Error("FeatureLayer::selectFeatures - "+esri.bundle.layers.FeatureLayer.invalidParams);this._resolve([err],null,_39,dfd,true);return dfd;}var _3d=this;if(this._ts){_3a._ts=(new Date()).getTime();}var _3e=dfd._pendingDfd=this._task.execute(_3a);_3e.addCallbacks(function(_3f){_3d._selectHandler(_3f,_37,_38,_39,dfd);},function(err){_3d._resolve([err],null,_39,dfd,true);});return dfd;}},getSelectedFeatures:function(){var _40=this._selectedFeatures,_41=[];for(var _42 in _40){if(_40.hasOwnProperty(_42)){_41.push(_40[_42]);}}return _41;},clearSelection:function(_43){var _44=this._selectedFeatures,_45=this._mode;for(var _46 in _44){if(_44.hasOwnProperty(_46)){this._unSelectFeatureIIf(_46,_45);_45._removeFeatureIIf(_46);}}this._selectedFeatures={};if(this._isSelOnly){_45._applyTimeFilter(true);}if(!_43){this.onSelectionClear();}return this;},setSelectionSymbol:function(_47){this._selectionSymbol=_47;if(_47){var _48=this._selectedFeatures;for(var _49 in _48){if(_48.hasOwnProperty(_49)){_48[_49].setSymbol(_47);}}}return this;},getSelectionSymbol:function(){return this._selectionSymbol;},__msigns:[{n:"applyEdits",c:5,a:[{i:0},{i:1}],e:4,f:1}],applyEdits:function(_4a,_4b,_4c,_4d,_4e,_4f){var _50=_4f.assembly,dfd=_4f.dfd;this._applyNormalized(_4a,_50&&_50[0]);this._applyNormalized(_4b,_50&&_50[1]);this.onBeforeApplyEdits(_4a,_4b,_4c);var _51={},_52=this.objectIdField,_53={f:"json"},_54=false;if(this._collection){var _55={};_55.addResults=_4a?dojo.map(_4a,function(){_54=true;return {objectId:this._nextId++,success:true};},this):null;_55.updateResults=_4b?dojo.map(_4b,function(_56){_54=true;var oid=_56.attributes[_52];_51[oid]=_56;return {objectId:oid,success:true};},this):null;_55.deleteResults=_4c?dojo.map(_4c,function(_57){_54=true;return {objectId:_57.attributes[_52],success:true};},this):null;if(_54){this._editHandler(_55,_4a,_51,_4d,_4e,dfd);}return;}if(_4a&&_4a.length>0){_53.adds=this._convertFeaturesToJson(_4a);_54=true;}if(_4b&&_4b.length>0){for(var i=0;i<_4b.length;i++){var _58=_4b[i];_51[_58.attributes[_52]]=_58;}_53.updates=this._convertFeaturesToJson(_4b);_54=true;}if(_4c&&_4c.length>0){var ids=[];for(var i=0;i<_4c.length;i++){ids.push(_4c[i].attributes[_52]);}_53.deletes=ids.join(",");_54=true;}if(_54){var _59=this;return esri.request({url:this._url.path+"/applyEdits",content:dojo.mixin(_53,this._url.query),callbackParamName:"callback",load:function(_5a){_59._editHandler(_5a,_4a,_51,_4d,_4e,dfd);},error:function(err){_59._resolve([err],null,_4e,dfd,true);}},{usePost:true});}},queryFeatures:function(_5b,_5c,_5d){return this._query("execute","onQueryFeaturesComplete",_5b,_5c,_5d);},queryRelatedFeatures:function(_5e,_5f,_60){return this._query("executeRelationshipQuery","onQueryRelatedFeaturesComplete",_5e,_5f,_60);},queryIds:function(_61,_62,_63){return this._query("executeForIds","onQueryIdsComplete",_61,_62,_63);},queryCount:function(_64,_65,_66){return this._query("executeForCount","onQueryCountComplete",_64,_65,_66);},queryAttachmentInfos:function(_67,_68,_69){var url=this._url.path+"/"+_67+"/attachments",dfd=new dojo.Deferred(esri._dfdCanceller),_6a=this;dfd._pendingDfd=esri.request({url:url,content:dojo.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:function(_6b){var _6c=_6b.attachmentInfos;dojo.forEach(_6c,function(_6d){_6d.url=url+"/"+_6d.id;_6d.objectId=_67;});_6a._resolve([_6c],"onQueryAttachmentInfosComplete",_68,dfd);},error:function(err){_6a._resolve([err],null,_69,dfd,true);}});return dfd;},addAttachment:function(_6e,_6f,_70,_71){return this._sendAttachment("add",_6e,_6f,_70,_71);},updateAttachment:function(_72,_73,_74,_75,_76){_74.appendChild(dojo.create("input",{type:"hidden",name:"attachmentId",value:_73}));return this._sendAttachment("update",_72,_74,_75,_76);},deleteAttachments:function(_77,_78,_79,_7a){var url=this._url.path+"/"+_77+"/deleteAttachments",dfd=new dojo.Deferred(esri._dfdCanceller),_7b=this,_7c={f:"json",attachmentIds:_78.join(",")};dfd._pendingDfd=esri.request({url:url,content:dojo.mixin(_7c,this._url.query),callbackParamName:"callback",load:dojo.hitch(this,function(_7d){var _7e=_7d.deleteAttachmentResults;_7e=dojo.map(_7e,function(_7f){var res=new esri.layers.FeatureEditResult(_7f);res.attachmentId=res.objectId;res.objectId=_77;return res;});_7b._resolve([_7e],"onDeleteAttachmentsComplete",_79,dfd);}),error:function(err){_7b._resolve([err],null,_7a,dfd,true);}},{usePost:true});return dfd;},addType:function(_80){if(!this._collection){return false;}var _81=this.types;if(_81){var _82=dojo.some(_81,function(_83,_84){if(_83.id==_80.id){return true;}return false;});if(_82){return false;}else{_81.push(_80);}}else{this.types=[_80];}this._typesDirty=true;return true;},deleteType:function(_85){if(!this._collection){return;}var _86=this.types;if(_86){var _87=-1;dojo.some(_86,function(_88,_89){if(_88.id==_85){_87=_89;return true;}return false;});if(_87>-1){this._typesDirty=true;return _86.splice(_87,1)[0];}}},toJson:function(){var _8a=this._json,_8b=dojo.isString(_8a)?dojo.fromJson(_8a):dojo.clone(_8a);if(!_8b){return;}_8b=_8b.layerDefinition?_8b:{layerDefinition:_8b};var _8c=_8b.layerDefinition,_8d=this._collection;if(_8d&&this._typesDirty){_8c.types=dojo.map(this.types||[],function(_8e){return _8e.toJson();});var _8f=this.renderer,_90=_8c.drawingInfo;if(_90&&_8f&&_8f.declaredClass.indexOf("TemporalRenderer")===-1){_90.renderer=_8f.toJson();}}var _91=null;if(!(_8d&&!this._fcAdded)){_91={geometryType:_8c.geometryType,features:this._convertFeaturesToJson(this.graphics,true)};}_8b.featureSet=dojo.mixin({},_8b.featureSet||{},_91);if(_8d){_8b.nextObjectId=this._nextId;}return _8b;},onSelectionComplete:function(){},onSelectionClear:function(){},onBeforeApplyEdits:function(){},onEditsComplete:function(){},onQueryFeaturesComplete:function(){},onQueryRelatedFeaturesComplete:function(){},onQueryIdsComplete:function(){},onQueryCountComplete:function(){},onQueryAttachmentInfosComplete:function(){},onAddAttachmentComplete:function(){},onUpdateAttachmentComplete:function(){},onDeleteAttachmentsComplete:function(){},_counter:{value:0},_getUniqueId:function(){return this._counter.value++;},_getDesiredStatus:function(){return this.visible&&this._isMapAtVisibleScale();},_isMapAtVisibleScale:function(){var _92=esri.geometry.getScale(this._map);var _93=this.minScale,_94=this.maxScale,_95=!_93,_96=!_94;if(!_95&&_92<=_93){_95=true;}if(!_96&&_92>=_94){_96=true;}return (_95&&_96)?true:false;},_suspend:function(){this.inherited("_suspend",arguments);this._toggleTime(false);var _97=this._mode;if(_97){_97.suspend();}},_resume:function(){this.inherited("_resume",arguments);this._toggleTime(true);var _98=this._mode;if(_98){_98.resume();}},_toggleTime:function(_99){var map=this._map;if(_99&&this.timeInfo&&this.useMapTime&&map){this._mapTimeExtent=map.timeExtent;if(!this._timeConnect){this._timeConnect=dojo.connect(map,"onTimeExtentChange",this,this._timeChangeHandler);}}else{this._mapTimeExtent=null;dojo.disconnect(this._timeConnect);this._timeConnect=null;}},_timeChangeHandler:function(_9a){this._mapTimeExtent=_9a;var _9b=this._mode;if(_9b){_9b.propertyChangeHandler(0);}},_getOffsettedTE:function(_9c){var _9d=this._timeOffset,_9e=this._timeOffsetUnits;return (_9c&&_9d&&_9e)?_9c.offset(-1*_9d,_9e):_9c;},_getTimeOverlap:function(_9f,_a0){if(_9f&&_a0){return _9f.intersection(_a0);}else{return _9f||_a0;}},_getTimeFilter:function(_a1){var _a2=this.getTimeDefinition(),_a3=null,_a4;if(_a2||_a3){_a4=this._getTimeOverlap(_a2,_a3);if(!_a4){return [false];}}if(_a1){_a1=_a4?this._getTimeOverlap(_a1,_a4):_a1;if(!_a1){return [false];}}else{_a1=_a4;}return [true,_a1];},_getAttributeFilter:function(_a5){var _a6=this.getDefinitionExpression();if(_a5){_a5=_a6?"("+_a6+") AND ("+_a5+")":_a5;}else{_a5=_a6;}return _a5;},_applyQueryFilters:function(_a7){_a7.where=this._getAttributeFilter(_a7.where);_a7.maxAllowableOffset=this._maxOffset;if(this.timeInfo){var _a8=this._getTimeFilter(_a7.timeExtent);if(!_a8[0]){return false;}else{_a7.timeExtent=_a8[1];}}return true;},_isNew:function(_a9){var _aa=dojo.indexOf(this._newFeatures,_a9);return _aa===-1?false:true;},_isDeleted:function(_ab){var _ac=_ab.attributes,_ad=this.objectIdField,oid=_ac[_ad];return this._deletedFeatures[oid]?true:false;},_add:function(_ae){var _af=this._selectionSymbol,_b0=_ae.attributes,_b1=this.visibilityField;if(_af&&this._isSelOnly){_ae.setSymbol(_af);}if(_b1&&_b0&&_b0.hasOwnProperty(_b1)){_ae[_b0[_b1]?"show":"hide"]();}return this.add.apply(this,arguments);},_remove:function(){return this.remove.apply(this,arguments);},_canDoClientSideQuery:function(_b2){var _b3=[],map=this._map;if(this._isTable||!map){return;}if(_b2.text||(_b2.where&&_b2.where!==this.getDefinitionExpression())){return;}var _b4=this._isSnapshot,_b5=this._isSelOnly;var _b6=_b2.geometry;if(_b6){if(!_b5&&_b2.spatialRelationship===esri.tasks.Query.SPATIAL_REL_INTERSECTS&&(_b6.type==="extent"&&(_b4||map.extent.contains(_b6)))){_b3.push(1);}else{return;}}var ids=_b2.objectIds;if(ids){if(_b4){_b3.push(2);}else{var len=ids.length,_b7=this._mode,_b8=0;for(var i=0;i<len;i++){if(_b7._getFeature(ids[i])){_b8++;}}if(_b8===len){_b3.push(2);}else{return;}}}if(this.timeInfo){var _b9=_b2.timeExtent,_ba=this._mapTimeExtent;if(_b4){if(_b9){_b3.push(3);}}else{if(_b5){if(_b9){return;}}else{if(_ba){if(dojo.indexOf(_b3,2)!==-1){if(_b9){_b3.push(3);}}else{return;}}else{if(_b3.length>0){if(_b9){_b3.push(3);}}else{if(_b9){return;}}}}}}return _b3.length>0?_b3:null;},_doQuery:function(_bb,_bc,_bd){var _be=[],_bf=this._mode,_c0=this.objectIdField;if(dojo.indexOf(_bc,2)!==-1){_be=[];var ids=_bb.objectIds,len=ids.length;for(var i=0;i<len;i++){var obj=_bf._getFeature(ids[i]);if(obj){_be.push(obj);}}if(_be.length===0){return [];}}if(dojo.indexOf(_bc,1)!==-1){var _c1=_be.length>0?_be:this.graphics,len=_c1.length,_c2=_bb.geometry._normalize(null,true);_be=[];for(var i=0;i<len;i++){var _c3=_c1[i],_c4=_c3.geometry;if(this.normalization&&_c2.length){if(_c2[0].intersects(_c4)||_c2[1].intersects(_c4)){_be.push(_c3);}}else{if(_c2.intersects(_c4)){_be.push(_c3);}}}if(_be.length===0){return [];}}if(dojo.indexOf(_bc,3)!==-1){if(this.timeInfo){var _c1=_be.length>0?_be:this.graphics,_c5=_bb.timeExtent;var _c6=this._filterByTime(_c1,_c5.startTime,_c5.endTime);_be=_c6.match;}}if(_bd){return dojo.map(_be,function(obj){return obj.attributes[_c0];},this);}else{return _be;}},_filterByTime:function(_c7,_c8,_c9){var _ca=this._startTimeField,_cb=this._endTimeField,_cc;if(!this._twoTimeFields){_cc=_ca||_cb;}var _cd=esri._isDefined,yea=[],nay=[];_c8=_c8?_c8.getTime():-Infinity;_c9=_c9?_c9.getTime():Infinity;if(_cc){for(var i=0,len=_c7.length;i<len;i++){var _ce=_c7[i],_cf=_ce.attributes;var _d0=_cf[_cc];if(_d0>=_c8&&_d0<=_c9){yea.push(_ce);}else{nay.push(_ce);}}}else{for(var i=0,len=_c7.length;i<len;i++){var _ce=_c7[i],_cf=_ce.attributes;var _d1=_cf[_ca],end=_cf[_cb];_d1=_cd(_d1)?_d1:-Infinity;end=_cd(end)?end:Infinity;if((_d1>=_c8&&_d1<=_c9)||(end>=_c8&&end<=_c9)){yea.push(_ce);}else{nay.push(_ce);}}}return {match:yea,noMatch:nay};},_resolve:function(_d2,_d3,_d4,dfd,_d5){if(_d3){this[_d3].apply(this,_d2);}if(_d4){_d4.apply(null,_d2);}if(dfd){esri._resDfd(dfd,_d2,_d5);}},_getShallowClone:function(_d6){var _d7=new esri.tasks.Query();for(var _d8 in _d6){if(_d6.hasOwnProperty(_d8)){_d7[_d8]=_d6[_d8];}}return _d7;},_query:function(_d9,_da,_db,_dc,_dd){var _de=this,dfd=new dojo.Deferred(esri._dfdCanceller);var _df=function(_e0,_e1){if(!_e1&&_d9==="execute"&&!_de._isTable){var _e2=_e0.features,_e3=_de._mode,_e4=_de.objectIdField;for(var il=_e2.length,i=il-1;i>=0;i--){var oid=_e2[i].attributes[_e4];var _e5=_e3._getFeature(oid);if(_e5){_e2.splice(i,1,_e5);}}}_de._resolve([_e0],_da,_dc,dfd);};if(_d9!=="executeRelationshipQuery"){_db=this._getShallowClone(_db);_db.outFields=this._getOutFields();_db.returnGeometry=true;var map=this._map;if(map){_db.outSpatialReference=new esri.SpatialReference(map.spatialReference.toJson());}if(!this._applyQueryFilters(_db)){var _e6;switch(_d9){case "execute":_e6=new esri.tasks.FeatureSet({features:[]});break;case "executeForIds":_e6=[];break;case "executeForCount":_e6=0;break;}_df(_e6,true);return dfd;}var _e7=this._canDoClientSideQuery(_db);if(_e7){var _e8=this._doQuery(_db,_e7,(_d9==="executeForIds"||_d9==="executeForCount"));var _e6;switch(_d9){case "execute":_e6=new esri.tasks.FeatureSet();_e6.features=_e8;break;case "executeForIds":_e6=_e8;break;case "executeForCount":_e6=_e8.length;break;}_df(_e6,true);return dfd;}}if(this._collection){var err=new Error("FeatureLayer::_query - "+esri.bundle.layers.FeatureLayer.invalidParams);this._resolve([err],null,_dd,dfd,true);return dfd;}if(this._ts){_db._ts=(new Date()).getTime();}var _e9=dfd._pendingDfd=this._task[_d9](_db);_e9.addCallbacks(_df,function(err){_de._resolve([err],null,_dd,dfd,true);});return dfd;},_convertFeaturesToJson:function(_ea,_eb){var _ec=[],_ed=this._selectionSymbol,_ee=this.visibilityField;for(var i=0;i<_ea.length;i++){var _ef=_ea[i],_f0={},_f1=_ef.geometry,_f2=_ef.attributes,_f3=_ef.symbol;if(_f1){_f0.geometry=_f1.toJson();}if(_ee){_f0.attributes=_f2=dojo.mixin({},_f2);_f2[_ee]=_ef.visible?1:0;}else{if(_f2){_f0.attributes=dojo.mixin({},_f2);}}if(_f3&&(_f3!==_ed)){_f0.symbol=_f3.toJson();}_ec.push(_f0);}return _eb?_ec:dojo.toJson(_ec);},_selectHandler:function(_f4,_f5,_f6,_f7,dfd){var _f8,_f9=this.constructor;switch(_f5){case _f9.SELECTION_NEW:this.clearSelection(true);_f8=true;break;case _f9.SELECTION_ADD:_f8=true;break;case _f9.SELECTION_SUBTRACT:_f8=false;break;}var _fa=_f4.features,_fb=this._mode,_fc=[],_fd=this.objectIdField;if(_f8){for(var i=0;i<_fa.length;i++){var _fe=_fa[i];var oid=_fe.attributes[_fd];var _ff=_fb._addFeatureIIf(oid,_fe);_fc.push(_ff);this._selectFeatureIIf(oid,_ff,_fb);}}else{for(var i=0;i<_fa.length;i++){var _fe=_fa[i];var oid=_fe.attributes[_fd];this._unSelectFeatureIIf(oid,_fb);var _100=_fb._removeFeatureIIf(oid);_fc.push(_100||_fe);}}if(this._isSelOnly){_fb._applyTimeFilter(true);}this._resolve([_fc,_f5],"onSelectionComplete",_f6,dfd);},_selectFeatureIIf:function(oid,_101,mode){var _102=this._selectedFeatures,_103=_102[oid];if(!_103){mode._incRefCount(oid);_102[oid]=_101;if(!this._isTable){this._setSelectSymbol(_101);}}return _103||_101;},_unSelectFeatureIIf:function(oid,mode){var _104=this._selectedFeatures[oid];if(_104){mode._decRefCount(oid);delete this._selectedFeatures[oid];if(!this._isTable){this._setUnSelectSymbol(_104);}}return _104;},_isSelected:function(_105){},_setSelectSymbol:function(_106){var _107=this._selectionSymbol;if(_107&&!this._isSelOnly){_106.setSymbol(_107);}},_setUnSelectSymbol:function(_108){var _109=this._selectionSymbol;if(_109&&!this._isSelOnly){if(_109===_108.symbol){_108.setSymbol(null,true);}}},_getOutFields:function(){var _10a=dojo.filter([this.objectIdField,this.typeIdField,this._startTimeField,this._endTimeField,this._trackIdField].concat(this._rendererFields),function(_10b,_10c,arr){return !!_10b&&(dojo.indexOf(arr,_10b)===_10c);});var _10d=dojo.clone(this._outFields);if(_10d){if(dojo.indexOf(_10d,"*")!==-1){return _10d;}dojo.forEach(_10a,function(_10e){if(dojo.indexOf(_10d,_10e)===-1){_10d.push(_10e);}});return _10d;}else{return _10a;}},_checkFields:function(_10f){var _110=_10f||this._getOutFields();dojo.forEach(_110,function(_111){if(_111==="*"){return;}if(!this._getField(_111)){console.debug("esri.layers.FeatureLayer: "+esri.substitute({url:this.url,field:_111},esri.bundle.layers.FeatureLayer.fieldNotFound));}},this);if(!_10f&&!this._isTable&&!this._fserver&&!this._collection){var _112=dojo.some(this.fields,function(_113){return (_113&&_113.type==="esriFieldTypeGeometry")?true:false;});if(!_112){console.debug("esri.layers.FeatureLayer: "+esri.substitute({url:this.url},esri.bundle.layers.FeatureLayer.noGeometryField));}}},_fixRendererFields:function(){var _114=this.renderer;if(_114&&this.fields.length>0){var _115=dojo.filter([_114,_114.observationRenderer,_114.latestObservationRenderer,_114.trackRenderer],esri._isDefined);var _116=[];dojo.forEach(_115,function(rnd){var _117,_118;_118=rnd.attributeField;if(_118){_117=!this._getField(_118)&&this._getField(_118,true);if(_117){rnd.attributeField=_117.name;}}_118=rnd.attributeField2;if(_118){_117=!this._getField(_118)&&this._getField(_118,true);if(_117){rnd.attributeField2=_117.name;}}_118=rnd.attributeField3;if(_118){_117=!this._getField(_118)&&this._getField(_118,true);if(_117){rnd.attributeField3=_117.name;}}_116.push(rnd.attributeField);_116.push(rnd.attributeField2);_116.push(rnd.attributeField3);},this);this._rendererFields=dojo.filter(_116,esri._isDefined);}},_getField:function(_119,_11a){var _11b=this.fields;if(_11b.length===0){return null;}var _11c;if(_11a){_119=_119.toLowerCase();}dojo.some(_11b,function(_11d){var _11e=false;if(_11a){_11e=(_11d&&_11d.name.toLowerCase()===_119)?true:false;}else{_11e=(_11d&&_11d.name===_119)?true:false;}if(_11e){_11c=_11d;}return _11e;});return _11c;},_getDateOpts:function(){if(!this._dtOpts){var _11f=dojo.map(dojo.filter(this.fields,function(_120){return !!(_120&&_120.type==="esriFieldTypeDate");}),function(_121){return _121.name;});this._dtOpts={properties:_11f};}return this._dtOpts;},_applyNormalized:function(_122,_123){if(_122&&_123){dojo.forEach(_122,function(_124,_125){if(_124&&_123[_125]){_124.setGeometry(_123[_125]);}});}},_editHandler:function(_126,adds,_127,_128,_129,dfd){var _12a=_126.addResults,_12b=_126.updateResults,_12c=_126.deleteResults;var mode=this._mode;var _12d=this._isTable;if(_12a){for(var i=0;i<_12a.length;i++){_12a[i]=new esri.layers.FeatureEditResult(_12a[i]);if(_12d){continue;}var _12e=_12a[i];if(_12e.success){var oid=_12e.objectId,_12f=adds[i],gl=_12f._graphicsLayer;if(gl&&gl!==this){gl.remove(_12f);}var attr=_12f.attributes||{},_130=this.objectIdField;attr[_130]=oid;_12f.setAttributes(attr);mode.drawFeature(_12f);}}}if(_12b){for(var i=0;i<_12b.length;i++){_12b[i]=new esri.layers.FeatureEditResult(_12b[i]);if(_12d){continue;}var _12e=_12b[i];if(_12e.success){var oid=_12e.objectId;var _12f=_127[oid];var _131=mode._getFeature(oid);if(_131){if(_131.geometry!==_12f.geometry){_131.setGeometry(esri.geometry.fromJson(_12f.geometry.toJson()));}this._repaint(_131,oid);}}}}if(_12c){var _132=[];for(var i=0;i<_12c.length;i++){_12c[i]=new esri.layers.FeatureEditResult(_12c[i]);if(_12d){continue;}var _12e=_12c[i];if(_12e.success){var oid=_12e.objectId;var _12f=mode._getFeature(oid);if(_12f){if(this._unSelectFeatureIIf(oid,mode)){_132.push(_12f);}_12f._count=0;mode._removeFeatureIIf(oid);}}}if(_132.length>0){this.onSelectionComplete(_132,this.constructor.SELECTION_SUBTRACT);}}this._resolve([_12a,_12b,_12c],"onEditsComplete",_128,dfd);},_sendAttachment:function(type,_133,_134,_135,_136){var _137=(type==="add")?"addAttachment":"updateAttachment";var url=this._url.path+"/"+_133+"/"+_137;_134.enctype="multipart/form-data";if(dojo.isIE<9){_134.encoding="multipart/form-data";}_134.method="post";var _138=_134.elements;if(!dojo.some(_138,function(el){return el.name==="f";})){_134.appendChild(dojo.create("input",{type:"hidden",name:"f",value:"json"}));}if(!dojo.some(_138,function(el){return el.name==="callback.html";})){_134.appendChild(dojo.create("input",{type:"hidden",name:"callback.html",value:"textarea"}));}var _139=this._getToken();if(_139&&!dojo.some(_138,function(el){return el.name==="token";})){_134.appendChild(dojo.create("input",{type:"hidden",name:"token",value:_139}));}var dfd=new dojo.Deferred(esri._dfdCanceller),self=this,_13a=function(_13b){if(!(_13b instanceof Error)){_13b=dojo.mixin(new Error(),_13b);}self._resolve([_13b],null,_136,dfd,true);},_13c=(esri.config.defaults.io.alwaysUseProxy||!esri._hasSameOrigin(url,window.location.href))?esri._getProxyUrl():null;dfd._pendingDfd=dojo.io.iframe.send({url:(_13c?(_13c.path+"?"):"")+url+"?callback.html=textarea",form:_134,handleAs:"json",load:dojo.hitch(this,function(_13d,io){var _13e=_13d.error;if(_13e){_13a(_13e);return;}var _13f=(type==="add")?"addAttachmentResult":"updateAttachmentResult";var _140=(type==="add")?"onAddAttachmentComplete":"onUpdateAttachmentComplete";var _141=new esri.layers.FeatureEditResult(_13d[_13f]);_141.attachmentId=_141.objectId;_141.objectId=_133;self._resolve([_141],_140,_135,dfd);}),error:_13a});return dfd;},_repaint:function(_142,oid,_143){oid=esri._isDefined(oid)?oid:_142.attributes[this.objectIdField];if(!(oid in this._selectedFeatures)||!this._selectionSymbol){_142.setSymbol(_142.symbol,_143);}},_getKind:function(_144){var _145=this._trackManager;if(_145){return _145.isLatestObservation(_144)?1:0;}return 0;}});dojo.mixin(esri.layers.FeatureLayer,{MODE_SNAPSHOT:0,MODE_ONDEMAND:1,MODE_SELECTION:2,SELECTION_NEW:3,SELECTION_ADD:4,SELECTION_SUBTRACT:5,POPUP_NONE:"esriServerHTMLPopupTypeNone",POPUP_HTML_TEXT:"esriServerHTMLPopupTypeAsHTMLText",POPUP_URL:"esriServerHTMLPopupTypeAsURL"});esri._createWrappers("esri.layers.FeatureLayer");dojo.declare("esri.layers.FeatureType",null,{constructor:function(json){if(json&&dojo.isObject(json)){this.id=json.id;this.name=json.name;var _146=json.symbol;if(_146){this.symbol=esri.symbol.fromJson(_146);}var _147=json.domains;var _148=this.domains={};for(var _149 in _147){if(_147.hasOwnProperty(_149)){var _14a=_147[_149];switch(_14a.type){case "range":_148[_149]=new esri.layers.RangeDomain(_14a);break;case "codedValue":_148[_149]=new esri.layers.CodedValueDomain(_14a);break;case "inherited":_148[_149]=new esri.layers.InheritedDomain(_14a);break;}}}var _14b=json.templates;if(_14b){var _14c=this.templates=[];for(var i=0;i<_14b.length;i++){_14c.push(new esri.layers.FeatureTemplate(_14b[i]));}}}},toJson:function(){var json={id:this.id,name:this.name,symbol:this.symbol&&this.symbol.toJson()};var _14d=this.domains,_14e=this.templates,_14f=esri._sanitize;if(_14d){var _150=json.domains={};for(var _151 in _14d){if(_14d.hasOwnProperty(_151)){_150[_151]=_14d[_151]&&_14d[_151].toJson();}}_14f(_150);}if(_14e){json.templates=dojo.map(_14e,function(_152){return _152.toJson();});}return _14f(json);}});dojo.declare("esri.layers.FeatureTemplate",null,{constructor:function(json){if(json&&dojo.isObject(json)){this.name=json.name;this.description=json.description;this.drawingTool=json.drawingTool;var _153=json.prototype;this.prototype=new esri.Graphic(_153.geometry,null,_153.attributes);}},toJson:function(){return esri._sanitize({name:this.name,description:this.description,drawingTool:this.drawingTool,prototype:this.prototype&&this.prototype.toJson()});}});dojo.mixin(esri.layers.FeatureTemplate,{TOOL_AUTO_COMPLETE_POLYGON:"esriFeatureEditToolAutoCompletePolygon",TOOL_CIRCLE:"esriFeatureEditToolCircle",TOOL_ELLIPSE:"esriFeatureEditToolEllipse",TOOL_FREEHAND:"esriFeatureEditToolFreehand",TOOL_LINE:"esriFeatureEditToolLine",TOOL_NONE:"esriFeatureEditToolNone",TOOL_POINT:"esriFeatureEditToolPoint",TOOL_POLYGON:"esriFeatureEditToolPolygon",TOOL_RECTANGLE:"esriFeatureEditToolRectangle",TOOL_ARROW:"esriFeatureEditToolArrow",TOOL_TRIANGLE:"esriFeatureEditToolTriangle",TOOL_LEFT_ARROW:"esriFeatureEditToolLeftArrow",TOOL_RIGHT_ARROW:"esriFeatureEditToolRightArrow",TOOL_UP_ARROW:"esriFeatureEditToolUpArrow",TOOL_DOWN_ARROW:"esriFeatureEditToolDownArrow"});dojo.declare("esri.layers.FeatureEditResult",null,{constructor:function(json){if(json&&dojo.isObject(json)){this.objectId=json.objectId;this.success=json.success;if(!json.success){var err=json.error;this.error=new Error();this.error.code=err.code;this.error.message=err.description;}}}});dojo.declare("esri.layers._RenderMode",null,{constructor:function(){this._prefix="jsonp_"+(dojo._scopeName||"dojo")+"IoScript";},initialize:function(map){},propertyChangeHandler:function(type){},destroy:function(){},drawFeature:function(_154){},suspend:function(){},resume:function(){},refresh:function(){},_incRefCount:function(oid){var _155=this._featureMap[oid];if(_155){_155._count++;}},_decRefCount:function(oid){var _156=this._featureMap[oid];if(_156){_156._count--;}},_getFeature:function(oid){return this._featureMap[oid];},_addFeatureIIf:function(oid,_157){var fmap=this._featureMap,_158=fmap[oid],_159=this.featureLayer;if(!_158){fmap[oid]=_157;_159._add(_157);_157._count=0;}return _158||_157;},_removeFeatureIIf:function(oid){var _15a=this._featureMap[oid],_15b=this.featureLayer;if(_15a){if(_15a._count){return;}delete this._featureMap[oid];_15b._remove(_15a);}return _15a;},_clearIIf:function(){var _15c=this.featureLayer,_15d=_15c.graphics,_15e=_15c._selectedFeatures,_15f=_15c.objectIdField;for(var i=_15d.length-1;i>=0;i--){var _160=_15d[i];var oid=_160.attributes[_15f];if(oid in _15e){_160._count=1;continue;}_160._count=0;this._removeFeatureIIf(oid);}},_isPending:function(id){var dfd=dojo.io.script[this._prefix+id];return dfd?true:false;},_cancelPendingRequest:function(dfd,id){dfd=dfd||dojo.io.script[this._prefix+id];if(dfd){try{dfd.cancel();dojo.io.script._validCheck(dfd);}catch(e){}}},_purgeRequests:function(){dojo.io.script._validCheck(null);},_toggleVisibility:function(show){var _161=this.featureLayer,_162=_161.graphics,_163=show?"show":"hide";show=show&&_161._ager;for(var i=0,len=_162.length;i<len;i++){var _164=_162[i];_164[_163]();if(show){_161._repaint(_164);}}},_applyTimeFilter:function(_165){var _166=this.featureLayer;if(!_166.timeInfo||_166._suspended){return;}if(!_165){_166._fireUpdateStart();}var _167=_166._trackManager;if(_167){_167.clearTracks();}var defn=_166.getTimeDefinition(),_168=_166._getOffsettedTE(_166._mapTimeExtent);if(_168){_168=_166._getTimeOverlap(defn,_168);if(_168){var _169=_166._filterByTime(_166.graphics,_168.startTime,_168.endTime);if(_167){_167.addFeatures(_169.match);}dojo.forEach(_169.match,function(_16a){var _16b=_16a._shape;if(!_16a.visible){_16a.show();_16b=_16a._shape;_16b&&_16b._moveToFront();}if(_166._ager&&_16b){_166._repaint(_16a);}});dojo.forEach(_169.noMatch,function(_16c){if(_16c.visible){_16c.hide();}});}else{this._toggleVisibility(false);}}else{if(_167){_167.addFeatures(_166.graphics);}this._toggleVisibility(true);}if(_167){_167.moveLatestToFront();_167.drawTracks();}if(!_165){_166._fireUpdateEnd();}}});dojo.declare("esri.layers._SelectionMode",[esri.layers._RenderMode],{constructor:function(_16d){this.featureLayer=_16d;this._featureMap={};},initialize:function(map){this.map=map;this._init=true;},propertyChangeHandler:function(type){if(this._init&&type===0){this._applyTimeFilter();}},destroy:function(){this._init=false;},resume:function(){this.propertyChangeHandler(0);}});dojo.declare("esri.layers._SnapshotMode",[esri.layers._RenderMode],{constructor:function(_16e){this.featureLayer=_16e;this._featureMap={};this._drawFeatures=dojo.hitch(this,this._drawFeatures);this._queryErrorHandler=dojo.hitch(this,this._queryErrorHandler);},initialize:function(map){this.map=map;var _16f=this.featureLayer;if(_16f._collection){this._applyTimeFilter();}else{this._fetchAll();}this._init=true;},propertyChangeHandler:function(type){if(this._init){if(type){this._fetchAll();}else{this._applyTimeFilter();}}},destroy:function(){this._init=false;},drawFeature:function(_170){var _171=this.featureLayer,_172=_171.objectIdField,oid=_170.attributes[_172];if(!_171._isDeleted(_170)){this._addFeatureIIf(oid,_170);this._incRefCount(oid);}},resume:function(){this.propertyChangeHandler(0);},refresh:function(){var _173=this.featureLayer;if(_173._collection){_173._fireUpdateStart();_173._refresh(true);_173._fireUpdateEnd();}else{this._fetchAll();}},_getRequestId:function(_174){var id="_"+_174.name+_174.layerId+_174._ulid;return id.replace(/[^a-zA-Z0-9\_]+/g,"_");},_fetchAll:function(){var _175=this.featureLayer;if(_175._collection){return;}_175._fireUpdateStart();this._clearIIf();this._sendRequest();},_sendRequest:function(){var map=this.map,_176=this.featureLayer,_177=_176.getDefinitionExpression();var _178=new esri.tasks.Query();_178.outFields=_176._getOutFields();_178.where=_177||"1=1";_178.returnGeometry=true;_178.outSpatialReference=new esri.SpatialReference(map.spatialReference.toJson());_178.timeExtent=_176.getTimeDefinition();_178.maxAllowableOffset=_176._maxOffset;if(_176._ts){_178._ts=(new Date()).getTime();}var _179;if(_176._usePatch){_179=this._getRequestId(_176);this._cancelPendingRequest(null,_179);}_176._task.execute(_178,this._drawFeatures,this._queryErrorHandler,_179);},_drawFeatures:function(_17a){this._purgeRequests();var _17b=_17a.features,_17c=this.featureLayer,_17d=_17c.objectIdField;for(var i=0,len=_17b.length;i<len;i++){var _17e=_17b[i];var oid=_17e.attributes[_17d];if(!_17c._isDeleted(_17e)){this._addFeatureIIf(oid,_17e);this._incRefCount(oid);}}this._applyTimeFilter(true);_17c._fireUpdateEnd();},_queryErrorHandler:function(err){this._purgeRequests();var _17f=this.featureLayer;_17f._errorHandler(err);_17f._fireUpdateEnd(err);}});dojo.declare("esri.layers._OnDemandMode",[esri.layers._RenderMode],{constructor:function(_180){this.featureLayer=_180;this._featureMap={};this._queryErrorHandler=dojo.hitch(this,this._queryErrorHandler);},initialize:function(map){this.map=map;this._initialize();this._init=true;},propertyChangeHandler:function(type){if(this._init){if(type<2){this._zoomHandler();}}},destroy:function(){this._disableConnectors();this._init=false;},drawFeature:function(_181){var _182=this._gridLayer,geom=_181.geometry,type=geom.type,_183=[];switch(type){case "point":_183=_182.getCellsInExtent({xmin:geom.x,ymin:geom.y,xmax:geom.x,ymax:geom.y}).cells;break;default:_183=_182.getCellsInExtent(geom.getExtent()).cells;break;}var _184=this._cellMap,_185=this.featureLayer,_186=_185.objectIdField;for(var i=0;i<_183.length;i++){var cell=_183[i];var oid=_181.attributes[_186];if(!_185._isDeleted(_181)){_184[cell.row][cell.col].features.push(_181);this._addFeatureIIf(oid,_181);this._incRefCount(oid);}}},suspend:function(){if(!this._init){return;}this._disableConnectors();},resume:function(){if(!this._init){return;}this._enableConnectors();this._zoomHandler();},refresh:function(){this._zoomHandler();},_initialize:function(){var map=this.map,_187=this.featureLayer;var _188=_187._wrap&&_187._srInfo;this._gridLayer=new esri.layers._GridLayout(new esri.geometry.Point(_188?_188.valid[0]:map.extent.xmin,map.extent.ymax,map.spatialReference),{width:_187._tileWidth,height:_187._tileHeight},{width:map.width,height:map.height},_188);this._ioQueue=[];if(!_187._suspended){this._zoomHandler();this._enableConnectors();}},_enableConnectors:function(){var map=this.map;this._zoomConnect=dojo.connect(map,"onZoomEnd",this,this._zoomHandler);this._panConnect=dojo.connect(map,"onPanEnd",this,this._panHandler);},_disableConnectors:function(){dojo.disconnect(this._zoomConnect);dojo.disconnect(this._panConnect);},_zoomHandler:function(){this._processIOQueue(true);var _189=this.featureLayer;if(_189._suspended){return;}_189._fireUpdateStart();this._clearIIf();var _18a=_189._trackManager;if(_18a){_18a.clearTracks();}this._cellMap={};this._gridLayer.setResolution(this.map.extent);this._sendRequest();},_panHandler:function(){this.featureLayer._fireUpdateStart();this._sendRequest();},_getRequestId:function(_18b,cell){var id="_"+_18b.name+_18b.layerId+_18b._ulid+"_"+cell.resolution+"_"+cell.row+"_"+cell.col;return id.replace(/[^a-zA-Z0-9\_]+/g,"_");},_sendRequest:function(){var _18c=this.featureLayer,map=this.map,_18d=map.extent;var _18e=this._gridLayer.getCellsInExtent(_18d),_18f=_18e.cells;if(!_18c._editable){var _190=this._cellMap;_18f=dojo.filter(_18f,function(cell){if(_190[cell.row]&&_190[cell.row][cell.col]){return false;}return true;});}var _191=_18c._getOutFields();var _192=_18c.getDefinitionExpression();var time=_18c._getOffsettedTE(_18c._mapTimeExtent);var _193=_18c._usePatch,_194=this._ioQueue;this._pending=this._pending||0;for(var i=0;i<_18f.length;i++){var cell=_18f[i];var _195=new esri.tasks.Query();_195.geometry=cell.extent;_195.outFields=_191;_195.where=_192;_195.returnGeometry=true;_195.timeExtent=time;_195.maxAllowableOffset=_18c._maxOffset;if(_18c._ts){_195._ts=(new Date()).getTime();}var _196;if(_193){_196=this._getRequestId(_18c,cell);if(this._isPending(_196)){continue;}}var self=this,func=this._drawFeatures;this._pending++;_194.push(_18c._task.execute(_195,function(){var _197=cell;return function(_198){func.apply(self,[_198,_197]);};}.call(this),this._queryErrorHandler,_196));}this._removeOldCells(_18d);this._endCheck();},_drawFeatures:function(_199,cell){this._finalizeIO();var _19a=this.featureLayer,map=this.map,_19b=map.extent,_19c=cell.extent,row=cell.row,col=cell.col,_19d=_19a.objectIdField;var _19e=_199.features,_19f=this._gridLayer;var _1a0=this._cellMap;var _1a1=_1a0[row]&&_1a0[row][col];if((cell.resolution!=this._gridLayer._resolution)||(!_19f.intersects(_19c,_19b))){if(_1a1){this._removeCell(row,col);}}else{if(_1a1){this._updateCell(_1a1,_19e);}else{cell.features=_19e;_1a0[row]=_1a0[row]||{};_1a0[row][col]=cell;for(var i=0,len=_19e.length;i<len;i++){var _1a2=_19e[i];var oid=_1a2.attributes[_19d];if(!_19a._isDeleted(_1a2)){this._addFeatureIIf(oid,_1a2);this._incRefCount(oid);}}}}this._endCheck();},_queryErrorHandler:function(err){this._finalizeIO();this.featureLayer._errorHandler(err);this._endCheck(true);},_finalizeIO:function(){this._purgeRequests();this._pending--;},_endCheck:function(_1a3){if(this._pending===0){this._processIOQueue();var _1a4=this.featureLayer,_1a5=_1a4._trackManager;if(_1a5){_1a5.clearTracks();_1a5.addFeatures(_1a4.graphics);if(_1a4._ager){dojo.forEach(_1a4.graphics,function(_1a6){if(_1a6._shape){_1a4._repaint(_1a6);}});}_1a5.moveLatestToFront();_1a5.drawTracks();}this.featureLayer._fireUpdateEnd(_1a3&&new Error("FeatureLayer: "+esri.bundle.layers.FeatureLayer.updateError));}},_processIOQueue:function(_1a7){this._ioQueue=dojo.filter(this._ioQueue,function(dfd){var keep=dfd.fired>-1?false:true;return keep;});if(_1a7){dojo.forEach(this._ioQueue,this._cancelPendingRequest);}},_removeOldCells:function(_1a8){var _1a9=this._cellMap,_1aa=this._gridLayer;for(var _1ab in _1a9){if(_1a9[_1ab]){var row=_1a9[_1ab];var _1ac=0,_1ad=0;for(var _1ae in row){if(row[_1ae]){_1ac++;var _1af=row[_1ae].extent;if(!_1aa.intersects(_1af,_1a8)){this._removeCell(_1ab,_1ae);_1ad++;}}}if(_1ad===_1ac){delete _1a9[_1ab];}}}},_updateCell:function(cell,_1b0){var _1b1=this.featureLayer,_1b2=_1b1.objectIdField,_1b3=_1b1._selectedFeatures;cell.features=cell.features||[];for(var i=0,len=_1b0.length;i<len;i++){var _1b4=_1b0[i];var oid=_1b4.attributes[_1b2];var _1b5=this._addFeatureIIf(oid,_1b4);if(_1b5===_1b4){this._incRefCount(oid);cell.features.push(_1b5);}else{if(!(oid in _1b3)){_1b5.setGeometry(_1b4.geometry);_1b5.setAttributes(_1b4.attributes);}}}},_removeCell:function(row,col){var _1b6=this._cellMap,_1b7=this.featureLayer,_1b8=_1b7.objectIdField;var cell=_1b6[row]&&_1b6[row][col];if(cell){delete _1b6[row][col];var _1b9=cell.features;for(var i=0;i<_1b9.length;i++){var _1ba=_1b9[i];var oid=_1ba.attributes[_1b8];this._decRefCount(oid);if(oid in _1b7._selectedFeatures){continue;}this._removeFeatureIIf(oid);}}}});dojo.declare("esri.layers._GridLayout",null,{constructor:function(_1bb,_1bc,_1bd,_1be){this.origin=_1bb;this.cellWidth=_1bc.width;this.cellHeight=_1bc.height;this.mapWidth=_1bd.width;this.mapHeight=_1bd.height;this.srInfo=_1be;},setResolution:function(_1bf){this._resolution=(_1bf.xmax-_1bf.xmin)/this.mapWidth;if(this.srInfo){var _1c0=Math.round((2*this.srInfo.valid[1])/this._resolution),_1c1=Math.round(_1c0/this.cellWidth);this._frameStats=[_1c1,0,_1c1-1];}},getCellCoordinates:function(_1c2){var res=this._resolution,_1c3=this.origin;return {row:Math.floor((_1c3.y-_1c2.y)/(this.cellHeight*res)),col:Math.floor((_1c2.x-_1c3.x)/(this.cellWidth*res))};},normalize:function(col){var _1c4=this._frameStats;if(_1c4){var _1c5=_1c4[0],m180=_1c4[1],p180=_1c4[2];if(col<m180){col=col%_1c5;col=col<m180?col+_1c5:col;}else{if(col>p180){col=col%_1c5;}}}return col;},intersects:function(_1c6,_1c7){var _1c8=this.srInfo;if(_1c8){return dojo.some(_1c7._getParts(_1c8),function(_1c9){return _1c6.intersects(_1c9.extent);});}else{return _1c6.intersects(_1c7);}},getCellExtent:function(row,col){var res=this._resolution,_1ca=this.origin,_1cb=this.cellWidth,_1cc=this.cellHeight;return new esri.geometry.Extent((col*_1cb*res)+_1ca.x,_1ca.y-((row+1)*_1cc*res),((col+1)*_1cb*res)+_1ca.x,_1ca.y-(row*_1cc*res),new esri.SpatialReference(_1ca.spatialReference.toJson()));},getCellsInExtent:function(_1cd){var _1ce=this.getCellCoordinates({x:_1cd.xmin,y:_1cd.ymax}),_1cf=this.getCellCoordinates({x:_1cd.xmax,y:_1cd.ymin}),_1d0=_1ce.row,_1d1=_1cf.row,_1d2=_1ce.col,_1d3=_1cf.col,_1d4=[],i,j,nj;for(i=_1d0;i<=_1d1;i++){for(j=_1d2;j<=_1d3;j++){nj=this.normalize(j);_1d4.push({row:i,col:nj,extent:this.getCellExtent(i,nj),resolution:this._resolution});}}return {minRow:_1d0,maxRow:_1d1,minCol:_1d2,maxCol:_1d3,cells:_1d4};}});dojo.declare("esri.layers._TrackManager",null,{constructor:function(_1d5){this.layer=_1d5;this.trackMap={};},initialize:function(map){this.map=map;var _1d6=this.layer,_1d7=_1d6.renderer.trackRenderer;if(_1d7&&(_1d6.geometryType==="esriGeometryPoint")){var _1d8=(this.container=new esri.layers._GraphicsLayer({id:_1d6.id+"_tracks"}));_1d8._onPanHandler=function(){};_1d8._setMap(map,_1d6._div);_1d8.setRenderer(_1d7);}},addFeatures:function(_1d9){var _1da=this.trackMap,_1db=this.layer,_1dc=_1db._trackIdField;dojo.forEach(_1d9,function(_1dd){var _1de=_1dd.attributes,tkid=_1de[_1dc];var ary=(_1da[tkid]=(_1da[tkid]||[]));ary.push(_1dd);});var _1df=_1db._startTimeField,_1e0=_1db.objectIdField;var _1e1=function(a,b){var _1e2=a.attributes[_1df],_1e3=b.attributes[_1df];if(_1e2===_1e3){return (a.attributes[_1e0]<b.attributes[_1e0])?-1:1;}else{return (_1e2<_1e3)?-1:1;}};for(var tkid in _1da){_1da[tkid].sort(_1e1);}},drawTracks:function(){var _1e4=this.container;if(!_1e4){return;}var _1e5=this.trackMap,sr=this.map.spatialReference;var _1e6=function(_1e7){var _1e8=_1e7.geometry;return [_1e8.x,_1e8.y];};for(var tkid in _1e5){var path=dojo.map(_1e5[tkid],_1e6);_1e4.add(new esri.Graphic(new esri.geometry.Polyline({paths:[path],spatialReference:sr})));}},moveLatestToFront:function(){dojo.forEach(this.getLatestObservations(),function(_1e9){var _1ea=_1e9._shape;_1ea&&_1ea._moveToFront();this._repaint(_1e9,null,true);},this.layer);},getLatestObservations:function(){var _1eb=[];if(!this.layer.renderer.latestObservationRenderer){return _1eb;}var _1ec=this.trackMap;for(var tkid in _1ec){var ary=_1ec[tkid];_1eb.push(ary[ary.length-1]);}return _1eb;},clearTracks:function(){var _1ed=this.getLatestObservations();this.trackMap={};var _1ee=this.container;if(_1ee){_1ee.clear();}dojo.forEach(_1ed,function(_1ef){this._repaint(_1ef,null,true);},this.layer);},isLatestObservation:function(_1f0){var _1f1=this.layer._trackIdField;var _1f2=this.trackMap[_1f0.attributes[_1f1]];if(_1f2){return (_1f2[_1f2.length-1]===_1f0);}return false;},destroy:function(){var _1f3=this.container;if(_1f3){_1f3.clear();_1f3._unsetMap(this.map,this.layer._div);this.container=null;}this.map=null;this.layer=null;this.trackMap=null;}});}