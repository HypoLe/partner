/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */

window[esri._dojoScopeName||"dojo"]._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","esri.layers.FeatureLayer"],["require","esri.layers.graphics"],["require","esri.tasks.query"],["require","dojo.io.iframe"],["require","esri.layers.agscommon"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["esri.layers.FeatureLayer"]){_4._hasResource["esri.layers.FeatureLayer"]=true;_4.provide("esri.layers.FeatureLayer");_4.require("esri.layers.graphics");_4.require("esri.tasks.query");_4.require("dojo.io.iframe");_4.require("esri.layers.agscommon");_4.declare("esri.layers.FeatureLayer",esri.layers.GraphicsLayer,{constructor:function(_7,_8){this._outFields=_8&&_8.outFields;this._loadCallback=_8&&_8.loadCallback;var _9=_8&&_8._usePatch;this._usePatch=(_9===null||_9===undefined)?true:_9;this._trackIdField=_8&&_8.trackIdField;this.objectIdField=_8&&_8.objectIdField;this._maxOffset=_8&&_8.maxAllowableOffset;this._optEditable=_8&&_8.editable;this.useMapTime=(_8&&_8.hasOwnProperty("useMapTime"))?(!!_8.useMapTime):true;this._selectedFeatures={};this._selectedFeaturesArr=[];this._newFeatures=[];this._deletedFeatures={};this._ulid=this._getUniqueId();var _a=this.constructor,_b=this.mode=(esri._isDefined(_8&&_8.mode)?_8.mode:_a.MODE_ONDEMAND);switch(_b){case _a.MODE_SNAPSHOT:this._mode=new esri.layers._SnapshotMode(this);this._isSnapshot=true;break;case _a.MODE_ONDEMAND:this._tileWidth=(_8&&_8.tileWidth)||512;this._tileHeight=(_8&&_8.tileHeight)||512;this._mode=new esri.layers._OnDemandMode(this);break;case _a.MODE_SELECTION:this._mode=new esri.layers._SelectionMode(this);this._isSelOnly=true;break;}this._initLayer=_4.hitch(this,this._initLayer);this._selectHandler=_4.hitch(this,this._selectHandler);if(_4.isObject(_7)&&_7.layerDefinition){var _c=_7;this._collection=true;this._editable=true;this.mode=_a.MODE_SNAPSHOT;this._initLayer(_c);return this;}this._task=new esri.tasks.QueryTask(this.url);var _d=this._url.path;this._editable=this._fserver=false;if(_d.search(/\/FeatureServer\//i)!==-1){this._fserver=true;}var _e=_8&&_8.resourceInfo;if(_e){this._initLayer(_e);}else{esri.request({url:_d,content:_4.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:this._initLayer,error:this._errorHandler});}},_initLayer:function(_f,io){if(_f||io){this._json=_f;if(this._collection){this._mode=new esri.layers._SnapshotMode(this);this._isSnapshot=true;this._featureSet=_f.featureSet;this._nextId=_f.nextObjectId;_f=_f.layerDefinition;}else{if(_f.hasOwnProperty("capabilities")){var _10=(this.capabilities=_f.capabilities);if(_10&&_10.toLowerCase().indexOf("editing")!==-1){this._editable=true;}}else{this._editable=this._fserver;}}if(esri._isDefined(this._optEditable)){this._editable=this._optEditable;delete this._optEditable;}this._json=_4.toJson(this._json);if(this._editable){delete this._maxOffset;}this.minScale=_f.minScale||0;this.maxScale=_f.maxScale||0;this.layerId=_f.id;this.name=_f.name;this.description=_f.description;this.copyright=_f.copyrightText;this.type=_f.type;this.geometryType=_f.geometryType;this.displayField=_f.displayField;this.defaultDefinitionExpression=_f.definitionExpression;this.fullExtent=new esri.geometry.Extent(_f.extent);this._isTable=(this.type==="Table");var _11=this.fields=[];var _12=_f.fields;for(var i=0;i<_12.length;i++){_11.push(new esri.layers.Field(_12[i]));}if(!this.objectIdField){this.objectIdField=_f.objectIdField;if(!this.objectIdField){var _12=_f.fields;for(var i=0;i<_12.length;i++){var _13=_12[i];if(_13.type==="esriFieldTypeOID"){this.objectIdField=_13.name;break;}}}if(!this.objectIdField){console.debug("esri.layers.FeatureLayer: "+esri.substitute({url:this.url},esri.bundle.layers.FeatureLayer.noOIDField));}}if(!esri._isDefined(this._nextId)){var _14=this.objectIdField,_15=-1;if(this._collection&&_14){var _16=this._featureSet,_17=_16&&_16.features,i,il,oid,_18;for(i=0,il=_17?_17.length:0;i<il;i++){_18=_17[i].attributes;oid=_18&&_18[_14];if(oid>_15){_15=oid;}}}this._nextId=(_15+1);}this.globalIdField=_f.globalIdField;this.typeIdField=_f.typeIdField;this.visibilityField=_f.visibilityField;var _19=_f.defaultSymbol;if(_19){this.defaultSymbol=esri.symbol.fromJson(_19);}var _1a=this.types=[];var _1b=_f.types;if(_1b){for(var i=0;i<_1b.length;i++){_1a.push(new esri.layers.FeatureType(_1b[i]));}}var _1c=_f.templates;var _1d=this.templates=[];if(_1c){for(var i=0;i<_1c.length;i++){_1d.push(new esri.layers.FeatureTemplate(_1c[i]));}}var _1e=_f.timeInfo;if(_1e){this.timeInfo=new esri.layers.TimeInfo(_1e);this._startTimeField=_1e.startTimeField;this._endTimeField=_1e.endTimeField;if(this._startTimeField&&this._endTimeField){this._twoTimeFields=true;}if(this._trackIdField){_1e.trackIdField=this._trackIdField;}else{this._trackIdField=_1e.trackIdField;}}this.relationships=_f.relationships;this.hasAttachments=(!this._collection&&_f.hasAttachments)?true:false;this.htmlPopupType=_f.htmlPopupType;var _1f=_f.drawingInfo;if(!this.renderer){if(_1f&&_1f.renderer){var _20=_1f.renderer;this.setRenderer(esri.renderer.fromJson(_20));if(_20.type==="classBreaks"){this.renderer._setMaxInclusiveness(true);}if(!this._collection){var _21=_20.type,_20=this.renderer,_22=[];switch(_21){case "simple":_22.push(_20.symbol);break;case "uniqueValue":case "classBreaks":_22.push(_20.defaultSymbol);_22=_22.concat(_4.map(_20.infos,function(_23){return _23.symbol;}));break;}_22=_4.filter(_22,esri._isDefined);var _24=this._url.path+"/images/",_25=this._getToken();_4.forEach(_22,function(sym){var url=sym.url;if(url){if((url.search(/https?\:/)===-1)&&(url.indexOf("data:")===-1)){sym.url=_24+url;}if(_25&&sym.url.search(/https?\:/)!==-1){sym.url+=("?token="+_25);}}});}}else{if(_19){var _1b=this.types,_20;if(_1b.length>0){_20=new esri.renderer.UniqueValueRenderer(this.defaultSymbol,this.typeIdField);_4.forEach(_1b,function(_26){_20.addValue(_26.id,_26.symbol);});}else{_20=new esri.renderer.SimpleRenderer(this.defaultSymbol);}this.setRenderer(_20);}else{if(!this._isTable){var _27;switch(this.geometryType){case "esriGeometryPoint":case "esriGeometryMultipoint":_27=new esri.symbol.SimpleMarkerSymbol();break;case "esriGeometryPolyline":_27=new esri.symbol.SimpleLineSymbol();break;case "esriGeometryPolygon":_27=new esri.symbol.SimpleFillSymbol();break;}this.setRenderer(_27?new esri.renderer.SimpleRenderer(_27):null);}}}}var _28=(_1f&&_1f.transparency)||0;if(!esri._isDefined(this.opacity)&&_28>0){this.opacity=1-(_28/100);}this.version=_f.currentVersion;if(!this.version){var ver;if("capabilities" in _f||"drawingInfo" in _f||"hasAttachments" in _f||"htmlPopupType" in _f||"relationships" in _f||"timeInfo" in _f||"typeIdField" in _f||"types" in _f){ver=10;}else{ver=9.3;}this.version=ver;}if((_4.isIE||_4.isSafari)&&this._editable&&this.version<10.02){this._ts=true;}this.loaded=true;this._fixRendererFields();this._checkFields();if(this._collection){this._fireUpdateStart();var _16=this._featureSet;delete this._featureSet;this._mode._drawFeatures(new esri.tasks.FeatureSet(_16));this._fcAdded=true;}this.onLoad(this);var _29=this._loadCallback;if(_29){delete this._loadCallback;_29(this);}}},setRenderer:function(ren){this.inherited("setRenderer",arguments);var _2a=this.renderer;if(_2a){this._ager=(_2a.declaredClass.indexOf("TemporalRenderer")!==-1&&_2a.observationAger&&_2a.observationRenderer);var _2b=_4.filter([_2a,_2a.observationRenderer,_2a.latestObservationRenderer,_2a.trackRenderer],esri._isDefined);var _2c=[];_4.forEach(_2b,function(rnd){_2c.push(rnd.attributeField);_2c.push(rnd.attributeField2);_2c.push(rnd.attributeField3);},this);this._rendererFields=_4.filter(_2c,esri._isDefined);}else{this._ager=false;this._rendererFields=[];}if(this.loaded&&this._rendererFields.length>0){this._fixRendererFields();this._checkFields(this._rendererFields);}if(this.loaded&&this._collection){this._typesDirty=true;}},_setMap:function(map,_2d){this._map=map;this._toggleTime(true);var div=this.inherited("_setMap",arguments);this.clearSelection();var _2e=this.renderer;if(this.timeInfo){if(this._trackIdField||(_2e&&(_2e.latestObservationRenderer||_2e.trackRenderer))){this._trackManager=new esri.layers._TrackManager(this);this._trackManager.initialize(map);}}if(this.minScale!==0||this.maxScale!==0){this._zoomConnect=_4.connect(map,"onZoomEnd",this,this._updateStatus);}var _2f=this._mode;if(_2f){_2f.initialize(map);}return div;},_unsetMap:function(map,_30){var _31=this._mode;if(_31){_31.destroy();this._mode=null;}if(this._trackManager){this._trackManager.destroy();this._trackManager=null;}_4.disconnect(this._zoomConnect);this._toggleTime(false);this.inherited("_unsetMap",arguments);},refresh:function(){var _32=this._mode;if(_32){_32.refresh();}},isEditable:function(){return this._editable;},setMaxAllowableOffset:function(_33){if(!this._editable){this._maxOffset=_33;}return this;},setDefinitionExpression:function(_34){this._defnExpr=_34;var _35=this._mode;if(_35){_35.propertyChangeHandler(1);}return this;},getDefinitionExpression:function(){return this._defnExpr;},setTimeDefinition:function(_36){if(this._isSnapshot){this._timeDefn=_36;var _37=this._mode;if(_37){_37.propertyChangeHandler(2);}}return this;},getTimeDefinition:function(){return this._timeDefn;},setTimeOffset:function(_38,_39){this._timeOffset=_38;this._timeOffsetUnits=_39;var _3a=this._mode;if(_3a){_3a.propertyChangeHandler(0);}return this;},setUseMapTime:function(use){this.useMapTime=use;this._toggleTime(!this._suspended);var _3b=this._mode;if(_3b){_3b.propertyChangeHandler(0);}},selectFeatures:function(_3c,_3d,_3e,_3f){_3d=_3d||this.constructor.SELECTION_NEW;var _40=this._getShallowClone(_3c),map=this._map,dfd=esri._fixDfd(new _4.Deferred(esri._dfdCanceller));_40.outFields=this._getOutFields();_40.returnGeometry=true;if(map){_40.outSpatialReference=new esri.SpatialReference(map.spatialReference.toJson());}if(!this._applyQueryFilters(_40)){var _41={features:[]};this._selectHandler(_41,_3d,_3e,_3f,dfd);return dfd;}var _42=this._canDoClientSideQuery(_40);if(_42){var _41={features:this._doQuery(_40,_42)};this._selectHandler(_41,_3d,_3e,_3f,dfd);return dfd;}else{if(this._collection){var err=new Error("FeatureLayer::selectFeatures - "+esri.bundle.layers.FeatureLayer.invalidParams);this._resolve([err],null,_3f,dfd,true);return dfd;}var _43=this;if(this._ts){_40._ts=(new Date()).getTime();}var _44=dfd._pendingDfd=this._task.execute(_40);_44.addCallbacks(function(_45){_43._selectHandler(_45,_3d,_3e,_3f,dfd);},function(err){_43._resolve([err],null,_3f,dfd,true);});return dfd;}},getSelectedFeatures:function(){var _46=this._selectedFeatures,_47=[];for(var _48 in _46){if(_46.hasOwnProperty(_48)){_47.push(_46[_48]);}}return _47;},clearSelection:function(_49){var _4a=this._selectedFeatures,_4b=this._mode;for(var _4c in _4a){if(_4a.hasOwnProperty(_4c)){this._unSelectFeatureIIf(_4c,_4b);_4b._removeFeatureIIf(_4c);}}this._selectedFeatures={};if(this._isSelOnly){_4b._applyTimeFilter(true);}if(!_49){this.onSelectionClear();}return this;},setSelectionSymbol:function(_4d){this._selectionSymbol=_4d;if(_4d){var _4e=this._selectedFeatures;for(var _4f in _4e){if(_4e.hasOwnProperty(_4f)){_4e[_4f].setSymbol(_4d);}}}return this;},getSelectionSymbol:function(){return this._selectionSymbol;},__msigns:[{n:"applyEdits",c:5,a:[{i:0},{i:1}],e:4,f:1}],applyEdits:function(_50,_51,_52,_53,_54,_55){var _56=_55.assembly,dfd=_55.dfd;this._applyNormalized(_50,_56&&_56[0]);this._applyNormalized(_51,_56&&_56[1]);this.onBeforeApplyEdits(_50,_51,_52);var _57={},_58=this.objectIdField,_59={f:"json"},_5a=false;if(this._collection){var _5b={};_5b.addResults=_50?_4.map(_50,function(){_5a=true;return {objectId:this._nextId++,success:true};},this):null;_5b.updateResults=_51?_4.map(_51,function(_5c){_5a=true;var oid=_5c.attributes[_58];_57[oid]=_5c;return {objectId:oid,success:true};},this):null;_5b.deleteResults=_52?_4.map(_52,function(_5d){_5a=true;return {objectId:_5d.attributes[_58],success:true};},this):null;if(_5a){this._editHandler(_5b,_50,_57,_53,_54,dfd);}return;}if(_50&&_50.length>0){_59.adds=this._convertFeaturesToJson(_50);_5a=true;}if(_51&&_51.length>0){for(var i=0;i<_51.length;i++){var _5e=_51[i];_57[_5e.attributes[_58]]=_5e;}_59.updates=this._convertFeaturesToJson(_51);_5a=true;}if(_52&&_52.length>0){var ids=[];for(var i=0;i<_52.length;i++){ids.push(_52[i].attributes[_58]);}_59.deletes=ids.join(",");_5a=true;}if(_5a){var _5f=this;return esri.request({url:this._url.path+"/applyEdits",content:_4.mixin(_59,this._url.query),callbackParamName:"callback",load:function(_60){_5f._editHandler(_60,_50,_57,_53,_54,dfd);},error:function(err){_5f._resolve([err],null,_54,dfd,true);}},{usePost:true});}},queryFeatures:function(_61,_62,_63){return this._query("execute","onQueryFeaturesComplete",_61,_62,_63);},queryRelatedFeatures:function(_64,_65,_66){return this._query("executeRelationshipQuery","onQueryRelatedFeaturesComplete",_64,_65,_66);},queryIds:function(_67,_68,_69){return this._query("executeForIds","onQueryIdsComplete",_67,_68,_69);},queryCount:function(_6a,_6b,_6c){return this._query("executeForCount","onQueryCountComplete",_6a,_6b,_6c);},queryAttachmentInfos:function(_6d,_6e,_6f){var url=this._url.path+"/"+_6d+"/attachments",dfd=new _4.Deferred(esri._dfdCanceller),_70=this;dfd._pendingDfd=esri.request({url:url,content:_4.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:function(_71){var _72=_71.attachmentInfos;_4.forEach(_72,function(_73){_73.url=url+"/"+_73.id;_73.objectId=_6d;});_70._resolve([_72],"onQueryAttachmentInfosComplete",_6e,dfd);},error:function(err){_70._resolve([err],null,_6f,dfd,true);}});return dfd;},addAttachment:function(_74,_75,_76,_77){return this._sendAttachment("add",_74,_75,_76,_77);},updateAttachment:function(_78,_79,_7a,_7b,_7c){_7a.appendChild(_4.create("input",{type:"hidden",name:"attachmentId",value:_79}));return this._sendAttachment("update",_78,_7a,_7b,_7c);},deleteAttachments:function(_7d,_7e,_7f,_80){var url=this._url.path+"/"+_7d+"/deleteAttachments",dfd=new _4.Deferred(esri._dfdCanceller),_81=this,_82={f:"json",attachmentIds:_7e.join(",")};dfd._pendingDfd=esri.request({url:url,content:_4.mixin(_82,this._url.query),callbackParamName:"callback",load:_4.hitch(this,function(_83){var _84=_83.deleteAttachmentResults;_84=_4.map(_84,function(_85){var res=new esri.layers.FeatureEditResult(_85);res.attachmentId=res.objectId;res.objectId=_7d;return res;});_81._resolve([_84],"onDeleteAttachmentsComplete",_7f,dfd);}),error:function(err){_81._resolve([err],null,_80,dfd,true);}},{usePost:true});return dfd;},addType:function(_86){if(!this._collection){return false;}var _87=this.types;if(_87){var _88=_4.some(_87,function(_89,_8a){if(_89.id==_86.id){return true;}return false;});if(_88){return false;}else{_87.push(_86);}}else{this.types=[_86];}this._typesDirty=true;return true;},deleteType:function(_8b){if(!this._collection){return;}var _8c=this.types;if(_8c){var _8d=-1;_4.some(_8c,function(_8e,_8f){if(_8e.id==_8b){_8d=_8f;return true;}return false;});if(_8d>-1){this._typesDirty=true;return _8c.splice(_8d,1)[0];}}},toJson:function(){var _90=this._json,_91=_4.isString(_90)?_4.fromJson(_90):_4.clone(_90);if(!_91){return;}_91=_91.layerDefinition?_91:{layerDefinition:_91};var _92=_91.layerDefinition,_93=this._collection;if(_93&&this._typesDirty){_92.types=_4.map(this.types||[],function(_94){return _94.toJson();});var _95=this.renderer,_96=_92.drawingInfo;if(_96&&_95&&_95.declaredClass.indexOf("TemporalRenderer")===-1){_96.renderer=_95.toJson();}}var _97=null;if(!(_93&&!this._fcAdded)){_97={geometryType:_92.geometryType,features:this._convertFeaturesToJson(this.graphics,true)};}_91.featureSet=_4.mixin({},_91.featureSet||{},_97);if(_93){_91.nextObjectId=this._nextId;}return _91;},onSelectionComplete:function(){},onSelectionClear:function(){},onBeforeApplyEdits:function(){},onEditsComplete:function(){},onQueryFeaturesComplete:function(){},onQueryRelatedFeaturesComplete:function(){},onQueryIdsComplete:function(){},onQueryCountComplete:function(){},onQueryAttachmentInfosComplete:function(){},onAddAttachmentComplete:function(){},onUpdateAttachmentComplete:function(){},onDeleteAttachmentsComplete:function(){},_counter:{value:0},_getUniqueId:function(){return this._counter.value++;},_getDesiredStatus:function(){return this.visible&&this._isMapAtVisibleScale();},_isMapAtVisibleScale:function(){var _98=esri.geometry.getScale(this._map);var _99=this.minScale,_9a=this.maxScale,_9b=!_99,_9c=!_9a;if(!_9b&&_98<=_99){_9b=true;}if(!_9c&&_98>=_9a){_9c=true;}return (_9b&&_9c)?true:false;},_suspend:function(){this.inherited("_suspend",arguments);this._toggleTime(false);var _9d=this._mode;if(_9d){_9d.suspend();}},_resume:function(){this.inherited("_resume",arguments);this._toggleTime(true);var _9e=this._mode;if(_9e){_9e.resume();}},_toggleTime:function(_9f){var map=this._map;if(_9f&&this.timeInfo&&this.useMapTime&&map){this._mapTimeExtent=map.timeExtent;if(!this._timeConnect){this._timeConnect=_4.connect(map,"onTimeExtentChange",this,this._timeChangeHandler);}}else{this._mapTimeExtent=null;_4.disconnect(this._timeConnect);this._timeConnect=null;}},_timeChangeHandler:function(_a0){this._mapTimeExtent=_a0;var _a1=this._mode;if(_a1){_a1.propertyChangeHandler(0);}},_getOffsettedTE:function(_a2){var _a3=this._timeOffset,_a4=this._timeOffsetUnits;return (_a2&&_a3&&_a4)?_a2.offset(-1*_a3,_a4):_a2;},_getTimeOverlap:function(_a5,_a6){if(_a5&&_a6){return _a5.intersection(_a6);}else{return _a5||_a6;}},_getTimeFilter:function(_a7){var _a8=this.getTimeDefinition(),_a9=null,_aa;if(_a8||_a9){_aa=this._getTimeOverlap(_a8,_a9);if(!_aa){return [false];}}if(_a7){_a7=_aa?this._getTimeOverlap(_a7,_aa):_a7;if(!_a7){return [false];}}else{_a7=_aa;}return [true,_a7];},_getAttributeFilter:function(_ab){var _ac=this.getDefinitionExpression();if(_ab){_ab=_ac?"("+_ac+") AND ("+_ab+")":_ab;}else{_ab=_ac;}return _ab;},_applyQueryFilters:function(_ad){_ad.where=this._getAttributeFilter(_ad.where);_ad.maxAllowableOffset=this._maxOffset;if(this.timeInfo){var _ae=this._getTimeFilter(_ad.timeExtent);if(!_ae[0]){return false;}else{_ad.timeExtent=_ae[1];}}return true;},_isNew:function(_af){var _b0=_4.indexOf(this._newFeatures,_af);return _b0===-1?false:true;},_isDeleted:function(_b1){var _b2=_b1.attributes,_b3=this.objectIdField,oid=_b2[_b3];return this._deletedFeatures[oid]?true:false;},_add:function(_b4){var _b5=this._selectionSymbol,_b6=_b4.attributes,_b7=this.visibilityField;if(_b5&&this._isSelOnly){_b4.setSymbol(_b5);}if(_b7&&_b6&&_b6.hasOwnProperty(_b7)){_b4[_b6[_b7]?"show":"hide"]();}return this.add.apply(this,arguments);},_remove:function(){return this.remove.apply(this,arguments);},_canDoClientSideQuery:function(_b8){var _b9=[],map=this._map;if(this._isTable||!map){return;}if(_b8.text||(_b8.where&&_b8.where!==this.getDefinitionExpression())){return;}var _ba=this._isSnapshot,_bb=this._isSelOnly;var _bc=_b8.geometry;if(_bc){if(!_bb&&_b8.spatialRelationship===esri.tasks.Query.SPATIAL_REL_INTERSECTS&&(_bc.type==="extent"&&(_ba||map.extent.contains(_bc)))){_b9.push(1);}else{return;}}var ids=_b8.objectIds;if(ids){if(_ba){_b9.push(2);}else{var len=ids.length,_bd=this._mode,_be=0;for(var i=0;i<len;i++){if(_bd._getFeature(ids[i])){_be++;}}if(_be===len){_b9.push(2);}else{return;}}}if(this.timeInfo){var _bf=_b8.timeExtent,_c0=this._mapTimeExtent;if(_ba){if(_bf){_b9.push(3);}}else{if(_bb){if(_bf){return;}}else{if(_c0){if(_4.indexOf(_b9,2)!==-1){if(_bf){_b9.push(3);}}else{return;}}else{if(_b9.length>0){if(_bf){_b9.push(3);}}else{if(_bf){return;}}}}}}return _b9.length>0?_b9:null;},_doQuery:function(_c1,_c2,_c3){var _c4=[],_c5=this._mode,_c6=this.objectIdField;if(_4.indexOf(_c2,2)!==-1){_c4=[];var ids=_c1.objectIds,len=ids.length;for(var i=0;i<len;i++){var obj=_c5._getFeature(ids[i]);if(obj){_c4.push(obj);}}if(_c4.length===0){return [];}}if(_4.indexOf(_c2,1)!==-1){var _c7=_c4.length>0?_c4:this.graphics,len=_c7.length,_c8=_c1.geometry._normalize(null,true);_c4=[];for(var i=0;i<len;i++){var _c9=_c7[i],_ca=_c9.geometry;if(this.normalization&&_c8.length){if(_c8[0].intersects(_ca)||_c8[1].intersects(_ca)){_c4.push(_c9);}}else{if(_c8.intersects(_ca)){_c4.push(_c9);}}}if(_c4.length===0){return [];}}if(_4.indexOf(_c2,3)!==-1){if(this.timeInfo){var _c7=_c4.length>0?_c4:this.graphics,_cb=_c1.timeExtent;var _cc=this._filterByTime(_c7,_cb.startTime,_cb.endTime);_c4=_cc.match;}}if(_c3){return _4.map(_c4,function(obj){return obj.attributes[_c6];},this);}else{return _c4;}},_filterByTime:function(_cd,_ce,_cf){var _d0=this._startTimeField,_d1=this._endTimeField,_d2;if(!this._twoTimeFields){_d2=_d0||_d1;}var _d3=esri._isDefined,yea=[],nay=[];_ce=_ce?_ce.getTime():-Infinity;_cf=_cf?_cf.getTime():Infinity;if(_d2){for(var i=0,len=_cd.length;i<len;i++){var _d4=_cd[i],_d5=_d4.attributes;var _d6=_d5[_d2];if(_d6>=_ce&&_d6<=_cf){yea.push(_d4);}else{nay.push(_d4);}}}else{for(var i=0,len=_cd.length;i<len;i++){var _d4=_cd[i],_d5=_d4.attributes;var _d7=_d5[_d0],end=_d5[_d1];_d7=_d3(_d7)?_d7:-Infinity;end=_d3(end)?end:Infinity;if((_d7>=_ce&&_d7<=_cf)||(end>=_ce&&end<=_cf)){yea.push(_d4);}else{nay.push(_d4);}}}return {match:yea,noMatch:nay};},_resolve:function(_d8,_d9,_da,dfd,_db){if(_d9){this[_d9].apply(this,_d8);}if(_da){_da.apply(null,_d8);}if(dfd){esri._resDfd(dfd,_d8,_db);}},_getShallowClone:function(_dc){var _dd=new esri.tasks.Query();for(var _de in _dc){if(_dc.hasOwnProperty(_de)){_dd[_de]=_dc[_de];}}return _dd;},_query:function(_df,_e0,_e1,_e2,_e3){var _e4=this,dfd=new _4.Deferred(esri._dfdCanceller);var _e5=function(_e6,_e7){if(!_e7&&_df==="execute"&&!_e4._isTable){var _e8=_e6.features,_e9=_e4._mode,_ea=_e4.objectIdField;for(var il=_e8.length,i=il-1;i>=0;i--){var oid=_e8[i].attributes[_ea];var _eb=_e9._getFeature(oid);if(_eb){_e8.splice(i,1,_eb);}}}_e4._resolve([_e6],_e0,_e2,dfd);};if(_df!=="executeRelationshipQuery"){_e1=this._getShallowClone(_e1);_e1.outFields=this._getOutFields();_e1.returnGeometry=true;var map=this._map;if(map){_e1.outSpatialReference=new esri.SpatialReference(map.spatialReference.toJson());}if(!this._applyQueryFilters(_e1)){var _ec;switch(_df){case "execute":_ec=new esri.tasks.FeatureSet({features:[]});break;case "executeForIds":_ec=[];break;case "executeForCount":_ec=0;break;}_e5(_ec,true);return dfd;}var _ed=this._canDoClientSideQuery(_e1);if(_ed){var _ee=this._doQuery(_e1,_ed,(_df==="executeForIds"||_df==="executeForCount"));var _ec;switch(_df){case "execute":_ec=new esri.tasks.FeatureSet();_ec.features=_ee;break;case "executeForIds":_ec=_ee;break;case "executeForCount":_ec=_ee.length;break;}_e5(_ec,true);return dfd;}}if(this._collection){var err=new Error("FeatureLayer::_query - "+esri.bundle.layers.FeatureLayer.invalidParams);this._resolve([err],null,_e3,dfd,true);return dfd;}if(this._ts){_e1._ts=(new Date()).getTime();}var _ef=dfd._pendingDfd=this._task[_df](_e1);_ef.addCallbacks(_e5,function(err){_e4._resolve([err],null,_e3,dfd,true);});return dfd;},_convertFeaturesToJson:function(_f0,_f1){var _f2=[],_f3=this._selectionSymbol,_f4=this.visibilityField;for(var i=0;i<_f0.length;i++){var _f5=_f0[i],_f6={},_f7=_f5.geometry,_f8=_f5.attributes,_f9=_f5.symbol;if(_f7){_f6.geometry=_f7.toJson();}if(_f4){_f6.attributes=_f8=_4.mixin({},_f8);_f8[_f4]=_f5.visible?1:0;}else{if(_f8){_f6.attributes=_4.mixin({},_f8);}}if(_f9&&(_f9!==_f3)){_f6.symbol=_f9.toJson();}_f2.push(_f6);}return _f1?_f2:_4.toJson(_f2);},_selectHandler:function(_fa,_fb,_fc,_fd,dfd){var _fe,_ff=this.constructor;switch(_fb){case _ff.SELECTION_NEW:this.clearSelection(true);_fe=true;break;case _ff.SELECTION_ADD:_fe=true;break;case _ff.SELECTION_SUBTRACT:_fe=false;break;}var _100=_fa.features,mode=this._mode,_101=[],_102=this.objectIdField;if(_fe){for(var i=0;i<_100.length;i++){var _103=_100[i];var oid=_103.attributes[_102];var _104=mode._addFeatureIIf(oid,_103);_101.push(_104);this._selectFeatureIIf(oid,_104,mode);}}else{for(var i=0;i<_100.length;i++){var _103=_100[i];var oid=_103.attributes[_102];this._unSelectFeatureIIf(oid,mode);var _105=mode._removeFeatureIIf(oid);_101.push(_105||_103);}}if(this._isSelOnly){mode._applyTimeFilter(true);}this._resolve([_101,_fb],"onSelectionComplete",_fc,dfd);},_selectFeatureIIf:function(oid,_106,mode){var _107=this._selectedFeatures,_108=_107[oid];if(!_108){mode._incRefCount(oid);_107[oid]=_106;if(!this._isTable){this._setSelectSymbol(_106);}}return _108||_106;},_unSelectFeatureIIf:function(oid,mode){var _109=this._selectedFeatures[oid];if(_109){mode._decRefCount(oid);delete this._selectedFeatures[oid];if(!this._isTable){this._setUnSelectSymbol(_109);}}return _109;},_isSelected:function(_10a){},_setSelectSymbol:function(_10b){var _10c=this._selectionSymbol;if(_10c&&!this._isSelOnly){_10b.setSymbol(_10c);}},_setUnSelectSymbol:function(_10d){var _10e=this._selectionSymbol;if(_10e&&!this._isSelOnly){if(_10e===_10d.symbol){_10d.setSymbol(null,true);}}},_getOutFields:function(){var _10f=_4.filter([this.objectIdField,this.typeIdField,this._startTimeField,this._endTimeField,this._trackIdField].concat(this._rendererFields),function(_110,_111,arr){return !!_110&&(_4.indexOf(arr,_110)===_111);});var _112=_4.clone(this._outFields);if(_112){if(_4.indexOf(_112,"*")!==-1){return _112;}_4.forEach(_10f,function(_113){if(_4.indexOf(_112,_113)===-1){_112.push(_113);}});return _112;}else{return _10f;}},_checkFields:function(_114){var _115=_114||this._getOutFields();_4.forEach(_115,function(_116){if(_116==="*"){return;}if(!this._getField(_116)){console.debug("esri.layers.FeatureLayer: "+esri.substitute({url:this.url,field:_116},esri.bundle.layers.FeatureLayer.fieldNotFound));}},this);if(!_114&&!this._isTable&&!this._fserver&&!this._collection){var _117=_4.some(this.fields,function(_118){return (_118&&_118.type==="esriFieldTypeGeometry")?true:false;});if(!_117){console.debug("esri.layers.FeatureLayer: "+esri.substitute({url:this.url},esri.bundle.layers.FeatureLayer.noGeometryField));}}},_fixRendererFields:function(){var _119=this.renderer;if(_119&&this.fields.length>0){var _11a=_4.filter([_119,_119.observationRenderer,_119.latestObservationRenderer,_119.trackRenderer],esri._isDefined);var _11b=[];_4.forEach(_11a,function(rnd){var _11c,_11d;_11d=rnd.attributeField;if(_11d){_11c=!this._getField(_11d)&&this._getField(_11d,true);if(_11c){rnd.attributeField=_11c.name;}}_11d=rnd.attributeField2;if(_11d){_11c=!this._getField(_11d)&&this._getField(_11d,true);if(_11c){rnd.attributeField2=_11c.name;}}_11d=rnd.attributeField3;if(_11d){_11c=!this._getField(_11d)&&this._getField(_11d,true);if(_11c){rnd.attributeField3=_11c.name;}}_11b.push(rnd.attributeField);_11b.push(rnd.attributeField2);_11b.push(rnd.attributeField3);},this);this._rendererFields=_4.filter(_11b,esri._isDefined);}},_getField:function(_11e,_11f){var _120=this.fields;if(_120.length===0){return null;}var _121;if(_11f){_11e=_11e.toLowerCase();}_4.some(_120,function(_122){var _123=false;if(_11f){_123=(_122&&_122.name.toLowerCase()===_11e)?true:false;}else{_123=(_122&&_122.name===_11e)?true:false;}if(_123){_121=_122;}return _123;});return _121;},_getDateOpts:function(){if(!this._dtOpts){var _124=_4.map(_4.filter(this.fields,function(_125){return !!(_125&&_125.type==="esriFieldTypeDate");}),function(_126){return _126.name;});this._dtOpts={properties:_124};}return this._dtOpts;},_applyNormalized:function(_127,_128){if(_127&&_128){_4.forEach(_127,function(_129,_12a){if(_129&&_128[_12a]){_129.setGeometry(_128[_12a]);}});}},_editHandler:function(_12b,adds,_12c,_12d,_12e,dfd){var _12f=_12b.addResults,_130=_12b.updateResults,_131=_12b.deleteResults;var mode=this._mode;var _132=this._isTable;if(_12f){for(var i=0;i<_12f.length;i++){_12f[i]=new esri.layers.FeatureEditResult(_12f[i]);if(_132){continue;}var _133=_12f[i];if(_133.success){var oid=_133.objectId,_134=adds[i],gl=_134._graphicsLayer;if(gl&&gl!==this){gl.remove(_134);}var attr=_134.attributes||{},_135=this.objectIdField;attr[_135]=oid;_134.setAttributes(attr);mode.drawFeature(_134);}}}if(_130){for(var i=0;i<_130.length;i++){_130[i]=new esri.layers.FeatureEditResult(_130[i]);if(_132){continue;}var _133=_130[i];if(_133.success){var oid=_133.objectId;var _134=_12c[oid];var _136=mode._getFeature(oid);if(_136){if(_136.geometry!==_134.geometry){_136.setGeometry(esri.geometry.fromJson(_134.geometry.toJson()));}this._repaint(_136,oid);}}}}if(_131){var _137=[];for(var i=0;i<_131.length;i++){_131[i]=new esri.layers.FeatureEditResult(_131[i]);if(_132){continue;}var _133=_131[i];if(_133.success){var oid=_133.objectId;var _134=mode._getFeature(oid);if(_134){if(this._unSelectFeatureIIf(oid,mode)){_137.push(_134);}_134._count=0;mode._removeFeatureIIf(oid);}}}if(_137.length>0){this.onSelectionComplete(_137,this.constructor.SELECTION_SUBTRACT);}}this._resolve([_12f,_130,_131],"onEditsComplete",_12d,dfd);},_sendAttachment:function(type,_138,_139,_13a,_13b){var _13c=(type==="add")?"addAttachment":"updateAttachment";var url=this._url.path+"/"+_138+"/"+_13c;_139.enctype="multipart/form-data";if(_4.isIE<9){_139.encoding="multipart/form-data";}_139.method="post";var _13d=_139.elements;if(!_4.some(_13d,function(el){return el.name==="f";})){_139.appendChild(_4.create("input",{type:"hidden",name:"f",value:"json"}));}if(!_4.some(_13d,function(el){return el.name==="callback.html";})){_139.appendChild(_4.create("input",{type:"hidden",name:"callback.html",value:"textarea"}));}var _13e=this._getToken();if(_13e&&!_4.some(_13d,function(el){return el.name==="token";})){_139.appendChild(_4.create("input",{type:"hidden",name:"token",value:_13e}));}var dfd=new _4.Deferred(esri._dfdCanceller),self=this,_13f=function(_140){if(!(_140 instanceof Error)){_140=_4.mixin(new Error(),_140);}self._resolve([_140],null,_13b,dfd,true);},_141=(esri.config.defaults.io.alwaysUseProxy||!esri._hasSameOrigin(url,window.location.href))?esri._getProxyUrl():null;dfd._pendingDfd=_4.io.iframe.send({url:(_141?(_141.path+"?"):"")+url+"?callback.html=textarea",form:_139,handleAs:"json",load:_4.hitch(this,function(_142,io){var _143=_142.error;if(_143){_13f(_143);return;}var _144=(type==="add")?"addAttachmentResult":"updateAttachmentResult";var _145=(type==="add")?"onAddAttachmentComplete":"onUpdateAttachmentComplete";var _146=new esri.layers.FeatureEditResult(_142[_144]);_146.attachmentId=_146.objectId;_146.objectId=_138;self._resolve([_146],_145,_13a,dfd);}),error:_13f});return dfd;},_repaint:function(_147,oid,_148){oid=esri._isDefined(oid)?oid:_147.attributes[this.objectIdField];if(!(oid in this._selectedFeatures)||!this._selectionSymbol){_147.setSymbol(_147.symbol,_148);}},_getKind:function(_149){var _14a=this._trackManager;if(_14a){return _14a.isLatestObservation(_149)?1:0;}return 0;}});_4.mixin(esri.layers.FeatureLayer,{MODE_SNAPSHOT:0,MODE_ONDEMAND:1,MODE_SELECTION:2,SELECTION_NEW:3,SELECTION_ADD:4,SELECTION_SUBTRACT:5,POPUP_NONE:"esriServerHTMLPopupTypeNone",POPUP_HTML_TEXT:"esriServerHTMLPopupTypeAsHTMLText",POPUP_URL:"esriServerHTMLPopupTypeAsURL"});esri._createWrappers("esri.layers.FeatureLayer");_4.declare("esri.layers.FeatureType",null,{constructor:function(json){if(json&&_4.isObject(json)){this.id=json.id;this.name=json.name;var _14b=json.symbol;if(_14b){this.symbol=esri.symbol.fromJson(_14b);}var _14c=json.domains;var _14d=this.domains={};for(var _14e in _14c){if(_14c.hasOwnProperty(_14e)){var _14f=_14c[_14e];switch(_14f.type){case "range":_14d[_14e]=new esri.layers.RangeDomain(_14f);break;case "codedValue":_14d[_14e]=new esri.layers.CodedValueDomain(_14f);break;case "inherited":_14d[_14e]=new esri.layers.InheritedDomain(_14f);break;}}}var _150=json.templates;if(_150){var _151=this.templates=[];for(var i=0;i<_150.length;i++){_151.push(new esri.layers.FeatureTemplate(_150[i]));}}}},toJson:function(){var json={id:this.id,name:this.name,symbol:this.symbol&&this.symbol.toJson()};var _152=this.domains,_153=this.templates,_154=esri._sanitize;if(_152){var _155=json.domains={};for(var _156 in _152){if(_152.hasOwnProperty(_156)){_155[_156]=_152[_156]&&_152[_156].toJson();}}_154(_155);}if(_153){json.templates=_4.map(_153,function(_157){return _157.toJson();});}return _154(json);}});_4.declare("esri.layers.FeatureTemplate",null,{constructor:function(json){if(json&&_4.isObject(json)){this.name=json.name;this.description=json.description;this.drawingTool=json.drawingTool;var _158=json.prototype;this.prototype=new esri.Graphic(_158.geometry,null,_158.attributes);}},toJson:function(){return esri._sanitize({name:this.name,description:this.description,drawingTool:this.drawingTool,prototype:this.prototype&&this.prototype.toJson()});}});_4.mixin(esri.layers.FeatureTemplate,{TOOL_AUTO_COMPLETE_POLYGON:"esriFeatureEditToolAutoCompletePolygon",TOOL_CIRCLE:"esriFeatureEditToolCircle",TOOL_ELLIPSE:"esriFeatureEditToolEllipse",TOOL_FREEHAND:"esriFeatureEditToolFreehand",TOOL_LINE:"esriFeatureEditToolLine",TOOL_NONE:"esriFeatureEditToolNone",TOOL_POINT:"esriFeatureEditToolPoint",TOOL_POLYGON:"esriFeatureEditToolPolygon",TOOL_RECTANGLE:"esriFeatureEditToolRectangle",TOOL_ARROW:"esriFeatureEditToolArrow",TOOL_TRIANGLE:"esriFeatureEditToolTriangle",TOOL_LEFT_ARROW:"esriFeatureEditToolLeftArrow",TOOL_RIGHT_ARROW:"esriFeatureEditToolRightArrow",TOOL_UP_ARROW:"esriFeatureEditToolUpArrow",TOOL_DOWN_ARROW:"esriFeatureEditToolDownArrow"});_4.declare("esri.layers.FeatureEditResult",null,{constructor:function(json){if(json&&_4.isObject(json)){this.objectId=json.objectId;this.success=json.success;if(!json.success){var err=json.error;this.error=new Error();this.error.code=err.code;this.error.message=err.description;}}}});_4.declare("esri.layers._RenderMode",null,{constructor:function(){this._prefix="jsonp_"+(_4._scopeName||"dojo")+"IoScript";},initialize:function(map){},propertyChangeHandler:function(type){},destroy:function(){},drawFeature:function(_159){},suspend:function(){},resume:function(){},refresh:function(){},_incRefCount:function(oid){var _15a=this._featureMap[oid];if(_15a){_15a._count++;}},_decRefCount:function(oid){var _15b=this._featureMap[oid];if(_15b){_15b._count--;}},_getFeature:function(oid){return this._featureMap[oid];},_addFeatureIIf:function(oid,_15c){var fmap=this._featureMap,_15d=fmap[oid],_15e=this.featureLayer;if(!_15d){fmap[oid]=_15c;_15e._add(_15c);_15c._count=0;}return _15d||_15c;},_removeFeatureIIf:function(oid){var _15f=this._featureMap[oid],_160=this.featureLayer;if(_15f){if(_15f._count){return;}delete this._featureMap[oid];_160._remove(_15f);}return _15f;},_clearIIf:function(){var _161=this.featureLayer,_162=_161.graphics,_163=_161._selectedFeatures,_164=_161.objectIdField;for(var i=_162.length-1;i>=0;i--){var _165=_162[i];var oid=_165.attributes[_164];if(oid in _163){_165._count=1;continue;}_165._count=0;this._removeFeatureIIf(oid);}},_isPending:function(id){var dfd=_4.io.script[this._prefix+id];return dfd?true:false;},_cancelPendingRequest:function(dfd,id){dfd=dfd||_4.io.script[this._prefix+id];if(dfd){try{dfd.cancel();_4.io.script._validCheck(dfd);}catch(e){}}},_purgeRequests:function(){_4.io.script._validCheck(null);},_toggleVisibility:function(show){var _166=this.featureLayer,_167=_166.graphics,_168=show?"show":"hide";show=show&&_166._ager;for(var i=0,len=_167.length;i<len;i++){var _169=_167[i];_169[_168]();if(show){_166._repaint(_169);}}},_applyTimeFilter:function(_16a){var _16b=this.featureLayer;if(!_16b.timeInfo||_16b._suspended){return;}if(!_16a){_16b._fireUpdateStart();}var _16c=_16b._trackManager;if(_16c){_16c.clearTracks();}var defn=_16b.getTimeDefinition(),_16d=_16b._getOffsettedTE(_16b._mapTimeExtent);if(_16d){_16d=_16b._getTimeOverlap(defn,_16d);if(_16d){var _16e=_16b._filterByTime(_16b.graphics,_16d.startTime,_16d.endTime);if(_16c){_16c.addFeatures(_16e.match);}_4.forEach(_16e.match,function(_16f){var _170=_16f._shape;if(!_16f.visible){_16f.show();_170=_16f._shape;_170&&_170._moveToFront();}if(_16b._ager&&_170){_16b._repaint(_16f);}});_4.forEach(_16e.noMatch,function(_171){if(_171.visible){_171.hide();}});}else{this._toggleVisibility(false);}}else{if(_16c){_16c.addFeatures(_16b.graphics);}this._toggleVisibility(true);}if(_16c){_16c.moveLatestToFront();_16c.drawTracks();}if(!_16a){_16b._fireUpdateEnd();}}});_4.declare("esri.layers._SelectionMode",[esri.layers._RenderMode],{constructor:function(_172){this.featureLayer=_172;this._featureMap={};},initialize:function(map){this.map=map;this._init=true;},propertyChangeHandler:function(type){if(this._init&&type===0){this._applyTimeFilter();}},destroy:function(){this._init=false;},resume:function(){this.propertyChangeHandler(0);}});_4.declare("esri.layers._SnapshotMode",[esri.layers._RenderMode],{constructor:function(_173){this.featureLayer=_173;this._featureMap={};this._drawFeatures=_4.hitch(this,this._drawFeatures);this._queryErrorHandler=_4.hitch(this,this._queryErrorHandler);},initialize:function(map){this.map=map;var _174=this.featureLayer;if(_174._collection){this._applyTimeFilter();}else{this._fetchAll();}this._init=true;},propertyChangeHandler:function(type){if(this._init){if(type){this._fetchAll();}else{this._applyTimeFilter();}}},destroy:function(){this._init=false;},drawFeature:function(_175){var _176=this.featureLayer,_177=_176.objectIdField,oid=_175.attributes[_177];if(!_176._isDeleted(_175)){this._addFeatureIIf(oid,_175);this._incRefCount(oid);}},resume:function(){this.propertyChangeHandler(0);},refresh:function(){var _178=this.featureLayer;if(_178._collection){_178._fireUpdateStart();_178._refresh(true);_178._fireUpdateEnd();}else{this._fetchAll();}},_getRequestId:function(_179){var id="_"+_179.name+_179.layerId+_179._ulid;return id.replace(/[^a-zA-Z0-9\_]+/g,"_");},_fetchAll:function(){var _17a=this.featureLayer;if(_17a._collection){return;}_17a._fireUpdateStart();this._clearIIf();this._sendRequest();},_sendRequest:function(){var map=this.map,_17b=this.featureLayer,_17c=_17b.getDefinitionExpression();var _17d=new esri.tasks.Query();_17d.outFields=_17b._getOutFields();_17d.where=_17c||"1=1";_17d.returnGeometry=true;_17d.outSpatialReference=new esri.SpatialReference(map.spatialReference.toJson());_17d.timeExtent=_17b.getTimeDefinition();_17d.maxAllowableOffset=_17b._maxOffset;if(_17b._ts){_17d._ts=(new Date()).getTime();}var _17e;if(_17b._usePatch){_17e=this._getRequestId(_17b);this._cancelPendingRequest(null,_17e);}_17b._task.execute(_17d,this._drawFeatures,this._queryErrorHandler,_17e);},_drawFeatures:function(_17f){this._purgeRequests();var _180=_17f.features,_181=this.featureLayer,_182=_181.objectIdField;for(var i=0,len=_180.length;i<len;i++){var _183=_180[i];var oid=_183.attributes[_182];if(!_181._isDeleted(_183)){this._addFeatureIIf(oid,_183);this._incRefCount(oid);}}this._applyTimeFilter(true);_181._fireUpdateEnd();},_queryErrorHandler:function(err){this._purgeRequests();var _184=this.featureLayer;_184._errorHandler(err);_184._fireUpdateEnd(err);}});_4.declare("esri.layers._OnDemandMode",[esri.layers._RenderMode],{constructor:function(_185){this.featureLayer=_185;this._featureMap={};this._queryErrorHandler=_4.hitch(this,this._queryErrorHandler);},initialize:function(map){this.map=map;this._initialize();this._init=true;},propertyChangeHandler:function(type){if(this._init){if(type<2){this._zoomHandler();}}},destroy:function(){this._disableConnectors();this._init=false;},drawFeature:function(_186){var _187=this._gridLayer,geom=_186.geometry,type=geom.type,_188=[];switch(type){case "point":_188=_187.getCellsInExtent({xmin:geom.x,ymin:geom.y,xmax:geom.x,ymax:geom.y}).cells;break;default:_188=_187.getCellsInExtent(geom.getExtent()).cells;break;}var _189=this._cellMap,_18a=this.featureLayer,_18b=_18a.objectIdField;for(var i=0;i<_188.length;i++){var cell=_188[i];var oid=_186.attributes[_18b];if(!_18a._isDeleted(_186)){_189[cell.row][cell.col].features.push(_186);this._addFeatureIIf(oid,_186);this._incRefCount(oid);}}},suspend:function(){if(!this._init){return;}this._disableConnectors();},resume:function(){if(!this._init){return;}this._enableConnectors();this._zoomHandler();},refresh:function(){this._zoomHandler();},_initialize:function(){var map=this.map,_18c=this.featureLayer;var _18d=_18c._wrap&&_18c._srInfo;this._gridLayer=new esri.layers._GridLayout(new esri.geometry.Point(_18d?_18d.valid[0]:map.extent.xmin,map.extent.ymax,map.spatialReference),{width:_18c._tileWidth,height:_18c._tileHeight},{width:map.width,height:map.height},_18d);this._ioQueue=[];if(!_18c._suspended){this._zoomHandler();this._enableConnectors();}},_enableConnectors:function(){var map=this.map;this._zoomConnect=_4.connect(map,"onZoomEnd",this,this._zoomHandler);this._panConnect=_4.connect(map,"onPanEnd",this,this._panHandler);},_disableConnectors:function(){_4.disconnect(this._zoomConnect);_4.disconnect(this._panConnect);},_zoomHandler:function(){this._processIOQueue(true);var _18e=this.featureLayer;if(_18e._suspended){return;}_18e._fireUpdateStart();this._clearIIf();var _18f=_18e._trackManager;if(_18f){_18f.clearTracks();}this._cellMap={};this._gridLayer.setResolution(this.map.extent);this._sendRequest();},_panHandler:function(){this.featureLayer._fireUpdateStart();this._sendRequest();},_getRequestId:function(_190,cell){var id="_"+_190.name+_190.layerId+_190._ulid+"_"+cell.resolution+"_"+cell.row+"_"+cell.col;return id.replace(/[^a-zA-Z0-9\_]+/g,"_");},_sendRequest:function(){var _191=this.featureLayer,map=this.map,_192=map.extent;var _193=this._gridLayer.getCellsInExtent(_192),_194=_193.cells;if(!_191._editable){var _195=this._cellMap;_194=_4.filter(_194,function(cell){if(_195[cell.row]&&_195[cell.row][cell.col]){return false;}return true;});}var _196=_191._getOutFields();var _197=_191.getDefinitionExpression();var time=_191._getOffsettedTE(_191._mapTimeExtent);var _198=_191._usePatch,_199=this._ioQueue;this._pending=this._pending||0;for(var i=0;i<_194.length;i++){var cell=_194[i];var _19a=new esri.tasks.Query();_19a.geometry=cell.extent;_19a.outFields=_196;_19a.where=_197;_19a.returnGeometry=true;_19a.timeExtent=time;_19a.maxAllowableOffset=_191._maxOffset;if(_191._ts){_19a._ts=(new Date()).getTime();}var _19b;if(_198){_19b=this._getRequestId(_191,cell);if(this._isPending(_19b)){continue;}}var self=this,func=this._drawFeatures;this._pending++;_199.push(_191._task.execute(_19a,function(){var _19c=cell;return function(_19d){func.apply(self,[_19d,_19c]);};}.call(this),this._queryErrorHandler,_19b));}this._removeOldCells(_192);this._endCheck();},_drawFeatures:function(_19e,cell){this._finalizeIO();var _19f=this.featureLayer,map=this.map,_1a0=map.extent,_1a1=cell.extent,row=cell.row,col=cell.col,_1a2=_19f.objectIdField;var _1a3=_19e.features,_1a4=this._gridLayer;var _1a5=this._cellMap;var _1a6=_1a5[row]&&_1a5[row][col];if((cell.resolution!=this._gridLayer._resolution)||(!_1a4.intersects(_1a1,_1a0))){if(_1a6){this._removeCell(row,col);}}else{if(_1a6){this._updateCell(_1a6,_1a3);}else{cell.features=_1a3;_1a5[row]=_1a5[row]||{};_1a5[row][col]=cell;for(var i=0,len=_1a3.length;i<len;i++){var _1a7=_1a3[i];var oid=_1a7.attributes[_1a2];if(!_19f._isDeleted(_1a7)){this._addFeatureIIf(oid,_1a7);this._incRefCount(oid);}}}}this._endCheck();},_queryErrorHandler:function(err){this._finalizeIO();this.featureLayer._errorHandler(err);this._endCheck(true);},_finalizeIO:function(){this._purgeRequests();this._pending--;},_endCheck:function(_1a8){if(this._pending===0){this._processIOQueue();var _1a9=this.featureLayer,_1aa=_1a9._trackManager;if(_1aa){_1aa.clearTracks();_1aa.addFeatures(_1a9.graphics);if(_1a9._ager){_4.forEach(_1a9.graphics,function(_1ab){if(_1ab._shape){_1a9._repaint(_1ab);}});}_1aa.moveLatestToFront();_1aa.drawTracks();}this.featureLayer._fireUpdateEnd(_1a8&&new Error("FeatureLayer: "+esri.bundle.layers.FeatureLayer.updateError));}},_processIOQueue:function(_1ac){this._ioQueue=_4.filter(this._ioQueue,function(dfd){var keep=dfd.fired>-1?false:true;return keep;});if(_1ac){_4.forEach(this._ioQueue,this._cancelPendingRequest);}},_removeOldCells:function(_1ad){var _1ae=this._cellMap,_1af=this._gridLayer;for(var _1b0 in _1ae){if(_1ae[_1b0]){var row=_1ae[_1b0];var _1b1=0,_1b2=0;for(var _1b3 in row){if(row[_1b3]){_1b1++;var _1b4=row[_1b3].extent;if(!_1af.intersects(_1b4,_1ad)){this._removeCell(_1b0,_1b3);_1b2++;}}}if(_1b2===_1b1){delete _1ae[_1b0];}}}},_updateCell:function(cell,_1b5){var _1b6=this.featureLayer,_1b7=_1b6.objectIdField,_1b8=_1b6._selectedFeatures;cell.features=cell.features||[];for(var i=0,len=_1b5.length;i<len;i++){var _1b9=_1b5[i];var oid=_1b9.attributes[_1b7];var _1ba=this._addFeatureIIf(oid,_1b9);if(_1ba===_1b9){this._incRefCount(oid);cell.features.push(_1ba);}else{if(!(oid in _1b8)){_1ba.setGeometry(_1b9.geometry);_1ba.setAttributes(_1b9.attributes);}}}},_removeCell:function(row,col){var _1bb=this._cellMap,_1bc=this.featureLayer,_1bd=_1bc.objectIdField;var cell=_1bb[row]&&_1bb[row][col];if(cell){delete _1bb[row][col];var _1be=cell.features;for(var i=0;i<_1be.length;i++){var _1bf=_1be[i];var oid=_1bf.attributes[_1bd];this._decRefCount(oid);if(oid in _1bc._selectedFeatures){continue;}this._removeFeatureIIf(oid);}}}});_4.declare("esri.layers._GridLayout",null,{constructor:function(_1c0,_1c1,_1c2,_1c3){this.origin=_1c0;this.cellWidth=_1c1.width;this.cellHeight=_1c1.height;this.mapWidth=_1c2.width;this.mapHeight=_1c2.height;this.srInfo=_1c3;},setResolution:function(_1c4){this._resolution=(_1c4.xmax-_1c4.xmin)/this.mapWidth;if(this.srInfo){var _1c5=Math.round((2*this.srInfo.valid[1])/this._resolution),_1c6=Math.round(_1c5/this.cellWidth);this._frameStats=[_1c6,0,_1c6-1];}},getCellCoordinates:function(_1c7){var res=this._resolution,_1c8=this.origin;return {row:Math.floor((_1c8.y-_1c7.y)/(this.cellHeight*res)),col:Math.floor((_1c7.x-_1c8.x)/(this.cellWidth*res))};},normalize:function(col){var _1c9=this._frameStats;if(_1c9){var _1ca=_1c9[0],m180=_1c9[1],p180=_1c9[2];if(col<m180){col=col%_1ca;col=col<m180?col+_1ca:col;}else{if(col>p180){col=col%_1ca;}}}return col;},intersects:function(_1cb,_1cc){var _1cd=this.srInfo;if(_1cd){return _4.some(_1cc._getParts(_1cd),function(_1ce){return _1cb.intersects(_1ce.extent);});}else{return _1cb.intersects(_1cc);}},getCellExtent:function(row,col){var res=this._resolution,_1cf=this.origin,_1d0=this.cellWidth,_1d1=this.cellHeight;return new esri.geometry.Extent((col*_1d0*res)+_1cf.x,_1cf.y-((row+1)*_1d1*res),((col+1)*_1d0*res)+_1cf.x,_1cf.y-(row*_1d1*res),new esri.SpatialReference(_1cf.spatialReference.toJson()));},getCellsInExtent:function(_1d2){var _1d3=this.getCellCoordinates({x:_1d2.xmin,y:_1d2.ymax}),_1d4=this.getCellCoordinates({x:_1d2.xmax,y:_1d2.ymin}),_1d5=_1d3.row,_1d6=_1d4.row,_1d7=_1d3.col,_1d8=_1d4.col,_1d9=[],i,j,nj;for(i=_1d5;i<=_1d6;i++){for(j=_1d7;j<=_1d8;j++){nj=this.normalize(j);_1d9.push({row:i,col:nj,extent:this.getCellExtent(i,nj),resolution:this._resolution});}}return {minRow:_1d5,maxRow:_1d6,minCol:_1d7,maxCol:_1d8,cells:_1d9};}});_4.declare("esri.layers._TrackManager",null,{constructor:function(_1da){this.layer=_1da;this.trackMap={};},initialize:function(map){this.map=map;var _1db=this.layer,_1dc=_1db.renderer.trackRenderer;if(_1dc&&(_1db.geometryType==="esriGeometryPoint")){var _1dd=(this.container=new esri.layers._GraphicsLayer({id:_1db.id+"_tracks"}));_1dd._onPanHandler=function(){};_1dd._setMap(map,_1db._div);_1dd.setRenderer(_1dc);}},addFeatures:function(_1de){var _1df=this.trackMap,_1e0=this.layer,_1e1=_1e0._trackIdField;_4.forEach(_1de,function(_1e2){var _1e3=_1e2.attributes,tkid=_1e3[_1e1];var ary=(_1df[tkid]=(_1df[tkid]||[]));ary.push(_1e2);});var _1e4=_1e0._startTimeField,_1e5=_1e0.objectIdField;var _1e6=function(a,b){var _1e7=a.attributes[_1e4],_1e8=b.attributes[_1e4];if(_1e7===_1e8){return (a.attributes[_1e5]<b.attributes[_1e5])?-1:1;}else{return (_1e7<_1e8)?-1:1;}};for(var tkid in _1df){_1df[tkid].sort(_1e6);}},drawTracks:function(){var _1e9=this.container;if(!_1e9){return;}var _1ea=this.trackMap,sr=this.map.spatialReference;var _1eb=function(_1ec){var _1ed=_1ec.geometry;return [_1ed.x,_1ed.y];};for(var tkid in _1ea){var path=_4.map(_1ea[tkid],_1eb);_1e9.add(new esri.Graphic(new esri.geometry.Polyline({paths:[path],spatialReference:sr})));}},moveLatestToFront:function(){_4.forEach(this.getLatestObservations(),function(_1ee){var _1ef=_1ee._shape;_1ef&&_1ef._moveToFront();this._repaint(_1ee,null,true);},this.layer);},getLatestObservations:function(){var _1f0=[];if(!this.layer.renderer.latestObservationRenderer){return _1f0;}var _1f1=this.trackMap;for(var tkid in _1f1){var ary=_1f1[tkid];_1f0.push(ary[ary.length-1]);}return _1f0;},clearTracks:function(){var _1f2=this.getLatestObservations();this.trackMap={};var _1f3=this.container;if(_1f3){_1f3.clear();}_4.forEach(_1f2,function(_1f4){this._repaint(_1f4,null,true);},this.layer);},isLatestObservation:function(_1f5){var _1f6=this.layer._trackIdField;var _1f7=this.trackMap[_1f5.attributes[_1f6]];if(_1f7){return (_1f7[_1f7.length-1]===_1f5);}return false;},destroy:function(){var _1f8=this.container;if(_1f8){_1f8.clear();_1f8._unsetMap(this.map,this.layer._div);this.container=null;}this.map=null;this.layer=null;this.trackMap=null;}});}}};});