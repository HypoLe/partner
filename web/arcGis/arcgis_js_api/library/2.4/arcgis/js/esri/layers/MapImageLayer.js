/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */

if(!dojo._hasResource["esri.layers.MapImageLayer"]){dojo._hasResource["esri.layers.MapImageLayer"]=true;dojo.provide("esri.layers.MapImageLayer");dojo.require("esri.utils");dojo.require("esri.layers.layer");dojo.declare("esri.layers.MapImageLayer",[esri.layers.Layer],{"-chains-":{constructor:"manual"},constructor:function(_1){this.inherited(arguments,[null,_1]);this._mapImages=[];var _2=dojo.hitch;this._panStart=_2(this,this._panStart);this._pan=_2(this,this._pan);this._extentChange=_2(this,this._extentChange);this._zoom=_2(this,this._zoom);this.loaded=true;this.onLoad(this);},opacity:1,setOpacity:function(_3){if(this.opacity!=_3){this.onOpacityChange(this.opacity=_3);}},onOpacityChange:function(_4){if(this._div){dojo.style(this._div,"opacity",_4);}},_transform:esri._getDOMAccessor("transform"),addImage:function(_5){var _6=this._mapImages.push(_5);_6=_6-1;_5._idx=_6;_5._layer=this;if(this._div){this._createImage(_5,_6);}},removeImage:function(_7){if(_7){var _8=_7._idx,_9=this._mapImages;if(_9[_8]===_7){delete _9[_8];var _a=_7._node;if(_a){this._clearEvents(_a);_a.e_idx=_a.e_bl=_a.e_tr=_a.e_l=_a.e_t=_a.e_w=_a.e_h=null;var _b=this._div;if(_b){_b.removeChild(_a);dojo.destroy(_a);}}_7._node=_7._idx=_7._layer=null;}}},removeAllImages:function(){var _c=this._mapImages,i,_d=_c.length;for(i=0;i<_d;i++){var _e=_c[i];if(_e){this.removeImage(_e);}}this._mapImages=[];},getImages:function(){var _f=this._mapImages,_10=[],i,len=_f.length;for(i=0;i<len;i++){if(_f[i]){_10.push(_f[i]);}}return _10;},_createImage:function(_11,idx){var _12=dojo.create("img");dojo.style(_12,{position:"absolute",left:"0px",top:"0px"});if(_11.rotation){var _13="rotate("+(360-_11.rotation)+"deg)";if(dojo.isIE<9){}else{dojo.style(_12,this._transform,_13);dojo.style(_12,"transform",_13);}}_11._node=_12;_12.e_idx=idx;_12.e_layer=this;_12.e_load=dojo.connect(_12,"onload",esri.layers.MapImageLayer.prototype._imageLoaded);_12.e_error=dojo.connect(_12,"onerror",esri.layers.MapImageLayer.prototype._imageError);_12.e_abort=dojo.connect(_12,"onabort",esri.layers.MapImageLayer.prototype._imageError);_12.src=_11.href;},_imageLoaded:function(evt){var _14=evt.target||evt.currentTarget,_15=_14.e_layer,_16=_15._mapImages[_14.e_idx];_15._clearEvents(_14);if(!_16||_16._node!==_14){return;}if(_15._map){_15._attach(_16);}},_imageError:function(evt){var _17=evt.target||evt.currentTarget,_18=_17.e_layer,_19=_18._mapImages[_17.e_idx];_18._clearEvents(_17);if(_19){_19._node=null;}},_clearEvents:function(_1a){var _1b=dojo.disconnect;_1b(_1a.e_load);_1b(_1a.e_error);_1b(_1a.e_abort);_1a.e_load=_1a.e_error=_1a.e_abort=_1a.e_layer=null;},_attach:function(_1c){var _1d=_1c.extent,_1e=_1d.spatialReference,_1f=this._sr,_20=_1e.wkid||4326,div=this._div,_21=_1c._node,_22=new esri.geometry.Point({x:_1d.xmin,y:_1d.ymin}),_23=new esri.geometry.Point({x:_1d.xmax,y:_1d.ymax});if(_1e&&(_20!==_1f.wkid)){if(_20===4326&&_1f._isWebMercator()){_21.e_bl=esri.geometry.geographicToWebMercator(_22);_21.e_tr=esri.geometry.geographicToWebMercator(_23);}else{if(_1e._isWebMercator()&&_1f.wkid===4326){_21.e_bl=esri.geometry.webMercatorToGeographic(_22);_21.e_tr=esri.geometry.webMercatorToGeographic(_23);}}}else{_21.e_bl=_22;_21.e_tr=_23;}if(_1c.visible){this._setPos(_21,dojo.style(div,"left"),dojo.style(div,"top"));div.appendChild(_21);}},_setPos:function(_24,_25,_26){var _27=_24.e_bl,_28=_24.e_tr,map=this._map;_27=map.toScreen(_27);_28=map.toScreen(_28);var _29=_27.x-_25,top=_28.y-_26,_2a=Math.abs(_28.x-_27.x),_2b=Math.abs(_27.y-_28.y);dojo.style(_24,{left:_29+"px",top:top+"px",width:_2a+"px",height:_2b+"px"});_24.e_l=_29;_24.e_t=top;_24.e_w=_2a;_24.e_h=_2b;},_setMap:function(map,_2c){this._map=map;this._sr=map.spatialReference;var div=this._div=dojo.create("div",null,_2c);dojo.style(div,"position","absolute");dojo.style(div,"opacity",this.opacity);var _2d=this._mapImages,i,len=_2d.length;for(i=0;i<len;i++){var _2e=_2d[i],_2f=_2e._node;if(!_2f){this._createImage(_2e,_2e._idx);}}this.onVisibilityChange(this.visible);return div;},_unsetMap:function(map,_30){this._disconnect();var div=this._div;if(div){var _31=this._mapImages,i,len=_31.length;for(i=0;i<len;i++){var _32=_31[i];if(_32){var _33=_32._node;if(_33){this._clearEvents(_33);_33.e_idx=_33.e_bl=_33.e_tr=_33.e_l=_33.e_t=_33.e_w=_33.e_h=null;}_32._node=null;}}_30.removeChild(div);dojo.destroy(div);}this._map=this._div=this._sr=null;},onVisibilityChange:function(_34){var div=this._div;if(div){if(_34){this._redraw();this._connect(this._map);esri.show(div);}else{this._disconnect();esri.hide(div);}}},_connect:function(map){if(!this._connections){var _35=dojo.connect;this._connections=[_35(map,"onPanStart",this._panStart),_35(map,"onPan",this._pan),_35(map,"onExtentChange",this._extentChange),_35(map,"onZoom",this._zoom)];}},_disconnect:function(){if(this._connections){dojo.forEach(this._connections,dojo.disconnect);this._connections=null;}},_panStart:function(){this._panL=dojo.style(this._div,"left");this._panT=dojo.style(this._div,"top");},_pan:function(_36,_37){dojo.style(this._div,{left:this._panL+_37.x+"px",top:this._panT+_37.y+"px"});},_extentChange:function(_38,_39,_3a){if(_3a){this._redraw();}else{if(_39){dojo.style(this._div,{left:this._panL+_39.x+"px",top:this._panT+_39.y+"px"});}}},_redraw:function(){var div=this._div,_3b=dojo.style(div,"left"),_3c=dojo.style(div,"top"),i,len=div.childNodes.length,_3d;for(i=0;i<len;i++){_3d=div.childNodes[i];this._setPos(_3d,_3b,_3c);}},_zoom:function(_3e,_3f,_40){var div=this._div,_41=dojo.style(div,"left"),_42=dojo.style(div,"top"),i,len=div.childNodes.length,_43;for(i=0;i<len;i++){_43=div.childNodes[i];var _44=_43.e_w*_3f,_45=_43.e_h*_3f,_46=(_40.x-_41-_43.e_l)*(_44-_43.e_w)/_43.e_w,_47=(_40.y-_42-_43.e_t)*(_45-_43.e_h)/_43.e_h;_46=isNaN(_46)?0:_46;_47=isNaN(_47)?0:_47;dojo.style(_43,{left:(_43.e_l-_46)+"px",top:(_43.e_t-_47)+"px",width:_44+"px",height:_45+"px"});}}});dojo.extend(esri.layers.MapImage,{visible:true,getLayer:function(){return this._layer;},getNode:function(){return this._node;},show:function(){if(!this.visible){this.visible=true;var _48=this._node,_49=this._layer;if(_48){if(_49&&_49._div){_49._setPos(_48,dojo.style(_49._div,"left"),dojo.style(_49._div,"top"));_49._div.appendChild(_48);}esri.show(_48);}}},hide:function(){if(this.visible){this.visible=false;var _4a=this._node,_4b=this._layer;if(_4a){esri.hide(_4a);_4b&&_4b._div&&_4b._div.removeChild(_4a);}}}});}