/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */

if(!dojo._hasResource["esri.dijit.AttributeInspector"]){dojo._hasResource["esri.dijit.AttributeInspector"]=true;dojo.provide("esri.dijit.AttributeInspector");dojo.require("dojo.fx");dojo.require("dojox.gfx");dojo.require("dijit._Widget");dojo.require("dijit._Templated");dojo.require("dijit.Editor");dojo.require("dijit._editor.plugins.LinkDialog");dojo.require("dijit._editor.plugins.TextColor");dojo.require("esri.dijit.editing.AttachmentEditor");dojo.require("esri.dijit.editing.Util");dojo.require("dijit.form.DateTextBox");dojo.require("dijit.form.TextBox");dojo.require("dijit.form.NumberTextBox");dojo.require("dijit.form.FilteringSelect");dojo.require("dijit.form.NumberSpinner");dojo.require("dijit.form.Button");dojo.require("dijit.form.SimpleTextarea");dojo.require("dijit.Tooltip");dojo.require("dojo.data.ItemFileReadStore");(function(){var _1=document.createElement("link");_1.type="text/css";_1.rel="stylesheet";_1.href=dojo.moduleUrl("esri","dijit/css/AttributeInspector.css");document.getElementsByTagName("head").item(0).appendChild(_1);})();dojo.declare("esri.dijit.AttributeInspector",[dijit._Widget,dijit._Templated],{widgetsInTemplate:true,templateString:"<div class=\"esriAttributeInspector\">\r\n    <div class=\"atiLayerName\" dojoAttachPoint=\"layerName\"></div>\r\n    <div class=\"atiAttributes\" dojoAttachPoint=\"attributeTable\"></div>\r\n    <div dojoAttachPoint=\"attachmentEditor\"></div>\r\n    <div class=\"atiButtons\" dojoAttachPoint=\"editButtons\">\r\n        <button  dojoType=\"dijit.form.Button\" class=\"atiButton atiDeleteButton\"  dojoAttachPoint=\"deleteBtn\" dojoAttachEvent=\"onClick: onDeleteBtn\" showLabel=\"true\" type=\"button\">${NLS_deleteFeature}</button>\r\n        <div class=\"atiNavButtons\" dojoAttachPoint=\"navButtons\">\r\n            <div class=\"atiNavMessage\" dojoAttachPoint=\"navMessage\"></div>\r\n            <button  dojoType=\"dijit.form.Button\" iconClass=\"atiButton atiFirstIcon\" dojoAttachPoint=\"firstFeatureButton\" dojoAttachEvent=\"onClick: onFirstFeature\" showLabel=\"false\" type=\"button\">${NLS_first}</button>\r\n            <button  dojoType=\"dijit.form.Button\" iconClass=\"atiButton atiPrevIcon\" dojoAttachPoint=\"prevFeatureButton\" dojoAttachEvent=\"onClick: onPreviousFeature\" showLabel=\"false\" type=\"button\">${NLS_previous}</button>\r\n            <button  dojoType=\"dijit.form.Button\" iconClass=\"atiButton atiNextIcon\" dojoAttachPoint=\"nextFeatureButton\" dojoAttachEvent=\"onClick: onNextFeature\" showLabel=\"false\" type=\"button\">${NLS_next}</button>\r\n            <button  dojoType=\"dijit.form.Button\" iconClass=\"atiButton atiLastIcon\" dojoAttachPoint=\"lastFeatureButton\" dojoAttachEvent=\"onClick: onLastFeature\" showLabel=\"false\" type=\"button\">${NLS_last}</button>\r\n        </div>\r\n    </div>\r\n</div>\r\n",_navMessage:"( ${idx} ${of} ${numFeatures} )",onUpdate:function(){},onDelete:function(){},onAttributeChange:function(){},onNext:function(){},onReset:function(){},onCancel:function(){},constructor:function(_2,_3){dojo.mixin(this,esri.bundle.widgets.attributeInspector);_2=_2||{};if(!_2.featureLayer&&!_2.layerInfos){console.error("esri.AttributeInspector: please provide correct parameter in the constructor");}this._layerInfos=_2.layerInfos||[{featureLayer:_2.featureLayer,options:_2.options||[]}];this._aiConnects=[];this._selection=[];this._toolTips=[];this._numFeatures=0;this._featureIdx=0;this._currentLInfo=null;this._currentFeature=null;this._hideNavButtons=_2.hideNavButtons||false;},postCreate:function(){this._initLayerInfos();this._createAttachmentEditor();this.onFirstFeature();},destroy:function(){this._destroyAttributeTable();dojo.forEach(this._aiConnects,dojo.disconnect);delete this._aiConnects;if(this._attachmentEditor){this._attachmentEditor.destroy();delete this._attachmentEditor;}delete this._layerInfos;this._selection=this._currentFeature=this._currentLInfo=this._attributes=this._layerInfos=null;this.inherited(arguments);},refresh:function(){this._updateSelection();},first:function(){this.onFirstFeature();},last:function(){this.onLastFeature();},next:function(){this.onNextFeature();},previous:function(){this.onPreviousFeature();},onLayerSelectionChange:function(_4,_5,_6){this._featureIdx=(_6===esri.layers.FeatureLayer.SELECTION_NEW)?0:this._featureIdx;this._updateSelection();this._updateUI();},onLayerSelectionClear:function(){if(!this._selection||this._selection.length<=0){return;}this._numFeatures=0;this._featureIdx=0;this._selection=[];this._currentFeature=null;this._currentLInfo=null;this._updateUI();},onLayerEditsComplete:function(_7,_8,_9,_a){_a=_a||[];if(_a.length){var _b=this._selection;var _c=_7.featureLayer.objectIdField;dojo.forEach(_a,dojo.hitch(this,function(_d){dojo.some(_b,dojo.hitch(this,function(_e,_f){if(_e.attributes[_c]!==_d.objectId){return false;}this._selection.splice(_f,1);return true;}));}));}_8=_8||[];if(_8.length){var _10=this._selection=esri.dijit.editing.Util.LayerHelper.findFeatures(_8,_7.featureLayer);this._featureIdx=0;}var _11=this._numFeatures=this._selection?this._selection.length:0;if(_8.length||_a.length){var _12=_11?this._selection[this._featureIdx]:null;this._showFeature(_12);}this._updateUI();},onFieldValueChange:function(_13,_14){var _15=_13.field;if(_15.type==="esriFieldTypeDate"){_14=(_14&&_14.getTime)?_14.getTime():_14;}if(this._currentFeature.attributes[_15.name]===_14){return;}var _16=this._currentLInfo;var _17=this._currentFeature;var _18=_15.name;if(_18===_16.typeIdField){var _19=this._findFirst(_16.types,"id",_14);var _1a=_16.fieldInfos;dojo.forEach(_1a,function(_1b){_15=_1b.field;if(!_15||_15.name===_16.typeIdField){return;}var _1c=_1b.dijit;var _1d=this._setFieldDomain(_1c,_19,_15);if(_1d&&_1c){this._setValue(_1c,_17.attributes[_15.name]+"");}},this);}this.onAttributeChange(_17,_18,_14);},onDeleteBtn:function(evt){this._deleteFeature();},onNextFeature:function(evt){this._onNextFeature(1);},onPreviousFeature:function(evt){this._onNextFeature(-1);},onFirstFeature:function(evt){this._onNextFeature(this._featureIdx*-1);},onLastFeature:function(evt){this._onNextFeature((this._numFeatures-1)-this._featureIdx);},_initLayerInfos:function(){var _1e=this._layerInfos;dojo.forEach(_1e,this._initLayerInfo,this);},_initLayerInfo:function(_1f){var _20=_1f.featureLayer;this._connect(_20,"onSelectionComplete",dojo.hitch(this,"onLayerSelectionChange",_1f));this._connect(_20,"onSelectionClear",dojo.hitch(this,"onLayerSelectionClear",_1f));this._connect(_20,"onEditsComplete",dojo.hitch(this,"onLayerEditsComplete",_1f));_1f.showAttachments=_20.hasAttachments?(esri._isDefined(_1f.showAttachments)?_1f.showAttachments:true):false;_1f.hideFields=_1f.hideFields||[];_1f.htmlFields=_1f.htmlFields||[];_1f.isEditable=_20.isEditable()?(esri._isDefined(_1f.isEditable)?_1f.isEditable:true):false;_1f.typeIdField=_20.typeIdField;_1f.layerId=_20.layerId;_1f.types=_20.types;if(!_1f.showGlobalID&&_20.globalIdField){_1f.hideFields.push(_20.globalIdField);}if(!_1f.showObjectID){_1f.hideFields.push(_20.objectIdField);}var _21=this._getFields(_1f.featureLayer);if(!_21){return;}var _22=_1f.fieldInfos||[];_22=dojo.map(_22,function(_23){return dojo.mixin({},_23);});if(!_22.length){_21=dojo.filter(_21,dojo.hitch(this,function(_24){return !this._isInFields(_24.name,_1f.hideFields);}));_1f.fieldInfos=dojo.map(_21,dojo.hitch(this,function(_25){var _26=(this._isInFields(_25.name,_1f.htmlFields)?esri.dijit.AttributeInspector.STRING_FIELD_OPTION_RICHTEXT:esri.dijit.AttributeInspector.STRING_FIELD_OPTION_TEXTBOX);return {"fieldName":_25.name,"field":_25,"stringFieldOption":_26};}));}else{_1f.fieldInfos=dojo.filter(dojo.map(_22,dojo.hitch(this,function(_27){var _28=_27.stringFieldOption||(this._isInFields(_27.fieldName,_1f.htmlFields)?esri.dijit.AttributeInspector.STRING_FIELD_OPTION_RICHTEXT:esri.dijit.AttributeInspector.STRING_FIELD_OPTION_TEXTBOX);return dojo.mixin(_27,{"field":this._findFirst(_21,"name",_27.fieldName),"stringFieldOption":_28});})),"return item.field;");}},_createAttachmentEditor:function(){this._attachmentEditor=null;var _29=this._layerInfos;var _2a=dojo.filter(_29,"return item.showAttachments");if(!_2a||!_2a.length){return;}this._attachmentEditor=new esri.dijit.editing.AttachmentEditor({"class":"atiAttachmentEditor"},this.attachmentEditor);this._attachmentEditor.startup();},_setCurrentLInfo:function(_2b){var _2c=this._currentLInfo?this._currentLInfo.featureLayer:null;var _2d=_2b.featureLayer;if(_2c&&_2c.layerId===_2d.layerId){return;}this._currentLInfo=_2b;this._createTable();},_updateSelection:function(){this._selection=[];var _2e=this._layerInfos;dojo.forEach(_2e,this._getSelection,this);var _2f=this._numFeatures=this._selection.length;var _30=_2f?this._selection[this._featureIdx]:null;this._showFeature(_30);},_getSelection:function(_31){var _32=_31.featureLayer.getSelectedFeatures();this._selection=this._selection.concat(_32);},_updateUI:function(){var _33=this._numFeatures;var _34=this._currentLInfo;this.layerName.innerHTML=(!_34||_33===0)?this.NLS_noFeaturesSelected:(_34.featureLayer?_34.featureLayer.name:"");dojo.style(this.attributeTable,"display",_33?"":"none");dojo.style(this.editButtons,"display",_33?"":"none");dojo.style(this.navButtons,"display",(!this._hideNavButtons&&(_33>1)?"":"none"));this.navMessage.innerHTML=esri.substitute({idx:this._featureIdx+1,of:this.NLS_of,numFeatures:this._numFeatures},this._navMessage);if(this._attachmentEditor){dojo.style(this._attachmentEditor.domNode,"display",((_34&&_34.showAttachments)&&_33)?"":"none");}var _35=((_34&&_34.showDeleteButton===false)||(_34&&_34.isEditable===false))?false:true;dojo.style(this.deleteBtn.domNode,"display",_35?"":"none");if(this.domNode.parentNode&&this.domNode.parentNode.scrollTop>0){this.domNode.parentNode.scrollTop=0;}},_onNextFeature:function(_36){this._featureIdx+=_36;if(this._featureIdx<0){this._featureIdx=this._numFeatures-1;}else{if(this._featureIdx>=this._numFeatures){this._featureIdx=0;}}var _37=this._selection.length?this._selection[this._featureIdx]:null;this._showFeature(_37);this._updateUI();this.onNext(_37);},_deleteFeature:function(){this.onDelete(this._currentFeature);},_showFeature:function(_38){if(!_38){return;}this._currentFeature=_38;var _39=this._getLInfoFromFeature(_38);if(!_39){return;}this._setCurrentLInfo(_39);var _3a=_38.attributes;var _3b=this._findFirst(_39.types,"id",_3a[_39.typeIdField]);var _3c,_3d=null;var _3e=_39.fieldInfos;dojo.forEach(_3e,function(_3f){_3d=_3f.field;_3c=_3f.dijit||null;if(!_3c){return;}var _40=this._setFieldDomain(_3c,_3b,_3d);var _41=_3a[_3d.name];_41=(_41&&_40&&_40.codedValues&&_40.codedValues.length)?(_40.codedValues[_41]?_40.codedValues[_41].name:_41):_41;if(!esri._isDefined(_41)){_41="";}if(_3c.declaredClass==="dijit.form.DateTextBox"){_41=(_41==="")?null:new Date(_41);}else{if(_3c.declaredClass==="dijit.form.FilteringSelect"){_3c._lastValueReported=null;_41=_3a[_3d.name]+"";}}try{this._setValue(_3c,_41);}catch(error){_3c.set("displayedValue",this.NLS_errorInvalid,false);}},this);if(this._attachmentEditor&&_39.showAttachments){this._attachmentEditor.showAttachments(this._currentFeature);}},_setFieldDomain:function(_42,_43,_44){if(!_42){return null;}var _45=_44.domain;if(_43&&_43.domains){if(_43.domains[_44.name]&&_43.domains[_44.name] instanceof esri.layers.InheritedDomain===false){_45=_43.domains[_44.name];}}if(!_45){return null;}if(_45.codedValues&&_45.codedValues.length>0){_42.store=this._toStore(dojo.map(_45.codedValues,"return { id: item.code += '', name: item.name };"));this._setValue(_42,_45.codedValues[0].code);}else{_42.constraints={min:esri._isDefined(_45.minValue)?_45.minValue:Number.MIN_VALUE,max:esri._isDefined(_45.maxValue)?_45.maxValue:Number.MAX_VALUE};this._setValue(_42,_42.constraints.min);}return _45;},_setValue:function(_46,_47){if(!_46.set){return;}_46._onChangeActive=false;_46.set("value",_47,true);_46._onChangeActive=true;},_getFields:function(_48){var _49=_48._getOutFields();if(!_49){return null;}var _4a=_48.fields;return (_49=="*")?_4a:dojo.filter(dojo.map(_49,dojo.hitch(this,"_findFirst",_4a,"name")),esri._isDefined);},_isInFields:function(_4b,_4c){if(!_4b||!_4c&&!_4c.length){return false;}return dojo.some(_4c,function(_4d){return _4d.toLowerCase()===_4b.toLowerCase();});},_findFirst:function(_4e,_4f,_50){var _51=dojo.filter(_4e,function(_52){return _52.hasOwnProperty(_4f)&&_52[_4f]===_50;});return (_51&&_51.length)?_51[0]:null;},_getLInfoFromFeature:function(_53){var _54=_53.getLayer()?_53.getLayer().layerId:null;return this._findFirst(this._layerInfos,"layerId",_54);},_createTable:function(){this._destroyAttributeTable();this.attributeTable.innerHTML="";this._attributes=dojo.create("table",{cellspacing:"0",cellpadding:"0"},this.attributeTable);var _55=dojo.create("tbody",null,this._attributes);var _56=this._currentFeature;var _57=this._currentLInfo;var _58=this._findFirst(_57.types,"id",_56.attributes[_57.typeIdField]);var _59=_57.fieldInfos;dojo.forEach(_59,dojo.hitch(this,"_createField",_58,_55),this);},_createField:function(_5a,_5b,_5c){var _5d=this._currentLInfo;var _5e=_5c.field;if(this._isInFields(_5e.name,_5d.hideFields)){return;}var _5f=dojo.create("tr",null,_5b);var _60=_5c.stringFieldOption===esri.dijit.AttributeInspector.STRING_FIELD_OPTION_RICHTEXT;var td=dojo.create("td",{innerHTML:_5c.label||_5e.alias||_5e.name,"class":"atiLabel"},_5f);td=dojo.create("td",null,_5f);var _61=null;var _62=false;if(_5c.customField){dojo.place(_5c.customField.domNode||_5c.customField,dojo.create("div",null,td),"first");_61=_5c.customField;}else{if(_5d.isEditable===false||_5e.isEditable===false||_5c.isEditable===false||_5e.type==="esriFieldTypeOID"||_5e.type==="esriFieldTypeGlobalID"){_62=true;}}if(!_61&&(_5d.typeIdField&&_5e.name.toLowerCase()==_5d.typeIdField.toLowerCase())){_61=this._createTypeField(_5e,_5c,td);}else{if(!_61){_61=this._createDomainField(_5e,_5c,_5a,td);}}if(!_61){switch(_5e.type){case "esriFieldTypeString":_61=this._createStringField(_5e,_5c,td);break;case "esriFieldTypeDate":_61=this._createDateField(_5e,_5c,td);break;case "esriFieldTypeInteger":case "esriFieldTypeSmallInteger":_61=this._createIntField(_5e,_5c,td);break;case "esriFieldTypeSingle":case "esriFieldTypeDouble":_61=this._createFltField(_5e,_5c,td);break;default:_61=this._createStringField(_5e,_5c,td);break;}}if(_5c.tooltip&&_5c.tooltip.length){this._toolTips.push(new dijit.Tooltip({connectId:[_61.id],label:_5c.tooltip}));}_61.onChange=dojo.hitch(this,"onFieldValueChange",_5c);_61.set("disabled",_62);_5c.dijit=_61;},_createTypeField:function(_63,_64,_65){return new dijit.form.FilteringSelect({"class":"atiField",name:_63.alias||_63.name,store:this._toStore(dojo.map(this._currentLInfo.types,"return { id: item.id, name: item.name };")),searchAttr:"name"},dojo.create("div",null,_65));},_createDomainField:function(_66,_67,_68,_69){var _6a=_66.domain;if(_68&&_68.domains){if(_68.domains[_66.name]&&_68.domains[_66.name] instanceof esri.layers.InheritedDomain===false){_6a=_68.domains[_66.name];}}if(!_6a){return null;}if(_6a.codedValues){return new dijit.form.FilteringSelect({"class":"atiField",name:_66.alias||_66.name,store:null,searchAttr:"name"},dojo.create("div",null,_69));}else{return new dijit.form.NumberSpinner({"class":"atiField"},dojo.create("div",null,_69));}},_createStringField:function(_6b,_6c,_6d){var _6e={"class":"atiField",trim:true,maxLength:_6b.length};if(_6c.stringFieldOption===esri.dijit.AttributeInspector.STRING_FIELD_OPTION_TEXTAREA){_6e["class"]+=" atiTextAreaField";return new dijit.form.SimpleTextarea(_6e,dojo.create("div",null,_6d));}else{if(_6c.stringFieldOption===esri.dijit.AttributeInspector.STRING_FIELD_OPTION_RICHTEXT){_6e["class"]+=" atiRichTextField";_6e.height="100%";_6e.width="100%";_6e.plugins=_6c.richTextPlugins||["bold","italic","underline","foreColor","hiliteColor","|","justifyLeft","justifyCenter","justifyRight","justifyFull","|","insertOrderedList","insertUnorderedList","indent","outdent","|","createLink"];return new dijit.Editor(_6e,dojo.create("div",null,_6d));}else{return new dijit.form.TextBox(_6e,dojo.create("div",null,_6d));}}},_createDateField:function(_6f,_70,_71){return new dijit.form.DateTextBox({"class":"atiField",trim:true},dojo.create("div",null,_71));},_createIntField:function(_72,_73,_74){return new dijit.form.NumberTextBox({"class":"atiField",constraints:{places:0},invalidMessage:this.NLS_validationInt,trim:true},dojo.create("div",null,_74));},_createFltField:function(_75,_76,_77){return new dijit.form.NumberTextBox({"class":"atiField",trim:true,invalidMessage:this.NLS_validationFlt},dojo.create("div",null,_77));},_toStore:function(_78){return new dojo.data.ItemFileReadStore({data:{identifier:"id",label:"name",items:_78}});},_connect:function(_79,evt,_7a){this._aiConnects.push(dojo.connect(_79,evt,_7a));},_destroyAttributeTable:function(){var _7b=this.layerInfos;dojo.forEach(_7b,function(_7c){var _7d=_7c.fieldInfos;dojo.forEach(_7d,function(_7e){var _7f=_7e.dijit;if(_7f){_7f._onChangeHandle=null;if(_7e.customField){return;}if(_7f.destroyRecursive){_7f.destroyRecursive();}else{if(_7f.destroy){_7f.destroy();}}}_7e.dijit=null;},this);},this);var _80=this._toolTips;dojo.forEach(_80,"item.destroy(); delete item;");this._toolTips=[];if(this._attributes){dojo.destroy(this._attributes);}}});dojo.mixin(esri.dijit.AttributeInspector,{STRING_FIELD_OPTION_RICHTEXT:"richtext",STRING_FIELD_OPTION_TEXTAREA:"textarea",STRING_FIELD_OPTION_TEXTBOX:"textbox"});}