/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */

window[esri._dojoScopeName||"dojo"]._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","esri.layers.wms"],["require","esri.layers.dynamic"],["require","esri.layers.agscommon"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["esri.layers.wms"]){_4._hasResource["esri.layers.wms"]=true;_4.provide("esri.layers.wms");_4.require("esri.layers.dynamic");_4.require("esri.layers.agscommon");_4.declare("esri.layers.WMSLayer",[esri.layers.DynamicMapServiceLayer],{_CRS_TO_EPSG:{84:4326,83:4269,27:4267},_REVERSED_LAT_LONG_RANGES:[[4001,4999],[2044,2045],[2081,2083],[2085,2086],[2093,2093],[2096,2098],[2105,2132],[2169,2170],[2176,2180],[2193,2193],[2200,2200],[2206,2212],[2319,2319],[2320,2462],[2523,2549],[2551,2735],[2738,2758],[2935,2941],[2953,2953],[3006,3030],[3034,3035],[3058,3059],[3068,3068],[3114,3118],[3126,3138],[3300,3301],[3328,3335],[3346,3346],[3350,3352],[3366,3366],[3416,3416],[20004,20032],[20064,20092],[21413,21423],[21473,21483],[21896,21899],[22171,22177],[22181,22187],[22191,22197],[25884,25884],[27205,27232],[27391,27398],[27492,27492],[28402,28432],[28462,28492],[30161,30179],[30800,30800],[31251,31259],[31275,31279],[31281,31290],[31466,31700]],_WEB_MERCATOR:[102100,3857,102113,900913],_WORLD_MERCATOR:[3395,54004],allExtents:[],constructor:function(_7,_8){this._getCapabilitiesURL=_7;this._initLayer=_4.hitch(this,this._initLayer);this._parseCapabilities=_4.hitch(this,this._parseCapabilities);this._getCapabilitiesError=_4.hitch(this,this._getCapabilitiesError);if(_8){this.imageFormat=this._getImageFormat(_8.format);this.imageTransparency=(_8.transparent===false)?false:true;this.visibleLayers=_8.visibleLayers?_8.visibleLayers:[];if(_8.resourceInfo){this._readResourceInfo(_8.resourceInfo);}else{this._getCapabilities();}}else{this.imageFormat="image/png";this.imageTransparency=true;this.visibleLayers=[];this._getCapabilities();}this._blankImageURL=_4.moduleUrl("esri","../../images/pixel.png").uri;},setVisibleLayers:function(_9){_9=this._checkVisibleLayersList(_9);this.visibleLayers=(_9)?_9:[];this.refresh(true);},setImageFormat:function(_a){this.imageFormat=this._getImageFormat(_a);this.refresh(true);},setImageTransparency:function(_b){this.imageTransparency=_b;this.refresh(true);},getImageUrl:function(_c,_d,_e,_f){if(!this.visibleLayers||this.visibleLayers.length===0){_f(this._blankImageURL);return;}var _10=_c.spatialReference.wkid;if(_4.some(this._WEB_MERCATOR,function(el){return el==_10;})){var _11=_4.filter(this.spatialReferences,function(el){return (_4.some(this._WEB_MERCATOR,function(el2){return el2==el;}));},this);if(_11.length==0){_11=_4.filter(this.spatialReferences,function(el){return (_4.some(this._WORLD_MERCATOR,function(el2){return el2==el;}));},this);}if(_11.length>0){_10=_11[0];}else{_10=this._WEB_MERCATOR[0];}}var _12=_4.filter(this.spatialReferences,function(el){return el!==_10;});this.spatialReferences=_12;this.spatialReferences.unshift(_10);var _13=_c.xmin;var _14=_c.xmax;var _15=_c.ymin;var _16=_c.ymax;var _17={};_17.SERVICE="WMS";_17.REQUEST="GetMap";_17.FORMAT=this.imageFormat;_17.TRANSPARENT=this.imageTransparency?"TRUE":"FALSE";_17.STYLES="";_17.VERSION=this.version;_17.LAYERS=this.visibleLayers?this.visibleLayers.toString():null;_17.WIDTH=_d;_17.HEIGHT=_e;if(this.maxWidth<_d){_17.WIDTH=this.maxWidth;}if(this.maxHeight<_e){_17.HEIGHT=this.maxHeight;}var _18=_10?_10:NaN;if(!isNaN(_18)){if(this.version=="1.3.0"){_17.CRS="EPSG:"+_18;}else{_17.SRS="EPSG:"+_18;}}if(this.version=="1.3.0"&&this._useLatLong(_18)){_17.BBOX=_15+","+_13+","+_16+","+_14;}else{_17.BBOX=_13+","+_15+","+_14+","+_16;}var _19=this.getMapURL;_19+=(_19.indexOf("?")==-1)?"?":"";for(var key in _17){_19+=(_19.substring(_19.length-1,_19.length)=="?")?"":"&";_19+=key+"="+_17[key];}_f(_19);},_initLayer:function(_1a,io){this.spatialReference=new esri.SpatialReference(this.extent.spatialReference);this.initialExtent=new esri.geometry.Extent(this.extent);this.fullExtent=new esri.geometry.Extent(this.extent);this.visibleLayers=this._checkVisibleLayersList(this.visibleLayers);this.loaded=true;this.onLoad(this);var _1b=this._loadCallback;if(_1b){delete this._loadCallback;_1b(this);}},_readResourceInfo:function(_1c){if(!_1c.extent){console.error("esri.layers.WMSLayer: unable to find the 'extent' property in resourceInfo");return;}if(!_1c.layerInfos){console.error("esri.layers.WMSLayer: unable to find the 'layerInfos' property in resourceInfo");return;}this.extent=_1c.extent;this.layerInfos=_1c.layerInfos;this.description=_1c.description?_1c.description:"";this.copyright=_1c.copyright?_1c.copyright:"";this.title=_1c.title?_1c.title:"";this.getMapURL=_1c.getMapURL?_1c.getMapURL:this._getCapabilitiesURL;this.version=_1c.version?_1c.version:"1.3.0";this.maxWidth=_1c.maxWidth?_1c.maxWidth:5000;this.maxHeight=_1c.maxHeight?_1c.maxHeight:5000;this.spatialReferences=_1c.spatialReferences?_1c.spatialReferences:[];this._initLayer();},_getCapabilities:function(){var _1d=this._url.query?this._url.query:{};_1d.SERVICE="WMS";_1d.REQUEST="GetCapabilities";var uri=this._url.path+"?";for(var key in _1d){uri+=(uri.substring(uri.length-1,uri.length)=="?")?"":"&";uri+=key+"="+_1d[key];}var _1e=esri.request({url:uri,handleAs:"xml",load:this._parseCapabilities,error:this._getCapabilitiesError},{usePost:false});},_parseCapabilities:function(xml){if(!xml){this.onError("GetCapabilities request for "+this._getCapabilitiesURL+" failed. (Response is null.)");return;}this.version=this._getAttributeValue("WMS_Capabilities","version",xml,null);if(!this.version){this.version=this._getAttributeValue("WMT_MS_Capabilities","version",xml,"1.3.0");}var _1f=this._getTag("Service",xml);this.title=this._getTagValue("Title",_1f,"");if(this.title.length==0){this.title=this._getTagValue("Name",_1f,"");}this.copyright=this._getTagValue("AccessConstraints",_1f,"");this.description=this._getTagValue("Abstract",_1f,"");this.maxWidth=parseInt(this._getTagValue("MaxWidth",_1f,5000));this.maxHeight=parseInt(this._getTagValue("MaxHeight",_1f,5000));var _20=this._getTag("Layer",xml);if(!_20){this._getCapabilitiesError({"error":{"message":"Response does not contain any layers."}});return;}var _21=this._getLayerInfo(_20);if(_21){this.layerInfos=_21.subLayers;this.extent=_21.extent;this.spatialReferences=_21.spatialReferences;this.allExtents=_21.allExtents;}this.getMapURL=this._getCapabilitiesURL;var _22=_4.query("DCPType",this._getTag("GetMap",xml));if(_22&&_22.length>0){var _23=_4.query("HTTP",_22[0]);if(_23&&_23.length>0){var _24=_4.query("Get",_23[0]);if(_24&&_24.length>0){var _25=this._getAttributeValue("OnlineResource","xlink:href",_24[0],null);if(_25){if(_25.indexOf("&")==(_25.length-1)){_25=_25.substring(0,_25.length-1);}this.getMapURL=_25;}}}}this.getMapFormats=[];_4.forEach(_4.query("Format",this._getTag("GetMap",xml)),function(_26){if(_4.isIE){this.getMapFormats.push(_26.text);}else{this.getMapFormats.push(_26.textContent);}},this);this._initLayer();},_getCapabilitiesError:function(_27,io){this.onError("GetCapabilities request for "+this._getCapabilitiesURL+" failed. ("+_4.toJson(_27)+")");},_getLayerInfo:function(_28){var _29;if(_28){_29=new esri.layers.WMSLayerInfo();_29.name="";_29.title="";_29.description="";_4.forEach(_28.childNodes,function(_2a){if(_2a.nodeName=="Name"){_29.name=(_4.isIE?_2a.text:_2a.textContent)||"";}else{if(_2a.nodeName=="Title"){_29.title=(_4.isIE?_2a.text:_2a.textContent)||"";}else{if(_2a.nodeName=="Abstract"){_29.description=(_4.isIE?_2a.text:_2a.textContent)||"";}}}},this);_29.allExtents=[];var _2b=this._getTag("LatLonBoundingBox",_28);if(_2b){_29.allExtents[0]=this._getExtent(_2b,4326);}var _2c=this._getTag("EX_GeographicBoundingBox",_28);if(_2c){var _2d=new esri.geometry.Extent(0,0,0,0,new esri.SpatialReference({wkid:4326}));_2d.xmin=parseFloat(this._getTagValue("westBoundLongitude",_2c,0));_2d.ymin=parseFloat(this._getTagValue("southBoundLatitude",_2c,0));_2d.xmax=parseFloat(this._getTagValue("eastBoundLongitude",_2c,0));_2d.ymax=parseFloat(this._getTagValue("northBoundLatitude",_2c,0));_29.allExtents[0]=_2d;}var _2e=_4.query("BoundingBox",_28);if(_2e.length===0){_29.extent=_29.allExtents[0];}else{var _2f=(this.version=="1.3.0")?"CRS":"SRS";var bb,_30,_31;for(var i=0;i<_2e.length;i++){bb=_2e[i];var tag=bb.parentNode.nodeName;if(tag!=="Layer"){continue;}var _32="";var _33="";_4.forEach(bb.parentNode.childNodes,function(_34){if(_34.nodeName=="Name"){_32=(_4.isIE?_34.text:_34.textContent)||"";}if(_34.nodeName=="Title"){_33=(_4.isIE?_34.text:_34.textContent)||"";}},this);if(_32!==_29.name||_33!==_29.title){continue;}_30=bb.getAttribute(_2f);if(_30&&_30.indexOf("EPSG:")===0){_31=parseInt(_30.substring(5));if(_31==0){continue;}var _2d;if(this.version=="1.3.0"){_2d=this._getExtent(bb,_31,this._useLatLong(_31));}else{_2d=this._getExtent(bb,_31);}_29.allExtents[_31]=_2d;if(!_29.extent){_29.extent=_2d;}}else{if(_30&&_30.indexOf("CRS:")===0){_31=parseInt(_30.substring(4));if(_31==0){continue;}if(this._CRS_TO_EPSG[_31]){_31=this._CRS_TO_EPSG[_31];}_29.allExtents[_31]=this._getExtent(bb,_31);}else{_31=parseInt(_30);_29.allExtents[_31]=this._getExtent(bb,_31);}}}if(!_29.extent){bb=_2e[0];_30=bb.getAttribute(_2f)[0];if(_30){if(_30.indexOf("CRS:")===0){_31=parseInt(_30.substring(4));if(this._CRS_TO_EPSG[_31]){_31=this._CRS_TO_EPSG[_31];}_29.extent=_29.allExtents[_31];}else{_31=parseInt(_30);_29.extent=_29.allExtents[_31];}}}}if(!_29.extent){_29.extent=_29.allExtents[0];}_29.spatialReferences=[];var _35=(this.version=="1.3.0")?"CRS":"SRS";_4.forEach(_4.query(_35,_28),function(crs){var _36;if(_4.isIE){_36=crs.text;}else{_36=crs.textContent;}var arr=_36.split(" ");_4.forEach(arr,function(val){if(val.indexOf(":")>-1){val=parseInt(val.split(":")[1]);}else{val=parseInt(val);}if(val!=84&&val!=0){if(!_4.some(_29.spatialReferences,function(el){return el==val;})){_29.spatialReferences.push(val);}}});},this);var _37=this._getTag("Style",_28);if(_37){var _38=this._getTag("LegendURL",_37);if(_38){var _39=this._getTag("OnlineResource",_38);if(_39){_29.legendURL=_39.getAttribute("xlink:href");}}}var _3a=_4.query("Layer",_28);var _3b="||";if(_3a.length>0){_29.subLayers=[];_4.forEach(_3a,function(_3c){var l=this._getLayerInfo(_3c);if(l.subLayers&&l.subLayers.length>0&&l.name===l.subLayers[0].name){l.name=null;}if(_3b.indexOf("||"+l.name+"||")==-1){_29.subLayers.push(l);if(l.subLayers&&l.subLayers.length>0){_4.forEach(l.subLayers,function(_3d){_3b+=_3d.name+"||";},this);}}},this);}}return _29;},_getImageFormat:function(_3e){var _3f=_3e?_3e.toLowerCase():"";switch(_3f){case "jpg":return "image/jpeg";case "bmp":return "image/bmp";case "gif":return "image/gif";case "svg":return "image/svg+xml";default:return "image/png";}},_getExtent:function(_40,_41,_42){var _43;if(_40){_43=new esri.geometry.Extent();var _44=parseFloat(_40.getAttribute("minx"));var _45=parseFloat(_40.getAttribute("miny"));var _46=parseFloat(_40.getAttribute("maxx"));var _47=parseFloat(_40.getAttribute("maxy"));if(_42){_43.xmin=isNaN(_45)?Number.MIN_VALUE:_45;_43.ymin=isNaN(_44)?Number.MIN_VALUE:_44;_43.xmax=isNaN(_47)?Number.MAX_VALUE:_47;_43.ymax=isNaN(_46)?Number.MAX_VALUE:_46;}else{_43.xmin=isNaN(_44)?Number.MIN_VALUE:_44;_43.ymin=isNaN(_45)?Number.MIN_VALUE:_45;_43.xmax=isNaN(_46)?Number.MAX_VALUE:_46;_43.ymax=isNaN(_47)?Number.MAX_VALUE:_47;}_43.spatialReference=new esri.SpatialReference({wkid:_41});}return _43;},_useLatLong:function(_48){var _49;for(var i=0;i<this._REVERSED_LAT_LONG_RANGES.length;i++){var _4a=this._REVERSED_LAT_LONG_RANGES[i];if(_48>=_4a[0]&&_48<=_4a[1]){_49=true;break;}}return _49;},_getTag:function(_4b,xml){var _4c=_4.query(_4b,xml);if(_4c&&_4c.length>0){return _4c[0];}else{return null;}},_getTagValue:function(_4d,xml,_4e){var _4f=_4.query(_4d,xml);if(_4f&&_4f.length>0){if(_4.isIE){return _4f[0].text;}else{return _4f[0].textContent;}}else{return _4e;}},_getAttributeValue:function(_50,_51,xml,_52){var _53=_4.query(_50,xml);if(_53&&_53.length>0){return _53[0].getAttribute(_51);}else{return _52;}},_checkVisibleLayersList:function(_54){if(_54&&_54.length>0&&this.layerInfos&&this.layerInfos.length>0){if((typeof _54[0])=="number"){var _55=[];_4.forEach(_54,function(pos){if(pos<this.layerInfos.length){_55.push(this.layerInfos[pos].name);}},this);_54=_55;}}return _54;}});_4.declare("esri.layers.WMSLayerInfo",null,{name:null,title:null,description:null,extent:null,legendURL:null,subLayers:[],constructor:function(_56){if(_56){this.name=_56.name;this.title=_56.title;this.description=_56.description;this.extent=_56.extent;this.legendURL=_56.legendURL;}}});}}};});