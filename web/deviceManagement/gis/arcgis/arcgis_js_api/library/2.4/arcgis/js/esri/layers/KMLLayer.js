/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */

if(!dojo._hasResource["esri.layers.KMLLayer"]){dojo._hasResource["esri.layers.KMLLayer"]=true;dojo.provide("esri.layers.KMLLayer");dojo.require("esri.utils");dojo.require("esri.layers.layer");dojo.require("esri.layers.MapImageLayer");dojo.require("esri.layers.FeatureLayer");dojo.require("esri.dijit.Popup");dojo.declare("esri.layers.KMLLayer",[esri.layers.Layer],{serviceUrl:"http://utility.arcgis.com/sharing/kml",constructor:function(_1,_2){if(!_1){console.log("KMLLayer:constructor - please provide url for the KML file");}this._outSR=null;if(_2&&_2.outSR){this._outSR=_2.outSR;this._outSR=(this._outSR)?this._outSR.wkid:null;}this._options=_2;if(esri.config.defaults.kmlService){this.serviceUrl=esri.config.defaults.kmlService;}var _3=(this.linkInfo=_2&&_2.linkInfo);if(_3){this.visible=!!_3.visibility;}if(!_3||(_3&&_3.visibility)){this._parseKml();}},getFeature:function(_4){if(!_4){return;}var _5=_4.type,id=_4.id,_6,i,_7;switch(_5){case "esriGeometryPoint":case "esriGeometryPolyline":case "esriGeometryPolygon":var _8=this["_"+_5];if(_8){_6=dojo.getObject("_mode._featureMap."+id,false,_8);}break;case "GroundOverlay":var _9=this._groundLyr;if(_9){var _a=_9.getImages();_7=_a.length;for(i=0;i<_7;i++){if(_a[i].id===id){_6=_a[i];break;}}}break;case "ScreenOverlay":break;case "NetworkLink":dojo.some(this._links,function(_b){if(_b.linkInfo.id===id){_6=_b;return true;}else{return false;}});break;case "Folder":var _c=this.folders;_7=_c?_c.length:0;for(i=0;i<_7;i++){if(_c[i].id===id){_6=_c[i];break;}}break;default:console.log("KMLLayer:getFeature - unknown feature type");break;}return _6;},getLayers:function(){var _d=[];if(this._groundLyr){_d.push(this._groundLyr);}if(this._fLayers){_d=_d.concat(this._fLayers);}return _d;},setFolderVisibility:function(_e,_f){if(!_e){return;}_e.visible=_f;if(_f){var _10=this._getParentFolders(_e,[]);if(_10.length>0){_f=dojo.every(_10,function(_11){return _11.visible;});}}this._setState(_e,_f);},_parseKml:function(){var _12=this;esri.request({url:this.serviceUrl,content:{url:this.url,model:"simple",folders:"",outSR:this._outSR},callbackParamName:"callback",load:function(_13){_12._initLayer(_13);},error:function(err){_12.onError("Error reading kml document. ("+dojo.toJson(err)+")");}});},_initLayer:function(_14){this.name=_14.name;this.description=_14.description;this.snippet=_14.snippet;this.visibility=_14.visibility;this.featureInfos=_14.featureInfos;var i,len;var _15=(this._links=_14.networkLinks);len=_15?_15.length:0;var _16=this;for(i=0;i<len;i++){var _17={linkInfo:_15[i]};_17=dojo.mixin(_17,this._options);if(_17.id){_17.id=_17.id+"_"+i;}if(_15[i].viewRefreshMode==="never"){_15[i]=new esri.layers.KMLLayer(_15[i].href,_17);dojo.connect(_15[i],"onLoad",function(a){_16._map.addLayer(a);});}}var _18=_14.groundOverlays;if(_18&&_18.length>0){var _17=dojo.mixin({},this._options);if(_17.id){_17.id=_17.id+"_"+"mapImage";}var _19=(this._groundLyr=new esri.layers.MapImageLayer(_17));len=_18.length;for(i=0;i<len;i++){_19.addImage(new esri.layers.KMLGroundOverlay(_18[i]));}}var _1a=dojo.getObject("featureCollection.layers",false,_14);if(_1a&&_1a.length>0){this._fLayers=[];dojo.forEach(_1a,function(_1b,i){var _1c=dojo.getObject("featureSet.features",false,_1b),_1d;if(_1c&&_1c.length>0){_1b.layerDefinition.capabilities="Query,Data";var _1e={outFields:["*"],infoTemplate:_1b.popupInfo?new esri.dijit.PopupTemplate(_1b.popupInfo):null,editable:false};_1e=dojo.mixin(_1e,this._options);if(_1e.id){_1e.id=_1e.id+"_"+i;}_1d=new esri.layers.FeatureLayer(_1b,_1e);if(_1d.geometryType){this["_"+_1d.geometryType]=_1d;}this._fLayers.push(_1d);}},this);if(this._fLayers.length===0){delete this._fLayers;}}var _1f=(this.folders=_14.folders),_20=[],_21;if(_1f){len=_1f.length;for(i=0;i<len;i++){_21=(_1f[i]=new esri.layers.KMLFolder(_1f[i]));if(_21.parentFolderId===-1){_20.push(_21);}}}len=_20.length;for(i=0;i<len;i++){_21=_20[i];this._setState(_21,_21.visible);}this.loaded=true;this.onLoad(this);},_setState:function(_22,_23){var _24=_22.featureInfos,_25,_26,i,len=_24?_24.length:0,_27=_23?"show":"hide";for(i=0;i<len;i++){_25=_24[i];_26=this.getFeature(_25);if(!_26){continue;}if(_25.type==="Folder"){this._setState(_26,_23&&_26.visible);}else{_26[_27]();}}},_getParentFolders:function(_28,_29){var _2a=_28.parentFolderId;if(_2a!==-1){var _2b=this.getFeature({type:"Folder",id:_2a});_29.push(_2b);return this._getParentFolders(_2b,_29);}return _29;},_setMap:function(map,_2c){this._map=map;var div=this._div=dojo.create("div",null,_2c);dojo.style(div,"position","absolute");if(this._groundLyr){var _2d=map.spatialReference._isWebMercator();if(_2d){var _2e=esri.geometry.geographicToWebMercator;dojo.forEach(this._groundLyr.getImages(),function(_2f){_2f.extent=_2e(_2f.extent);});}map.addLayer(this._groundLyr,map.layerIds.length);}var _30=this._fLayers;if(_30&&_30.length>0){var _2d=map.spatialReference._isWebMercator();dojo.forEach(_30,function(_31){if(_2d){var _32=_31.graphics,i,_33,len=_32?_32.length:0,_2e=esri.geometry.geographicToWebMercator;for(i=0;i<len;i++){_33=_32[i].geometry;if(_33){_32[i].setGeometry(_2e(_33));}}}map.addLayer(_31);});}this.onVisibilityChange(this.visible);return div;},_unsetMap:function(map,_34){if(this._groundLyr){map.removeLayer(this._groundLyr);}if(this._fLayers){dojo.forEach(this._fLayers,function(_35){map.removeLayer(_35);});}var div=this._div;if(div){_34.removeChild(div);dojo.destroy(div);}this._map=this._div=null;},onVisibilityChange:function(_36){var _37=_36?"show":"hide";if(_36&&this.linkInfo&&!this.loaded){this._parseKml();}else{if(this._groundLyr){this._groundLyr[_37]();}if(this._fLayers){dojo.forEach(this._fLayers,function(_38){_38[_37]();});}}}});dojo.declare("esri.layers.KMLGroundOverlay",[esri.layers.MapImage],{constructor:function(_39){if(esri._isDefined(this.visibility)){this.visible=!!this.visibility;}}});dojo.declare("esri.layers.KMLFolder",null,{constructor:function(_3a){dojo.mixin(this,_3a);if(esri._isDefined(this.visibility)){this.visible=!!this.visibility;}}});}