/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */

if(!dojo._hasResource["esri.dijit.BasemapGallery"]){dojo._hasResource["esri.dijit.BasemapGallery"]=true;dojo.provide("esri.dijit.BasemapGallery");dojo.require("esri.virtualearth.VETiledLayer");dojo.require("esri.layers.osm");dojo.require("dijit._Widget");dojo.require("dijit._Templated");dojo.require("dojo.DeferredList");(function(){var _1=[dojo.moduleUrl("esri.dijit","css/BasemapGallery.css")];var _2=document.getElementsByTagName("head").item(0),_3;for(var i=0,il=_1.length;i<il;i++){_3=document.createElement("link");_3.type="text/css";_3.rel="stylesheet";_3.href=_1[i].toString();_2.appendChild(_3);}}());esri.dijit._arcgisUrl="http://www.arcgis.com/sharing";dojo.declare("esri.dijit.BasemapGallery",[dijit._Widget,dijit._Templated],{widgetsInTemplate:true,templateString:"<div class=\"esriBasemapGallery\">\r\n  <div dojoAttachPoint=\"flowContainer\">\r\n  </div>\r\n</div>\r\n",basePath:dojo.moduleUrl("esri.dijit"),loaded:false,basemaps:[],bingMapsKey:null,flowContainer:null,_hasUI:false,_selectedBasemap:null,constructor:function(_4,_5){_4=_4||{};if(!_4.map){console.error("esri.dijit.BasemapGallery: Unable to find the 'map' property in parameters");}this.map=_4.map;this._hasUI=_5?true:false;this.bingMapsKey=(_4.bingMapsKey&&_4.bingMapsKey.length>0)?_4.bingMapsKey:null;this.showArcGISBasemaps=(_4.showArcGISBasemaps===false)?false:true;this.basemaps=_4.basemaps?_4.basemaps:[];this.basemapIds=_4.basemapIds;this.referenceIds=_4.referenceIds;this.init();},init:function(){this.inherited(arguments);dojo.forEach(this.basemaps,function(_6,i){if(!_6.id||_6.id.length===0){_6.id=this._getUniqueId();}dojo.forEach(_6.layers,function(_7){_7.opacity=(_7.opacity>=0)?_7.opacity:1;_7.visibility=true;},this);},this);if(this.basemapIds&&this.basemapIds.length>0){dojo.forEach(this.basemapIds,function(_8){var _9=this.map.getLayer(_8);_9._basemapGalleryLayerType="basemap";},this);}if(this.referenceIds&&this.referenceIds.length>0){dojo.forEach(this.referenceIds,function(_a){var _b=this.map.getLayer(_a);_b._basemapGalleryLayerType="reference";},this);}if(this.showArcGISBasemaps){this._findArcGISBasemapsGroup(dojo.hitch(this,"_handleArcGISBasemapsResponse"));}else{this._finishStartup();}},startup:function(){if(this.loaded){this._refreshUI();}else{dojo.connect(this,"onLoad",dojo.hitch(this,function(){this._refreshUI();}));}},select:function(id){this._select(id);},getSelected:function(){return this._selectedBasemap;},get:function(id){for(var i=0;i<this.basemaps.length;i++){if(this.basemaps[i].id==id){return this.basemaps[i];}}return null;},add:function(_c){if(_c&&!_c.id){_c.id=this._getUniqueId();this.basemaps.push(_c);this._refreshUI();this.onAdd(_c);return true;}else{if(_c&&this._isUniqueId(_c.id)){this.basemaps.push(_c);this._refreshUI();this.onAdd(_c);return true;}}return false;},remove:function(id){for(var i=0;i<this.basemaps.length;i++){var _d=this.basemaps[i];if(_d.id===id){if(this._selectedBasemap&&this._selectedBasemap.id===_d.id){this._selectedBasemap=null;}this.basemaps.splice(i,1);this._refreshUI();this.onRemove(_d);return _d;}}return null;},onLoad:function(){},onSelectionChange:function(){},onAdd:function(_e){},onRemove:function(_f){},onError:function(msg){},_basemapGalleryGroupQuery:"title:\"ArcGIS Online Basemaps\" AND owner:esri",_finishStartup:function(){this.loaded=true;this.onLoad();if(this.map.layerIds.length===0&&this.basemaps.length>0){this._select(this.basemaps[0].id);}},_findArcGISBasemapsGroup:function(_10){var _11=dojo.hitch(this,"_findArcGISBasemaps");var url=esri.dijit._arcgisUrl+"/community/groups";var _12={};_12.q=this._basemapGalleryGroupQuery;_12.f="json";esri.request({url:url,content:_12,callbackParamName:"callback",load:function(_13,_14){if(_13.results.length>0){_11(_13.results[0].id,_10);}else{console.error("esri.dijit.BasemapGallery: could not find group for basemaps.");}},error:esriConfig.defaults.io.errorHandler});},_findArcGISBasemaps:function(_15,_16){var url=esri.dijit._arcgisUrl+"/search";var _17={};_17.q="group:"+_15+" AND type:\"web map\"";_17.sortField="name";_17.sortOrder="desc";_17.num=50;_17.f="json";esri.request({url:url,content:_17,callbackParamName:"callback",load:function(_18,_19){_16(_18.results);},error:esriConfig.defaults.io.errorHandler});},_handleArcGISBasemapsResponse:function(_1a){if(_1a.length>0){dojo.forEach(_1a,function(_1b,i){if(this.bingMapsKey||(!this.bingMapsKey&&_1b.title&&_1b.title.indexOf("Bing Maps")==-1)){var _1c={};_1c.id=this._getUniqueId();_1c.title=_1b.title;_1c.thumbnailUrl=(_1b.thumbnail&&_1b.thumbnail.length>0)?(esri.dijit._arcgisUrl+"/content/items/"+_1b.id+"/info/"+_1b.thumbnail):"";_1c.itemId=_1b.id;var _1d=new esri.dijit.Basemap(_1c);this.basemaps.splice(0,0,_1d);}},this);this._finishStartup();}},_refreshUI:function(){if(this._hasUI){dojo.empty(this.flowContainer);dojo.forEach(this.basemaps,function(_1e,i){if(!_1e.id){_1e.id="basemap_"+i;}this.flowContainer.appendChild(this._buildNodeLayout(_1e));},this);dojo.create("br",{style:{clear:"both"}},this.flowContainer);this._markSelected(this._selectedBasemap);}},_buildNodeLayout:function(_1f){var nId="galleryNode_"+_1f.id;var n=dojo.create("div",{id:nId,"class":"esriBasemapGalleryNode"});var _20=dojo.create("a",{href:"#"},n);dojo.connect(_20,"onclick",dojo.hitch(this,"_onNodeClick",_1f));if(_1f.thumbnailUrl){dojo.create("img",{"class":"esriBasemapGalleryThumbnail",src:_1f.thumbnailUrl},_20);}else{dojo.create("img",{"class":"esriBasemapGalleryThumbnail",src:this.basePath.toString()+"images/transparent.gif"},_20);}var _21=dojo.create("div",{"class":"esriBasemapGalleryLabelContainer"},n);var _22=_1f.title||"";dojo.create("span",{innerHTML:_22,alt:_22,title:_22},_21);return n;},_onNodeClick:function(_23,e){e.preventDefault();this._markSelected(_23);this.select(_23.id);},_markSelected:function(_24){if(_24){dojo.forEach(dojo.query(".esriBasemapGallerySelectedNode",this.domNode),function(_25){dojo.removeClass(_25,"esriBasemapGallerySelectedNode");});dojo.addClass(dojo.byId("galleryNode_"+_24.id),"esriBasemapGallerySelectedNode");}},_select:function(id){var _26=this.get(id);if(_26.layers){this._getServiceInfos(_26);}else{var _27=_26.getLayers();if(dojo.isArray(_27)){this._getServiceInfos(_26);}else{_27.addCallback(dojo.hitch(this,function(_28){this._getServiceInfos(_26);}));}}},_getServiceInfos:function(_29){this._selectedBasemap=_29;var _2a=[];dojo.forEach(_29.layers,function(_2b){if(_2b.url&&_2b.url.length>0&&!_2b.isReference){_2b.deferredsPos=_2a.length;_2a.push(this._getServiceInfo(_2b.url));}},this);if(_2a.length>0){var _2c=new dojo.DeferredList(_2a);_2c.addCallback(dojo.hitch(this,function(_2d){var _2e=null;dojo.forEach(_29.layers,function(_2f){if(_2f.deferredsPos===0||_2f.deferredsPos){_2f.serviceInfoResponse=_2a[_2f.deferredsPos].ioArgs.json;var ext=_2f.serviceInfoResponse.fullExtent;if(!ext){ext=_2f.serviceInfoResponse.extent;}if(!_2e){_2e=new esri.geometry.Extent(ext);}else{_2e=_2e.union(new esri.geometry.Extent(ext));}}},this);if(this.map.extent){var _30=this._getIntersectionPercent(_2e,this.map.extent);if(_30<5){this.map.setExtent(_2e,true);}}this._switchBasemapLayers(_29);this._updateReferenceLayer(_29);}));}else{this._switchBasemapLayers(_29);this._updateReferenceLayer(_29);}},_switchBasemapLayers:function(_31){var _32=_31.layers;if(this.map.layerIds.length>0&&this.map.getNumLevels()===0&&(_32[0].type==="OpenStreetMap"||(_32[0].type&&_32[0].type.indexOf("BingMaps")>-1))){var msg="esri.dijit.BasemapGallery: Unable to switch basemap because new basemap is a tiled service and cannot be loaded as a dynamic layer.";this.onError(msg);return;}dojo.forEach(_32,function(_33){if(!_33.isReference&&_33.type&&_33.type.indexOf("BingMaps")>-1&&!this.bingMapsKey){var msg="esri.dijit.BasemapGallery: Invalid Bing Maps key.";this.onError(msg);return;}},this);this._removeBasemapLayers();dojo.forEach(_32,function(_34){if(!_34.isReference){var _35;if(_34.type==="OpenStreetMap"){if(this.map.layerIds.length>0&&this.map.getNumLevels()===0){var msg="esri.dijit.BasemapGallery: Unable to switch basemap because new basemap is a tiled service and cannot be loaded as a dynamic layer.";this.onError(msg);return;}_35=new esri.layers.OpenStreetMapLayer({id:"layer_osm"});}else{if(_34.type&&_34.type.indexOf("BingMaps")>-1){if(this.map.layerIds.length>0&&this.map.getNumLevels()===0){var msg="esri.dijit.BasemapGallery: Unable to switch basemap because new basemap is a tiled service and cannot be loaded as a dynamic layer.";this.onError(msg);return;}var _36=esri.virtualearth.VETiledLayer.MAP_STYLE_AERIAL_WITH_LABELS;if(_34.type=="BingMapsAerial"){_36=esri.virtualearth.VETiledLayer.MAP_STYLE_AERIAL;}else{if(_34.type=="BingMapsRoad"){_36=esri.virtualearth.VETiledLayer.MAP_STYLE_ROAD;}}_35=new esri.virtualearth.VETiledLayer({id:"layer_bing",bingMapsKey:this.bingMapsKey,mapStyle:_36});}else{if(_34.serviceInfoResponse&&_34.serviceInfoResponse.mapName){if((this.map.layerIds.length===0||this.map.getNumLevels()>0)&&_34.serviceInfoResponse.singleFusedMapCache===true){_35=this._loadAsCached(_34);}else{_35=this._loadAsDynamic(_34);}}else{if(_34.serviceInfoResponse&&_34.serviceInfoResponse.pixelSizeX){var _37=new esri.layers.ImageServiceParameters();_37.bandIds=_34.bandIds;if(!_34.bandIds&&_34.serviceInfoResponse.bandCount&&parseInt(_34.serviceInfoResponse.bandCount)>3){_37.bandIds=[0,1,2];}_35=new esri.layers.ArcGISImageServiceLayer(_34.url,{resourceInfo:_34.serviceInfoResponse,opacity:_34.opacity,visible:_34.visibility,imageServiceParameters:_37});}}}}if(_35){_35._basemapGalleryLayerType="basemap";this.map.addLayer(_35,0);}}},this);this.onSelectionChange();},_removeBasemapLayers:function(){var _38=this.map.layerIds;var _39=[];dojo.forEach(_38,function(id){var _3a=this.map.getLayer(id);if(_3a._basemapGalleryLayerType==="basemap"){_39.push(_3a);}},this);if(_39.length===0&&_38.length>0){_39.push(this.map.getLayer(_38[0]));}if(_39.length>0){dojo.forEach(_39,function(_3b){this.map.removeLayer(_3b);},this);}},_updateReferenceLayer:function(_3c){this._removeReferenceLayer();for(var i=0;i<_3c.layers.length;i++){if(_3c.layers[i].isReference===true){this._addReferenceLayer(_3c.layers[i]);}}},_removeReferenceLayer:function(){for(var i=this.map.layerIds.length-1;i>=0;i--){var id=this.map.layerIds[i];var _3d=this.map.getLayer(id);if(_3d._basemapGalleryLayerType==="reference"){this.map.removeLayer(_3d);}}},_addReferenceLayer:function(_3e){this._getServiceInfo(_3e.url,dojo.hitch(this,"_handleReferenceServiceInfoResponse",_3e));},_handleReferenceServiceInfoResponse:function(_3f,_40,_41){var _42;_3f.serviceInfoResponse=_40;if(_40&&_40.mapName){if(_40.singleFusedMapCache===true){_42=this._loadAsCached(_3f);}else{_42=this._loadAsDynamic(_3f);}}else{if(_40&&_40.pixelSizeX){var _43=new esri.layers.ImageServiceParameters();_43.bandIds=_3f.bandIds;if(!_3f.bandIds&&_40.bandCount&&parseInt(_40.bandCount)>3){_43.bandIds=[0,1,2];}_42=new esri.layers.ArcGISImageServiceLayer(_3f.url,{resourceInfo:_40,opacity:_3f.opacity,visible:_3f.visibility,imageServiceParameters:_43});}}if(_42){_42._basemapGalleryLayerType="reference";this.map.addLayer(_42);}},_getServiceInfo:function(url,_44){var _45={};_45.f="json";var _46=esri.request({url:url,content:_45,callbackParamName:"callback",load:function(_47,_48){if(_44){_44(_47,_48);}},error:esriConfig.defaults.io.errorHandler});return _46;},_loadAsCached:function(_49){var _4a=[];if(!_49.displayLevels){_4a=dojo.map(_49.serviceInfoResponse.tileInfo.lods,function(lod){return lod.level;});}var _4b=new esri.layers.ArcGISTiledMapServiceLayer(_49.url,{resourceInfo:_49.serviceInfoResponse,opacity:_49.opacity,visible:_49.visibility,displayLevels:(_49.displayLevels)?_49.displayLevels:_4a});return _4b;},_loadAsDynamic:function(_4c){var _4d=new esri.layers.ArcGISDynamicMapServiceLayer(_4c.url,{resourceInfo:_4c.serviceInfoResponse,opacity:_4c.opacity,visible:_4c.visibility});if(_4c.visibleLayers){_4d.setVisibleLayers(_4c.visibleLayers);}return _4d;},_getIntersectionPercent:function(_4e,_4f){var _50=_4f.intersects(_4e);if(_50){var _51=_50.getWidth()*_50.getHeight();var _52=_4f.getWidth()*_4f.getHeight();return (_51/_52)*100;}else{return 0;}},_getIds:function(){var ids=[];dojo.forEach(this.basemaps,function(_53){ids.push(_53.id);},this);return ids;},_getUniqueId:function(){var _54=","+this._getIds().toString()+",";var _55=0;while(true){if(_54.indexOf(",basemap_"+_55+",")>-1){_55++;}else{return "basemap_"+_55;}}},_isUniqueId:function(id){var _56=","+this._getIds().toString()+",";if(_56.indexOf(","+id+",")===-1){return true;}return false;}});dojo.declare("esri.dijit.Basemap",null,{id:null,title:"",thumbnailUrl:null,layers:null,itemId:null,constructor:function(_57){_57=_57||{};if(!_57.layers&&!_57.itemId){console.error("esri.dijit.Basemap: unable to find the 'layers' property in parameters");}this.id=_57.id;this.itemId=_57.itemId;this.layers=_57.layers;this.title=_57.title?_57.title:"";this.thumbnailUrl=_57.thumbnailUrl;},getLayers:function(){if(this.layers){return this.layers;}else{if(this.itemId){var url=esri.dijit._arcgisUrl+"/content/items/"+this.itemId+"/data";var _58={};_58.f="json";var _59=esri.request({url:url,content:_58,callbackParamName:"callback",error:esriConfig.defaults.io.errorHandler});_59.addCallback(dojo.hitch(this,function(_5a,_5b){this.layers=[];dojo.forEach(_5a.baseMap.baseMapLayers,function(_5c){var _5d={};if(_5c.url){_5d.url=_5c.url;}if(_5c.type){_5d.type=_5c.type;}if(_5c.isReference){_5d.isReference=_5c.isReference;}if(_5c.displayLevels){_5d.displayLevels=_5c.displayLevels;}if(_5c.visibleLayers){_5d.visibleLayers=_5c.visibleLayers;}if(_5c.bandIds){_5d.bandIds=_5c.bandIds;}this.layers.push(new esri.dijit.BasemapLayer(_5d));},this);return this.layers;}));return _59;}}}});dojo.declare("esri.dijit.BasemapLayer",null,{constructor:function(_5e){_5e=_5e||{};if(!_5e.url&&!_5e.type){console.error("esri.dijit.BasemapLayer: unable to find the 'url' or 'type' property in parameters");}this.url=_5e.url;this.type=_5e.type;this.isReference=(_5e.isReference===true)?true:false;this.displayLevels=_5e.displayLevels;this.visibleLayers=_5e.visibleLayers;this.bandIds=_5e.bandIds;this.opacity=_5e.opacity;}});}