/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */

if(!dojo._hasResource["esri.dijit.editing.tools.AdvancedTools"]){dojo._hasResource["esri.dijit.editing.tools.AdvancedTools"]=true;dojo.require("esri.dijit.editing.tools.ToggleToolBase");dojo.require("esri.dijit.editing.tools.ButtonToolBase");dojo.provide("esri.dijit.editing.tools.AdvancedTools");dojo.provide("esri.dijit.editing.tools.Cut");dojo.provide("esri.dijit.editing.tools.Reshape");dojo.provide("esri.dijit.editing.tools.Union");dojo.declare("esri.dijit.editing.tools.Cut",[esri.dijit.editing.tools.ToggleToolBase],{id:"btnFeatureCut",_enabledIcon:"toolbarIcon cutIcon",_disabledIcon:"toolbarIcon cutIcon",_drawType:esri.toolbars.Draw.POLYLINE,_enabled:true,_label:"NLS_cutLbl",_cutConnects:[],activate:function(){this._cutConnects.push(dojo.connect(this._toolbar,"onDrawEnd",this,"_onDrawEnd"));this.inherited(arguments);},deactivate:function(){this.inherited(arguments);dojo.forEach(this._cutConnects,"dojo.disconnect(item);");this._cutConnects=[];this._edits=[];},_onDrawEnd:function(_1){var _2=this._settings.layers;var _3=this._cutLayers=dojo.filter(_2,function(_4){return ((_4.geometryType==="esriGeometryPolygon")||(_4.geometryType==="esriGeometryPolyline")&&_4.visible&&_4._isMapAtVisibleScale());});this._cutConnects=this._cutConnects.concat(dojo.map(_3,dojo.hitch(this,function(_5){return dojo.connect(_5,"onEditsComplete",dojo.hitch(this,function(_6,_7,_8){if(this._settings.undoRedoManager){var _9=this._settings.undoRedoManager;dojo.forEach(this._edits,dojo.hitch(this,function(_a){_9.add(new esri.dijit.editing.Cut({featureLayer:_a.layer,addedGraphics:_a.adds,preUpdatedGraphics:_a.preUpdates,postUpdatedGraphics:_a.updates}));}),this);}this.onFinished();}));})));var _b=new esri.tasks.Query();_b.geometry=_1;dojo.forEach(_3,function(_c,_d){this._settings.editor._selectionHelper.selectFeatures([_c],_b,esri.layers.FeatureLayer.SELECTION_NEW,dojo.hitch(this,"_cutFeatures",_c,_b));},this);},_cutFeatures:function(_e,_f,_10){if(!_10||!_10.length){return;}this._edits=[];var _11=[];_11.push(this._settings.geometryService.cut(esri.getGeometries(_10),_f.geometry,dojo.hitch(this,"_cutHandler",_e,_10)));var _12=new dojo.DeferredList(_11).addCallback(dojo.hitch(this,function(){this.onApplyEdits(this._edits);}));},_cutHandler:function(_13,_14,_15){var _16=[];var _17=[];var _18=dojo.map(_14,"return new esri.Graphic(dojo.clone(item.toJson()))");var _19;var _1a;dojo.forEach(_15.cutIndexes,function(_1b,i){if(_19!=_1b){_19=_1b;_17.push(_14[_1b].setGeometry(_15.geometries[i]));}else{_1a=new esri.Graphic(_15.geometries[i],null,dojo.mixin({},_14[_1b].attributes),null);_1a.attributes[_14[0].getLayer().objectIdField]=null;_16.push(_1a);}},this);this._edits.push({layer:_13,adds:_16,updates:_17,preUpdates:_18});}});dojo.declare("esri.dijit.editing.tools.Reshape",[esri.dijit.editing.tools.ToggleToolBase],{id:"btnFeatureReshape",_enabledIcon:"toolbarIcon reshapeIcon",_disabledIcon:"toolbarIcon reshapeIcon",_drawType:esri.toolbars.Draw.POLYLINE,_enabled:true,_label:"NLS_reshapeLbl",activate:function(){dojo.disconnect(this._rConnect);this._rConnect=dojo.connect(this._toolbar,"onDrawEnd",this,"_onDrawEnd");this.inherited(arguments);},deactivate:function(){this.inherited(arguments);dojo.disconnect(this._rConnect);delete this._rConnect;},_onDrawEnd:function(_1c){var _1d=this._settings.layers;var _1e=new esri.tasks.Query();_1e.geometry=_1c;var _1f=this._reshapeLayers=dojo.filter(_1d,function(_20){return (_20.geometryType==="esriGeometryPolygon"||"esriGeometryPolyline");});this._settings.editor._selectionHelper.selectFeatures(_1f,_1e,esri.layers.FeatureLayer.SELECTION_NEW,dojo.hitch(this,"_reshape",_1e));},_reshape:function(_21,_22){var _23=[];var _24=_22;if(_24.length!==1){return;}this._settings.geometryService.reshape(_24[0].geometry,_21.geometry,dojo.hitch(this,function(_25){var _26=[_24[0].setGeometry(_25)];this.onApplyEdits([{layer:_24[0].getLayer(),updates:_26}],dojo.hitch(this,function(){this._settings.editor._selectionHelper.clearSelection(false);this.onFinished();}));}));}});dojo.declare("esri.dijit.editing.tools.Union",[esri.dijit.editing.tools.ButtonToolBase],{id:"btnFeatureUnion",_enabledIcon:"toolbarIcon unionIcon",_disabledIcon:"toolbarIcon unionIcon",_drawType:esri.toolbars.Draw.POLYLINE,_enabled:true,_label:"NLS_unionLbl",_onClick:function(evt){this._settings.editor._activeTool="UNION";var _27=this._settings.layers;var _28=dojo.filter(_27,"return (item.geometryType === 'esriGeometryPolygon') && (item.visible && item._isMapAtVisibleScale());");var _29=[];var _2a=0;dojo.forEach(_28,function(_2b,idx){var _2c=_2b.getSelectedFeatures();if(_2c.length>=2){_2a++;var _2d=dojo.map(_2c,"return new esri.Graphic(dojo.clone(item.toJson()))");this._settings.geometryService.union(esri.getGeometries(_2c),dojo.hitch(this,function(_2e){var _2f=[_2c.pop().setGeometry(_2e)];_29.push({layer:_2b,updates:_2f,deletes:_2c,preUpdates:_2d});_2a--;if(_2a<=0){this.onApplyEdits(_29,dojo.hitch(this,function(){if(this._settings.undoRedoManager){var _30=this._settings.undoRedoManager;dojo.forEach(this._edits,dojo.hitch(this,function(_31){_30.add(new esri.dijit.editing.Union({featureLayer:_31.layer,addedGraphics:_31.deletes,preUpdatedGraphics:_31.preUpdates,postUpdatedGraphics:_31.updates}));}),this);}this._settings.editor._selectionHelper.clearSelection(false);this.onFinished();}));}}));}},this);}});}