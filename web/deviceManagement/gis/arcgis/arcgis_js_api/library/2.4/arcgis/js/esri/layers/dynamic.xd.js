/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */

window[esri._dojoScopeName||"dojo"]._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","esri.layers.dynamic"],["require","esri.layers.layer"],["require","esri.geometry"],["require","dojox.xml.parser"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["esri.layers.dynamic"]){_4._hasResource["esri.layers.dynamic"]=true;_4.provide("esri.layers.dynamic");_4.require("esri.layers.layer");_4.require("esri.geometry");_4.require("dojox.xml.parser");_4.declare("esri.layers.DynamicMapServiceLayer",esri.layers.Layer,{constructor:function(_7,_8){this.useMapTime=(_8&&_8.hasOwnProperty("useMapTime"))?(!!_8.useMapTime):true;var dh=_4.hitch;this._exportMapImageHandler=dh(this,this._exportMapImageHandler);this._imgSrcFunc=dh(this,this._imgSrcFunc);this._divAlphaImageFunc=dh(this,this._divAlphaImageFunc);this._tileLoadHandler=dh(this,this._tileLoadHandler);this._tileErrorHandler=dh(this,this._tileErrorHandler);},opacity:1,isPNG32:false,_setMap:function(_9,_a,_b){this._map=_9;var d=(this._div=_4.create("div",null,_a));var _c={position:"absolute",left:"0px",top:"0px",width:_9.width+"px",height:_9.height+"px",overflow:"visible",opacity:this.opacity};var _d=_4.isIE;if(_d&&_d>7){delete _c["opacity"];}_4.style(d,_c);this._layerIndex=_b;var dc=_4.connect;this._onPanHandler_connect=dc(_9,"onPan",this,"_onPanHandler");this._onExtentChangeHandler_connect=dc(_9,"onExtentChange",this,"_onExtentChangeHandler");this._toggleTime();this._onZoomHandler_connect=dc(_9,"onZoom",this,"_onZoomHandler");this._onResizeHandler_connect=dc(_9,"onResize",this,"_onResizeHandler");this._opacityChangeHandler_connect=dc(this,"onOpacityChange",this,"_opacityChangeHandler");this._visibilityChangeHandler_connect=dc(this,"onVisibilityChange",this,"_visibilityChangeHandler");this._img_loading=null;this._img_dragOrigin={x:0,y:0};if(!this.visible){this._visibilityChangeHandler(this.visible);}else{if(_9.extent&&_9.loaded){this._onExtentChangeHandler(_9.extent);}}return d;},_unsetMap:function(_e,_f){if(_f){this._div=_f.removeChild(this._div);}_4.destroy(this._div);this._map=this._layerIndex=this._div=null;var dd=_4.disconnect;dd(this._onPanHandler_connect);dd(this._onExtentChangeHandler_connect);dd(this._onZoomHandler_connect);dd(this._onResizeHandler_connect);dd(this._opacityChangeHandler_connect);dd(this._visibilityChangeHandler_connect);this._toggleTime();},_onResizeHandler:function(_10,_11,_12){_4.style(this._div,{width:_11+"px",height:_12+"px"});this._onExtentChangeHandler(_10);},_visibilityChangeHandler:function(v){var dc=_4.connect,dd=_4.disconnect;this._toggleTime();if(v){this._onExtentChangeHandler(this._map.extent);this._onPanHandler_connect=dc(this._map,"onPan",this,"_onPanHandler");this._onExtentChangeHandler_connect=dc(this._map,"onExtentChange",this,"_onExtentChangeHandler");this._onZoomHandler_connect=dc(this._map,"onZoom",this,"_onZoomHandler");}else{esri.hide(this._div);dd(this._onPanHandler_connect);dd(this._onExtentChangeHandler_connect);dd(this._onZoomHandler_connect);}},_toggleTime:function(){var map=this._map;if(this.timeInfo&&this.useMapTime&&map&&this.visible){if(!this._timeConnect){this._timeConnect=_4.connect(map,"onTimeExtentChange",this,this._onTimeExtentChangeHandler);}this._setTime(map.timeExtent);}else{_4.disconnect(this._timeConnect);this._timeConnect=null;this._setTime(null);}},_setTime:function(_13){if(this._params){this._params.time=_13?_13.toJson().join(","):null;}},_onPanHandler:function(_14,_15){this._panDx=_15.x;this._panDy=_15.y;var _16=this._img_dragOrigin,img=this._img;if(img){_4.style(img,{left:(_16.x+_15.x)+"px",top:(_16.y+_15.y)+"px"});}},_onExtentChangeHandler:function(_17,_18,_19){if(!this.visible){return;}this._fireUpdateStart();var _1a=this._map,_1b=this._img,_1c=_1b&&_1b.style,_1d=this._img_dragOrigin;if(_18&&!_19&&_1b&&(_18.x!==this._panDx||_18.y!==this._panDy)){_4.style(_1b,{left:(_1d.x+_18.x)+"px",top:(_1d.y+_18.y)+"px"});}if(_1b){_1d.x=parseInt(_1c.left);_1d.y=parseInt(_1c.top);}else{_1d.x=(_1d.y=0);}var _1e=this._img_loading;if(_1e){_4.disconnect(_1e._onload_connect);_4.disconnect(_1e._onerror_connect);_4.disconnect(_1e._onabort_connect);_4.destroy(_1e);this._img_loading=null;var _1f=this._jsonRequest;if(_1f){try{_1f.cancel();}catch(e){}this._jsonRequest=null;}}if(this.version>=10&&_1a.wrapAround180){_17=_17._normalize(true);}if(this.isPNG32){var div=(this._img_loading=_4.create("div"));div.id=_1a.id+"_"+this.id+"_"+new Date().getTime();_4.style(div,{position:"absolute",left:"0px",top:"0px",width:_1a.width+"px",height:_1a.height+"px"});var _20=div.appendChild(_4.create("div"));_4.style(_20,{opacity:0,width:_1a.width+"px",height:_1a.height+"px"});this.getImageUrl(_17,_1a.width,_1a.height,this._divAlphaImageFunc);div=null;}else{var img=(this._img_loading=_4.create("img"));img.id=_1a.id+"_"+this.id+"_"+new Date().getTime();var _21={position:"absolute",left:"0px",top:"0px",width:_1a.width+"px",height:_1a.height+"px"};var _22=_4.isIE;if(_22&&_22>7){_21.opacity=this.opacity;}_4.style(img,_21);img._onload_connect=_4.connect(img,"onload",this,"_onLoadHandler");img._onerror_connect=_4.connect(img,"onerror",this,"_onErrorHandler");img._onabort_connect=_4.connect(img,"onabort",this,"_onErrorHandler");this._startRect={left:_1d.x,top:_1d.y,width:_1b?parseInt(_1c.width):_1a.width,height:_1b?parseInt(_1c.height):_1a.height,zoom:(_1c&&_1c.zoom)?parseFloat(_1c.zoom):1};this.getImageUrl(_17,_1a.width,_1a.height,this._imgSrcFunc);img=null;}},_onTimeExtentChangeHandler:function(_23){if(!this.visible){return;}this._setTime(_23);this.refresh(true);},getImageUrl:function(_24,wd,ht,_25){},_imgSrcFunc:function(src){this._img_loading.src=src;},_divAlphaImageFunc:function(src){_4.style(this._img_loading,"filter","progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+src+"', sizingMethod='scale')");this._onLoadHandler({currentTarget:this._img_loading});},_onLoadHandler:function(evt){var img=evt.currentTarget,dd=_4.disconnect,_26=this._map;dd(img._onload_connect);dd(img._onerror_connect);dd(img._onabort_connect);if(!_26||_26.__panning){_4.destroy(img);this._fireUpdateEnd();return;}_6.xml.parser.removeChildren(this._div);this._img=img;this._startRect={left:0,top:0,width:_26.width,height:_26.height,zoom:1};this._div.appendChild(img);if(this.visible){esri.show(this._div);}img._onload_connect=img._onerror_connect=img._onabort_connect=this._img_loading=null;var _27=this._img_dragOrigin;_27.x=(_27.y=0);this.onUpdate();this._fireUpdateEnd();},_onErrorHandler:function(evt){var img=evt.currentTarget,dd=_4.disconnect;_4.style(img,"visibility","hidden");dd(img._onload_connect);dd(img._onerror_connect);dd(img._onabort_connect);img._onload_connect=img._onerror_connect=img._onabort_connect=null;var _28=new Error(esri.bundle.layers.dynamic.imageError+": "+img.src);this.onError(_28);this._fireUpdateEnd(_28);},setUseMapTime:function(use,_29){this.useMapTime=use;this._toggleTime();if(!_29){this.refresh(true);}},refresh:function(){if(this._map){this._onExtentChangeHandler(this._map.extent);}},_onZoomHandler:function(_2a,_2b,_2c){var _2d=this._startRect,_2e={width:_2d.width*_2b,height:_2d.height*_2b},img=this._img;if(img){var _2f=_4.isIE;if(_2f&&_2f<8){_4.style(img,{left:(_2d.left-((_2e.width-_2d.width)*(_2c.x-_2d.left)/_2d.width))+"px",top:(_2d.top-((_2e.height-_2d.height)*(_2c.y-_2d.top)/_2d.height))+"px",zoom:_2b*_2d.zoom});}else{_4.style(img,{left:(_2d.left-((_2e.width-_2d.width)*(_2c.x-_2d.left)/_2d.width))+"px",top:(_2d.top-((_2e.height-_2d.height)*(_2c.y-_2d.top)/_2d.height))+"px",width:_2e.width+"px",height:_2e.height+"px"});}}},_exportMapImage:function(url,_30,_31){var _32=this._exportMapImageHandler;esri.request({url:url,content:_30,callbackParamName:"callback",load:function(){_32(arguments[0],arguments[1],_31);},error:esri.config.defaults.io.errorHandler});},_exportMapImageHandler:function(_33,io,_34){var _35=new esri.layers.MapImage(_33);this.onMapImageExport(_35);if(_34){_34(_35);}},onMapImageExport:function(){},setOpacity:function(o){if(this.opacity!=o){this.onOpacityChange(this.opacity=o);}},onOpacityChange:function(){},_opacityChangeHandler:function(_36){_4.style(this._div,"opacity",_36);}});}}};});