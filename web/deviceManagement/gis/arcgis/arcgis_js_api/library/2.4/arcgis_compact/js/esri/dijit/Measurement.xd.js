/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */

window[esri._dojoScopeName||"dojo"]._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","esri.dijit.Measurement"],["require","dijit._Widget"],["require","dijit._Templated"],["require","esri.map"],["require","esri.geometry"],["require","esri.symbol"],["require","dojo.parser"],["require","dijit.layout.ContentPane"],["require","dijit.Menu"],["require","dijit.form.Button"],["require","esri.tasks.geometry"],["require","esri.WKIDUnitConversion"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["esri.dijit.Measurement"]){_4._hasResource["esri.dijit.Measurement"]=true;_4.provide("esri.dijit.Measurement");_4.require("dijit._Widget");_4.require("dijit._Templated");_4.require("esri.map");_4.require("esri.geometry");_4.require("esri.symbol");_4.require("dojo.parser");_4.require("dijit.layout.ContentPane");_4.require("dijit.Menu");_4.require("dijit.form.Button");_4.require("esri.tasks.geometry");_4.require("esri.WKIDUnitConversion");(function(){var _7=[_4.moduleUrl("esri.dijit","css/Measurement.css")];var _8=document.getElementsByTagName("head").item(0),_9;for(var i=0,il=_7.length;i<il;i++){_9=document.createElement("link");_9.type="text/css";_9.rel="stylesheet";_9.href=_7[i].toString();_8.appendChild(_9);}}());_4.declare("esri.dijit.Measurement",[_5._Widget,_5._Templated],{widgetsInTemplate:true,templateString:"<div style=\"padding:8px;\">\r\n  <div dojoType='dijit.form.ToggleButton' baseClass='esriButton' id='area' checked='false' iconClass='areaIcon' showLabel='false' dojoAttachEvent='onClick:areaToggleButton'></div>\r\n  <div dojoType='dijit.form.ToggleButton' baseClass='esriButton' id='distance' iconClass='distanceIcon' showLabel='false' dojoAttachEvent='onClick:distanceToggleButton'></div>\r\n  <div dojoType='dijit.form.ToggleButton' baseClass='esriButton' id='location' iconClass='locationIcon' showLabel='false' dojoAttachEvent='onClick:locationToggleButton'></div>\r\n  <div style=\"display:inline;margin-left:2px;margin-right:2px;padding-top:2px;\">|</div>\r\n  <button dojoType='dijit.form.DropDownButton' baseClass='esriToggleButton' id='unit' label='unit' value='unit' style='visibility:hidden;'></button>\r\n  <div dojoType='dijit.layout.ContentPane' id='resultLabel' class='resultLabel'></div>\r\n  <div dojoType='dijit.layout.ContentPane' id='result' name='result' align='left' class='result'></div>\r\n</div>\r\n",unitDictionary:[],result:null,inputPoints:[],measureGraphics:[],constructor:function(_a,_b){_a=_a||{};if(!_a.map){console.log("dijit.MeasureTool: unable to find the 'map' property in parameters");return;}this._map=_a.map;this._map.cs=this._checkCS(this._map.spatialReference);this._geometryService=esri.config.defaults.geometryService;if(_a.pointSymbol){this._pointSymbol=_a.pointSymbol;}else{var _c=_4.moduleUrl("esri.dijit","./images/flag.png");this._pointSymbol=new esri.symbol.PictureMarkerSymbol(_c.uri,24,24);this._pointSymbol.setOffset(9,11);}if(_a.lineSymbol){this._lineSymbol=_a.lineSymbol;}else{this._lineSymbol=new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new _4.Color([0,128,255]),3);}if(_a.defaultLengthUnit){this._defaultLengthUnit=_a.defaultLengthUnit;}else{this._defaultLengthUnit=esri.Units.MILES;}if(_a.defaultAreaUnit){this._defaultAreaUnit=_a.defaultAreaUnit;}else{this._defaultAreaUnit=esri.Units.ACRES;}this._snappingCallback=_4.hitch(this,this._snappingCallback);},startup:function(){var _d=esri.bundle.widgets.measurement;this.unitDictionary[_d.NLS_length_miles]=1;this.unitDictionary[_d.NLS_length_kilometers]=1.609344;this.unitDictionary[_d.NLS_length_feet]=5280;this.unitDictionary[_d.NLS_length_meters]=1609.34;this.unitDictionary[_d.NLS_length_yards]=1760;this.unitDictionary["Nautical Miles"]=0.869;this.unitDictionary[_d.NLS_area_acres]=1;this.unitDictionary[_d.NLS_area_sq_kilometers]=0.004047;this.unitDictionary[_d.NLS_area_sq_miles]=0.0015625;this.unitDictionary[_d.NLS_area_sq_feet]=43560;this.unitDictionary[_d.NLS_area_sq_meters]=4046.87;this.unitDictionary[_d.NLS_area_hectares]=0.4047;this.unitDictionary[_d.NLS_area_sq_yards]=4840;this.units={"esriMiles":_d.NLS_length_miles,"esriKilometers":_d.NLS_length_kilometers,"esriFeet":_d.NLS_length_feet,"esriMeters":_d.NLS_length_meters,"esriYards":_d.NLS_length_yards,"esriAcres":_d.NLS_area_acres,"esriSquareKilometers":_d.NLS_area_sq_kilometers,"esriSquareMiles":_d.NLS_area_sq_miles,"esriSquareFeet":_d.NLS_area_sq_feet,"esriSquareMeters":_d.NLS_area_sq_meters,"esriHectares":_d.NLS_area_hectares,"esriSquareYards":_d.NLS_area_sq_yards};_5.byId("distance").setLabel(esri.bundle.widgets.measurement.NLS_distance);_5.byId("area").setLabel(esri.bundle.widgets.measurement.NLS_area);_5.byId("location").setLabel(esri.bundle.widgets.measurement.NLS_location);_5.byId("resultLabel").setContent(esri.bundle.widgets.measurement.NLS_resultLabel);},measureArea:function(){this._map.__setClickDuration(0);this._createAreaUnitList();this.inputPoints=[];this.tempGraphic=new esri.Graphic();this.tempGraphic.setSymbol(this._lineSymbol);this.tempGraphic.setGeometry(new esri.geometry.Polyline());this._map.graphics.add(this.tempGraphic);if(this._map.cs==="PCS"){this._geometryAreaHandler=_4.connect(this._geometryService,"onAreasAndLengthsComplete",this,"_outputArea");}this.mouseClickMapHandler=_4.connect(this._map,"onClick",this,"_measureAreaMouseClickHandler");this.doubleClickMapHandler=_4.connect(this._map,"onDblClick",this,"_measureAreaDblClickHandler");},measureDistance:function(){this._map.__setClickDuration(0);if(this._map.cs==="PCS"){this._projectMapExtent(this._map.extent);this._mapExtentChangeHandler=_4.connect(this._map,"onExtentChange",this,"_projectMapExtent");}this.inputPoints=[];this._createLengthUnitList();this.mouseClickMapHandler=_4.connect(this._map,"onClick",this,"_measureDistanceMouseClickHandler");this.doubleClickMapHandler=_4.connect(this._map,"onDblClick",this,"_measureDistanceDblClickHandler");},measureLocation:function(){this._map.__setClickDuration(0);this.measureGraphics=[];this._map.graphics.remove(this.locationGraphic);if(this._map.cs==="PCS"){this._projectMapExtent(this._map.extent);this._mapExtentChangeHandler=_4.connect(this._map,"onExtentChange",_4.hitch(this,this._projectMapExtent));}this._clickMapHandler=_4.connect(this._map,"onClick",this,"_measureLocationClickHandler");this.mouseMoveMapHandler=_4.connect(this._map,"onMouseMove",this,"_showCoordinates");this.mouseDragMapHandler=_4.connect(this._map,"onMouseDrag",_4.hitch(this,function(){_5.byId("result").setAttribute("disabled",true);}));},setTool:function(_e,_f){this.closeTool();var _10=_5.byId(_e).checked;_4.style(_5.byId("unit").domNode,"visibility","visible");_5.byId("area").setAttribute("checked",false);_5.byId("distance").setAttribute("checked",false);_5.byId("location").setAttribute("checked",false);if(_f===true||_f===false){_10=_f;}_5.byId(_e).setAttribute("checked",_10);if(_10){this.activeTool=_e;this._map.disableDoubleClickZoom();if(_e==="area"){this.measureArea();}else{if(_e==="distance"){this.measureDistance();}else{if(_e==="location"){_4.style(_5.byId("unit").domNode,"visibility","hidden");this.measureLocation();}}}if(this._map.snappingManager){this._map.snappingManager._startSelectionLayerQuery();this._map.snappingManager._setUpSnapping();}}},areaToggleButton:function(){this.clearResult();this.setTool("area");},distanceToggleButton:function(){this.clearResult();this.setTool("distance");},locationToggleButton:function(){this.clearResult();this.setTool("location");},closeTool:function(){var map=this._map;map.__resetClickDuration();map.enableDoubleClickZoom();this.inputPoints=[];if(map.snappingManager&&map.snappingManager._snappingGraphic){map.graphics.remove(map.snappingManager._snappingGraphic);}_4.disconnect(this.mouseClickMapHandler);_4.disconnect(this.mouseMoveMapHandler);_4.disconnect(this.doubleClickMapHandler);_4.disconnect(this.mouseDragMapHandler);_4.disconnect(this._clickMapHandler);_4.disconnect(this._mapExtentChangeHandler);_4.disconnect(this._geometryAreaHandler);if(this._map.snappingManager){this._map.snappingManager._stopSelectionLayerQuery();this._map.snappingManager._killOffSnapping();}},clearResult:function(){var map=this._map;this.result=0;_5.byId("result").setAttribute("content","");for(var i=0;i<this.measureGraphics.length;i++){map.graphics.remove(this.measureGraphics[i]);}this.measureGraphics=[];map.graphics.remove(this.tempGraphic);},show:function(){esri.show(this.domNode);},hide:function(){esri.hide(this.domNode);},showTool:function(_11){var _12=_4.query("[widgetid='"+_11+"']",this.domNode)[0];_12.style.display="inline";},hideTool:function(_13){var _14=_4.query("[widgetid='"+_13+"']",this.domNode)[0];_14.style.display="none";},destroy:function(){this.closeTool();this.clearResult();this.inherited(arguments);this._map=this._geometryService=this.measureGraphic=this.measureGraphic=this.tempGraphic=null;},onMeasureEnd:function(){},_densifiedLine:function(_15){if(this._map.cs==="Web Mercator"){_15=esri.geometry.webMercatorToGeographic(_15);}var _16;if(this._map.cs==="PCS"){_16=_15;}else{_16=esri.geometry.geodesicDensify(_15,500000);}if(this._map.cs==="Web Mercator"){_16=esri.geometry.geographicToWebMercator(_16);}return _16;},_measureAreaMouseClickHandler:function(evt){var _17;if(this._map.snappingManager){_17=this._map.snappingManager._snappingPoint;}var _18=_17||evt.mapPoint;this.inputPoints.push(_18);this._currentStartPt=_18;if(this.inputPoints.length===1){this.tempGraphic.setGeometry(new esri.geometry.Polyline());for(var i=0;i<this.measureGraphics.length;i++){this._map.graphics.remove(this.measureGraphics[i]);}this.measureGraphics=[];this.result=0;this._outputResult(this.result,esri.bundle.widgets.measurement.NLS_area_acres);this.mouseMoveMapHandler=_4.connect(this._map,"onMouseMove",this,"_measureAreaMouseMoveHandler");}this.measureGraphic=new esri.Graphic();this.measureGraphic.setSymbol(this._lineSymbol);this.measureGraphics.push(this.measureGraphic);if(this.inputPoints.length>1){var _19=new esri.geometry.Polyline(this._map.spatialReference);_19.addPath([this.inputPoints[this.inputPoints.length-2],_18]);var _1a=new esri.geometry.Polyline(this._map.spatialReference);_1a.addPath([this.inputPoints[0],_18]);var _1b=this._densifiedLine(_19);var _1c=this._densifiedLine(_1a);this.tempGraphic.setGeometry(_1c);this.measureGraphic.setGeometry(_1b);this._map.graphics.add(this.measureGraphic);}},_measureAreaMouseMoveHandler:function(evt){var _1d;if(this.inputPoints.length>0){var _1e=new esri.geometry.Polyline(this._map.spatialReference);var _1f;if(this._map.snappingManager){_1f=this._map.snappingManager._snappingPoint;}_1d=_1f||evt.mapPoint;_1e.addPath([this._currentStartPt,_1d]);var _20=this._densifiedLine(_1e);this.tempGraphic.setGeometry(_20);}if(this.inputPoints.length>1){var _21=new esri.geometry.Polyline(this._map.spatialReference);_21.addPath([_1d,this.inputPoints[0]]);var _22=this._densifiedLine(_21);this.tempGraphic.setGeometry(this.tempGraphic.geometry.addPath(_22.paths[0]));}},_measureAreaDblClickHandler:function(evt){_4.disconnect(this.mouseMoveMapHandler);var _23=new esri.geometry.Polygon(this._map.spatialReference);var _24=[];for(var i=0;i<this.inputPoints.length;i++){_24.push([this.inputPoints[i].x,this.inputPoints[i].y]);}_24.push([this.inputPoints[0].x,this.inputPoints[0].y]);_23.addRing(_24);this.inputPoints=[];this._getArea(_23);},_getArea:function(_25){var _26=[];var _27=new esri.tasks.AreasAndLengthsParameters();_27.areaUnit=esri.tasks.GeometryService.UNIT_ACRES;if(esri.geometry.polygonSelfIntersecting(_25)){this._geometryService.simplify([_25],_4.hitch(this,function(_28){_4.forEach(_28,_4.hitch(this,function(_29,idx){if(this._map.cs==="PCS"){_27.polygons=_28;this._geometryService.areasAndLengths(_27);return;}else{if(this._map.cs==="Web Mercator"){_29=esri.geometry.webMercatorToGeographic(_29);}}_26.push(_29);}));var _2a=esri.geometry.geodesicAreas(_26,esri.Units.ACRES);this._showArea(_2a[0]);}));}else{if(this._map.cs==="Web Mercator"){_25=esri.geometry.webMercatorToGeographic(_25);}_26.push(_25);if(this._map.cs==="PCS"){_27.polygons=_26;this._geometryService.areasAndLengths(_27);return;}var _2b=esri.geometry.geodesicAreas(_26,esri.Units.ACRES);this._showArea(Math.abs(_2b[0]));}},_outputArea:function(_2c){this._showArea(Math.abs(_2c.areas[0]));},_showArea:function(_2d){if(_2d){this.result=_2d;var _2e=_5.byId("unit").label;this._outputResult(this.result,_2e);}this.onMeasureEnd(this.activeTool);},_measureDistanceDblClickHandler:function(evt){_4.disconnect(this.mouseMoveMapHandler);this.inputPoints=[];this.onMeasureEnd(this.activeTool);},_measureDistanceMouseClickHandler:function(evt){var _2f;if(this._map.snappingManager){_2f=this._map.snappingManager._snappingPoint;}var _30=_2f||evt.mapPoint;this.inputPoints.push(_30);this._currentStartPt=_30;if(this.inputPoints.length===1){for(var i=0;i<this.measureGraphics.length;i++){this._map.graphics.remove(this.measureGraphics[i]);}this._map.graphics.remove(this.tempGraphic);this.measureGraphics=[];this.result=0;this._outputResult(this.result,esri.bundle.widgets.measurement.NLS_length_miles);this.tempGraphic=new esri.Graphic();this.tempGraphic.setSymbol(this._lineSymbol);this._map.graphics.add(this.tempGraphic);this.mouseMoveMapHandler=_4.connect(this._map,"onMouseMove",this,"_measureDistanceMouseMoveHandler");}this.tempGraphic.setGeometry(new esri.geometry.Polyline());this.flagGraphic=new esri.Graphic();this.flagGraphic.setSymbol(this._pointSymbol);this.flagGraphic.setGeometry(_30);this.measureGraphics.push(this.flagGraphic);this._map.graphics.add(this.flagGraphic);if(this.inputPoints.length>1){this.measureGraphic=new esri.Graphic();this.measureGraphic.setSymbol(this._lineSymbol);this.measureGraphics.push(this.measureGraphic);var _31=new esri.geometry.Polyline(this._map.spatialReference);_31.addPath([this.inputPoints[this.inputPoints.length-2],_30]);var _32=this._densifiedLine(_31);this.measureGraphic.setGeometry(_32);this._map.graphics.add(this.measureGraphic);this.result+=this._geodesicDistance(this.inputPoints[this.inputPoints.length-2],_30);this._showDistance(this.result);}},_measureDistanceMouseMoveHandler:function(evt){if(this.inputPoints.length>0){var _33=new esri.geometry.Polyline(this._map.spatialReference);var _34;if(this._map.snappingManager){_34=this._map.snappingManager._snappingPoint;}var _35=_34||evt.mapPoint;_33.addPath([this._currentStartPt,_35]);var _36=this._densifiedLine(_33);this.tempGraphic.setGeometry(_36);var _37=this._geodesicDistance(this._currentStartPt,_35);this._showDistance(_37+this.result);}},_geodesicDistance:function(pt1,pt2){var _38=new esri.geometry.Polyline(this._map.spatialReference);if(this._map.cs==="PCS"){pt1=this._getGCSLocation(pt1);pt2=this._getGCSLocation(pt2);}_38.addPath([pt1,pt2]);if(this._map.cs==="Web Mercator"){_38=esri.geometry.webMercatorToGeographic(_38);}return esri.geometry.geodesicLengths([_38],esri.Units.MILES)[0];},_showDistance:function(_39){if(_39){this._outputResult(_39,_5.byId("unit").label);}},_measureLocationClickHandler:function(evt){_5.byId("location").setAttribute("checked",false);var _3a;if(this._map.snappingManager){_3a=this._map.snappingManager._snappingPoint;}var _3b=_3a||evt.mapPoint;this.locationToggleButton();this.locationGraphic=new esri.Graphic();this.locationGraphic.setGeometry(_3b);this.locationGraphic.setSymbol(this._pointSymbol);this._map.graphics.add(this.locationGraphic);this.measureGraphics.push(this.locationGraphic);var _3c={mapPoint:_3b};this._showCoordinates(_3c);_4.style(_5.byId("unit").domNode,"visibility","hidden");this.onMeasureEnd(this.activeTool);},_getGCSLocation:function(pt){var _3d=pt;if(this._map.cs==="Web Mercator"){_3d=esri.geometry.webMercatorToGeographic(_3d);}else{if(this._map.cs==="PCS"){if(this._map._newExtent){var _3e=Math.abs((this._map._newExtent.xmax-this._map._newExtent.xmin)/(this._map.extent.xmax-this._map.extent.xmin));var _3f=Math.abs((this._map._newExtent.ymax-this._map._newExtent.ymin)/(this._map.extent.ymax-this._map.extent.ymin));var _40=(_3d.x-this._map.extent.xmin)*_3e+this._map._newExtent.xmin;var _41=(_3d.y-this._map.extent.ymin)*_3f+this._map._newExtent.ymin;_3d=new esri.geometry.Point(_40,_41);}}}return _3d;},_projectMapExtent:function(_42){var _43=new esri.Graphic(_42);var _44=new esri.SpatialReference({wkid:4326});this._geometryService.project([_43.geometry],_44,_4.hitch(this,function(_45){if(!this.mouseMoveMapHandler&&this.activeTool==="location"){this.mouseMoveMapHandler=_4.connect(this._map,"onMouseMove",_4.hitch(this,this._showCoordinates));this.mouseDragMapHandler=_4.connect(this._map,"onMouseDrag",_4.hitch(this,function(){_5.byId("result").setAttribute("disabled",true);}));}this._map._newExtent=_45[0];}));},_showCoordinates:function(evt){var _46;if(this._map.snappingManager){_46=this._map.snappingManager._snappingPoint;}var _47=_46||evt.mapPoint;var _48=this._getGCSLocation(_47);var lon=Math.floor(_48.x)+"°"+Math.floor((_48.x-Math.floor(_48.x))*60)+"'"+Math.floor(((_48.x-Math.floor(_48.x))*60-Math.floor((_48.x-Math.floor(_48.x))*60))*60)+"\"";var lat=Math.floor(_48.y)+"°"+Math.floor((_48.y-Math.floor(_48.y))*60)+"'"+Math.floor(((_48.y-Math.floor(_48.y))*60-Math.floor((_48.y-Math.floor(_48.y))*60))*60)+"\"";_5.byId("result").setAttribute("content",esri.bundle.widgets.measurement.NLS_longitude+": "+lon+"<br/>"+esri.bundle.widgets.measurement.NLS_latitude+": "+lat);},_checkCS:function(_49){if(_49.wkid){if(_49.wkid===3857||_49.wkid===102100||_49.wkid===102113){return "Web Mercator";}if(esri._isDefined(esri.WKIDUnitConversion[_49.wkid])){return "PCS";}return "GCS";}if(_49.wkt){if(_49.wkt.indexOf("WGS_1984_Web_Mercator")!==-1){return "Web Mercator";}if(_49.wkt.indexOf("PROJCS")===0){return "PCS";}return "GCS";}},_switchUnit:function(_4a){_5.byId("unit").setAttribute("label",_4a);if(this.result===null){return;}this._outputResult(this.result,_4a);},_outputResult:function(_4b,_4c){var _4d=_4b*this.unitDictionary[_4c];if(_4d===0){_5.byId("result").setAttribute("content","");}else{if(_4d>1000000){_5.byId("result").setAttribute("content",_4d.toPrecision(9)+" "+_4c);}else{_5.byId("result").setAttribute("content",_4d.toFixed(2)+" "+_4c);}}},_createLengthUnitList:function(){var _4e=new _5.Menu({style:"display: none;"});var _4f=esri.bundle.widgets.measurement;var _50=[_4f.NLS_length_miles,_4f.NLS_length_kilometers,_4f.NLS_length_feet,_4f.NLS_length_meters,_4f.NLS_length_yards];_4.forEach(_50,_4.hitch(this,function(_51,idx){var _52=new _5.MenuItem({label:_51,onClick:_4.hitch(this,function(){this._switchUnit(_51);})});_52.setAttribute("class","unitDropDown");_4e.addChild(_52);}));_5.byId("unit").setAttribute("dropDown",_4e);var _53=this.units[this._defaultLengthUnit];_5.byId("unit").setAttribute("label",_53);_4.attr(_4.byId("unit_label"),"class","unitDropDown");},_createAreaUnitList:function(){var _54=new _5.Menu({style:"display: none;"});var _55=esri.bundle.widgets.measurement;var _56=[_55.NLS_area_acres,_55.NLS_area_sq_miles,_55.NLS_area_sq_kilometers,_55.NLS_area_hectares,_55.NLS_area_sq_yards,_55.NLS_area_sq_feet,_55.NLS_area_sq_meters];_4.forEach(_56,_4.hitch(this,function(_57,idx){var _58=new _5.MenuItem({label:_57,onClick:_4.hitch(this,function(){this._switchUnit(_57);})});_58.setAttribute("class","unitDropDown");_54.addChild(_58);}));_5.byId("unit").setAttribute("dropDown",_54);var _59=this.units[this._defaultAreaUnit];_5.byId("unit").setAttribute("label",_59);_4.attr(_4.byId("unit_label"),"class","unitDropDown");}});}}};});