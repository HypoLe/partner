/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */

window[esri._dojoScopeName||"dojo"]._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","esri.layers.tiled"],["require","dojox.collections.ArrayList"],["require","esri.layers.layer"],["require","esri.geometry"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["esri.layers.tiled"]){_4._hasResource["esri.layers.tiled"]=true;_4.provide("esri.layers.tiled");_4.require("dojox.collections.ArrayList");_4.require("esri.layers.layer");_4.require("esri.geometry");_4.declare("esri.layers.TiledMapServiceLayer",esri.layers.Layer,{constructor:function(_7,_8){_4.connect(this,"onLoad",this,"_initTiledLayer");this._displayLevels=_8?_8.displayLevels:null;var dh=_4.hitch;this._addImage=dh(this,this._addImage);this._tileLoadHandler=dh(this,this._tileLoadHandler);this._tileErrorHandler=dh(this,this._tileErrorHandler);this._tilePopPop=dh(this,this._tilePopPop);this._cleanUpRemovedImages=dh(this,this._cleanUpRemovedImages);this._fireOnUpdateEvent=dh(this,this._fireOnUpdateEvent);},opacity:1,isPNG32:false,_initTiledLayer:function(){var ti=this.tileInfo,_9=ti.lods;this._tileOrigin=new esri.geometry.Point(_4.mixin(ti.origin,this.spatialReference));this._tileW=ti.width;this._tileH=ti.height;this._normalizedScales=[];var _a=(this.scales=[]),dl=this._displayLevels,fe=this.fullExtent,ul=new esri.geometry.Point(fe.xmin,fe.ymax),lr=new esri.geometry.Point(fe.xmax,fe.ymin),_b=esri.TileUtils.getContainingTileCoords,_c,_d,i,_e=_9.length;for(i=0;i<_e;i++){_d=_9[i];_c=_b(ti,ul,_d);_d.startTileRow=_c.row<0?0:_c.row;_d.startTileCol=_c.col<0?0:_c.col;_c=_b(ti,lr,_d);_d.endTileRow=_c.row;_d.endTileCol=_c.col;if(!dl||_4.indexOf(dl,_d.level)!==-1){_a[i]=_d.scale;this._normalizedScales[i]=_d.scale/ti.dpi;}}this._patchIE=_4.isIE>=6&&_4.isIE<7&&(this.isPNG32||ti.format==="Mixed");},_setMap:function(_f,_10,_11,lod){this._map=_f;var d=(this._div=_4.create("div",null,_10));this._layerIndex=_11;var _12=_f.__visibleDelta,dc=_4.connect;_4.style(d,{position:"absolute",left:-_12.x+"px",top:-_12.y+"px",width:_f.width+"px",height:_f.height+"px",overflow:"visible"});this._onExtentChangeHandler_connect=dc(_f,"onExtentChange",this,"_onExtentChangeHandler");this._onPanHandler_connect=dc(_f,"onPan",this,"_onPanHandler");this._onZoomHandler_connect=dc(_f,"onZoom",this,"_onZoomHandler");this._onResizeHandler_connect=dc(_f,"onResize",this,"_onResizeHandler");this._opacityChangeHandler_connect=dc(this,"onOpacityChange",this,"_opacityChangeHandler");this._visibilityChangeHandler_connect=dc(this,"onVisibilityChange",this,"_visibilityChangeHandler");this._tileIds=[];this._tiles=[];this._tileBounds=[];this._ct=null;this._removeList=new _6.collections.ArrayList();this._loadingList=new _6.collections.ArrayList();var _13=this.tileInfo,sr=_13.spatialReference,_14=sr._getInfo();this._wrap=_f.wrapAround180&&sr._isWrappable()&&Math.abs(_14.origin[0]-_13.origin.x)<=_14.dx;if(this._wrap){esri.TileUtils._addFrameInfo(_13,_14);}var _15=_f.extent;if(!this.visible){this._visibilityChangeHandler(this.visible);}if(_15&&_f.loaded){this._onExtentChangeHandler(_15,null,null,lod);}return d;},_unsetMap:function(map,_16){if(_16){this._div=_16.removeChild(this._div);}_4.destroy(this._div);this._map=this._layerIndex=this._div=null;var dd=_4.disconnect;dd(this._onExtentChangeHandler_connect);dd(this._onPanHandler_connect);dd(this._onZoomHandler_connect);dd(this._onLayerReorderHandler_connect);dd(this._onResizeHandler_connect);dd(this._opacityChangeHandler_connect);dd(this._visibilityChangeHandler_connect);},_visibilityChangeHandler:function(v){if(v){esri.show(this._div);var map=this._map;this._onPanHandler_connect=_4.connect(map,"onPan",this,"_onPanHandler");this._onZoomHandler_connect=_4.connect(map,"onZoom",this,"_onZoomHandler");this._onExtentChangeHandler(map.extent,null,true);}else{esri.hide(this._div);_4.disconnect(this._onPanHandler_connect);_4.disconnect(this._onZoomHandler_connect);}},_onResizeHandler:function(_17,_18,_19){_4.style(this._div,{width:_18+"px",height:_19+"px"});},_onExtentChangeHandler:function(_1a,_1b,_1c,lod){var _1d=true;this._refreshArgs={extent:_1a,lod:lod};if(!this.visible){_1d=false;}var map=this._map,_1e,i;if(lod){_1e=_4.indexOf(this.scales,lod.scale)===-1;if(this.declaredClass=="esri.layers.WMTSLayer"){var _1f=map._params.tileInfo.dpi;var _20=map.width>map.height?map.width:map.height;_1e=true;var s1,s2=lod.scale/_1f;for(i=0;i<this._normalizedScales.length;i++){s1=this._normalizedScales[i];if(Math.abs((s1-s2)/s1)<(1/_20)){_1e=false;break;}}}}else{var _21=map.getLevel(),_22=(_21!=-1)?map._params.tileInfo.lods[_21].scale:-1;_1e=(_4.indexOf(this.scales,_22)===-1);}if(_1d){var dd=_4.disconnect;if(_1e){_1d=false;esri.hide(this._div);dd(this._onPanHandler_connect);dd(this._onZoomHandler_connect);}else{this._fireUpdateStart();esri.show(this._div);dd(this._onPanHandler_connect);dd(this._onZoomHandler_connect);this._onPanHandler_connect=_4.connect(map,"onPan",this,"_onPanHandler");this._onZoomHandler_connect=_4.connect(map,"onZoom",this,"_onZoomHandler");}}this._rrIndex=0;var ct=esri.TileUtils.getCandidateTileInfo(map,this.tileInfo,_1a),mv=map.__visibleDelta,id;if(!this._ct||ct.lod.level!=this._ct.lod.level||_1c){this._ct=ct;var _23=this._tiles,_24=this._tileIds,_25=this._tileBounds,_26=this._removeList,_27,il=_24.length;this._cleanUpRemovedImages();for(i=0;i<il;i++){id=_24[i];_27=_23[id];_25[id]=_24[i]=null;_26.add(_27);}if(_1c){this._tileIds=[];this._tiles=[];this._tileBounds=[];}}var mx=mv.x,my=mv.y;_4.style(this._div,{left:mx+"px",top:my+"px"});if(_1d&&!_1e){this.__coords_dx=mx;this.__coords_dy=my;this._updateImages(new esri.geometry.Rect(0,0,mv.width,mv.height));if(this._loadingList.count===0){this.onUpdate();this._fireUpdateEnd();}else{this._fireOnUpdate=true;}}else{this._cleanUpRemovedImages();}var _28,img,_29=this._tileW,_2a=this._tileH;mv=new esri.geometry.Rect(-mv.x,-mv.y,mv.width,mv.height);for(i=this._tileIds.length-1;i>=0;i--){id=this._tileIds[i];if(id){img=this._tiles[id];_28=_4.coords(img);var _2b=new esri.geometry.Rect(_28.l,_28.t,_29,_2a);if(mv.intersects(_2b)){this._tileBounds[id]=_2b;}else{if(this._loadingList.contains(id)){this._tilePopPop(img);}_4.destroy(img);this._tileIds.splice(i,1);delete this._tileBounds[id];delete this._tiles[id];}}else{this._tileIds.splice(i,1);delete this._tileBounds[id];delete this._tiles[id];}}},_onPanHandler:function(_2c,_2d){var m=this._map,mv=m.__visibleDelta.offset(_2d.x,_2d.y);_4.style(this._div,{left:mv.x+"px",top:mv.y+"px"});this.__coords_dx=this.__coords_dy=0;this._updateImages({x:-mv.x,y:-mv.y,width:mv.width,height:mv.height});if(this._loadingList.count>0){this._fireUpdateStart();this._fireOnUpdate=true;}},_onZoomHandler:function(_2e,_2f,_30){var _31=_4.coords(this._div);_30=_30.offset(-_31.l,-_31.t);var _32,_33=this._tileW*_2f,_34=this._tileH*_2f,_35=this._tileBounds,_36=this._tiles,es=_4.style;var _37=_4.isIE;if(_37&&_37<8){_4.forEach(this._tileIds,function(id){_32=_35[id];es(_36[id],{left:(_32.x-((_33-_32.width)*(_30.x-_32.x)/_32.width))+"px",top:(_32.y-((_34-_32.height)*(_30.y-_32.y)/_32.height))+"px",zoom:_2f});});}else{_4.forEach(this._tileIds,function(id){_32=_35[id];es(_36[id],{left:(_32.x-((_33-_32.width)*(_30.x-_32.x)/_32.width))+"px",top:(_32.y-((_34-_32.height)*(_30.y-_32.y)/_32.height))+"px",width:_33+"px",height:_34+"px"});});}},_updateImages:function(_38){var id,_39=this._tileW,_3a=this._tileH,_3b=this._ct,lod=_3b.lod,_3c=_3b.tile,off=_3c.offsets,_3d=_3c.coords,cr=_3d.row,cc=_3d.col,_3e=lod.level,_3f=this.opacity,_40=this._tileIds,_41=this._loadingList,_42=this._addImage,mId=this._map.id,tId=this.id,rx=_38.x,ry=_38.y,str=lod.startTileRow,etr=lod.endTileRow,stc=lod.startTileCol,etc=lod.endTileCol,_43=_4.indexOf,r,c,mvx=-_38.x,mvy=-_38.y,_44=off.x-this.__coords_dx,_45=off.y-this.__coords_dy,vx=((_39-_44)+mvx),vy=((_3a-_45)+mvy),_46=Math.ceil,_47=(vx>0)?(vx%_39):((_39-(Math.abs(vx)%_39))),_48=(vy>0)?(vy%_3a):((_3a-(Math.abs(vy)%_3a))),_49=(rx>0)?Math.floor((rx+_44)/_39):_46((rx-(_39-_44))/_39),_4a=(ry>0)?Math.floor((ry+_45)/_3a):_46((ry-(_3a-_45))/_3a),_4b=_49+_46((_38.width-_47)/_39),_4c=_4a+_46((_38.height-_48)/_3a),_4d,_4e,_4f,_50,col,row;if(this._wrap){_4d=lod._frameInfo;_4e=_4d[0];_4f=_4d[1];_50=_4d[2];}for(col=_49;col<=_4b;col++){for(row=_4a;row<=_4c;row++){r=cr+row;c=cc+col;if(this._wrap){if(c<_4f){c=c%_4e;c=c<_4f?c+_4e:c;}else{if(c>_50){c=c%_4e;}}}if(r>=str&&r<=etr&&c>=stc&&c<=etc){id=mId+"_"+tId+"_tile_"+_3e+"_"+row+"_"+col;if(_43(_40,id)===-1){_41.add(id);_40.push(id);_42(_3e,row,r,col,c,id,_39,_3a,_3f,_3c,off);}}}}},_cleanUpRemovedImages:function(){var _51=this._removeList,dd=_4.destroy;_51.forEach(function(img){img.style.filter="";img.style.zoom=1;dd(img);});_51.clear();},_addImage:function(_52,row,r,col,c,id,_53,_54,_55,_56,_57){if(this._patchIE){var div=(this._tiles[id]=_4.create("div"));div.id=id;_4.addClass(div,"layerTile");_4.style(div,{left:((_53*col)-_57.x)+"px",top:((_54*row)-_57.y)+"px",width:_53+"px",height:_54+"px",filter:"progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+this.getTileUrl(_52,r,c)+"', sizingMethod='scale')"});if(_55<1){_4.style(div,"opacity",_55);}var _58=div.appendChild(_4.create("div"));_4.style(_58,{opacity:0,width:_53+"px",height:_54+"px"});this._div.appendChild(div);div=null;this._loadingList.remove(id);this._fireOnUpdateEvent();}else{var img=(this._tiles[id]=_4.create("img")),dc=_4.connect;img.id=id;_4.addClass(img,"layerTile");_4.style(img,{left:((_53*col)-_57.x)+"px",top:((_54*row)-_57.y)+"px",width:_53+"px",height:_54+"px",visibility:"hidden"});if(_55<1){_4.style(img,"opacity",_55);}img._onload_connect=dc(img,"onload",this,"_tileLoadHandler");img._onerror_connect=dc(img,"onerror",this,"_tileErrorHandler");img._onabort_connect=dc(img,"onabort",this,"_tileErrorHandler");var url=this.getTileUrl(_52,r,c,img);if(url){img.src=url;}this._div.appendChild(img);img=null;}},getTileUrl:function(_59,row,col){},refresh:function(){var ra=this._refreshArgs;this._onExtentChangeHandler(ra.extent,null,true,ra.lod);},_tilePopPop:function(img){var dd=_4.disconnect;dd(img._onload_connect);dd(img._onerror_connect);dd(img._onabort_connect);img._onload_connect=img._onerror_connect=img._onabort_connect=null;this._loadingList.remove(img.id);this._fireOnUpdateEvent();},_tileLoadHandler:function(evt){var img=evt.currentTarget;_4.style(img,"visibility","visible");this._tilePopPop(img);},_tileErrorHandler:function(evt){var img=evt.currentTarget;this.onError(new Error(esri.bundle.layers.tiled.tileError+": "+img.src));_4.style(img,"visibility","hidden");this._tilePopPop(img);},_fireOnUpdateEvent:function(){if(this._loadingList.count===0){this._cleanUpRemovedImages();if(this._fireOnUpdate){this._fireOnUpdate=false;this.onUpdate();this._fireUpdateEnd();}}},setOpacity:function(o){if(this.opacity!=o){this.onOpacityChange(this.opacity=o);}},onOpacityChange:function(){},_opacityChangeHandler:function(_5a){var djs=_4.style;_4.forEach(this._div.childNodes,function(_5b){djs(_5b,"opacity",_5a);});}});_4.declare("esri.layers.TileInfo",null,{constructor:function(_5c){this.spatialReference=new esri.SpatialReference(_5c.spatialReference);this.width=_5c.cols||_5c.width;this.height=_5c.rows||_5c.height;this.origin=_5c instanceof esri.layers.TileInfo?new esri.geometry.Point(_5c.origin):new esri.geometry.Point(_4.mixin(_5c.origin,_5c.spatialReference));this.dpi=_5c.dpi;this.format=_5c.format;var _5d=(this.lods=[]);_4.forEach(_5c.lods,function(lod,i){_5d[i]=new esri.layers.LOD(lod);});}});_4.declare("esri.layers.LOD",null,{constructor:function(_5e){_4.mixin(this,_5e);}});}}};});