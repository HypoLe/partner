/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */

window[esri._dojoScopeName||"dojo"]._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","esri.dijit.Legend"],["require","dijit._Widget"],["require","dojo.DeferredList"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["esri.dijit.Legend"]){_4._hasResource["esri.dijit.Legend"]=true;_4.provide("esri.dijit.Legend");_4.require("dijit._Widget");_4.require("dojo.DeferredList");(function(){var _7=[_4.moduleUrl("esri.dijit","css/Legend.css")];var _8=document.getElementsByTagName("head").item(0),_9;for(var i=0,il=_7.length;i<il;i++){_9=document.createElement("link");_9.type="text/css";_9.rel="stylesheet";_9.href=_7[i].toString();_8.appendChild(_9);}}());_4.declare("esri.dijit.Legend",[_5._Widget],{widgetsInTemplate:false,layers:null,alignRight:false,_ieTimer:100,constructor:function(_a,_b){_4.mixin(this,esri.bundle.widgets.legend);_a=_a||{};if(!_a.map){console.error("esri.dijit.Legend: unable to find the 'map' property in parameters");return;}if(!_b){console.error("esri.dijit.Legend: must specify a container for the legend");return;}this.map=_a.map;this.layerInfos=_a.layerInfos;this._respectCurrentMapScale=(_a.respectCurrentMapScale===false)?false:true;this.arrangement=(_a.arrangement===esri.dijit.Legend.ALIGN_RIGHT)?esri.dijit.Legend.ALIGN_RIGHT:esri.dijit.Legend.ALIGN_LEFT;if(this.arrangement===esri.dijit.Legend.ALIGN_RIGHT){this.alignRight=true;}this._surfaceItems=[];},startup:function(){this.inherited(arguments);this._initialize();if(_4.isIE){this._repaintItems=_4.hitch(this,this._repaintItems);setTimeout(this._repaintItems,this._ieTimer);}},destroy:function(){this._deactivate();this.inherited(arguments);},refresh:function(_c){if(!this.domNode){return;}if(_c){this.layerInfos=_c;this.layers=[];_4.forEach(this.layerInfos,function(_d){if(this._isSupportedLayerType(_d.layer)){if(_d.title){_d.layer._titleForLegend=_d.title;}this.layers.push(_d.layer);}},this);}else{if(this.useAllMapLayers){this.layerInfos=null;this.layers=null;}}for(var i=this.domNode.children.length-1;i>=0;i--){_4.destroy(this.domNode.children[i]);}this.startup();},_legendUrl:"http://www.arcgis.com/sharing/tools/legend",_initialize:function(){if(this.layerInfos){this.layers=[];_4.forEach(this.layerInfos,function(_e){if(this._isSupportedLayerType(_e.layer)){if(_e.title){_e.layer._titleForLegend=_e.title;}this.layers.push(_e.layer);}},this);}this.useAllMapLayers=false;if(!this.layers){this.useAllMapLayers=true;this.layers=[];_4.forEach(this.map.layerIds,function(_f){var _10=this.map.getLayer(_f);if(this._isSupportedLayerType(_10)){this.layers.push(_10);}},this);_4.forEach(this.map.graphicsLayerIds,function(_11){var _12=this.map.getLayer(_11);if(this._isSupportedLayerType(_12)){this.layers.push(_12);}},this);}this._createLegend();},_activate:function(){this._deactivate();if(this._respectCurrentMapScale){this._ozeConnect=_4.connect(this.map,"onZoomEnd",this,"_refreshLayers");}if(this.useAllMapLayers){this._olaConnect=_4.connect(this.map,"onLayerAdd",this,"_updateAllMapLayers");this._olrConnect=_4.connect(this.map,"onLayerRemove",this,"_updateAllMapLayers");this._olroConnect=_4.connect(this.map,"onLayersReordered",this,"_updateAllMapLayers");}_4.forEach(this.layers,function(_13){_13.ovcConnect=_4.connect(_13,"onVisibilityChange",this,"_refreshLayers");},this);},_deactivate:function(){if(this._ozeConnect){_4.disconnect(this._ozeConnect);}if(this._olaConnect){_4.disconnect(this._olaConnect);}if(this._olroConnect){_4.disconnect(this._olroConnect);}if(this._olrConnect){_4.disconnect(this._olrConnect);}_4.forEach(this.layers,function(_14){if(_14.ovcConnect){_4.disconnect(_14.ovcConnect);}},this);},_refreshLayers:function(){this.refresh();},_updateAllMapLayers:function(){this.layers=[];_4.forEach(this.map.layerIds,function(_15){var _16=this.map.getLayer(_15);if(this._isSupportedLayerType(_16)){this.layers.push(_16);}},this);_4.forEach(this.map.graphicsLayerIds,function(_17){var _18=this.map.getLayer(_17);if(this._isSupportedLayerType(_18)){this.layers.push(_18);}},this);this.refresh();},_createLegend:function(){_4.style(this.domNode,"position","relative");_4.create("div",{id:this.id+"_msg",innerHTML:this.NLS_creatingLegend+"..."},this.domNode);var _19=[];_4.forEach(this.layers,function(_1a){if(_1a.declaredClass=="esri.layers.KMLLayer"){_4.forEach(_1a.getLayers(),function(_1b){if(_1b.declaredClass=="esri.layers.FeatureLayer"){_1b._titleForLegend=_1a._titleForLegend+" - ";if(_1b.geometryType=="esriGeometryPoint"){_1b._titleForLegend+="Points";}else{if(_1b.geometryType=="esriGeometryPolyline"){_1b._titleForLegend+="Lines";}else{if(_1b.geometryType=="esriGeometryPolygon"){_1b._titleForLegend+="Polygons";}}}_19.push(_1b);}});}else{_19.push(_1a);}},this);var _1c=[];_4.forEach(_19,function(_1d){if(_1d.visible===true&&(_1d.layerInfos||_1d.renderer)){var d=_4.create("div",{id:this.id+"_"+_1d.id,style:"display: none;","class":"esriLegendService"});_4.create("span",{innerHTML:this._getServiceTitle(_1d),"class":"esriLegendServiceLabel"},_4.create("td",{align:(this.alignRight?"right":"")},_4.create("tr",{},_4.create("tbody",{},_4.create("table",{width:"95%"},d)))));_4.place(d,this.id,"first");if(_4.isIE){_4.style(_4.byId(this.id+"_"+_1d.id),"display","none");}if(_1d.legendResponse||_1d.renderer){this._createLegendForLayer(_1d);}else{_1c.push(this._legendRequest(_1d));}}},this);if(_1c.length===0){_4.byId(this.id+"_msg").innerHTML=this.NLS_noLegend;this._activate();}else{var _1e=new _4.DeferredList(_1c);_1e.addCallback(_4.hitch(this,function(_1f){_4.byId(this.id+"_msg").innerHTML=this.NLS_noLegend;this._activate();}));}},_createLegendForLayer:function(_20){if(_20.legendResponse||_20.renderer){var _21=false;if(_20.legendResponse){_4.forEach(_20.layerInfos,function(_22,i){var f=this._buildLegendItems(_20,_22,i);_21=_21||f;},this);}else{if(_20.renderer){var id;if(!_20.url){id="fc_"+_20.id;}else{id=_20.url.substring(_20.url.lastIndexOf("/")+1,_20.url.length);}var _23={id:id,name:null,subLayerIds:null,parentLayerId:-1};_21=this._buildLegendItems(_20,_23,0);}}if(_21){_4.style(_4.byId(this.id+"_"+_20.id),"display","block");_4.style(_4.byId(this.id+"_msg"),"display","none");}}},_legendRequest:function(_24){if(_24.version>=10.01){return this._legendRequestServer(_24);}else{return this._legendRequestTools(_24);}},_legendRequestServer:function(_25){var url=_25.url+"/legend";var _26=_4.hitch(this,"_processLegendResponse");var _27={};_27.f="json";var _28=esri.request({url:url,content:_27,callbackParamName:"callback",load:function(_29,_2a){_26(_25,_29,_2a);},error:esriConfig.defaults.io.errorHandler});return _28;},_legendRequestTools:function(_2b){var p=_2b.url.toLowerCase().indexOf("/rest/");var _2c=_2b.url.substring(0,p)+_2b.url.substring(p+5,_2b.url.length);var url=this._legendUrl+"?soapUrl="+escape(_2c);if(!_4.isIE){url+="&returnbytes=true";}var uri=url+(_4.isIE?("&"+(new Date()).getTime()+"="+(new Date()).getTime()):"");var _2d=_4.hitch(this,"_processLegendResponse");var _2e={};_2e.f="json";var _2f=esri.request({url:uri,content:_2e,callbackParamName:"callback",load:function(_30,_31){_2d(_2b,_30,_31);},error:esriConfig.defaults.io.errorHandler});return _2f;},_processLegendResponse:function(_32,_33){if(_33&&_33.layers){_32.legendResponse=_33;this._createLegendForLayer(_32);}else{console.log("Legend could not get generated for "+_32.url+": "+_4.toJson(_33));}},_buildLegendItems:function(_34,_35,pos){var _36=false;var _37=_4.byId(this.id+"_"+_34.id);var _38=_35.subLayerIds;var _39=_35.parentLayerId;if(_38){var _3a=_4.create("div",{id:this.id+"_"+_34.id+"_"+_35.id+"_group",style:"display: none;","class":(_39==-1)?((pos>0)?"esriLegendGroupLayer":""):(this.alignRight?"esriLegendRight":"esriLegendLeft")},(_39==-1)?_37:_4.byId(this.id+"_"+_34.id+"_"+_39+"_group"));if(_4.isIE){_4.style(_4.byId(this.id+"_"+_34.id+"_"+_35.id+"_group"),"display","none");}_4.create("td",{innerHTML:_35.name.replace(/[\<]/g,"&lt;").replace(/[\>]/g,"&gt;"),align:(this.alignRight?"right":"")},_4.create("tr",{},_4.create("tbody",{},_4.create("table",{width:"95%","class":"esriLegendLayerLabel"},_3a))));}else{if(_34.visibleLayers&&(","+_34.visibleLayers+",").indexOf(","+_35.id+",")==-1){return _36;}var d=_4.create("div",{id:this.id+"_"+_34.id+"_"+_35.id,style:"display:none;","class":(_39>-1)?(this.alignRight?"esriLegendRight":"esriLegendLeft"):""},(_39==-1)?_37:_4.byId(this.id+"_"+_34.id+"_"+_39+"_group"));if(_4.isIE){_4.style(_4.byId(this.id+"_"+_34.id+"_"+_35.id),"display","none");}if(_35.name&&_35.name.length>0){_4.create("td",{innerHTML:(_35.name)?_35.name.replace(/[\<]/g,"&lt;").replace(/[\>]/g,"&gt;"):"",align:(this.alignRight?"right":"")},_4.create("tr",{},_4.create("tbody",{},_4.create("table",{width:"95%","class":"esriLegendLayerLabel"},d))));}if(_34.legendResponse){_36=_36||this._buildLegendItems_Tools(_34,_35,d);}else{if(_34.renderer){_36=_36||this._buildLegendItems_Renderer(_34,_35,d);}}}return _36;},_buildLegendItems_Tools:function(_3b,_3c,_3d){var _3e=_3c.parentLayerId;var _3f=esri.geometry.getScale(this.map);var _40=false;if(!this._respectCurrentMapScale||(this._respectCurrentMapScale&&this._isLayerInScale(_3b,_3c,_3f))){for(var i=0;i<_3b.legendResponse.layers.length;i++){if(_3c.id==_3b.legendResponse.layers[i].layerId){var _41=_3b.legendResponse.layers[i].legend;if(_41.length==3&&_41[0].label.replace(/\s+/g,"").indexOf(":Band_")>-1){}else{var _42=_4.create("tbody",{},_4.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},_3d));_4.forEach(_41,function(_43){if((_43.url&&_43.url.indexOf("http://")>-1)||(_43.imageData&&_43.imageData.length>0)){_40=true;this._buildRow_Tools(_43,_42,_3b,_3c.id);}},this);}break;}}}if(_40){_4.style(_4.byId(this.id+"_"+_3b.id+"_"+_3c.id),"display","block");if(_3e>-1){_4.style(_4.byId(this.id+"_"+_3b.id+"_"+_3e+"_group"),"display","block");this._findParentGroup(_3b.id,_3b,_3e);}}return _40;},_buildRow_Tools:function(_44,_45,_46,_47){var tr=_4.create("tr",{},_45);var _48;var _49;if(this.alignRight){_48=_4.create("td",{align:"right"},tr);_49=_4.create("td",{align:"right",width:35},tr);}else{_49=_4.create("td",{width:35},tr);_48=_4.create("td",{},tr);}var src=_44.url;if(!_4.isIE&&_44.imageData&&_44.imageData.length>0){src="data:image/png;base64,"+_44.imageData;}else{if(_44.url.indexOf("http://")==-1){src=_46.url+"/"+_47+"/images/"+_44.url;}}_4.create("img",{src:src,border:0},_49);_4.create("td",{innerHTML:_44.label.replace(/[\<]/g,"&lt;").replace(/[\>]/g,"&gt;"),align:(this.alignRight?"right":"")},_4.create("tr",{},_4.create("tbody",{},_4.create("table",{width:"95%"},_48))));},_buildLegendItems_Renderer:function(_4a,_4b,_4c){var _4d=_4b.parentLayerId;var _4e=esri.geometry.getScale(this.map);var _4f=false;if(!this._respectCurrentMapScale||this._isLayerInScale(_4a,_4b,_4e)){var _50;if(_4a.renderer instanceof esri.renderer.UniqueValueRenderer){if(_4a.renderer.infos&&_4a.renderer.infos.length>0){_4f=true;_50=_4.create("tbody",{},_4.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},_4c));_4.forEach(_4a.renderer.infos,function(_51,_52){var _53=null;if(_4a._editable&&_4a.types){_53=this._getTemplateFromTypes(_4a.types,_51.value);}var _54=_51.label;if(!_54||_54.length===0){_54=_51.value;}this._buildRow_Renderer(_51.symbol,_54,_53,_50);},this);}}if(_4a.renderer instanceof esri.renderer.ClassBreaksRenderer){if(_4a.renderer.infos&&_4a.renderer.infos.length>0){_4f=true;_50=_4.create("tbody",{},_4.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},_4c));_4.forEach(_4a.renderer.infos,function(_55,_56){var _57=_55.label;if(!_57||_57.length===0){_57=_55.minValue+" - "+_55.maxValue;}this._buildRow_Renderer(_55.symbol,_57,null,_50);},this);}}if(_4a.renderer instanceof esri.renderer.SimpleRenderer){_4f=true;_50=_4.create("tbody",{},_4.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},_4c));var _58=null;if(_4a._editable&&_4a.templates&&_4a.templates.length>0){_58=_4a.templates[0];}this._buildRow_Renderer(_4a.renderer.symbol,_4a.renderer.label,_58,_50);}if(_4a.renderer.defaultSymbol){_4f=true;_50=_4.create("tbody",{},_4.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},_4c));this._buildRow_Renderer(_4a.renderer.defaultSymbol,"others",null,_50);}}if(_4f){_4.style(_4.byId(this.id+"_"+_4a.id+"_"+_4b.id),"display","block");if(_4d>-1){_4.style(_4.byId(this.id+"_"+_4a.id+"_"+_4d+"_group"),"display","block");this._findParentGroup(_4a.id,_4d);}}return _4f;},_buildRow_Renderer:function(_59,_5a,_5b,_5c){var tr=_4.create("tr",{},_5c);var _5d;var _5e;if(this.alignRight){_5d=_4.create("td",{align:"right"},tr);_5e=_4.create("td",{align:"right",width:35},tr);}else{_5e=_4.create("td",{width:35},tr);_5d=_4.create("td",{},tr);}var _5f=30;if(_59.type=="simplemarkersymbol"){_5f=Math.min(Math.max(_5f,_59.size+12),125);}else{if(_59.type=="picturemarkersymbol"){_5f=Math.min(Math.max(_5f,_59.width),125);}}var div=_4.create("div",{style:"width:"+_5f+"px;height:"+_5f+"px;"},_5e);_4.create("td",{innerHTML:_5a?_5a.replace(/[\<]/g,"&lt;").replace(/[\>]/g,"&gt;").replace(/^#/,""):"",align:(this.alignRight?"right":"")},_4.create("tr",{},_4.create("tbody",{},_4.create("table",{width:"95%"},_5d))));var _60=this._drawSymbol(div,_59,_5f,_5f,_5b);this._surfaceItems.push(_60);},_drawSymbol:function(_61,_62,_63,_64,_65){var _66=_6.gfx.createSurface(_61,_63,_64);if(_4.isIE){var _67=_66.getEventSource();_4.style(_67,"position","relative");_4.style(_67.parentNode,"position","relative");}var _68=this._getDrawingToolShape(_62,_65)||esri.symbol.getShapeDescriptors(_62);var _69;try{_69=_66.createShape(_68.defaultShape).setFill(_68.fill).setStroke(_68.stroke);}catch(e){_66.clear();_66.destroy();return;}var dim=_66.getDimensions();var _6a={dx:dim.width/2,dy:dim.height/2};var _6b=_69.getBoundingBox(),_6c=_6b.width,_6d=_6b.height;if(_6c>_63||_6d>_64){var _6e=_6c>_6d?_6c:_6d;var _6f=_63<_64?_63:_64;var _70=(_6f-5)/_6e;_4.mixin(_6a,{xx:_70,yy:_70});}_69.applyTransform(_6a);return _66;},_getDrawingToolShape:function(_71,_72){var _73,_74=_72?_72.drawingTool||null:null;switch(_74){case "esriFeatureEditToolArrow":_73={type:"path",path:"M 10,1 L 3,8 L 3,5 L -15,5 L -15,-2 L 3,-2 L 3,-5 L 10,1 E"};break;case "esriFeatureEditToolTriangle":_73={type:"path",path:"M -10,14 L 2,-10 L 14,14 L -10,14 E"};break;case "esriFeatureEditToolRectangle":_73={type:"path",path:"M -10,-10 L 10,-10 L 10,10 L -10,10 L -10,-10 E"};break;case "esriFeatureEditToolCircle":_73={type:"circle",cx:0,cy:0,r:10};break;case "esriFeatureEditToolEllipse":_73={type:"ellipse",cx:0,cy:0,rx:10,ry:5};break;default:return null;}return {defaultShape:_73,fill:_71.getFill(),stroke:_71.getStroke()};},_repaintItems:function(){_4.forEach(this._surfaceItems,function(_75){this._repaint(_75);},this);},_repaint:function(_76){if(!_76){return;}if(_76.getStroke&&_76.setStroke){_76.setStroke(_76.getStroke());}if(_76.getFill&&_76.setFill){_76.setFill(_76.getFill());}if(_76.children&&_4.isArray(_76.children)){_4.forEach(_76.children,this._repaint,this);}},_getTemplateFromTypes:function(_77,_78){for(var i=0;i<_77.length;i++){if(_77[i].id==_78&&_77[i].templates&&_77[i].templates.length>0){return _77[i].templates[0];}}return null;},_findParentGroup:function(_79,_7a,_7b){var _7c=_7a.layerInfos;for(var k=0;k<_7c.length;k++){if(_7b==_7c[k].id){if(_7c[k].parentLayerId>-1){_4.style(_4.byId(this.id+"_"+_79+"_"+_7c[k].parentLayerId+"_group"),"display","block");this._findParentGroup(_79,_7a,_7c[k].parentLayerId);}break;}}},_isLayerInScale:function(_7d,_7e,_7f){var _80=true;if(_7d.legendResponse&&_7d.legendResponse.layers){for(var i=0;i<_7d.legendResponse.layers.length;i++){var _81=_7d.legendResponse.layers[i];if(_7e.id==_81.layerId){if(_81.minScale==0&&_7d.tileInfo){_81.minScale=_7d.tileInfo.lods[0].scale+1;}if(_81.maxScale==0&&_7d.tileInfo){_81.maxScale=_7d.tileInfo.lods[_7d.tileInfo.lods.length-1].scale-1;}if((_81.minScale>0&&_81.minScale<_7f)||_81.maxScale>_7f){_80=false;}break;}}}else{if(_7d.minScale||_7d.maxScale){if((_7d.minScale&&_7d.minScale<_7f)||_7d.maxScale&&_7d.maxScale>_7f){_80=false;}}}return _80;},_getServiceTitle:function(_82){var _83=_82._titleForLegend;if(!_83){_83=_82.url;if(!_82.url){_83="";}else{if(_82.url.indexOf("/MapServer")>-1){_83=_82.url.substring(0,_82.url.indexOf("/MapServer"));_83=_83.substring(_83.lastIndexOf("/")+1,_83.length);}else{if(_82.url.indexOf("/ImageServer")>-1){_83=_82.url.substring(0,_82.url.indexOf("/ImageServer"));_83=_83.substring(_83.lastIndexOf("/")+1,_83.length);}else{if(_82.url.indexOf("/FeatureServer")>-1){_83=_82.url.substring(0,_82.url.indexOf("/FeatureServer"));_83=_83.substring(_83.lastIndexOf("/")+1,_83.length);}}}}if(_82.name){if(_83.length>0){_83+=" - "+_82.name;}else{_83=_82.name;}}}return _83;},_isSupportedLayerType:function(_84){if(_84&&(_84.declaredClass==="esri.layers.ArcGISDynamicMapServiceLayer"||_84.declaredClass==="esri.layers.ArcGISTiledMapServiceLayer"||_84.declaredClass==="esri.layers.FeatureLayer"||_84.declaredClass=="esri.layers.KMLLayer")){return true;}return false;}});_4.mixin(esri.dijit.Legend,{ALIGN_LEFT:0,ALIGN_RIGHT:1});}}};});