/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */

if(!dojo._hasResource["esri.layers.tiled"]){dojo._hasResource["esri.layers.tiled"]=true;dojo.provide("esri.layers.tiled");dojo.require("dojox.collections.ArrayList");dojo.require("esri.layers.layer");dojo.require("esri.geometry");dojo.declare("esri.layers.TiledMapServiceLayer",esri.layers.Layer,{constructor:function(_1,_2){dojo.connect(this,"onLoad",this,"_initTiledLayer");this._displayLevels=_2?_2.displayLevels:null;var dh=dojo.hitch;this._addImage=dh(this,this._addImage);this._tileLoadHandler=dh(this,this._tileLoadHandler);this._tileErrorHandler=dh(this,this._tileErrorHandler);this._tilePopPop=dh(this,this._tilePopPop);this._cleanUpRemovedImages=dh(this,this._cleanUpRemovedImages);this._fireOnUpdateEvent=dh(this,this._fireOnUpdateEvent);},opacity:1,isPNG32:false,_initTiledLayer:function(){var ti=this.tileInfo,_3=ti.lods;this._tileOrigin=new esri.geometry.Point(dojo.mixin(ti.origin,this.spatialReference));this._tileW=ti.width;this._tileH=ti.height;this._normalizedScales=[];var _4=(this.scales=[]),dl=this._displayLevels,fe=this.fullExtent,ul=new esri.geometry.Point(fe.xmin,fe.ymax),lr=new esri.geometry.Point(fe.xmax,fe.ymin),_5=esri.TileUtils.getContainingTileCoords,_6,_7,i,_8=_3.length;for(i=0;i<_8;i++){_7=_3[i];_6=_5(ti,ul,_7);_7.startTileRow=_6.row<0?0:_6.row;_7.startTileCol=_6.col<0?0:_6.col;_6=_5(ti,lr,_7);_7.endTileRow=_6.row;_7.endTileCol=_6.col;if(!dl||dojo.indexOf(dl,_7.level)!==-1){_4[i]=_7.scale;this._normalizedScales[i]=_7.scale/ti.dpi;}}this._patchIE=dojo.isIE>=6&&dojo.isIE<7&&(this.isPNG32||ti.format==="Mixed");},_setMap:function(_9,_a,_b,_c){this._map=_9;var d=(this._div=dojo.create("div",null,_a));this._layerIndex=_b;var _d=_9.__visibleDelta,dc=dojo.connect;dojo.style(d,{position:"absolute",left:-_d.x+"px",top:-_d.y+"px",width:_9.width+"px",height:_9.height+"px",overflow:"visible"});this._onExtentChangeHandler_connect=dc(_9,"onExtentChange",this,"_onExtentChangeHandler");this._onPanHandler_connect=dc(_9,"onPan",this,"_onPanHandler");this._onZoomHandler_connect=dc(_9,"onZoom",this,"_onZoomHandler");this._onResizeHandler_connect=dc(_9,"onResize",this,"_onResizeHandler");this._opacityChangeHandler_connect=dc(this,"onOpacityChange",this,"_opacityChangeHandler");this._visibilityChangeHandler_connect=dc(this,"onVisibilityChange",this,"_visibilityChangeHandler");this._tileIds=[];this._tiles=[];this._tileBounds=[];this._ct=null;this._removeList=new dojox.collections.ArrayList();this._loadingList=new dojox.collections.ArrayList();var _e=this.tileInfo,sr=_e.spatialReference,_f=sr._getInfo();this._wrap=_9.wrapAround180&&sr._isWrappable()&&Math.abs(_f.origin[0]-_e.origin.x)<=_f.dx;if(this._wrap){esri.TileUtils._addFrameInfo(_e,_f);}var _10=_9.extent;if(!this.visible){this._visibilityChangeHandler(this.visible);}if(_10&&_9.loaded){this._onExtentChangeHandler(_10,null,null,_c);}return d;},_unsetMap:function(map,_11){if(_11){this._div=_11.removeChild(this._div);}dojo.destroy(this._div);this._map=this._layerIndex=this._div=null;var dd=dojo.disconnect;dd(this._onExtentChangeHandler_connect);dd(this._onPanHandler_connect);dd(this._onZoomHandler_connect);dd(this._onLayerReorderHandler_connect);dd(this._onResizeHandler_connect);dd(this._opacityChangeHandler_connect);dd(this._visibilityChangeHandler_connect);},_visibilityChangeHandler:function(v){if(v){esri.show(this._div);var map=this._map;this._onPanHandler_connect=dojo.connect(map,"onPan",this,"_onPanHandler");this._onZoomHandler_connect=dojo.connect(map,"onZoom",this,"_onZoomHandler");this._onExtentChangeHandler(map.extent,null,true);}else{esri.hide(this._div);dojo.disconnect(this._onPanHandler_connect);dojo.disconnect(this._onZoomHandler_connect);}},_onResizeHandler:function(_12,_13,_14){dojo.style(this._div,{width:_13+"px",height:_14+"px"});},_onExtentChangeHandler:function(_15,_16,_17,lod){var _18=true;this._refreshArgs={extent:_15,lod:lod};if(!this.visible){_18=false;}var map=this._map,_19,i;if(lod){_19=dojo.indexOf(this.scales,lod.scale)===-1;if(this.declaredClass=="esri.layers.WMTSLayer"){var _1a=map._params.tileInfo.dpi;var _1b=map.width>map.height?map.width:map.height;_19=true;var s1,s2=lod.scale/_1a;for(i=0;i<this._normalizedScales.length;i++){s1=this._normalizedScales[i];if(Math.abs((s1-s2)/s1)<(1/_1b)){_19=false;break;}}}}else{var _1c=map.getLevel(),_1d=(_1c!=-1)?map._params.tileInfo.lods[_1c].scale:-1;_19=(dojo.indexOf(this.scales,_1d)===-1);}if(_18){var dd=dojo.disconnect;if(_19){_18=false;esri.hide(this._div);dd(this._onPanHandler_connect);dd(this._onZoomHandler_connect);}else{this._fireUpdateStart();esri.show(this._div);dd(this._onPanHandler_connect);dd(this._onZoomHandler_connect);this._onPanHandler_connect=dojo.connect(map,"onPan",this,"_onPanHandler");this._onZoomHandler_connect=dojo.connect(map,"onZoom",this,"_onZoomHandler");}}this._rrIndex=0;var ct=esri.TileUtils.getCandidateTileInfo(map,this.tileInfo,_15),mv=map.__visibleDelta,id;if(!this._ct||ct.lod.level!=this._ct.lod.level||_17){this._ct=ct;var _1e=this._tiles,_1f=this._tileIds,_20=this._tileBounds,_21=this._removeList,_22,il=_1f.length;this._cleanUpRemovedImages();for(i=0;i<il;i++){id=_1f[i];_22=_1e[id];_20[id]=_1f[i]=null;_21.add(_22);}if(_17){this._tileIds=[];this._tiles=[];this._tileBounds=[];}}var mx=mv.x,my=mv.y;dojo.style(this._div,{left:mx+"px",top:my+"px"});if(_18&&!_19){this.__coords_dx=mx;this.__coords_dy=my;this._updateImages(new esri.geometry.Rect(0,0,mv.width,mv.height));if(this._loadingList.count===0){this.onUpdate();this._fireUpdateEnd();}else{this._fireOnUpdate=true;}}else{this._cleanUpRemovedImages();}var _23,img,_24=this._tileW,_25=this._tileH;mv=new esri.geometry.Rect(-mv.x,-mv.y,mv.width,mv.height);for(i=this._tileIds.length-1;i>=0;i--){id=this._tileIds[i];if(id){img=this._tiles[id];_23=dojo.coords(img);var _26=new esri.geometry.Rect(_23.l,_23.t,_24,_25);if(mv.intersects(_26)){this._tileBounds[id]=_26;}else{if(this._loadingList.contains(id)){this._tilePopPop(img);}dojo.destroy(img);this._tileIds.splice(i,1);delete this._tileBounds[id];delete this._tiles[id];}}else{this._tileIds.splice(i,1);delete this._tileBounds[id];delete this._tiles[id];}}},_onPanHandler:function(_27,_28){var m=this._map,mv=m.__visibleDelta.offset(_28.x,_28.y);dojo.style(this._div,{left:mv.x+"px",top:mv.y+"px"});this.__coords_dx=this.__coords_dy=0;this._updateImages({x:-mv.x,y:-mv.y,width:mv.width,height:mv.height});if(this._loadingList.count>0){this._fireUpdateStart();this._fireOnUpdate=true;}},_onZoomHandler:function(_29,_2a,_2b){var _2c=dojo.coords(this._div);_2b=_2b.offset(-_2c.l,-_2c.t);var _2d,_2e=this._tileW*_2a,_2f=this._tileH*_2a,_30=this._tileBounds,_31=this._tiles,es=dojo.style;var _32=dojo.isIE;if(_32&&_32<8){dojo.forEach(this._tileIds,function(id){_2d=_30[id];es(_31[id],{left:(_2d.x-((_2e-_2d.width)*(_2b.x-_2d.x)/_2d.width))+"px",top:(_2d.y-((_2f-_2d.height)*(_2b.y-_2d.y)/_2d.height))+"px",zoom:_2a});});}else{dojo.forEach(this._tileIds,function(id){_2d=_30[id];es(_31[id],{left:(_2d.x-((_2e-_2d.width)*(_2b.x-_2d.x)/_2d.width))+"px",top:(_2d.y-((_2f-_2d.height)*(_2b.y-_2d.y)/_2d.height))+"px",width:_2e+"px",height:_2f+"px"});});}},_updateImages:function(_33){var id,_34=this._tileW,_35=this._tileH,_36=this._ct,lod=_36.lod,_37=_36.tile,off=_37.offsets,_38=_37.coords,cr=_38.row,cc=_38.col,_39=lod.level,_3a=this.opacity,_3b=this._tileIds,_3c=this._loadingList,_3d=this._addImage,mId=this._map.id,tId=this.id,rx=_33.x,ry=_33.y,str=lod.startTileRow,etr=lod.endTileRow,stc=lod.startTileCol,etc=lod.endTileCol,_3e=dojo.indexOf,r,c,mvx=-_33.x,mvy=-_33.y,_3f=off.x-this.__coords_dx,_40=off.y-this.__coords_dy,vx=((_34-_3f)+mvx),vy=((_35-_40)+mvy),_41=Math.ceil,_42=(vx>0)?(vx%_34):((_34-(Math.abs(vx)%_34))),_43=(vy>0)?(vy%_35):((_35-(Math.abs(vy)%_35))),_44=(rx>0)?Math.floor((rx+_3f)/_34):_41((rx-(_34-_3f))/_34),_45=(ry>0)?Math.floor((ry+_40)/_35):_41((ry-(_35-_40))/_35),_46=_44+_41((_33.width-_42)/_34),_47=_45+_41((_33.height-_43)/_35),_48,_49,_4a,_4b,col,row;if(this._wrap){_48=lod._frameInfo;_49=_48[0];_4a=_48[1];_4b=_48[2];}for(col=_44;col<=_46;col++){for(row=_45;row<=_47;row++){r=cr+row;c=cc+col;if(this._wrap){if(c<_4a){c=c%_49;c=c<_4a?c+_49:c;}else{if(c>_4b){c=c%_49;}}}if(r>=str&&r<=etr&&c>=stc&&c<=etc){id=mId+"_"+tId+"_tile_"+_39+"_"+row+"_"+col;if(_3e(_3b,id)===-1){_3c.add(id);_3b.push(id);_3d(_39,row,r,col,c,id,_34,_35,_3a,_37,off);}}}}},_cleanUpRemovedImages:function(){var _4c=this._removeList,dd=dojo.destroy;_4c.forEach(function(img){img.style.filter="";img.style.zoom=1;dd(img);});_4c.clear();},_addImage:function(_4d,row,r,col,c,id,_4e,_4f,_50,_51,_52){if(this._patchIE){var div=(this._tiles[id]=dojo.create("div"));div.id=id;dojo.addClass(div,"layerTile");dojo.style(div,{left:((_4e*col)-_52.x)+"px",top:((_4f*row)-_52.y)+"px",width:_4e+"px",height:_4f+"px",filter:"progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+this.getTileUrl(_4d,r,c)+"', sizingMethod='scale')"});if(_50<1){dojo.style(div,"opacity",_50);}var _53=div.appendChild(dojo.create("div"));dojo.style(_53,{opacity:0,width:_4e+"px",height:_4f+"px"});this._div.appendChild(div);div=null;this._loadingList.remove(id);this._fireOnUpdateEvent();}else{var img=(this._tiles[id]=dojo.create("img")),dc=dojo.connect;img.id=id;dojo.addClass(img,"layerTile");dojo.style(img,{left:((_4e*col)-_52.x)+"px",top:((_4f*row)-_52.y)+"px",width:_4e+"px",height:_4f+"px",visibility:"hidden"});if(_50<1){dojo.style(img,"opacity",_50);}img._onload_connect=dc(img,"onload",this,"_tileLoadHandler");img._onerror_connect=dc(img,"onerror",this,"_tileErrorHandler");img._onabort_connect=dc(img,"onabort",this,"_tileErrorHandler");var url=this.getTileUrl(_4d,r,c,img);if(url){img.src=url;}this._div.appendChild(img);img=null;}},getTileUrl:function(_54,row,col){},refresh:function(){var ra=this._refreshArgs;this._onExtentChangeHandler(ra.extent,null,true,ra.lod);},_tilePopPop:function(img){var dd=dojo.disconnect;dd(img._onload_connect);dd(img._onerror_connect);dd(img._onabort_connect);img._onload_connect=img._onerror_connect=img._onabort_connect=null;this._loadingList.remove(img.id);this._fireOnUpdateEvent();},_tileLoadHandler:function(evt){var img=evt.currentTarget;dojo.style(img,"visibility","visible");this._tilePopPop(img);},_tileErrorHandler:function(evt){var img=evt.currentTarget;this.onError(new Error(esri.bundle.layers.tiled.tileError+": "+img.src));dojo.style(img,"visibility","hidden");this._tilePopPop(img);},_fireOnUpdateEvent:function(){if(this._loadingList.count===0){this._cleanUpRemovedImages();if(this._fireOnUpdate){this._fireOnUpdate=false;this.onUpdate();this._fireUpdateEnd();}}},setOpacity:function(o){if(this.opacity!=o){this.onOpacityChange(this.opacity=o);}},onOpacityChange:function(){},_opacityChangeHandler:function(_55){var djs=dojo.style;dojo.forEach(this._div.childNodes,function(_56){djs(_56,"opacity",_55);});}});dojo.declare("esri.layers.TileInfo",null,{constructor:function(_57){this.spatialReference=new esri.SpatialReference(_57.spatialReference);this.width=_57.cols||_57.width;this.height=_57.rows||_57.height;this.origin=_57 instanceof esri.layers.TileInfo?new esri.geometry.Point(_57.origin):new esri.geometry.Point(dojo.mixin(_57.origin,_57.spatialReference));this.dpi=_57.dpi;this.format=_57.format;var _58=(this.lods=[]);dojo.forEach(_57.lods,function(lod,i){_58[i]=new esri.layers.LOD(lod);});}});dojo.declare("esri.layers.LOD",null,{constructor:function(_59){dojo.mixin(this,_59);}});}