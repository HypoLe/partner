/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */

window[esri._dojoScopeName||"dojo"]._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","esri.dijit.BasemapGallery"],["require","esri.virtualearth.VETiledLayer"],["require","esri.layers.osm"],["require","dijit._Widget"],["require","dijit._Templated"],["require","dojo.DeferredList"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["esri.dijit.BasemapGallery"]){_4._hasResource["esri.dijit.BasemapGallery"]=true;_4.provide("esri.dijit.BasemapGallery");_4.require("esri.virtualearth.VETiledLayer");_4.require("esri.layers.osm");_4.require("dijit._Widget");_4.require("dijit._Templated");_4.require("dojo.DeferredList");(function(){var _7=[_4.moduleUrl("esri.dijit","css/BasemapGallery.css")];var _8=document.getElementsByTagName("head").item(0),_9;for(var i=0,il=_7.length;i<il;i++){_9=document.createElement("link");_9.type="text/css";_9.rel="stylesheet";_9.href=_7[i].toString();_8.appendChild(_9);}}());esri.dijit._arcgisUrl="http://www.arcgis.com/sharing";_4.declare("esri.dijit.BasemapGallery",[_5._Widget,_5._Templated],{widgetsInTemplate:true,templateString:"<div class=\"esriBasemapGallery\">\r\n  <div dojoAttachPoint=\"flowContainer\">\r\n  </div>\r\n</div>\r\n",basePath:_4.moduleUrl("esri.dijit"),loaded:false,basemaps:[],bingMapsKey:null,flowContainer:null,_hasUI:false,_selectedBasemap:null,constructor:function(_a,_b){_a=_a||{};if(!_a.map){console.error("esri.dijit.BasemapGallery: Unable to find the 'map' property in parameters");}this.map=_a.map;this._hasUI=_b?true:false;this.bingMapsKey=(_a.bingMapsKey&&_a.bingMapsKey.length>0)?_a.bingMapsKey:null;this.showArcGISBasemaps=(_a.showArcGISBasemaps===false)?false:true;this.basemaps=_a.basemaps?_a.basemaps:[];this.basemapIds=_a.basemapIds;this.referenceIds=_a.referenceIds;this.init();},init:function(){this.inherited(arguments);_4.forEach(this.basemaps,function(_c,i){if(!_c.id||_c.id.length===0){_c.id=this._getUniqueId();}_4.forEach(_c.layers,function(_d){_d.opacity=(_d.opacity>=0)?_d.opacity:1;_d.visibility=true;},this);},this);if(this.basemapIds&&this.basemapIds.length>0){_4.forEach(this.basemapIds,function(_e){var _f=this.map.getLayer(_e);_f._basemapGalleryLayerType="basemap";},this);}if(this.referenceIds&&this.referenceIds.length>0){_4.forEach(this.referenceIds,function(_10){var _11=this.map.getLayer(_10);_11._basemapGalleryLayerType="reference";},this);}if(this.showArcGISBasemaps){this._findArcGISBasemapsGroup(_4.hitch(this,"_handleArcGISBasemapsResponse"));}else{this._finishStartup();}},startup:function(){if(this.loaded){this._refreshUI();}else{_4.connect(this,"onLoad",_4.hitch(this,function(){this._refreshUI();}));}},select:function(id){this._select(id);},getSelected:function(){return this._selectedBasemap;},get:function(id){for(var i=0;i<this.basemaps.length;i++){if(this.basemaps[i].id==id){return this.basemaps[i];}}return null;},add:function(_12){if(_12&&!_12.id){_12.id=this._getUniqueId();this.basemaps.push(_12);this._refreshUI();this.onAdd(_12);return true;}else{if(_12&&this._isUniqueId(_12.id)){this.basemaps.push(_12);this._refreshUI();this.onAdd(_12);return true;}}return false;},remove:function(id){for(var i=0;i<this.basemaps.length;i++){var _13=this.basemaps[i];if(_13.id===id){if(this._selectedBasemap&&this._selectedBasemap.id===_13.id){this._selectedBasemap=null;}this.basemaps.splice(i,1);this._refreshUI();this.onRemove(_13);return _13;}}return null;},onLoad:function(){},onSelectionChange:function(){},onAdd:function(_14){},onRemove:function(_15){},onError:function(msg){},_basemapGalleryGroupQuery:"title:\"ArcGIS Online Basemaps\" AND owner:esri",_finishStartup:function(){this.loaded=true;this.onLoad();if(this.map.layerIds.length===0&&this.basemaps.length>0){this._select(this.basemaps[0].id);}},_findArcGISBasemapsGroup:function(_16){var _17=_4.hitch(this,"_findArcGISBasemaps");var url=esri.dijit._arcgisUrl+"/community/groups";var _18={};_18.q=this._basemapGalleryGroupQuery;_18.f="json";esri.request({url:url,content:_18,callbackParamName:"callback",load:function(_19,_1a){if(_19.results.length>0){_17(_19.results[0].id,_16);}else{console.error("esri.dijit.BasemapGallery: could not find group for basemaps.");}},error:esriConfig.defaults.io.errorHandler});},_findArcGISBasemaps:function(_1b,_1c){var url=esri.dijit._arcgisUrl+"/search";var _1d={};_1d.q="group:"+_1b+" AND type:\"web map\"";_1d.sortField="name";_1d.sortOrder="desc";_1d.num=50;_1d.f="json";esri.request({url:url,content:_1d,callbackParamName:"callback",load:function(_1e,_1f){_1c(_1e.results);},error:esriConfig.defaults.io.errorHandler});},_handleArcGISBasemapsResponse:function(_20){if(_20.length>0){_4.forEach(_20,function(_21,i){if(this.bingMapsKey||(!this.bingMapsKey&&_21.title&&_21.title.indexOf("Bing Maps")==-1)){var _22={};_22.id=this._getUniqueId();_22.title=_21.title;_22.thumbnailUrl=(_21.thumbnail&&_21.thumbnail.length>0)?(esri.dijit._arcgisUrl+"/content/items/"+_21.id+"/info/"+_21.thumbnail):"";_22.itemId=_21.id;var _23=new esri.dijit.Basemap(_22);this.basemaps.splice(0,0,_23);}},this);this._finishStartup();}},_refreshUI:function(){if(this._hasUI){_4.empty(this.flowContainer);_4.forEach(this.basemaps,function(_24,i){if(!_24.id){_24.id="basemap_"+i;}this.flowContainer.appendChild(this._buildNodeLayout(_24));},this);_4.create("br",{style:{clear:"both"}},this.flowContainer);this._markSelected(this._selectedBasemap);}},_buildNodeLayout:function(_25){var nId="galleryNode_"+_25.id;var n=_4.create("div",{id:nId,"class":"esriBasemapGalleryNode"});var _26=_4.create("a",{href:"#"},n);_4.connect(_26,"onclick",_4.hitch(this,"_onNodeClick",_25));if(_25.thumbnailUrl){_4.create("img",{"class":"esriBasemapGalleryThumbnail",src:_25.thumbnailUrl},_26);}else{_4.create("img",{"class":"esriBasemapGalleryThumbnail",src:this.basePath.toString()+"images/transparent.gif"},_26);}var _27=_4.create("div",{"class":"esriBasemapGalleryLabelContainer"},n);var _28=_25.title||"";_4.create("span",{innerHTML:_28,alt:_28,title:_28},_27);return n;},_onNodeClick:function(_29,e){e.preventDefault();this._markSelected(_29);this.select(_29.id);},_markSelected:function(_2a){if(_2a){_4.forEach(_4.query(".esriBasemapGallerySelectedNode",this.domNode),function(_2b){_4.removeClass(_2b,"esriBasemapGallerySelectedNode");});_4.addClass(_4.byId("galleryNode_"+_2a.id),"esriBasemapGallerySelectedNode");}},_select:function(id){var _2c=this.get(id);if(_2c.layers){this._getServiceInfos(_2c);}else{var _2d=_2c.getLayers();if(_4.isArray(_2d)){this._getServiceInfos(_2c);}else{_2d.addCallback(_4.hitch(this,function(_2e){this._getServiceInfos(_2c);}));}}},_getServiceInfos:function(_2f){this._selectedBasemap=_2f;var _30=[];_4.forEach(_2f.layers,function(_31){if(_31.url&&_31.url.length>0&&!_31.isReference){_31.deferredsPos=_30.length;_30.push(this._getServiceInfo(_31.url));}},this);if(_30.length>0){var _32=new _4.DeferredList(_30);_32.addCallback(_4.hitch(this,function(_33){var _34=null;_4.forEach(_2f.layers,function(_35){if(_35.deferredsPos===0||_35.deferredsPos){_35.serviceInfoResponse=_30[_35.deferredsPos].ioArgs.json;var ext=_35.serviceInfoResponse.fullExtent;if(!ext){ext=_35.serviceInfoResponse.extent;}if(!_34){_34=new esri.geometry.Extent(ext);}else{_34=_34.union(new esri.geometry.Extent(ext));}}},this);if(this.map.extent){var _36=this._getIntersectionPercent(_34,this.map.extent);if(_36<5){this.map.setExtent(_34,true);}}this._switchBasemapLayers(_2f);this._updateReferenceLayer(_2f);}));}else{this._switchBasemapLayers(_2f);this._updateReferenceLayer(_2f);}},_switchBasemapLayers:function(_37){var _38=_37.layers;if(this.map.layerIds.length>0&&this.map.getNumLevels()===0&&(_38[0].type==="OpenStreetMap"||(_38[0].type&&_38[0].type.indexOf("BingMaps")>-1))){var msg="esri.dijit.BasemapGallery: Unable to switch basemap because new basemap is a tiled service and cannot be loaded as a dynamic layer.";this.onError(msg);return;}_4.forEach(_38,function(_39){if(!_39.isReference&&_39.type&&_39.type.indexOf("BingMaps")>-1&&!this.bingMapsKey){var msg="esri.dijit.BasemapGallery: Invalid Bing Maps key.";this.onError(msg);return;}},this);this._removeBasemapLayers();_4.forEach(_38,function(_3a){if(!_3a.isReference){var _3b;if(_3a.type==="OpenStreetMap"){if(this.map.layerIds.length>0&&this.map.getNumLevels()===0){var msg="esri.dijit.BasemapGallery: Unable to switch basemap because new basemap is a tiled service and cannot be loaded as a dynamic layer.";this.onError(msg);return;}_3b=new esri.layers.OpenStreetMapLayer({id:"layer_osm"});}else{if(_3a.type&&_3a.type.indexOf("BingMaps")>-1){if(this.map.layerIds.length>0&&this.map.getNumLevels()===0){var msg="esri.dijit.BasemapGallery: Unable to switch basemap because new basemap is a tiled service and cannot be loaded as a dynamic layer.";this.onError(msg);return;}var _3c=esri.virtualearth.VETiledLayer.MAP_STYLE_AERIAL_WITH_LABELS;if(_3a.type=="BingMapsAerial"){_3c=esri.virtualearth.VETiledLayer.MAP_STYLE_AERIAL;}else{if(_3a.type=="BingMapsRoad"){_3c=esri.virtualearth.VETiledLayer.MAP_STYLE_ROAD;}}_3b=new esri.virtualearth.VETiledLayer({id:"layer_bing",bingMapsKey:this.bingMapsKey,mapStyle:_3c});}else{if(_3a.serviceInfoResponse&&_3a.serviceInfoResponse.mapName){if((this.map.layerIds.length===0||this.map.getNumLevels()>0)&&_3a.serviceInfoResponse.singleFusedMapCache===true){_3b=this._loadAsCached(_3a);}else{_3b=this._loadAsDynamic(_3a);}}else{if(_3a.serviceInfoResponse&&_3a.serviceInfoResponse.pixelSizeX){var _3d=new esri.layers.ImageServiceParameters();_3d.bandIds=_3a.bandIds;if(!_3a.bandIds&&_3a.serviceInfoResponse.bandCount&&parseInt(_3a.serviceInfoResponse.bandCount)>3){_3d.bandIds=[0,1,2];}_3b=new esri.layers.ArcGISImageServiceLayer(_3a.url,{resourceInfo:_3a.serviceInfoResponse,opacity:_3a.opacity,visible:_3a.visibility,imageServiceParameters:_3d});}}}}if(_3b){_3b._basemapGalleryLayerType="basemap";this.map.addLayer(_3b,0);}}},this);this.onSelectionChange();},_removeBasemapLayers:function(){var _3e=this.map.layerIds;var _3f=[];_4.forEach(_3e,function(id){var _40=this.map.getLayer(id);if(_40._basemapGalleryLayerType==="basemap"){_3f.push(_40);}},this);if(_3f.length===0&&_3e.length>0){_3f.push(this.map.getLayer(_3e[0]));}if(_3f.length>0){_4.forEach(_3f,function(_41){this.map.removeLayer(_41);},this);}},_updateReferenceLayer:function(_42){this._removeReferenceLayer();for(var i=0;i<_42.layers.length;i++){if(_42.layers[i].isReference===true){this._addReferenceLayer(_42.layers[i]);}}},_removeReferenceLayer:function(){for(var i=this.map.layerIds.length-1;i>=0;i--){var id=this.map.layerIds[i];var _43=this.map.getLayer(id);if(_43._basemapGalleryLayerType==="reference"){this.map.removeLayer(_43);}}},_addReferenceLayer:function(_44){this._getServiceInfo(_44.url,_4.hitch(this,"_handleReferenceServiceInfoResponse",_44));},_handleReferenceServiceInfoResponse:function(_45,_46,_47){var _48;_45.serviceInfoResponse=_46;if(_46&&_46.mapName){if(_46.singleFusedMapCache===true){_48=this._loadAsCached(_45);}else{_48=this._loadAsDynamic(_45);}}else{if(_46&&_46.pixelSizeX){var _49=new esri.layers.ImageServiceParameters();_49.bandIds=_45.bandIds;if(!_45.bandIds&&_46.bandCount&&parseInt(_46.bandCount)>3){_49.bandIds=[0,1,2];}_48=new esri.layers.ArcGISImageServiceLayer(_45.url,{resourceInfo:_46,opacity:_45.opacity,visible:_45.visibility,imageServiceParameters:_49});}}if(_48){_48._basemapGalleryLayerType="reference";this.map.addLayer(_48);}},_getServiceInfo:function(url,_4a){var _4b={};_4b.f="json";var _4c=esri.request({url:url,content:_4b,callbackParamName:"callback",load:function(_4d,_4e){if(_4a){_4a(_4d,_4e);}},error:esriConfig.defaults.io.errorHandler});return _4c;},_loadAsCached:function(_4f){var _50=[];if(!_4f.displayLevels){_50=_4.map(_4f.serviceInfoResponse.tileInfo.lods,function(lod){return lod.level;});}var _51=new esri.layers.ArcGISTiledMapServiceLayer(_4f.url,{resourceInfo:_4f.serviceInfoResponse,opacity:_4f.opacity,visible:_4f.visibility,displayLevels:(_4f.displayLevels)?_4f.displayLevels:_50});return _51;},_loadAsDynamic:function(_52){var _53=new esri.layers.ArcGISDynamicMapServiceLayer(_52.url,{resourceInfo:_52.serviceInfoResponse,opacity:_52.opacity,visible:_52.visibility});if(_52.visibleLayers){_53.setVisibleLayers(_52.visibleLayers);}return _53;},_getIntersectionPercent:function(_54,_55){var _56=_55.intersects(_54);if(_56){var _57=_56.getWidth()*_56.getHeight();var _58=_55.getWidth()*_55.getHeight();return (_57/_58)*100;}else{return 0;}},_getIds:function(){var ids=[];_4.forEach(this.basemaps,function(_59){ids.push(_59.id);},this);return ids;},_getUniqueId:function(){var _5a=","+this._getIds().toString()+",";var _5b=0;while(true){if(_5a.indexOf(",basemap_"+_5b+",")>-1){_5b++;}else{return "basemap_"+_5b;}}},_isUniqueId:function(id){var _5c=","+this._getIds().toString()+",";if(_5c.indexOf(","+id+",")===-1){return true;}return false;}});_4.declare("esri.dijit.Basemap",null,{id:null,title:"",thumbnailUrl:null,layers:null,itemId:null,constructor:function(_5d){_5d=_5d||{};if(!_5d.layers&&!_5d.itemId){console.error("esri.dijit.Basemap: unable to find the 'layers' property in parameters");}this.id=_5d.id;this.itemId=_5d.itemId;this.layers=_5d.layers;this.title=_5d.title?_5d.title:"";this.thumbnailUrl=_5d.thumbnailUrl;},getLayers:function(){if(this.layers){return this.layers;}else{if(this.itemId){var url=esri.dijit._arcgisUrl+"/content/items/"+this.itemId+"/data";var _5e={};_5e.f="json";var _5f=esri.request({url:url,content:_5e,callbackParamName:"callback",error:esriConfig.defaults.io.errorHandler});_5f.addCallback(_4.hitch(this,function(_60,_61){this.layers=[];_4.forEach(_60.baseMap.baseMapLayers,function(_62){var _63={};if(_62.url){_63.url=_62.url;}if(_62.type){_63.type=_62.type;}if(_62.isReference){_63.isReference=_62.isReference;}if(_62.displayLevels){_63.displayLevels=_62.displayLevels;}if(_62.visibleLayers){_63.visibleLayers=_62.visibleLayers;}if(_62.bandIds){_63.bandIds=_62.bandIds;}this.layers.push(new esri.dijit.BasemapLayer(_63));},this);return this.layers;}));return _5f;}}}});_4.declare("esri.dijit.BasemapLayer",null,{constructor:function(_64){_64=_64||{};if(!_64.url&&!_64.type){console.error("esri.dijit.BasemapLayer: unable to find the 'url' or 'type' property in parameters");}this.url=_64.url;this.type=_64.type;this.isReference=(_64.isReference===true)?true:false;this.displayLevels=_64.displayLevels;this.visibleLayers=_64.visibleLayers;this.bandIds=_64.bandIds;this.opacity=_64.opacity;}});}}};});