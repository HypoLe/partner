/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */

if(!dojo._hasResource["esri.dijit.editing.TemplatePicker"]){dojo._hasResource["esri.dijit.editing.TemplatePicker"]=true;dojo.provide("esri.dijit.editing.TemplatePicker");dojo.require("dojo.data.ItemFileReadStore");dojo.require("dojox.grid.DataGrid");(function(){var _1=[dojo.moduleUrl("esri.dijit.editing","css/TemplatePicker.css"),dojo.moduleUrl("dojox","grid/resources/Grid.css")];var _2=document.getElementsByTagName("head").item(0),_3;for(var i=0,il=_1.length;i<il;i++){_3=document.createElement("link");_3.type="text/css";_3.rel="stylesheet";_3.href=_1[i].toString();_2.appendChild(_3);}}());dojo.declare("esri.dijit.editing.TemplatePicker",[dijit._Widget,dijit._Templated],{widgetsInTemplate:true,templateString:"<div class=\"templatePicker\">\r\n\r\n  <table dojoType=\"dojox.grid.DataGrid\" selectionMode=\"none\" autoHeight=\"${_rows}\" autoWidth=\"${_autoWidth}\"\r\n         query=\"{ query: '*' }\" dojoAttachPoint=\"grid\" class=\"grid\">\r\n  </table>\r\n  \r\n</div>\r\n",basePath:dojo.moduleUrl("esri.dijit.editing"),featureLayers:null,items:null,grouping:true,showTooltip:false,maxLabelLength:0,rows:4,columns:3,surfaceWidth:30,surfaceHeight:30,_uniqueId:{id:0},_assumedCellWidth:90,_initialAutoWidth:300,_initialAutoHeight:200,_ieTimer:150,constructor:function(_4,_5){_4=_4||{};if(!_4.items&&!_4.featureLayers){console.error("TemplatePicker: please provide 'featureLayers' or 'items' parameter in the constructor");}this._dojo14x=(dojo.version.minor>=4);this._itemWidgets={};},postMixInProperties:function(){this.inherited(arguments);this._preprocess();},startup:function(){this.inherited(arguments);if(this.rows==="auto"&&this.columns==="auto"){var _6=dojo.contentBox(this.domNode);if(!_6.w){this.domNode.style.width=this._initialAutoWidth+"px";}if(!_6.h){this.domNode.style.height=this._initialAutoHeight+"px";}_6=dojo.contentBox(this.domNode);this._columns=Math.floor(_6.w/this._assumedCellWidth)||1;}this._applyGridPatches();this._setGridLayout();dojo.connect(this.grid,"onRowClick",this,this._rowClicked);this._setGridData();this._toggleTooltip();if(dojo.isIE<9){this._repaintItems=dojo.hitch(this,this._repaintItems);setTimeout(this._repaintItems,this._ieTimer);}},destroy:function(){this.showTooltip=false;this._toggleTooltip();this.featureLayers=this.items=this.grid=this._flItems=this._itItems=this._groupRowIndices=this._selectedCell=this._selectedInfo=this._selectedItem=null;this.inherited(arguments);},getSelected:function(){return this._selectedCell?this._selectedItem:null;},clearSelection:function(){var _7=this._selectedCell,_8=this._selectedInfo;if(_7){this._rowClicked({cellNode:_7,rowIndex:_8.selRow,cellIndex:_8.selCol});}},update:function(_9){var _a=(this.rows==="auto"&&this.columns==="auto"&&_9)?true:false;var _b=this.grid;if(_a){var _c=this.domNode,_d=dojo.contentBox(_c),id=_c.id;this._columns=Math.floor((_d.w-_b.views.views[0].getScrollbarWidth())/dojo.coords(dojo.query("#"+id+".templatePicker div.item")[0].parentNode).w);this._columns=this._columns||1;}var _e=this._rows;this._preprocess();var _f=this._rows;this._setGridLayout();this._setGridData();if(_f!==_e){_b.set("autoHeight",this._rows,false);}if(_a){_b._resize({w:_d.w,h:_d.h});_b.viewsHeaderNode.style.display="none";}else{_b.update();}this._toggleTooltip();var _10=this,_11=this.getSelected();if(_11){_b.store.fetch({onComplete:function(its){var _12=_10._locate(_11,_10._selectedInfo,its);var _13=_12&&_b.views.views[0].getCellNode(_12[0],_12[1]);if(_13){_10._rowClicked({cellNode:_13,rowIndex:_12[0],cellIndex:_12[1]},true);}}});}if(dojo.isIE<9){setTimeout(this._repaintItems,this._ieTimer);}},onSelectionChange:function(){},_preprocess:function(){if(this.items){this.grouping=false;}this._autoWidth=false;if(this.rows==="auto"||this.columns==="auto"){this._autoWidth=true;}var _14;if(this.featureLayers){_14=this._flItems=this._getItemsFromLayers(this.featureLayers);}else{_14=this._itItems=this._getItemsFromItems(this.items);}if(this.rows==="auto"&&this.columns==="auto"){if(!this._started){this._rows=false;this._columns=null;this._autoWidth=false;}return;}var len=0;this._rows=this.rows;this._columns=this.columns;if(this.rows==="auto"){if(this.featureLayers){if(this.grouping){len=_14.length;dojo.forEach(_14,function(_15){len+=Math.ceil(_15.length/this.columns);},this);}else{dojo.forEach(_14,function(_16){len+=_16.length;},this);len=Math.ceil(len/this.columns);}}else{len=Math.ceil(_14.length/this.columns);}this._rows=len;}else{if(this.columns==="auto"){if(this.featureLayers){if(this.grouping){len=3;}else{dojo.forEach(_14,function(_17){len+=_17.length;},this);len=Math.ceil(len/this.rows);}}else{len=Math.ceil(_14.length/this.rows);}this._columns=len;}}},_applyGridPatches:function(){var _18=this.grid;var _19=_18.adaptWidth;_18.adaptWidth=function(){var _1a=this.views.views;for(var i=0,_1b;_1b=_1a[i];i++){dojo.style(_1b.headerNode,"display","block");}_19.apply(this,arguments);for(var i=0,_1b;_1b=_1a[i];i++){dojo.style(_1b.headerNode,"display","none");}};if(this._dojo14x){if(this.rows!=="auto"&&this.columns!=="auto"){var _1c=dojo.connect(_18,"_onFetchComplete",this,function(){dojo.disconnect(_1c);this.grid.set("autoHeight",this._rows);});}dojo.connect(_18,"_onDelete",this,this._destroyItems);dojo.connect(_18,"_clearData",this,this._destroyItems);dojo.connect(_18,"destroy",this,this._destroyItems);var _1d=_18.focus;if(_1d&&_1d.findAndFocusGridCell){_1d.findAndFocusGridCell=function(){return false;};}}},_setGridLayout:function(){var _1e=function(_1f){return function(_20,_21){return this._cellGet(_1f,_20,_21);};};var _22=dojo.hitch(this,this._cellFormatter);var _23=[],_24=this._columns;for(var i=0;i<_24;i++){_23.push({field:"cell"+i,get:dojo.hitch(this,_1e(i)),formatter:_22});}var _25={cells:[_23]};if(this.grouping){var _26={field:"groupName",colSpan:_24,get:dojo.hitch(this,this._cellGetGroup),formatter:dojo.hitch(this,this._cellGroupFormatter)};_25.cells.push([_26]);}var _27=this.grid;_27.set("structure",_25);},_setGridData:function(){var _28=[];if(this.grouping){this._groupRowIndices=[];var _29,_2a,_2b=this._columns;dojo.forEach(this._flItems,function(_2c,idx){_28.push({});var _2d=(idx===0)?0:(_29+_2a+1);this._groupRowIndices.push(_2d);_29=_2d;_2a=Math.ceil(_2c.length/_2b);_28=_28.concat(this._getStoreItems(_2c));},this);}else{if(this.featureLayers){dojo.forEach(this._flItems,function(_2e){_28=_28.concat(_2e);});_28=this._getStoreItems(_28);}else{_28=this._getStoreItems(this._itItems);}}var _2f=new dojo.data.ItemFileReadStore({data:{items:_28}});this.grid.setStore(_2f);},_toggleTooltip:function(){if(this.showTooltip){if(this.tooltip){return;}this.tooltip=dojo.create("div",{"class":"tooltip"},this.domNode);this.tooltip.style.display="none";this.tooltip.style.position="fixed";var _30=this.grid;this._mouseOverConnect=dojo.connect(_30,"onCellMouseOver",this,this._cellMouseOver);this._mouseOutConnect=dojo.connect(_30,"onCellMouseOut",this,this._cellMouseOut);}else{if(this.tooltip){dojo.disconnect(this._mouseOverConnect);dojo.disconnect(this._mouseOutConnect);dojo.destroy(this.tooltip);this.tooltip=null;}}},_rowClicked:function(evt,_31){var _32=evt.cellNode,row=evt.rowIndex,col=evt.cellIndex;var _33=this._getCellInfo(_32,row,col);if(!_33){return;}if(this._selectedCell){dojo.removeClass(this._selectedCell,"selectedItem");}if(_32!==this._selectedCell){dojo.addClass(_32,"selectedItem");this._selectedCell=_32;var _34=this.grid.store;this._selectedItem={featureLayer:_34.getValue(_33,"layer"),type:_34.getValue(_33,"type"),template:_34.getValue(_33,"template"),symbolInfo:_34.getValue(_33,"symbolInfo"),item:this._getItem(_33)};this._selectedInfo={selRow:row,selCol:col,index1:_34.getValue(_33,"index1"),index2:_34.getValue(_33,"index2"),index:_34.getValue(_33,"index")};}else{this._selectedCell=this._selectedInfo=this._selectedItem=null;}if(!_31){this.onSelectionChange();}},_locate:function(_35,_36,_37){var _38=this.grid.store,_39=new Array(this._columns);var _3a,_3b=_36.index1,_3c=_36.index2,_3d=_36.index,_3e=_35.item;dojo.some(_37,function(_3f,_40){return dojo.some(_39,function(_41,_42){var _43=_38.getValue(_3f,"cell"+_42);if(_43&&(_3e?(_3d===_38.getValue(_43,"index")):(_3b===_38.getValue(_43,"index1")&&_3c===_38.getValue(_43,"index2")))){_3a=[_40,_42];return true;}else{return false;}});});return _3a;},_getCellInfo:function(_44,row,col){if(!_44){return;}var _45=this.grid;var _46=_45.getItem(row);var _47=_45.store.getValue(_46,"cell"+col);return _47;},_getItem:function(_48){var _49=this.items;if(_49){return _49[this.grid.store.getValue(_48,"index")];}},_cellMouseOver:function(evt){var _4a=this.tooltip;var _4b=evt.cellNode,row=evt.rowIndex,col=evt.cellIndex;var _4c=this._getCellInfo(_4b,row,col);if(_4a&&_4c){var _4d=this.grid.store;var _4e=_4d.getValue(_4c,"template");var _4f=_4d.getValue(_4c,"type");var _50=_4d.getValue(_4c,"symbolInfo");var _51=_4d.getValue(_4c,"layer");var _52=this._getItem(_4c);var _53=(_52&&(_52.label+(_52.description?(": "+_52.description):"")))||(_4e&&(_4e.name+(_4e.description?(": "+_4e.description):"")))||(_4f&&_4f.name)||(_50&&(_50.label+(_50.description?(": "+_50.description):"")))||((_51&&_51.name+": ")+"Default");_4a.style.display="none";_4a.innerHTML=_53;var _54=dojo.coords(_4b.firstChild);dojo.style(_4a,{left:(_54.x)+"px",top:(_54.y+_54.h+5)+"px"});_4a.style.display="";}},_cellMouseOut:function(){var _55=this.tooltip;if(_55){_55.style.display="none";}},_destroyItems:function(){var _56=this._itemWidgets;for(var w in _56){if(!_56[w]){continue;}_56[w].destroy();delete _56[w];}},_repaintItems:function(){var _57=this._itemWidgets;for(var w in _57){var _58=_57[w];if(_58){_58._repaint(_58._surface);}}},_getStoreItems:function(_59){var uid=this._uniqueId;_59=dojo.map(_59,function(_5a){return dojo.mixin({"surfaceId":"tpick-surface-"+(uid.id++)},_5a);});var len=_59.length,_5b=0,obj={},k=0,_5c,_5d=[],_5e=true,_5f=this._columns;while(_5b<len){_5e=true;_5c="cell"+k;obj[_5c]=_59[_5b];_5b++;k++;if(k%_5f===0){_5e=false;_5d.push(obj);obj={};k=0;}}if(_5e){_5d.push(obj);}return _5d;},_getItemsFromLayers:function(_60){var _61=[];dojo.forEach(_60,function(_62,_63){_61.push(this._getItemsFromLayer(_62,_63));},this);return _61;},_getItemsFromLayer:function(_64,_65){var _66=[];var _67=[];_67=_67.concat(_64.templates);dojo.forEach(_64.types,function(_68){var _69=_68.templates;dojo.forEach(_69,function(_6a){_6a._type_=_68;});_67=_67.concat(_69);});_67=dojo.filter(_67,esri._isDefined);var _6b=_64.renderer;if(_6b){if(_67.length>0){dojo.forEach(_67,function(_6c){var _6d=_6c.prototype;if(_6d){var _6e=_6b.getSymbol(_6d);if(_6e){_66.push({label:this._trimLabel(_6c.name),symbol:_6e,layer:_64,type:_6c._type_,template:_6c,index1:_65,index2:_66.length});}}delete _6c._type_;},this);}else{var _6f=_6b.declaredClass.replace("esri.renderer.",""),_70=[];if(_6f==="TemporalRenderer"){_6b=_6b.observationRenderer;if(_6b){_6f=_6b.declaredClass.replace("esri.renderer.","");}}switch(_6f){case "SimpleRenderer":_70=[{symbol:_6b.symbol,label:_6b.label,description:_6b.description}];break;case "UniqueValueRenderer":case "ClassBreaksRenderer":_70=_6b.infos;break;}_66=dojo.map(_70,function(_71,idx){return {label:this._trimLabel(_71.label),description:_71.description,symbolInfo:dojo.mixin({constructor:function(){}},_71),symbol:_71.symbol,layer:_64,index1:_65,index2:idx};},this);}}return _66;},_getItemsFromItems:function(_72){return dojo.map(_72,function(_73,idx){var _73=dojo.mixin({index:idx},_73);_73.label=this._trimLabel(_73.label);return _73;},this);},_trimLabel:function(_74){var max=this.maxLabelLength;if(max&&_74){if(_74.length>max){_74=_74.substr(0,max)+"...";}}return _74||"";},_cellGet:function(_75,_76,_77){if(!_77){return "";}return this.grid.store.getValue(_77,"cell"+_75);},_cellFormatter:function(_78){if(_78){var _79=this._itemWidgets,_7a=this.grid.store;var sid=_7a.getValue(_78,"surfaceId");var w=_79[sid];if(!w){w=(_79[sid]=new esri.dijit.editing.TemplatePickerItem({id:sid,label:_7a.getValue(_78,"label"),symbol:_7a.getValue(_78,"symbol"),surfaceWidth:this.surfaceWidth,surfaceHeight:this.surfaceHeight,template:_7a.getValue(_78,"template")}));}return w||"";}else{return "";}},_cellGetGroup:function(_7b,_7c){if(!this._groupRowIndices){return "";}var _7d=dojo.indexOf(this._groupRowIndices,_7b);if(!_7c||_7d===-1){return "";}return this.featureLayers[_7d].name;},_cellGroupFormatter:function(_7e){if(_7e){return "<div class='groupLabel'>"+_7e+"</div>";}else{return "";}}});dojo.declare("esri.dijit.editing.TemplatePickerItem",[dijit._Widget,dijit._Templated],{templateString:"<div class='item' style='text-align: center;'>"+"<div class='itemSymbol' dojoAttachPoint='_surfaceNode'></div>"+"<div class='itemLabel'>${label}</div>"+"</div>",startup:function(){if(this._started){return;}this.inherited(arguments);this._surface=this._draw(this._surfaceNode,this.symbol,this.surfaceWidth,this.surfaceHeight,this.template);},_draw:function(_7f,_80,_81,_82,_83){var _84=dojox.gfx.createSurface(_7f,_81,_82);if(dojo.isIE<9){var _85=_84.getEventSource();dojo.style(_85,"position","relative");dojo.style(_85.parentNode,"position","relative");}var _86=this._getDrawingToolShape(_80,_83)||esri.symbol.getShapeDescriptors(_80);var _87;try{_87=_84.createShape(_86.defaultShape).setFill(_86.fill).setStroke(_86.stroke);}catch(e){_84.clear();_84.destroy();return;}var dim=_84.getDimensions();var _88={dx:dim.width/2,dy:dim.height/2};var _89=_87.getBoundingBox(),_8a=_89.width,_8b=_89.height;if(_8a>_81||_8b>_82){var _8c=_8a>_8b?_8a:_8b;var _8d=_81<_82?_81:_82;var _8e=(_8d-5)/_8c;dojo.mixin(_88,{xx:_8e,yy:_8e});}_87.applyTransform(_88);return _84;},_getDrawingToolShape:function(_8f,_90){var _91,_92=_90?_90.drawingTool||null:null;switch(_92){case "esriFeatureEditToolArrow":_91={type:"path",path:"M 10,1 L 3,8 L 3,5 L -15,5 L -15,-2 L 3,-2 L 3,-5 L 10,1 E"};break;case "esriFeatureEditToolLeftArrow":_91={type:"path",path:"M -15,1 L -8,8 L -8,5 L 10,5 L 10,-2 L -8,-2 L -8,-5 L -15,1 E"};break;case "esriFeatureEditToolRightArrow":_91={type:"path",path:"M 10,1 L 3,8 L 3,5 L -15,5 L -15,-2 L 3,-2 L 3,-5 L 10,1 E"};break;case "esriFeatureEditToolUpArrow":_91={type:"path",path:"M 1,-10 L 8,-3 L 5,-3 L 5,15 L -2,15 L -2,-3 L -5,-3 L 1,-10 E"};break;case "esriFeatureEditToolDownArrow":_91={type:"path",path:"M 1,15 L 8,8 L 5,8 L 5,-10 L -2,-10 L -2,8 L -5,8 L 1,15 E"};break;case "esriFeatureEditToolTriangle":_91={type:"path",path:"M -10,14 L 2,-10 L 14,14 L -10,14 E"};break;case "esriFeatureEditToolRectangle":_91={type:"path",path:"M -10,-10 L 10,-10 L 10,10 L -10,10 L -10,-10 E"};break;case "esriFeatureEditToolCircle":_91={type:"circle",cx:0,cy:0,r:10};break;case "esriFeatureEditToolEllipse":_91={type:"ellipse",cx:0,cy:0,rx:10,ry:5};break;case "esriFeatureEditToolFreehand":if(_8f.type==="simplelinesymbol"||_8f.type==="cartographiclinesymbol"){_91={type:"path",path:"m -11, -7c-1.5,-3.75 7.25,-9.25 12.5,-7c5.25,2.25 6.75,9.75 3.75,12.75c-3,3 -3.25,2.5 -9.75,5.25c-6.5,2.75 -7.25,14.25 2,15.25c9.25,1 11.75,-4 13.25,-6.75c1.5,-2.75 3.5,-11.75 12,-6.5"};}else{_91={type:"path",path:"M 10,-13 c3.1,0.16667 4.42564,2.09743 2.76923,3.69231c-2.61025,2.87179 -5.61025,5.6718 -6.14358,6.20513c-0.66667,0.93333 -0.46667,1.2 -0.53333,1.93333c-0.00001,0.86666 0.6,1.66667 1.13334,2c1.03077,0.38462 2.8,0.93333 3.38974,1.70769c0.47693,0.42564 0.87693,0.75897 1.41026,1.75897c0.13333,1.06667 -0.46667,2.86667 -1.8,3.8c-0.73333,0.73333 -3.86667,2.66666 -4.86667,3.13333c-0.93333,0.8 -7.4,3.2 -7.6,3.06667c-1.06667,0.46667 -4.73333,1.13334 -5.2,1.26667c-1.6,0.33334 -4.6,0.4 -6.25128,0.05128c-1.41539,-0.18462 -2.34872,-2.31796 -1.41539,-4.45129c0.93333,-1.73333 1.86667,-3.13333 2.64615,-3.85641c1.28718,-1.47692 2.57437,-2.68204 3.88718,-3.54359c0.88718,-1.13845 1.8,-1.33333 2.26666,-2.45641c0.33334,-0.74359 0.37949,-1.7641 0.06667,-2.87692c-0.66666,-1.46666 -1.66666,-1.86666 -2.98975,-2.2c-1.27692,-0.26666 -2.12307,-0.64102 -3.27692,-1.46666c-0.66667,-1.00001 -1.01538,-3.01539 0.73333,-4.06667c1.73333,-1.2 3.6,-1.93333 4.93333,-2.2c1.33333,-0.46667 4.84104,-1.09743 5.84103,-1.23076c1.60001,-0.46667 6.02564,-0.50257 7.29231,-0.56924z"};}break;default:return null;}return {defaultShape:_91,fill:_8f.getFill(),stroke:_8f.getStroke()};},_repaint:function(_93){if(!_93){this._surface=this._draw(this._surfaceNode,this.symbol,this.surfaceWidth,this.surfaceHeight,this.template);return;}if(_93.getStroke&&_93.setStroke){_93.setStroke(_93.getStroke());}if(_93.getFill&&_93.setFill){_93.setFill(_93.getFill());}if(_93.children&&dojo.isArray(_93.children)){dojo.forEach(_93.children,this._repaint,this);}},destroy:function(){if(this._surface){this._surface.destroy();delete this._surface;}this.inherited(arguments);}});}